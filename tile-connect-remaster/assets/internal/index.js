System.register("chunks:///internal.js",["./env-5304ac8c.js","cc"],(function(){var e,a,t,i,n,o,r,s,l,d,h,c,p,u,g,m,f,b,S,_,y,w,P,v,M,T,R,E,C,x,A;return{setters:[function(l){e=l._,a=l.a,t=l.b,i=l.c,n=l.d,o=l.e,r=l.f,s=l.g,l.E},function(e){l=e.cclegacy,d=e.gfx,h=e.ccenum,c=e._decorator,p=e.Camera,u=e.CCBoolean,g=e.CCInteger,m=e.CCFloat,f=e.Material,b=e.Texture2D,S=e.rendering,_=e.Component,y=e.geometry,w=e.renderer,P=e.assert,v=e.Layers,M=e.PipelineEventType,T=e.sys,R=e.pipeline,E=e.Vec2,C=e.Vec4,x=e.clamp,A=e.Vec3}],execute:function(){l._RF.push({},"cbf30kCUX9A3K+QpVC6wnzx","builtin-pipeline-types",void 0);var D=d.SampleCount;function F(){return{enabled:!1,sampleCount:D.X4}}var L,O,k,N,G,B,Q,z,H,I,W,U,V,j,K,X,Y,q,Z,J,$,ee,ae,te,ie,ne,oe,re,se,le,de,he,ce,pe=function(e){return e[e.KawaseDualFilter=0]="KawaseDualFilter",e[e.MipmapFilter=1]="MipmapFilter",e}({});function ue(){return{enabled:!1,type:pe.KawaseDualFilter,material:null,kawaseFilterMaterial:null,mipmapFilterMaterial:null,enableAlphaMask:!1,iterations:3,threshold:.8,intensity:1}}function ge(){return{msaa:F(),enableShadingScale:!1,shadingScale:.5,bloom:ue(),toneMapping:{material:null},colorGrading:{enabled:!1,material:null,contribute:1,colorGradingMap:null},fsr:{enabled:!1,material:null,sharpness:.8},fxaa:{enabled:!1,material:null}}}function me(e){e.msaa?function(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.sampleCount&&(e.sampleCount=D.X4)}(e.msaa):e.msaa=F(),void 0===e.enableShadingScale&&(e.enableShadingScale=!1),void 0===e.shadingScale&&(e.shadingScale=.5),e.bloom?function(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.type&&(e.type=pe.KawaseDualFilter),void 0===e.material&&(e.material=null),void 0===e.kawaseFilterMaterial&&(e.kawaseFilterMaterial=e.material||null),void 0===e.mipmapFilterMaterial&&(e.mipmapFilterMaterial=null),void 0===e.enableAlphaMask&&(e.enableAlphaMask=!1),void 0===e.iterations&&(e.iterations=3),void 0===e.threshold&&(e.threshold=.8),void 0===e.intensity&&(e.intensity=1)}(e.bloom):e.bloom=ue(),e.toneMapping?function(e){void 0===e.material&&(e.material=null)}(e.toneMapping):e.toneMapping={material:null},e.colorGrading?function(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null),void 0===e.contribute&&(e.contribute=1),void 0===e.colorGradingMap&&(e.colorGradingMap=null)}(e.colorGrading):e.colorGrading={enabled:!1,material:null,contribute:1,colorGradingMap:null},e.fsr?function(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null),void 0===e.sharpness&&(e.sharpness=.8)}(e.fsr):e.fsr={enabled:!1,material:null,sharpness:.8},e.fxaa?function(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null)}(e.fxaa):e.fxaa={enabled:!1,material:null}}h(pe),l._RF.pop(),l._RF.push({},"de1c2EHcMhAIYRZY5nyTQHG","builtin-pipeline-settings",void 0);var fe=c.ccclass,be=c.disallowMultiple,Se=c.executeInEditMode,_e=c.menu,ye=c.property,we=c.requireComponent,Pe=c.type;L=fe("BuiltinPipelineSettings"),O=_e("Rendering/BuiltinPipelineSettings"),k=we(p),N=ye(u),G=ye({displayName:"Editor Preview (Experimental)",type:u}),B=ye({group:{id:"MSAA",name:"Multisample Anti-Aliasing"},type:u}),Q=ye({group:{id:"MSAA",name:"Multisample Anti-Aliasing",style:"section"},type:g,range:[2,4,2]}),z=ye({group:{id:"ShadingScale",name:"ShadingScale",style:"section"},type:u}),H=ye({tooltip:"i18n:postprocess.shadingScale",group:{id:"ShadingScale",name:"ShadingScale"},type:m,range:[.01,4,.01],slide:!0}),I=ye({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:u}),W=Pe(pe),U=ye({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"}}),V=ye({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:f}),j=ye({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:f}),K=ye({tooltip:"i18n:bloom.enableAlphaMask",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:u}),X=ye({tooltip:"i18n:bloom.iterations",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:g,range:[1,6,1],slide:!0}),Y=ye({tooltip:"i18n:bloom.threshold",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:m,min:0}),q=Pe(m),Z=ye({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"}}),J=ye({group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:u}),$=ye({group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:f}),ee=ye({tooltip:"i18n:color_grading.contribute",group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:m,range:[0,1,.01],slide:!0}),ae=ye({tooltip:"i18n:color_grading.originalMap",group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:b}),te=ye({group:{id:"FXAA",name:"Fast Approximate Anti-Aliasing (PostProcessing)",style:"section"},type:u}),ie=ye({group:{id:"FXAA",name:"Fast Approximate Anti-Aliasing (PostProcessing)",style:"section"},type:f}),ne=ye({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:u}),oe=ye({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:f}),re=ye({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:m,range:[0,1,.01],slide:!0}),se=ye({group:{id:"ToneMapping",name:"ToneMapping",style:"section"},type:f}),L(le=O(le=k(le=be(le=Se((he=e((de=function(e){a(l,e);var s=t(l);function l(){var e;i(this,l);for(var a=arguments.length,t=new Array(a),r=0;r<a;r++)t[r]=arguments[r];return e=s.call.apply(s,[this].concat(t)),n(e,"_settings",he,o(e)),n(e,"_editorPreview",ce,o(e)),e}return r(l,[{key:"getPipelineSettings",value:function(){return this._settings}},{key:"onEnable",value:function(){me(this._settings),this.getComponent(p).camera.pipelineSettings=this._settings}},{key:"onDisable",value:function(){var e=this.getComponent(p).camera;e&&(e.pipelineSettings=null)}},{key:"editorPreview",get:function(){return this._editorPreview},set:function(e){this._editorPreview=e}},{key:"_tryEnableEditorPreview",value:function(){void 0!==S&&(this._editorPreview?S.setEditorPipelineSettings(this._settings):this._disableEditorPreview())}},{key:"_disableEditorPreview",value:function(){void 0!==S&&(S.getEditorPipelineSettings()===this._settings&&S.setEditorPipelineSettings(null))}},{key:"MsaaEnable",get:function(){return this._settings.msaa.enabled},set:function(e){this._settings.msaa.enabled=e}},{key:"msaaSampleCount",get:function(){return this._settings.msaa.sampleCount},set:function(e){e=Math.pow(2,Math.ceil(Math.log2(Math.max(e,2)))),e=Math.min(e,4),this._settings.msaa.sampleCount=e}},{key:"shadingScaleEnable",get:function(){return this._settings.enableShadingScale},set:function(e){this._settings.enableShadingScale=e}},{key:"shadingScale",get:function(){return this._settings.shadingScale},set:function(e){this._settings.shadingScale=e}},{key:"bloomEnable",get:function(){return this._settings.bloom.enabled},set:function(e){this._settings.bloom.enabled=e}},{key:"bloomType",get:function(){return this._settings.bloom.type},set:function(e){this._settings.bloom.type=e}},{key:"kawaseBloomMaterial",get:function(){return this._settings.bloom.kawaseFilterMaterial},set:function(e){this._settings.bloom.kawaseFilterMaterial!==e&&(this._settings.bloom.kawaseFilterMaterial=e)}},{key:"mipmapBloomMaterial",get:function(){return this._settings.bloom.mipmapFilterMaterial},set:function(e){this._settings.bloom.mipmapFilterMaterial!==e&&(this._settings.bloom.mipmapFilterMaterial=e)}},{key:"bloomEnableAlphaMask",get:function(){return this._settings.bloom.enableAlphaMask},set:function(e){this._settings.bloom.enableAlphaMask=e}},{key:"bloomIterations",get:function(){return this._settings.bloom.iterations},set:function(e){this._settings.bloom.iterations=e}},{key:"bloomThreshold",get:function(){return this._settings.bloom.threshold},set:function(e){this._settings.bloom.threshold=e}},{key:"bloomIntensity",get:function(){return this._settings.bloom.intensity},set:function(e){this._settings.bloom.intensity=e}},{key:"colorGradingEnable",get:function(){return this._settings.colorGrading.enabled},set:function(e){this._settings.colorGrading.enabled=e}},{key:"colorGradingMaterial",get:function(){return this._settings.colorGrading.material},set:function(e){this._settings.colorGrading.material!==e&&(this._settings.colorGrading.material=e)}},{key:"colorGradingContribute",get:function(){return this._settings.colorGrading.contribute},set:function(e){this._settings.colorGrading.contribute=e}},{key:"colorGradingMap",get:function(){return this._settings.colorGrading.colorGradingMap},set:function(e){this._settings.colorGrading.colorGradingMap=e}},{key:"fxaaEnable",get:function(){return this._settings.fxaa.enabled},set:function(e){this._settings.fxaa.enabled=e}},{key:"fxaaMaterial",get:function(){return this._settings.fxaa.material},set:function(e){this._settings.fxaa.material!==e&&(this._settings.fxaa.material=e)}},{key:"fsrEnable",get:function(){return this._settings.fsr.enabled},set:function(e){this._settings.fsr.enabled=e}},{key:"fsrMaterial",get:function(){return this._settings.fsr.material},set:function(e){this._settings.fsr.material!==e&&(this._settings.fsr.material=e)}},{key:"fsrSharpness",get:function(){return this._settings.fsr.sharpness},set:function(e){this._settings.fsr.sharpness=e}},{key:"toneMappingMaterial",get:function(){return this._settings.toneMapping.material},set:function(e){this._settings.toneMapping.material!==e&&(this._settings.toneMapping.material=e)}}]),l}(_)).prototype,"_settings",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ge()}}),ce=e(de.prototype,"_editorPreview",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),e(de.prototype,"editorPreview",[G],Object.getOwnPropertyDescriptor(de.prototype,"editorPreview"),de.prototype),e(de.prototype,"MsaaEnable",[B],Object.getOwnPropertyDescriptor(de.prototype,"MsaaEnable"),de.prototype),e(de.prototype,"msaaSampleCount",[Q],Object.getOwnPropertyDescriptor(de.prototype,"msaaSampleCount"),de.prototype),e(de.prototype,"shadingScaleEnable",[z],Object.getOwnPropertyDescriptor(de.prototype,"shadingScaleEnable"),de.prototype),e(de.prototype,"shadingScale",[H],Object.getOwnPropertyDescriptor(de.prototype,"shadingScale"),de.prototype),e(de.prototype,"bloomEnable",[I],Object.getOwnPropertyDescriptor(de.prototype,"bloomEnable"),de.prototype),e(de.prototype,"bloomType",[W,U],Object.getOwnPropertyDescriptor(de.prototype,"bloomType"),de.prototype),e(de.prototype,"kawaseBloomMaterial",[V],Object.getOwnPropertyDescriptor(de.prototype,"kawaseBloomMaterial"),de.prototype),e(de.prototype,"mipmapBloomMaterial",[j],Object.getOwnPropertyDescriptor(de.prototype,"mipmapBloomMaterial"),de.prototype),e(de.prototype,"bloomEnableAlphaMask",[K],Object.getOwnPropertyDescriptor(de.prototype,"bloomEnableAlphaMask"),de.prototype),e(de.prototype,"bloomIterations",[X],Object.getOwnPropertyDescriptor(de.prototype,"bloomIterations"),de.prototype),e(de.prototype,"bloomThreshold",[Y],Object.getOwnPropertyDescriptor(de.prototype,"bloomThreshold"),de.prototype),e(de.prototype,"bloomIntensity",[q,Z],Object.getOwnPropertyDescriptor(de.prototype,"bloomIntensity"),de.prototype),e(de.prototype,"colorGradingEnable",[J],Object.getOwnPropertyDescriptor(de.prototype,"colorGradingEnable"),de.prototype),e(de.prototype,"colorGradingMaterial",[$],Object.getOwnPropertyDescriptor(de.prototype,"colorGradingMaterial"),de.prototype),e(de.prototype,"colorGradingContribute",[ee],Object.getOwnPropertyDescriptor(de.prototype,"colorGradingContribute"),de.prototype),e(de.prototype,"colorGradingMap",[ae],Object.getOwnPropertyDescriptor(de.prototype,"colorGradingMap"),de.prototype),e(de.prototype,"fxaaEnable",[te],Object.getOwnPropertyDescriptor(de.prototype,"fxaaEnable"),de.prototype),e(de.prototype,"fxaaMaterial",[ie],Object.getOwnPropertyDescriptor(de.prototype,"fxaaMaterial"),de.prototype),e(de.prototype,"fsrEnable",[ne],Object.getOwnPropertyDescriptor(de.prototype,"fsrEnable"),de.prototype),e(de.prototype,"fsrMaterial",[oe],Object.getOwnPropertyDescriptor(de.prototype,"fsrMaterial"),de.prototype),e(de.prototype,"fsrSharpness",[re],Object.getOwnPropertyDescriptor(de.prototype,"fsrSharpness"),de.prototype),e(de.prototype,"toneMappingMaterial",[se],Object.getOwnPropertyDescriptor(de.prototype,"toneMappingMaterial"),de.prototype),le=de))||le)||le)||le)||le);l._RF.pop(),l._RF.push({},"ff9b0GZzgRM/obMbHGfCNbk","builtin-pipeline",void 0);var ve=y.AABB,Me=y.Sphere,Te=y.intersect,Re=d.ClearFlagBit,Ee=d.Color,Ce=d.Format,xe=d.FormatFeatureBit,Ae=d.LoadOp,De=d.StoreOp,Fe=d.TextureType,Le=d.Viewport,Oe=w.scene,ke=Oe.CameraUsage,Ne=Oe.CSMLevel,Ge=Oe.LightType;function Be(e){return!!(e.clearFlag&(Re.COLOR|Re.STENCIL<<1))}function Qe(e,a,t,i,n,o){e.shadowFixedArea||e.csmLevel===Ne.LEVEL_1?(n.left=0,n.top=0,n.width=Math.trunc(a),n.height=Math.trunc(t)):(n.left=Math.trunc(i%2*.5*a),n.top=o>0?Math.trunc(.5*(1-Math.floor(i/2))*t):Math.trunc(.5*Math.floor(i/2)*t),n.width=Math.trunc(.5*a),n.height=Math.trunc(.5*t)),n.left=Math.max(0,n.left),n.top=Math.max(0,n.top),n.width=Math.max(1,n.width),n.height=Math.max(1,n.height)}var ze=r((function e(){i(this,e),this.isWeb=!1,this.isWebGL1=!1,this.isWebGPU=!1,this.isMobile=!1,this.isHDR=!1,this.useFloatOutput=!1,this.toneMappingType=0,this.shadowEnabled=!1,this.shadowMapFormat=Ce.R32F,this.shadowMapSize=new E(1,1),this.usePlanarShadow=!1,this.screenSpaceSignY=1,this.supportDepthSample=!1,this.mobileMaxSpotLightShadowMaps=1,this.platform=new C(0,0,0,0)}));function He(e,a){var t=xe.SAMPLED_TEXTURE|xe.LINEAR_FILTER,i=e.device;a.isWeb=!T.isNative,a.isWebGL1=i.gfxAPI===d.API.WEBGL,a.isWebGPU=i.gfxAPI===d.API.WEBGPU,a.isMobile=T.isMobile,a.isHDR=e.pipelineSceneData.isHDR,a.useFloatOutput=e.getMacroBool("CC_USE_FLOAT_OUTPUT"),a.toneMappingType=e.pipelineSceneData.postSettings.toneMappingType;var n=e.pipelineSceneData.shadows;a.shadowEnabled=n.enabled,a.shadowMapFormat=R.supportsR32FloatTexture(e.device)?Ce.R32F:Ce.RGBA8,a.shadowMapSize.set(n.size),a.usePlanarShadow=n.enabled&&n.type===w.scene.ShadowType.Planar,a.screenSpaceSignY=e.device.capabilities.screenSpaceSignY,a.supportDepthSample=(e.device.getFormatFeatures(Ce.DEPTH_STENCIL)&t)===t;var o=i.capabilities.screenSpaceSignY;a.platform.x=a.isMobile?1:0,a.platform.w=.5*o+.5<<1|.5*i.capabilities.clipSpaceSignY+.5}var Ie=ge(),We=r((function e(){i(this,e),this.settings=Ie,this.isMainGameWindow=!1,this.renderWindowId=0,this.colorName="",this.depthStencilName="",this.enableFullPipeline=!1,this.enableProfiler=!1,this.remainingPasses=0,this.enableShadingScale=!1,this.shadingScale=1,this.nativeWidth=1,this.nativeHeight=1,this.width=1,this.height=1,this.enableHDR=!1,this.radianceFormat=d.Format.RGBA8,this.copyAndTonemapMaterial=null,this.enableStoreSceneDepth=!1})),Ue=new Ee(0,0,0,0);function Ve(e,a,t,i){P(!!t.copyAndTonemapMaterial);var n=e.addRenderPass(t.nativeWidth,t.nativeHeight,"cc-tone-mapping");return n.addRenderTarget(t.colorName,Ae.CLEAR,De.STORE,Ue),n.addTexture(i,"inputTexture"),n.addQueue(S.QueueHint.OPAQUE).addFullscreenQuad(t.copyAndTonemapMaterial,1),n}function je(e,a,t){return e.startsWith(a)?"".concat(a).concat(1-Number(e.charAt(a.length)),"_").concat(t):"".concat(a,"0_").concat(t)}var Ke=function(){function e(){i(this,e),this.lights=[],this.shadowEnabledSpotLights=[],this._sphere=Me.create(0,0,0,1),this._boundingBox=new ve,this._rangedDirLightBoundingBox=new ve(0,0,0,.5,.5,.5)}return r(e,[{key:"cullLights",value:function(e,a,t){this.lights.length=0,this.shadowEnabledSpotLights.length=0;var i,n=s(e.spotLights);try{for(n.s();!(i=n.n()).done;){var o=i.value;o.baked||(Me.set(this._sphere,o.position.x,o.position.y,o.position.z,o.range),Te.sphereFrustum(this._sphere,a)&&(o.shadowEnabled?this.shadowEnabledSpotLights.push(o):this.lights.push(o)))}}catch(e){n.e(e)}finally{n.f()}var r,l=s(e.sphereLights);try{for(l.s();!(r=l.n()).done;){var d=r.value;d.baked||(Me.set(this._sphere,d.position.x,d.position.y,d.position.z,d.range),Te.sphereFrustum(this._sphere,a)&&this.lights.push(d))}}catch(e){l.e(e)}finally{l.f()}var h,c=s(e.pointLights);try{for(c.s();!(h=c.n()).done;){var p=h.value;p.baked||(Me.set(this._sphere,p.position.x,p.position.y,p.position.z,p.range),Te.sphereFrustum(this._sphere,a)&&this.lights.push(p))}}catch(e){c.e(e)}finally{c.f()}var u,g=s(e.rangedDirLights);try{for(g.s();!(u=g.n()).done;){var m=u.value;ve.transform(this._boundingBox,this._rangedDirLightBoundingBox,m.node.getWorldMatrix()),Te.aabbFrustum(this._boundingBox,a)&&this.lights.push(m)}}catch(e){g.e(e)}finally{g.f()}t&&this.shadowEnabledSpotLights.sort((function(e,a){return A.squaredDistance(t,e.position)-A.squaredDistance(t,a.position)}))}},{key:"_addLightQueues",value:function(e,a){var t,i=s(this.lights);try{for(i.s();!(t=i.n()).done;){var n=t.value,o=a.addQueue(S.QueueHint.BLEND,"forward-add");switch(n.type){case Ge.SPHERE:o.name="sphere-light";break;case Ge.SPOT:o.name="spot-light";break;case Ge.POINT:o.name="point-light";break;case Ge.RANGED_DIRECTIONAL:o.name="ranged-directional-light";break;default:o.name="unknown-light"}o.addScene(e,S.SceneFlags.BLEND,n)}}catch(e){i.e(e)}finally{i.f()}}},{key:"addSpotlightShadowPasses",value:function(e,a,t){var i,n=0,o=s(this.shadowEnabledSpotLights);try{for(o.s();!(i=o.n()).done;){var r=i.value,l=e.pipelineSceneData.shadows.size,d=e.addRenderPass(l.x,l.y,"default");if(d.name="SpotLightShadowPass".concat(n),d.addRenderTarget("SpotShadowMap".concat(n),Ae.CLEAR,De.STORE,new Ee(1,1,1,1)),d.addDepthStencil("SpotShadowDepth".concat(n),Ae.CLEAR,De.DISCARD),d.addQueue(S.QueueHint.NONE,"shadow-caster").addScene(a,S.SceneFlags.OPAQUE|S.SceneFlags.MASK|S.SceneFlags.SHADOW_CASTER).useLightFrustum(r),++n>=t)break}}catch(e){o.e(e)}finally{o.f()}}},{key:"addLightQueues",value:function(e,a,t){this._addLightQueues(a,e);var i,n=0,o=s(this.shadowEnabledSpotLights);try{for(o.s();!(i=o.n()).done;){var r=i.value;if(e.addTexture("SpotShadowMap".concat(n),"cc_spotShadowMap"),e.addQueue(S.QueueHint.BLEND,"forward-add").addScene(a,S.SceneFlags.BLEND,r),++n>=t)break}}catch(e){o.e(e)}finally{o.f()}}},{key:"addLightPasses",value:function(e,a,t,i,n,o,r,l,d,h){this._addLightQueues(r,h);var c,p=0,u=d.pipelineSceneData.shadows.size,g=s(this.shadowEnabledSpotLights);try{for(g.s();!(c=g.n()).done;){var m=c.value,f=d.addRenderPass(u.x,u.y,"default");f.name="SpotlightShadowPass",f.addRenderTarget("ShadowMap".concat(i),Ae.CLEAR,De.STORE,new Ee(1,1,1,1)),f.addDepthStencil("ShadowDepth".concat(i),Ae.CLEAR,De.DISCARD),f.addQueue(S.QueueHint.NONE,"shadow-caster").addScene(r,S.SceneFlags.OPAQUE|S.SceneFlags.MASK|S.SceneFlags.SHADOW_CASTER).useLightFrustum(m);var b=++p===this.shadowEnabledSpotLights.length?t:De.STORE;(h=d.addRenderPass(n,o,"default")).name="SpotlightWithShadowMap",h.setViewport(l),h.addRenderTarget(e,Ae.LOAD),h.addDepthStencil(a,Ae.LOAD,b),h.addTexture("ShadowMap".concat(i),"cc_spotShadowMap"),h.addQueue(S.QueueHint.BLEND,"forward-add").addScene(r,S.SceneFlags.BLEND,m)}}catch(e){g.e(e)}finally{g.f()}return h}},{key:"isMultipleLightPassesNeeded",value:function(){return this.shadowEnabledSpotLights.length>0}}]),e}(),Xe=function(){function e(){i(this,e),this.forwardLighting=new Ke,this._viewport=new Le,this._clearColor=new Ee(0,0,0,1),this._reflectionProbeClearColor=new A(0,0,0)}return r(e,[{key:"getConfigOrder",value:function(){return e.ConfigOrder}},{key:"getRenderOrder",value:function(){return e.RenderOrder}},{key:"configCamera",value:function(e,a,t){t.enableMainLightShadowMap=a.shadowEnabled&&!a.usePlanarShadow&&!!e.scene&&!!e.scene.mainLight&&e.scene.mainLight.shadowEnabled,t.enableMainLightPlanarShadowMap=a.shadowEnabled&&a.usePlanarShadow&&!!e.scene&&!!e.scene.mainLight&&e.scene.mainLight.shadowEnabled,t.enablePlanarReflectionProbe=t.isMainGameWindow||e.cameraUsage===ke.SCENE_VIEW||e.cameraUsage===ke.GAME_VIEW,t.enableMSAA=t.settings.msaa.enabled&&!t.enableStoreSceneDepth&&!a.isWeb&&!a.isWebGL1,t.enableSingleForwardPass=a.isMobile||t.enableMSAA,++t.remainingPasses}},{key:"windowResize",value:function(e,a,t,i,n,o,r){var s=S.ResourceFlags,l=S.ResourceResidency,d=i.renderWindowId,h=t.settings,c=t.enableShadingScale?Math.max(Math.floor(o*t.shadingScale),1):o,p=t.enableShadingScale?Math.max(Math.floor(r*t.shadingScale),1):r;if(t.enableMSAA&&(t.enableHDR?e.addTexture("MsaaRadiance".concat(d),Fe.TEX2D,t.radianceFormat,c,p,1,1,1,h.msaa.sampleCount,s.COLOR_ATTACHMENT,l.MEMORYLESS):e.addTexture("MsaaRadiance".concat(d),Fe.TEX2D,Ce.RGBA8,c,p,1,1,1,h.msaa.sampleCount,s.COLOR_ATTACHMENT,l.MEMORYLESS),e.addTexture("MsaaDepthStencil".concat(d),Fe.TEX2D,Ce.DEPTH_STENCIL,c,p,1,1,1,h.msaa.sampleCount,s.DEPTH_STENCIL_ATTACHMENT,l.MEMORYLESS)),e.addRenderTarget("ShadowMap".concat(d),a.shadowMapFormat,a.shadowMapSize.x,a.shadowMapSize.y),e.addDepthStencil("ShadowDepth".concat(d),Ce.DEPTH_STENCIL,a.shadowMapSize.x,a.shadowMapSize.y),t.enableSingleForwardPass)for(var u=a.mobileMaxSpotLightShadowMaps,g=0;g!==u;++g)e.addRenderTarget("SpotShadowMap".concat(g),a.shadowMapFormat,a.shadowMapSize.x,a.shadowMapSize.y),e.addDepthStencil("SpotShadowDepth".concat(g),Ce.DEPTH_STENCIL,a.shadowMapSize.x,a.shadowMapSize.y)}},{key:"setup",value:function(e,a,t,i,n){e.setVec4("g_platform",a.platform);var o=i.window.renderWindowId,r=i.scene,s=r.mainLight;--t.remainingPasses,P(t.remainingPasses>=0),this.forwardLighting.cullLights(r,i.frustum),t.enableMainLightShadowMap&&(P(!!s),this._addCascadedShadowMapPass(e,a,o,s,i)),t.enableSingleForwardPass&&this.forwardLighting.addSpotlightShadowPasses(e,i,a.mobileMaxSpotLightShadowMaps),this._tryAddReflectionProbePasses(e,t,o,s,i.scene),t.remainingPasses>0||t.enableShadingScale?(n.colorName=t.enableShadingScale?"ScaledRadiance0_".concat(o):"Radiance0_".concat(o),n.depthStencilName=t.enableShadingScale?"ScaledSceneDepth_".concat(o):"SceneDepth_".concat(o)):(n.colorName=t.colorName,n.depthStencilName=t.depthStencilName);var l=this._addForwardRadiancePasses(e,a,t,o,i,t.width,t.height,s,n.colorName,n.depthStencilName,!t.enableMSAA,t.enableStoreSceneDepth?De.STORE:De.DISCARD);return t.enableStoreSceneDepth||(n.depthStencilName=""),0===t.remainingPasses&&t.enableShadingScale?Ve(e,0,t,n.colorName):l}},{key:"_addCascadedShadowMapPass",value:function(e,a,t,i,n){var o=S.QueueHint,r=S.SceneFlags,s=e.pipelineSceneData.shadows.size,l=s.x,d=s.y,h=this._viewport;h.left=h.top=0,h.width=l,h.height=d;var c=e.addRenderPass(l,d,"default");c.name="CascadedShadowMap",c.addRenderTarget("ShadowMap".concat(t),Ae.CLEAR,De.STORE,new Ee(1,1,1,1)),c.addDepthStencil("ShadowDepth".concat(t),Ae.CLEAR,De.DISCARD);for(var p=e.pipelineSceneData.csmSupported?i.csmLevel:1,u=0;u!==p;++u){Qe(i,l,d,u,this._viewport,a.screenSpaceSignY);var g=c.addQueue(o.NONE,"shadow-caster");a.isWebGPU||g.setViewport(this._viewport),g.addScene(n,r.OPAQUE|r.MASK|r.SHADOW_CASTER).useLightFrustum(i,u)}}},{key:"_tryAddReflectionProbePasses",value:function(e,a,t,i,n){var o=l.internal.reflectionProbeManager;if(o){var r,h=S.ResourceResidency,c=o.getProbes(),p=0,u=s(c);try{for(u.s();!(r=u.n()).done;){var g=r.value;if(g.needRender){var m=g.renderArea(),f=Math.max(Math.floor(m.x),1),b=Math.max(Math.floor(m.y),1);if(g.probeType===w.scene.ProbeType.PLANAR){if(!a.enablePlanarReflectionProbe)continue;var _=g.realtimePlanarTexture.window,y="PlanarProbeRT".concat(p),P="PlanarProbeDS".concat(p);e.addRenderWindow(y,a.radianceFormat,f,b,_),e.addDepthStencil(P,d.Format.DEPTH_STENCIL,f,b,h.MEMORYLESS);var v=e.addRenderPass(f,b,"default");v.name="PlanarReflectionProbe".concat(p),this._buildReflectionProbePass(v,a,t,g.camera,y,P,i,n)}else;if(4===++p)break}}}catch(e){u.e(e)}finally{u.f()}}}},{key:"_buildReflectionProbePass",value:function(e,a,t,i,n,o,r){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=S.QueueHint,d=S.SceneFlags,h=a.enableMSAA?De.DISCARD:De.STORE;if(Be(i)){this._reflectionProbeClearColor.x=i.clearColor.x,this._reflectionProbeClearColor.y=i.clearColor.y,this._reflectionProbeClearColor.z=i.clearColor.z;var c=S.packRGBE(this._reflectionProbeClearColor);this._clearColor.x=c.x,this._clearColor.y=c.y,this._clearColor.z=c.z,this._clearColor.w=c.w,e.addRenderTarget(n,Ae.CLEAR,h,this._clearColor)}else e.addRenderTarget(n,Ae.LOAD,h);i.clearFlag&Re.DEPTH_STENCIL?e.addDepthStencil(o,Ae.CLEAR,De.DISCARD,i.clearDepth,i.clearStencil,i.clearFlag&Re.DEPTH_STENCIL):e.addDepthStencil(o,Ae.LOAD,De.DISCARD),a.enableMainLightShadowMap&&e.addTexture("ShadowMap".concat(t),"cc_shadowMap"),e.addQueue(l.NONE,"reflect-map").addScene(i,d.OPAQUE|d.MASK|d.REFLECTION_PROBE,r||void 0,s||void 0)}},{key:"_addForwardRadiancePasses",value:function(e,a,t,i,n,o,r,s,l,d){var h=arguments.length>10&&void 0!==arguments[10]&&arguments[10],c=arguments.length>11&&void 0!==arguments[11]?arguments[11]:De.DISCARD,p=S.QueueHint,u=S.SceneFlags,g=n.clearColor;this._clearColor.x=g.x,this._clearColor.y=g.y,this._clearColor.z=g.z,this._clearColor.w=g.w;var m=n.viewport;this._viewport.left=Math.round(m.x*o),this._viewport.top=Math.round(m.y*r),this._viewport.width=Math.max(Math.round(m.width*o),1),this._viewport.height=Math.max(Math.round(m.height*r),1);var f=!h&&t.enableMSAA;P(!f||t.enableSingleForwardPass);var b=t.enableSingleForwardPass?this._addForwardSingleRadiancePass(e,a,t,i,n,f,o,r,s,l,d,c):this._addForwardMultipleRadiancePasses(e,t,i,n,o,r,s,l,d,c);t.enableMainLightPlanarShadowMap&&this._addPlanarShadowQueue(n,s,b);var _=u.BLEND|(n.geometryRenderer?u.GEOMETRY:u.NONE);return b.addQueue(p.BLEND).addScene(n,_,s||void 0),b}},{key:"_addForwardSingleRadiancePass",value:function(e,a,t,i,n,o,r,s,l,d,h,c){var p;if(P(t.enableSingleForwardPass),o){var u="MsaaRadiance".concat(i),g="MsaaDepthStencil".concat(i),m=t.settings.msaa.sampleCount,f=e.addMultisampleRenderPass(r,s,m,0,"default");f.name="MsaaForwardPass",this._buildForwardMainLightPass(f,t,i,n,u,g,De.DISCARD,l),f.resolveRenderTarget(u,d),p=f}else(p=e.addRenderPass(r,s,"default")).name="ForwardPass",this._buildForwardMainLightPass(p,t,i,n,d,h,c,l);return P(void 0!==p),this.forwardLighting.addLightQueues(p,n,a.mobileMaxSpotLightShadowMaps),p}},{key:"_addForwardMultipleRadiancePasses",value:function(e,a,t,i,n,o,r,s,l,d){P(!a.enableSingleForwardPass);var h=e.addRenderPass(n,o,"default");h.name="ForwardPass";var c=this.forwardLighting.isMultipleLightPassesNeeded()?De.STORE:d;return this._buildForwardMainLightPass(h,a,t,i,s,l,c,r),h=this.forwardLighting.addLightPasses(s,l,d,t,n,o,i,this._viewport,e,h)}},{key:"_buildForwardMainLightPass",value:function(e,a,t,i,n,o,r,s){var l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,d=S.QueueHint,h=S.SceneFlags;e.setViewport(this._viewport);var c=a.enableMSAA?De.DISCARD:De.STORE;Be(i)?e.addRenderTarget(n,Ae.CLEAR,c,this._clearColor):e.addRenderTarget(n,Ae.LOAD,c),i.clearFlag&Re.DEPTH_STENCIL?e.addDepthStencil(o,Ae.CLEAR,r,i.clearDepth,i.clearStencil,i.clearFlag&Re.DEPTH_STENCIL):e.addDepthStencil(o,Ae.LOAD,r),a.enableMainLightShadowMap&&e.addTexture("ShadowMap".concat(t),"cc_shadowMap"),e.addQueue(d.NONE).addScene(i,h.OPAQUE|h.MASK,s||void 0,l||void 0)}},{key:"_addPlanarShadowQueue",value:function(e,a,t){var i=S.QueueHint,n=S.SceneFlags;t.addQueue(i.BLEND,"planar-shadow").addScene(e,n.SHADOW_CASTER|n.PLANAR_SHADOW|n.BLEND,a||void 0)}}]),e}();function Ye(e,a){return Math.max(Math.floor(e*a),1)}Xe.ConfigOrder=100,Xe.RenderOrder=100;var qe=function(){function e(){i(this,e),this._clearColorTransparentBlack=new Ee(0,0,0,0),this._bloomParams=new C(0,0,0,0),this._bloomTexSize=new C(0,0,0,0),this._bloomWidths=[],this._bloomHeights=[],this._bloomTexNames=[],this._bloomUpSampleTexDescs=[],this._bloomDownSampleTexDescs=[],this._prefilterTexDesc={name:"",width:0,height:0},this._originalColorDesc={name:"",width:0,height:0}}return r(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 200}},{key:"configCamera",value:function(e,a,t){var i=t.settings.bloom,n=i.type===pe.KawaseDualFilter&&!!i.kawaseFilterMaterial||i.type===pe.MipmapFilter&&!!i.mipmapFilterMaterial;t.enableBloom=i.enabled&&n,t.enableBloom&&++t.remainingPasses}},{key:"windowResize",value:function(e,a,t,i){if(t.enableBloom){var n=t.width,o=t.height,r=t.settings.bloom,s=i.renderWindowId,l=t.radianceFormat;if(r.type===pe.KawaseDualFilter)for(var d=t.width,h=t.height,c=0;c!==r.iterations+1;++c)d=Math.max(Math.floor(d/2),1),h=Math.max(Math.floor(h/2),1),e.addRenderTarget("BloomTex".concat(s,"_").concat(c),l,d,h);else if(r.type===pe.MipmapFilter){for(var p=r.iterations,u=0;u!==p+1;++u){if(u<p){var g=Math.pow(.5,u+2);this._bloomDownSampleTexDescs[u]=this.createTexture(e,"DownSampleColor".concat(s).concat(u),Ye(n,g),Ye(o,g),l)}if(u<p-1){var m=Math.pow(.5,p-u-1);this._bloomUpSampleTexDescs[u]=this.createTexture(e,"UpSampleColor".concat(s).concat(u),Ye(n,m),Ye(o,m),l)}}this._originalColorDesc=this.createTexture(e,"OriginalColor".concat(s),n,o,l),this._prefilterTexDesc=this.createTexture(e,"PrefilterColor".concat(s),Ye(n,.5),Ye(o,.5),l)}}}},{key:"createTexture",value:function(e,a,t,i,n){var o={name:a,width:t,height:i};return e.addRenderTarget(o.name,n,o.width,o.height),o}},{key:"setup",value:function(e,a,t,i,n,o){if(!t.enableBloom)return o;--t.remainingPasses,P(t.remainingPasses>=0);var r=t.settings.bloom,s=i.window.renderWindowId;switch(r.type){case pe.KawaseDualFilter:var l=r.kawaseFilterMaterial;return P(!!l),this._addKawaseDualFilterBloomPasses(e,a,t,t.settings,l,s,t.width,t.height,n.colorName);case pe.MipmapFilter:var d=r.mipmapFilterMaterial;return P(!!d),this._addMipmapFilterBloomPasses(e,a,t,t.settings,d,s,t.width,t.height,n.colorName);default:return o}}},{key:"_addKawaseDualFilterBloomPasses",value:function(e,a,t,i,n,o,r,s,l){var d=S.QueueHint,h=i.bloom.iterations,c=h+1;this._bloomWidths.length=c,this._bloomHeights.length=c,this._bloomWidths[0]=Math.max(Math.floor(r/2),1),this._bloomHeights[0]=Math.max(Math.floor(s/2),1);for(var p=1;p!==c;++p)this._bloomWidths[p]=Math.max(Math.floor(this._bloomWidths[p-1]/2),1),this._bloomHeights[p]=Math.max(Math.floor(this._bloomHeights[p-1]/2),1);this._bloomTexNames.length=c;for(var u=0;u!==c;++u)this._bloomTexNames[u]="BloomTex".concat(o,"_").concat(u);this._bloomParams.x=a.useFloatOutput?1:0,this._bloomParams.y=0,this._bloomParams.z=i.bloom.threshold,this._bloomParams.w=i.bloom.enableAlphaMask?1:0;var g=e.addRenderPass(this._bloomWidths[0],this._bloomHeights[0],"cc-bloom-prefilter");g.addRenderTarget(this._bloomTexNames[0],Ae.CLEAR,De.STORE,this._clearColorTransparentBlack),g.addTexture(l,"inputTexture"),g.setVec4("bloomParams",this._bloomParams),g.addQueue(d.OPAQUE).addFullscreenQuad(n,0);for(var m=1;m!==c;++m){var f=e.addRenderPass(this._bloomWidths[m],this._bloomHeights[m],"cc-bloom-downsample");f.addRenderTarget(this._bloomTexNames[m],Ae.CLEAR,De.STORE,this._clearColorTransparentBlack),f.addTexture(this._bloomTexNames[m-1],"bloomTexture"),this._bloomTexSize.x=this._bloomWidths[m-1],this._bloomTexSize.y=this._bloomHeights[m-1],f.setVec4("bloomTexSize",this._bloomTexSize),f.addQueue(d.OPAQUE).addFullscreenQuad(n,1)}for(var b=h;b-- >0;){var _=e.addRenderPass(this._bloomWidths[b],this._bloomHeights[b],"cc-bloom-upsample");_.addRenderTarget(this._bloomTexNames[b],Ae.CLEAR,De.STORE,this._clearColorTransparentBlack),_.addTexture(this._bloomTexNames[b+1],"bloomTexture"),this._bloomTexSize.x=this._bloomWidths[b+1],this._bloomTexSize.y=this._bloomHeights[b+1],_.setVec4("bloomTexSize",this._bloomTexSize),_.addQueue(d.OPAQUE).addFullscreenQuad(n,2)}this._bloomParams.w=i.bloom.intensity;var y=e.addRenderPass(r,s,"cc-bloom-combine");return y.addRenderTarget(l,Ae.LOAD,De.STORE),y.addTexture(this._bloomTexNames[0],"bloomTexture"),y.setVec4("bloomParams",this._bloomParams),y.addQueue(d.BLEND).addFullscreenQuad(n,3),0===t.remainingPasses?Ve(e,0,t,l):y}},{key:"_addPass",value:function(e,a,t,i,n,o,r){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Ae.CLEAR,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:Ue,d=arguments.length>9&&void 0!==arguments[9]?arguments[9]:S.QueueHint.OPAQUE,h=e.addRenderPass(a,t,i);return h.addRenderTarget(n,s,De.STORE,l),h.addQueue(d).addFullscreenQuad(o,r),h}},{key:"_addMipmapFilterBloomPasses",value:function(e,a,t,i,n,o,r,s,l){this._bloomParams.x=a.useFloatOutput?1:0,this._bloomParams.x=0,this._bloomParams.z=i.bloom.threshold,this._bloomParams.w=i.bloom.intensity;var d=this._prefilterTexDesc,h=this._addPass(e,d.width,d.height,"cc-bloom-mipmap-prefilter",d.name,n,0);h.addTexture(l,"mainTexture"),h.setVec4("bloomParams",this._bloomParams);for(var c=this._bloomDownSampleTexDescs,p=0;p<c.length;++p){var u=c[p],g=0===p?d:c[p-1],m=g.name;this._bloomTexSize.x=1/g.width,this._bloomTexSize.y=1/g.height,(h=this._addPass(e,u.width,u.height,"cc-bloom-mipmap-downsample",u.name,n,1)).addTexture(m,"mainTexture"),h.setVec4("bloomParams",this._bloomTexSize)}for(var f=c.length-1,b=this._bloomUpSampleTexDescs,S=0;S<b.length;S++){var _=b[S],y=0===S?c[f]:b[S-1],w=y.name;this._bloomTexSize.x=1/y.width,this._bloomTexSize.y=1/y.height,(h=this._addPass(e,_.width,_.height,"cc-bloom-mipmap-upsample",_.name,n,2)).addTexture(w,"mainTexture"),h.addTexture(c[f-1-S].name,"downsampleTexture"),h.setVec4("bloomParams",this._bloomTexSize)}var P=this._addPass(e,r,s,"cc-bloom-mipmap-combine",l,n,3,Ae.LOAD);return P.addTexture(b[b.length-1].name,"bloomTexture"),P.setVec4("bloomParams",this._bloomParams),0===t.remainingPasses?Ve(e,0,t,l):P}}]),e}(),Ze=function(){function e(){i(this,e),this._colorGradingTexSize=new E(0,0)}return r(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 300}},{key:"configCamera",value:function(e,a,t){var i=t.settings;t.enableColorGrading=i.colorGrading.enabled&&!!i.colorGrading.material&&!!i.colorGrading.colorGradingMap,t.enableToneMapping=t.enableHDR||t.enableColorGrading,t.enableToneMapping&&++t.remainingPasses}},{key:"windowResize",value:function(e,a,t){t.enableColorGrading&&(P(!!t.settings.colorGrading.material),t.settings.colorGrading.material.setProperty("colorGradingMap",t.settings.colorGrading.colorGradingMap))}},{key:"setup",value:function(e,a,t,i,n,o){if(!t.enableToneMapping)return o;if(--t.remainingPasses,P(t.remainingPasses>=0),0===t.remainingPasses)return this._addCopyAndTonemapPass(e,a,t,t.width,t.height,n.colorName,t.colorName);var r=t.renderWindowId,s=t.enableShadingScale?"ScaledLdrColor":"LdrColor",l=je(n.colorName,s,r),d=n.colorName;return n.colorName=l,this._addCopyAndTonemapPass(e,a,t,t.width,t.height,d,l)}},{key:"_addCopyAndTonemapPass",value:function(e,a,t,i,n,o,r){var s,l=t.settings;if(t.enableColorGrading){P(!!l.colorGrading.material),P(!!l.colorGrading.colorGradingMap);var d=l.colorGrading.colorGradingMap;this._colorGradingTexSize.x=d.width,this._colorGradingTexSize.y=d.height;var h=d.width===d.height;(s=h?e.addRenderPass(i,n,"cc-color-grading-8x8"):e.addRenderPass(i,n,"cc-color-grading-nx1")).addRenderTarget(r,Ae.CLEAR,De.STORE,Ue),s.addTexture(o,"sceneColorMap"),s.setVec2("lutTextureSize",this._colorGradingTexSize),s.setFloat("contribute",l.colorGrading.contribute),s.addQueue(S.QueueHint.OPAQUE).addFullscreenQuad(l.colorGrading.material,h?1:0)}else(s=e.addRenderPass(i,n,"cc-tone-mapping")).addRenderTarget(r,Ae.CLEAR,De.STORE,Ue),s.addTexture(o,"inputTexture"),l.toneMapping.material?s.addQueue(S.QueueHint.OPAQUE).addFullscreenQuad(l.toneMapping.material,0):(P(!!t.copyAndTonemapMaterial),s.addQueue(S.QueueHint.OPAQUE).addFullscreenQuad(t.copyAndTonemapMaterial,0));return s}}]),e}(),Je=function(){function e(){i(this,e),this._fxaaParams=new C(0,0,0,0)}return r(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 400}},{key:"configCamera",value:function(e,a,t){t.enableFXAA=t.settings.fxaa.enabled&&!!t.settings.fxaa.material,t.enableFXAA&&++t.remainingPasses}},{key:"setup",value:function(e,a,t,i,n,o){if(!t.enableFXAA)return o;--t.remainingPasses,P(t.remainingPasses>=0);var r=t.renderWindowId,s=t.enableShadingScale?"ScaledLdrColor":"LdrColor",l=je(n.colorName,s,r);if(P(!!t.settings.fxaa.material),0===t.remainingPasses)return t.enableShadingScale?(this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,n.colorName,l),Ve(e,0,t,l)):(P(t.width===t.nativeWidth),P(t.height===t.nativeHeight),this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,n.colorName,t.colorName));var d=n.colorName;return n.colorName=l,this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,d,l)}},{key:"_addFxaaPass",value:function(e,a,t,i,n,o,r){this._fxaaParams.x=i,this._fxaaParams.y=n,this._fxaaParams.z=1/i,this._fxaaParams.w=1/n;var s=e.addRenderPass(i,n,"cc-fxaa");return s.addRenderTarget(r,Ae.CLEAR,De.STORE,Ue),s.addTexture(o,"sceneColorMap"),s.setVec4("texSize",this._fxaaParams),s.addQueue(S.QueueHint.OPAQUE).addFullscreenQuad(t,0),s}}]),e}(),$e=function(){function e(){i(this,e),this._fsrParams=new C(0,0,0,0),this._fsrTexSize=new C(0,0,0,0)}return r(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 500}},{key:"configCamera",value:function(e,a,t){t.enableFSR=t.settings.fsr.enabled&&!!t.settings.fsr.material&&t.enableShadingScale&&t.shadingScale<1,t.enableFSR&&++t.remainingPasses}},{key:"setup",value:function(e,a,t,i,n,o){if(!t.enableFSR)return o;--t.remainingPasses;var r=n.colorName,s=0===t.remainingPasses?t.colorName:je(n.colorName,"UiColor",t.renderWindowId);return n.colorName=s,P(!!t.settings.fsr.material),this._addFsrPass(e,a,t,t.settings,t.settings.fsr.material,t.renderWindowId,t.width,t.height,r,t.nativeWidth,t.nativeHeight,s)}},{key:"_addFsrPass",value:function(e,a,t,i,n,o,r,s,l,d,h,c){this._fsrTexSize.x=r,this._fsrTexSize.y=s,this._fsrTexSize.z=d,this._fsrTexSize.w=h,this._fsrParams.x=x(1-i.fsr.sharpness,.02,.98);var p=je(c,"UiColor",o),u=e.addRenderPass(d,h,"cc-fsr-easu");u.addRenderTarget(p,Ae.CLEAR,De.STORE,Ue),u.addTexture(l,"outputResultMap"),u.setVec4("fsrTexSize",this._fsrTexSize),u.addQueue(S.QueueHint.OPAQUE).addFullscreenQuad(n,0);var g=e.addRenderPass(d,h,"cc-fsr-rcas");return g.addRenderTarget(c,Ae.CLEAR,De.STORE,Ue),g.addTexture(p,"outputResultMap"),g.setVec4("fsrTexSize",this._fsrTexSize),g.setVec4("fsrParams",this._fsrParams),g.addQueue(S.QueueHint.OPAQUE).addFullscreenQuad(n,1),g}}]),e}(),ea=function(){function e(){i(this,e)}return r(e,[{key:"getConfigOrder",value:function(){return 0}},{key:"getRenderOrder",value:function(){return 1e3}},{key:"setup",value:function(e,a,t,i,n,o){P(!!o);var r=S.SceneFlags.UI;return t.enableProfiler&&(r|=S.SceneFlags.PROFILER,o.showStatistics=!0),o.addQueue(S.QueueHint.BLEND,"default","default").addScene(i,r),o}}]),e}();if(S){var aa=S.QueueHint,ta=S.SceneFlags,ia=function(){function e(){i(this,e),this._pipelineEvent=l.director.root.pipelineEvent,this._forwardPass=new Xe,this._bloomPass=new qe,this._toneMappingPass=new Ze,this._fxaaPass=new Je,this._fsrPass=new $e,this._uiPass=new ea,this._clearColor=new Ee(0,0,0,1),this._viewport=new Le,this._configs=new ze,this._cameraConfigs=new We,this._copyAndTonemapMaterial=new f,this._initialized=!1,this._passBuilders=[]}return r(e,[{key:"_setupPipelinePreview",value:function(e,a){if(e.cameraUsage===ke.SCENE_VIEW||e.cameraUsage===ke.PREVIEW){var t=S.getEditorPipelineSettings();a.settings=t||Ie}else e.pipelineSettings?a.settings=e.pipelineSettings:a.settings=Ie}},{key:"_preparePipelinePasses",value:function(e){var a=this._passBuilders;a.length=0;var t=e.settings;if(t._passes){var i,n=s(t._passes);try{for(n.s();!(i=n.n()).done;){var o=i.value;a.push(o)}}catch(e){n.e(e)}finally{n.f()}P(a.length===t._passes.length)}a.push(this._forwardPass),t.bloom.enabled&&a.push(this._bloomPass),a.push(this._toneMappingPass),t.fxaa.enabled&&a.push(this._fxaaPass),t.fsr.enabled&&a.push(this._fsrPass),a.push(this._uiPass)}},{key:"_setupBuiltinCameraConfigs",value:function(e,a,t,i){var n=a.window,o=a.cameraUsage===ke.GAME&&!!n.swapchain,r=o||a.cameraUsage===ke.GAME_VIEW;i.isMainGameWindow=o,i.renderWindowId=n.renderWindowId,i.colorName=n.colorName,i.depthStencilName=n.depthStencilName,i.enableFullPipeline=0!=(a.visibility&v.Enum.DEFAULT),i.enableProfiler=e.profiler&&r,i.remainingPasses=0,i.shadingScale=i.settings.shadingScale,i.enableShadingScale=i.settings.enableShadingScale&&1!==i.shadingScale,i.nativeWidth=Math.max(Math.floor(n.width),1),i.nativeHeight=Math.max(Math.floor(n.height),1),i.width=i.enableShadingScale?Math.max(Math.floor(i.nativeWidth*i.shadingScale),1):i.nativeWidth,i.height=i.enableShadingScale?Math.max(Math.floor(i.nativeHeight*i.shadingScale),1):i.nativeHeight,i.enableHDR=i.enableFullPipeline&&t.useFloatOutput,i.radianceFormat=i.enableHDR?d.Format.RGBA16F:d.Format.RGBA8,i.copyAndTonemapMaterial=this._copyAndTonemapMaterial,i.enableStoreSceneDepth=!1}},{key:"_setupCameraConfigs",value:function(e,a,t,i){this._setupPipelinePreview(a,i),this._preparePipelinePasses(i),this._passBuilders.sort((function(e,a){return e.getConfigOrder()-a.getConfigOrder()})),this._setupBuiltinCameraConfigs(e,a,t,i);var n,o=s(this._passBuilders);try{for(o.s();!(n=o.n()).done;){var r=n.value;r.configCamera&&r.configCamera(a,t,i)}}catch(e){o.e(e)}finally{o.f()}}},{key:"windowResize",value:function(e,a,t,i,n){He(e,this._configs),this._setupCameraConfigs(e,t,this._configs,this._cameraConfigs);var o=a.renderWindowId;e.addRenderWindow(this._cameraConfigs.colorName,Ce.RGBA8,i,n,a,this._cameraConfigs.depthStencilName);var r=this._cameraConfigs.width,l=this._cameraConfigs.height;this._cameraConfigs.enableShadingScale?(e.addDepthStencil("ScaledSceneDepth_".concat(o),Ce.DEPTH_STENCIL,r,l),e.addRenderTarget("ScaledRadiance0_".concat(o),this._cameraConfigs.radianceFormat,r,l),e.addRenderTarget("ScaledRadiance1_".concat(o),this._cameraConfigs.radianceFormat,r,l),e.addRenderTarget("ScaledLdrColor0_".concat(o),Ce.RGBA8,r,l),e.addRenderTarget("ScaledLdrColor1_".concat(o),Ce.RGBA8,r,l)):(e.addDepthStencil("SceneDepth_".concat(o),Ce.DEPTH_STENCIL,r,l),e.addRenderTarget("Radiance0_".concat(o),this._cameraConfigs.radianceFormat,r,l),e.addRenderTarget("Radiance1_".concat(o),this._cameraConfigs.radianceFormat,r,l),e.addRenderTarget("LdrColor0_".concat(o),Ce.RGBA8,r,l),e.addRenderTarget("LdrColor1_".concat(o),Ce.RGBA8,r,l)),e.addRenderTarget("UiColor0_".concat(o),Ce.RGBA8,i,n),e.addRenderTarget("UiColor1_".concat(o),Ce.RGBA8,i,n);var d,h=s(this._passBuilders);try{for(h.s();!(d=h.n()).done;){var c=d.value;c.windowResize&&c.windowResize(e,this._configs,this._cameraConfigs,a,t,i,n)}}catch(e){h.e(e)}finally{h.f()}}},{key:"setup",value:function(e,a){if(!this._initMaterials(a)){var t,i=s(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;n.scene&&n.window&&(this._setupCameraConfigs(a,n,this._configs,this._cameraConfigs),this._pipelineEvent.emit(M.RENDER_CAMERA_BEGIN,n),this._cameraConfigs.enableFullPipeline?this._buildForwardPipeline(a,n,n.scene,this._passBuilders):this._buildSimplePipeline(a,n),this._pipelineEvent.emit(M.RENDER_CAMERA_END,n))}}catch(e){i.e(e)}finally{i.f()}}}},{key:"_buildSimplePipeline",value:function(e,a){var t=Math.max(Math.floor(a.window.width),1),i=Math.max(Math.floor(a.window.height),1),n=this._cameraConfigs.colorName,o=this._cameraConfigs.depthStencilName,r=a.viewport;this._viewport.left=Math.round(r.x*t),this._viewport.top=Math.round(r.y*i),this._viewport.width=Math.max(Math.round(r.width*t),1),this._viewport.height=Math.max(Math.round(r.height*i),1);var s=a.clearColor;this._clearColor.x=s.x,this._clearColor.y=s.y,this._clearColor.z=s.z,this._clearColor.w=s.w;var l=e.addRenderPass(t,i,"default");Be(a)?l.addRenderTarget(n,Ae.CLEAR,De.STORE,this._clearColor):l.addRenderTarget(n,Ae.LOAD,De.STORE),a.clearFlag&Re.DEPTH_STENCIL?l.addDepthStencil(o,Ae.CLEAR,De.DISCARD,a.clearDepth,a.clearStencil,a.clearFlag&Re.DEPTH_STENCIL):l.addDepthStencil(o,Ae.LOAD,De.DISCARD),l.setViewport(this._viewport),l.addQueue(aa.OPAQUE).addScene(a,ta.OPAQUE);var d=ta.BLEND|ta.UI;this._cameraConfigs.enableProfiler&&(d|=ta.PROFILER,l.showStatistics=!0),l.addQueue(aa.BLEND).addScene(a,d)}},{key:"_buildForwardPipeline",value:function(e,a,t,i){!function(e){e.sort((function(e,a){return e.getRenderOrder()-a.getRenderOrder()}))}(i);var n,o={colorName:"",depthStencilName:""},r=void 0,l=s(i);try{for(l.s();!(n=l.n()).done;){var d=n.value;d.setup&&(r=d.setup(e,this._configs,this._cameraConfigs,a,o,r))}}catch(e){l.e(e)}finally{l.f()}P(0===this._cameraConfigs.remainingPasses)}},{key:"_initMaterials",value:function(e){return this._initialized?0:(He(e,this._configs),this._copyAndTonemapMaterial._uuid="builtin-pipeline-tone-mapping-material",this._copyAndTonemapMaterial.initialize({effectName:"pipeline/post-process/tone-mapping"}),this._copyAndTonemapMaterial.effectAsset&&(this._initialized=!0),this._initialized?0:1)}}]),e}();S.setCustomPipeline("Builtin",new ia)}l._RF.pop()}}}));

(function(r) {
  r('virtual:///prerequisite-imports/internal', 'chunks:///internal.js'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});