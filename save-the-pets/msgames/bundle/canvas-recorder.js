var M=Object.defineProperty;var et=(c,h,w)=>h in c?M(c,h,{enumerable:!0,configurable:!0,writable:!0,value:w}):c[h]=w;var a=(c,h)=>M(c,"name",{value:h,configurable:!0});var f=(c,h,w)=>et(c,typeof h!="symbol"?h+"":h,w);System.register(["./core.js"],function(c,h){"use strict";var w,T;return{setters:[y=>{w=y.P,T=y.G}],execute:a(function(){const y=c("d",{});c("e",Object.freeze(Object.defineProperty({__proto__:null,default:y},Symbol.toStringTag,{value:"Module"}))),"stream"in Blob.prototype||Object.defineProperty(Blob.prototype,"stream",{value(){return new Response(this).body}}),"setBigUint64"in DataView.prototype||Object.defineProperty(DataView.prototype,"setBigUint64",{value(t,i,e){const n=Number(0xffffffffn&i),s=Number(i>>32n);this.setUint32(t+(e?0:4),n,e),this.setUint32(t+(e?4:0),s,e)}});var v=a(t=>new DataView(new ArrayBuffer(t)),"e"),d=a(t=>new Uint8Array(t.buffer||t),"n"),C=a(t=>new TextEncoder().encode(String(t)),"t"),U=a(t=>Math.min(4294967295,Number(t)),"i"),D=a(t=>Math.min(65535,Number(t)),"r");function N(t,i){if(i===void 0||i instanceof Date||(i=new Date(i)),t instanceof File)return{isFile:1,t:i||new Date(t.lastModified),i:t.stream()};if(t instanceof Response)return{isFile:1,t:i||new Date(t.headers.get("Last-Modified")||Date.now()),i:t.body};if(i===void 0)i=new Date;else if(isNaN(i))throw new Error("Invalid modification date.");if(t===void 0)return{isFile:0,t:i};if(typeof t=="string")return{isFile:1,t:i,i:C(t)};if(t instanceof Blob)return{isFile:1,t:i,i:t.stream()};if(t instanceof Uint8Array||t instanceof ReadableStream)return{isFile:1,t:i,i:t};if(t instanceof ArrayBuffer||ArrayBuffer.isView(t))return{isFile:1,t:i,i:d(t)};if(Symbol.asyncIterator in t)return{isFile:1,t:i,i:L(t[Symbol.asyncIterator]())};throw new TypeError("Unsupported input format.")}a(N,"f");function L(t,i=t){return new ReadableStream({async pull(e){let n=0;for(;e.desiredSize>n;){const s=await t.next();if(!s.value){e.close();break}{const r=$(s.value);e.enqueue(r),n+=r.byteLength}}},cancel(e){var n;(n=i.throw)==null||n.call(i,e)}})}a(L,"o");function $(t){return typeof t=="string"?C(t):t instanceof Uint8Array?t:d(t)}a($,"a");function A(t,i,e){let[n,s]=function(r){return r?r instanceof Uint8Array?[r,1]:ArrayBuffer.isView(r)||r instanceof ArrayBuffer?[d(r),1]:[C(r),0]:[void 0,0]}(i);if(t instanceof File)return{o:B(n||C(t.name)),u:BigInt(t.size),l:s};if(t instanceof Response){const r=t.headers.get("content-disposition"),o=r&&r.match(/;\s*filename\*?=["']?(.*?)["']?$/i),l=o&&o[1]||t.url&&new URL(t.url).pathname.split("/").findLast(Boolean),g=l&&decodeURIComponent(l),m=e||+t.headers.get("content-length");return{o:B(n||C(g)),u:BigInt(m),l:s}}return n=B(n,t!==void 0||e!==void 0),typeof t=="string"?{o:n,u:BigInt(C(t).length),l:s}:t instanceof Blob?{o:n,u:BigInt(t.size),l:s}:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?{o:n,u:BigInt(t.byteLength),l:s}:{o:n,u:j(t,e),l:s}}a(A,"s");function j(t,i){return i>-1?BigInt(i):t?void 0:0n}a(j,"u");function B(t,i=1){if(!t||t.every(e=>e===47))throw new Error("The file must have a name.");if(i)for(;t[t.length-1]===47;)t=t.subarray(0,-1);else t[t.length-1]!==47&&(t=new Uint8Array([...t,47]));return t}a(B,"d");var R=new Uint32Array(256);for(let t=0;t<256;++t){let i=t;for(let e=0;e<8;++e)i=i>>>1^(1&i&&3988292384);R[t]=i}function x(t,i=0){i^=-1;for(var e=0,n=t.length;e<n;e++)i=i>>>8^R[255&i^t[e]];return(-1^i)>>>0}a(x,"y");function E(t,i,e=0){const n=t.getSeconds()>>1|t.getMinutes()<<5|t.getHours()<<11,s=t.getDate()|t.getMonth()+1<<5|t.getFullYear()-1980<<9;i.setUint16(e,n,1),i.setUint16(e+2,s,1)}a(E,"w");function k({o:t,l:i},e){return 8*(!i||(e??function(n){try{z.decode(n)}catch{return 0}return 1}(t)))}a(k,"B$1");var z=new TextDecoder("utf8",{fatal:1});function V(t,i=0){const e=v(30);return e.setUint32(0,1347093252),e.setUint32(4,754976768|i),E(t.t,e,10),e.setUint16(26,t.o.length,1),d(e)}a(V,"p");async function*_(t){let{i}=t;if("then"in i&&(i=await i),i instanceof Uint8Array)yield i,t.m=x(i,0),t.u=BigInt(i.length);else{t.u=0n;const e=i.getReader();for(;;){const{value:n,done:s}=await e.read();if(s)break;t.m=x(n,t.m),t.u+=BigInt(n.length),yield n}}}a(_,"g");function H(t,i){const e=v(16+(i?8:0));return e.setUint32(0,1347094280),e.setUint32(4,t.isFile?t.m:0,1),i?(e.setBigUint64(8,t.u,1),e.setBigUint64(16,t.u,1)):(e.setUint32(8,U(t.u),1),e.setUint32(12,U(t.u),1)),d(e)}a(H,"I$1");function G(t,i,e=0,n=0){const s=v(46);return s.setUint32(0,1347092738),s.setUint32(4,755182848),s.setUint16(8,2048|e),E(t.t,s,12),s.setUint32(16,t.isFile?t.m:0,1),s.setUint32(20,U(t.u),1),s.setUint32(24,U(t.u),1),s.setUint16(28,t.o.length,1),s.setUint16(30,n,1),s.setUint16(40,t.isFile?33204:16893,1),s.setUint32(42,U(i),1),d(s)}a(G,"v");function Y(t,i,e){const n=v(e);return n.setUint16(0,1,1),n.setUint16(2,e-4,1),16&e&&(n.setBigUint64(4,t.u,1),n.setBigUint64(12,t.u,1)),n.setBigUint64(e-8,i,1),d(n)}a(Y,"h");function P(t){return t instanceof File||t instanceof Response?[[t],[t]]:[[t.input,t.name,t.size],[t.input,t.lastModified]]}a(P,"D$1");var Q=a(t=>function(i){let e=BigInt(22),n=0n,s=0;for(const r of i){if(!r.o)throw new Error("Every file must have a non-empty name.");if(r.u===void 0)throw new Error(`Missing size for file "${new TextDecoder().decode(r.o)}".`);const o=r.u>=0xffffffffn,l=n>=0xffffffffn;n+=BigInt(46+r.o.length+(o&&8))+r.u,e+=BigInt(r.o.length+46+(12*l|28*o)),s||(s=o)}return(s||n>=0xffffffffn)&&(e+=BigInt(76)),e+n}(function*(i){for(const e of i)yield A(...P(e)[0])}(t)),"S");function Z(t,i={}){const e={"Content-Type":"application/zip","Content-Disposition":"attachment"};return(typeof i.length=="bigint"||Number.isInteger(i.length))&&i.length>0&&(e["Content-Length"]=String(i.length)),i.metadata&&(e["Content-Length"]=String(Q(i.metadata))),new Response(J(t,i),{headers:e})}a(Z,"A");function J(t,i={}){const e=function(n){var r;const s=n[Symbol.iterator in n?Symbol.iterator:Symbol.asyncIterator]();return{async next(){const o=await s.next();if(o.done)return o;const[l,g]=P(o.value);return{done:0,value:Object.assign(N(...g),A(...l))}},throw:(r=s.throw)==null?void 0:r.bind(s),[Symbol.asyncIterator](){return this}}}(t);return L(async function*(n,s){const r=[];let o=0n,l=0n,g=0;for await(const u of n){const q=k(u,s.buffersAreUTF8);yield V(u,q),yield new Uint8Array(u.o),u.isFile&&(yield*_(u));const b=u.u>=0xffffffffn,F=12*(o>=0xffffffffn)|28*b;yield H(u,b),r.push(G(u,o,q,F)),r.push(u.o),F&&r.push(Y(u,o,F)),b&&(o+=8n),l++,o+=BigInt(46+u.o.length)+u.u,g||(g=b)}let m=0n;for(const u of r)yield u,m+=BigInt(u.length);if(g||o>=0xffffffffn){const u=v(76);u.setUint32(0,1347094022),u.setBigUint64(4,BigInt(44),1),u.setUint32(12,755182848),u.setBigUint64(24,l,1),u.setBigUint64(32,l,1),u.setBigUint64(40,m,1),u.setBigUint64(48,o,1),u.setUint32(56,1347094023),u.setBigUint64(64,o+m,1),u.setUint32(72,1,1),yield d(u)}const p=v(22);p.setUint32(0,1347093766),p.setUint16(8,D(l),1),p.setUint16(10,D(l),1),p.setUint32(12,U(m),1),p.setUint32(16,U(o),1),yield d(p)}(e,i),e)}a(J,"N");const K={recordFps:30,syncFps:!1,type:"png",quality:.92},{Utils:{Time:W,Image:O,Browser:X,Device:tt}}=T,S=class S extends w.Plugins.BasePlugin{constructor(){super(...arguments);f(this,"options");f(this,"panelControl",null);f(this,"canvas",null);f(this,"capturing");f(this,"requestCount",0);f(this,"requestFinishCount",0);f(this,"lastCaptureTime",0);f(this,"realStartTime",0);f(this,"countVideoTime",0);f(this,"imageList");f(this,"processCapture",a(async()=>{if(!this.isCapturing())return;const e=performance.now();if(await this.waitNextFrame(!0),!this.isCapturing())return;await this.handleCapture(),this.lastCaptureTime=performance.now();const n=e-this.lastCaptureTime;if(!this.options.syncFps){const s=1e3/this.options.recordFps;s>n&&await W.sleepAsync(s-n)}this.countVideoTime+=n,this.updateRecordInfo(),this.processCapture()},"processCapture"));f(this,"handleCapture",a(async()=>{try{this.requestCount++;const e=await this.snapshotCanvas();if(!e)throw new Error("Image data is null");this.addImageDataToList(this.requestCount,e),this.requestFinishCount++}catch(e){console.error("handleCapture",e),await this.stopCaptureAsync()}},"handleCapture"));f(this,"addImageDataToList",a((e,n)=>{const s=this.getPaddingName(e);this.imageList.push({name:`${s}.${this.options.type}`,input:n})},"addImageDataToList"))}init(){this.imageList=[],this.options={...K}}configure(e){this.options={...this.options,...e},typeof y=="function"&&(this.panelControl=new y(this,this.options))}setCanvas(e){this.canvas=e}getCanvas(){return this.canvas}runTestCanvas(){if(!y)return;const e=this.createCanvas(200,300);e&&(e.style.position="absolute",document.body.appendChild(e),y(e),this.setCanvas(e))}setPanelExpanded(e){var n;(n=this.panelControl)==null||n.setPanelExpanded(e)}getOptions(){return this.options}isCapturing(){return this.capturing}initCaptureState(){this.imageList=[],this.capturing=!1,this.requestCount=0,this.requestFinishCount=0,this.countVideoTime=0,this.realStartTime=performance.now()}setStateInputPanel(e){this.panelControl&&(e?this.panelControl.unblockInputPanel():this.panelControl.blockInputPanel())}async startCaptureAsync(){if(!this.isCapturing()){if(!this.canvas){console.warn("Canvas is not set");return}this.initCaptureState(),this.setStateInputPanel(!1),this.capturing=!0,this.processCapture()}}waitNextFrame(e=!1){return new Promise((n,s)=>{!e&&!this.isCapturing()&&s(new Error("CanvasRecorder is not capturing")),requestAnimationFrame(()=>{n()})})}updateRecordInfo(){if(!this.panelControl)return;const e=this.formatDateHMS(this.countVideoTime),n=this.formatDateHMS(performance.now()-this.realStartTime);this.panelControl.updateRecordInfo(e,n)}snapshotCanvas(e){return new Promise((n,s)=>{if(!this.canvas){s(new Error("Canvas is not set"));return}const{type:r,quality:o}=this.options,{type:l=r,quality:g=o,resolution:m=1}=e||{};this.canvas.toBlob(p=>{if(!p){s(new Error("Blob is null"));return}m!==1?this.resizeBlob(p,l,m).then(n).catch(s):n(p)},`image/${l}`,g)})}async resizeBlob(e,n,s){const r=await O.blobToHtmlImage(e,!0,!1);if(!r)throw new Error("Can not convert blob to image");const o=s/tt.pixelRatio();r.width*=o,r.height*=o;const l=await O.elementToBlob(r,n);if(URL.revokeObjectURL(r.src),!l)throw new Error("Can not convert image to blob");return l}async stopCaptureAsync(){return this.capturing=!1,new Promise(e=>{const n=setInterval(()=>{this.requestCount===this.requestFinishCount&&(clearInterval(n),this.setStateInputPanel(!0),e())},500)})}async snapshotFrameAsync(e){try{if(!this.canvas)return console.warn("Canvas is not set"),null;const{force:n=!1}=e||{};await this.waitNextFrame(n);const s=await this.snapshotCanvas(e);if(!s)throw new Error("Image data is null");return s}catch(n){return console.error("snapshotFrame",n),null}}downloadImage(e){const n=document.createElement("a"),s=`screenshot-${this.getDateFilename()}`;n.download=s,n.href=URL.createObjectURL(e);const r=`image/${this.options.type}`;n.dataset.downloadurl=[r,n.download,n.href].join(":"),n.click(),URL.revokeObjectURL(n.href),n.remove()}async downloadImagesAsync(){try{if(this.isCapturing())return;this.setStateInputPanel(!1);const e=document.createElement("a"),n=`images-${this.getDateFilename()}`;e.download=n;const s=await Z(this.imageList).blob();e.href=URL.createObjectURL(s),e.click(),URL.revokeObjectURL(e.href),e.remove()}catch(e){console.error("downloadZipImages",e)}}getRecordImages(){return this.imageList.map(e=>e.input)}createCanvas(e,n){const s=X.createCanvas({type:"canvas"});return s?(s.canvas.width=e,s.canvas.height=n,s.canvas):(console.warn("Can not create canvas"),null)}getPaddingName(e){const n=e.toString().length,s=5;let r="";for(let o=0;o<s-n;o++)r+="0";return r+e.toString()}getDateFilename(){const e=new Date;return`${e.toLocaleTimeString()}-${e.toLocaleDateString()}`}formatDateHMS(e,n=!1){const s=new Date(e).toISOString();return n?s.slice(11,-5):s.slice(14,-5)}};a(S,"CanvasRecorderPlugin");let I=S;c("i",Object.freeze(Object.defineProperty({__proto__:null,default:I},Symbol.toStringTag,{value:"Module"})))},"execute")}});
