var K=Object.defineProperty;var W=(f,g,y)=>g in f?K(f,g,{enumerable:!0,configurable:!0,writable:!0,value:y}):f[g]=y;var l=(f,g,y)=>W(f,typeof g!="symbol"?g+"":g,y);System.register(["./core.js"],function(f,g){"use strict";var y,I;return{setters:[m=>{y=m.P,I=m.G}],execute:function(){const m=f("d",{});f("e",Object.freeze(Object.defineProperty({__proto__:null,default:m},Symbol.toStringTag,{value:"Module"}))),"stream"in Blob.prototype||Object.defineProperty(Blob.prototype,"stream",{value(){return new Response(this).body}}),"setBigUint64"in DataView.prototype||Object.defineProperty(DataView.prototype,"setBigUint64",{value(t,i,e){const n=Number(0xffffffffn&i),s=Number(i>>32n);this.setUint32(t+(e?0:4),n,e),this.setUint32(t+(e?4:0),s,e)}});var v=t=>new DataView(new ArrayBuffer(t)),h=t=>new Uint8Array(t.buffer||t),U=t=>new TextEncoder().encode(String(t)),w=t=>Math.min(4294967295,Number(t)),S=t=>Math.min(65535,Number(t));function E(t,i){if(i===void 0||i instanceof Date||(i=new Date(i)),t instanceof File)return{isFile:1,t:i||new Date(t.lastModified),i:t.stream()};if(t instanceof Response)return{isFile:1,t:i||new Date(t.headers.get("Last-Modified")||Date.now()),i:t.body};if(i===void 0)i=new Date;else if(isNaN(i))throw new Error("Invalid modification date.");if(t===void 0)return{isFile:0,t:i};if(typeof t=="string")return{isFile:1,t:i,i:U(t)};if(t instanceof Blob)return{isFile:1,t:i,i:t.stream()};if(t instanceof Uint8Array||t instanceof ReadableStream)return{isFile:1,t:i,i:t};if(t instanceof ArrayBuffer||ArrayBuffer.isView(t))return{isFile:1,t:i,i:h(t)};if(Symbol.asyncIterator in t)return{isFile:1,t:i,i:F(t[Symbol.asyncIterator]())};throw new TypeError("Unsupported input format.")}function F(t,i=t){return new ReadableStream({async pull(e){let n=0;for(;e.desiredSize>n;){const s=await t.next();if(!s.value){e.close();break}{const r=O(s.value);e.enqueue(r),n+=r.byteLength}}},cancel(e){var n;(n=i.throw)==null||n.call(i,e)}})}function O(t){return typeof t=="string"?U(t):t instanceof Uint8Array?t:h(t)}function T(t,i,e){let[n,s]=function(r){return r?r instanceof Uint8Array?[r,1]:ArrayBuffer.isView(r)||r instanceof ArrayBuffer?[h(r),1]:[U(r),0]:[void 0,0]}(i);if(t instanceof File)return{o:b(n||U(t.name)),u:BigInt(t.size),l:s};if(t instanceof Response){const r=t.headers.get("content-disposition"),a=r&&r.match(/;\s*filename\*?=["']?(.*?)["']?$/i),u=a&&a[1]||t.url&&new URL(t.url).pathname.split("/").findLast(Boolean),p=u&&decodeURIComponent(u),d=e||+t.headers.get("content-length");return{o:b(n||U(p)),u:BigInt(d),l:s}}return n=b(n,t!==void 0||e!==void 0),typeof t=="string"?{o:n,u:BigInt(U(t).length),l:s}:t instanceof Blob?{o:n,u:BigInt(t.size),l:s}:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?{o:n,u:BigInt(t.byteLength),l:s}:{o:n,u:q(t,e),l:s}}function q(t,i){return i>-1?BigInt(i):t?void 0:0n}function b(t,i=1){if(!t||t.every(e=>e===47))throw new Error("The file must have a name.");if(i)for(;t[t.length-1]===47;)t=t.subarray(0,-1);else t[t.length-1]!==47&&(t=new Uint8Array([...t,47]));return t}var D=new Uint32Array(256);for(let t=0;t<256;++t){let i=t;for(let e=0;e<8;++e)i=i>>>1^(1&i&&3988292384);D[t]=i}function L(t,i=0){i^=-1;for(var e=0,n=t.length;e<n;e++)i=i>>>8^D[255&i^t[e]];return(-1^i)>>>0}function R(t,i,e=0){const n=t.getSeconds()>>1|t.getMinutes()<<5|t.getHours()<<11,s=t.getDate()|t.getMonth()+1<<5|t.getFullYear()-1980<<9;i.setUint16(e,n,1),i.setUint16(e+2,s,1)}function M({o:t,l:i},e){return 8*(!i||(e??function(n){try{N.decode(n)}catch{return 0}return 1}(t)))}var N=new TextDecoder("utf8",{fatal:1});function j(t,i=0){const e=v(30);return e.setUint32(0,1347093252),e.setUint32(4,754976768|i),R(t.t,e,10),e.setUint16(26,t.o.length,1),h(e)}async function*$(t){let{i}=t;if("then"in i&&(i=await i),i instanceof Uint8Array)yield i,t.m=L(i,0),t.u=BigInt(i.length);else{t.u=0n;const e=i.getReader();for(;;){const{value:n,done:s}=await e.read();if(s)break;t.m=L(n,t.m),t.u+=BigInt(n.length),yield n}}}function k(t,i){const e=v(16+(i?8:0));return e.setUint32(0,1347094280),e.setUint32(4,t.isFile?t.m:0,1),i?(e.setBigUint64(8,t.u,1),e.setBigUint64(16,t.u,1)):(e.setUint32(8,w(t.u),1),e.setUint32(12,w(t.u),1)),h(e)}function z(t,i,e=0,n=0){const s=v(46);return s.setUint32(0,1347092738),s.setUint32(4,755182848),s.setUint16(8,2048|e),R(t.t,s,12),s.setUint32(16,t.isFile?t.m:0,1),s.setUint32(20,w(t.u),1),s.setUint32(24,w(t.u),1),s.setUint16(28,t.o.length,1),s.setUint16(30,n,1),s.setUint16(40,t.isFile?33204:16893,1),s.setUint32(42,w(i),1),h(s)}function V(t,i,e){const n=v(e);return n.setUint16(0,1,1),n.setUint16(2,e-4,1),16&e&&(n.setBigUint64(4,t.u,1),n.setBigUint64(12,t.u,1)),n.setBigUint64(e-8,i,1),h(n)}function A(t){return t instanceof File||t instanceof Response?[[t],[t]]:[[t.input,t.name,t.size],[t.input,t.lastModified]]}var _=t=>function(i){let e=BigInt(22),n=0n,s=0;for(const r of i){if(!r.o)throw new Error("Every file must have a non-empty name.");if(r.u===void 0)throw new Error(`Missing size for file "${new TextDecoder().decode(r.o)}".`);const a=r.u>=0xffffffffn,u=n>=0xffffffffn;n+=BigInt(46+r.o.length+(a&&8))+r.u,e+=BigInt(r.o.length+46+(12*u|28*a)),s||(s=a)}return(s||n>=0xffffffffn)&&(e+=BigInt(76)),e+n}(function*(i){for(const e of i)yield T(...A(e)[0])}(t));function H(t,i={}){const e={"Content-Type":"application/zip","Content-Disposition":"attachment"};return(typeof i.length=="bigint"||Number.isInteger(i.length))&&i.length>0&&(e["Content-Length"]=String(i.length)),i.metadata&&(e["Content-Length"]=String(_(i.metadata))),new Response(G(t,i),{headers:e})}function G(t,i={}){const e=function(n){var r;const s=n[Symbol.iterator in n?Symbol.iterator:Symbol.asyncIterator]();return{async next(){const a=await s.next();if(a.done)return a;const[u,p]=A(a.value);return{done:0,value:Object.assign(E(...p),T(...u))}},throw:(r=s.throw)==null?void 0:r.bind(s),[Symbol.asyncIterator](){return this}}}(t);return F(async function*(n,s){const r=[];let a=0n,u=0n,p=0;for await(const o of n){const x=M(o,s.buffersAreUTF8);yield j(o,x),yield new Uint8Array(o.o),o.isFile&&(yield*$(o));const C=o.u>=0xffffffffn,B=12*(a>=0xffffffffn)|28*C;yield k(o,C),r.push(z(o,a,x,B)),r.push(o.o),B&&r.push(V(o,a,B)),C&&(a+=8n),u++,a+=BigInt(46+o.o.length)+o.u,p||(p=C)}let d=0n;for(const o of r)yield o,d+=BigInt(o.length);if(p||a>=0xffffffffn){const o=v(76);o.setUint32(0,1347094022),o.setBigUint64(4,BigInt(44),1),o.setUint32(12,755182848),o.setBigUint64(24,u,1),o.setBigUint64(32,u,1),o.setBigUint64(40,d,1),o.setBigUint64(48,a,1),o.setUint32(56,1347094023),o.setBigUint64(64,a+d,1),o.setUint32(72,1,1),yield h(o)}const c=v(22);c.setUint32(0,1347093766),c.setUint16(8,S(u),1),c.setUint16(10,S(u),1),c.setUint32(12,w(d),1),c.setUint32(16,w(a),1),yield h(c)}(e,i),e)}const Y={recordFps:30,syncFps:!1,type:"png",quality:.92},{Utils:{Time:Q,Image:P,Browser:Z}}=I;class J extends y.Plugins.BasePlugin{constructor(){super(...arguments);l(this,"options");l(this,"panelControl",null);l(this,"canvas",null);l(this,"capturing");l(this,"requestCount",0);l(this,"requestFinishCount",0);l(this,"lastCaptureTime",0);l(this,"realStartTime",0);l(this,"countVideoTime",0);l(this,"imageList");l(this,"processCapture",async()=>{if(!this.isCapturing())return;const e=performance.now();if(await this.waitNextFrame(!0),!this.isCapturing())return;await this.handleCapture(),this.lastCaptureTime=performance.now();const n=e-this.lastCaptureTime;if(!this.options.syncFps){const s=1e3/this.options.recordFps;s>n&&await Q.sleepAsync(s-n)}this.countVideoTime+=n,this.updateRecordInfo(),this.processCapture()});l(this,"handleCapture",async()=>{try{this.requestCount++;const e=await this.snapshotCanvas();if(!e)throw new Error("Image data is null");this.addImageDataToList(this.requestCount,e),this.requestFinishCount++}catch(e){console.error("handleCapture",e),await this.stopCaptureAsync()}});l(this,"addImageDataToList",(e,n)=>{const s=this.getPaddingName(e);this.imageList.push({name:`${s}.${this.options.type}`,input:n})})}init(){this.imageList=[],this.options={...Y}}configure(e){this.options={...this.options,...e},typeof m=="function"&&(this.panelControl=new m(this,this.options))}setCanvas(e){this.canvas=e}getCanvas(){return this.canvas}runTestCanvas(){if(!m)return;const e=this.createCanvas(200,300);e&&(e.style.position="absolute",document.body.appendChild(e),m(e),this.setCanvas(e))}setPanelExpanded(e){var n;(n=this.panelControl)==null||n.setPanelExpanded(e)}getOptions(){return this.options}isCapturing(){return this.capturing}initCaptureState(){this.imageList=[],this.capturing=!1,this.requestCount=0,this.requestFinishCount=0,this.countVideoTime=0,this.realStartTime=performance.now()}setStateInputPanel(e){this.panelControl&&(e?this.panelControl.unblockInputPanel():this.panelControl.blockInputPanel())}async startCaptureAsync(){if(!this.isCapturing()){if(!this.canvas){console.warn("Canvas is not set");return}this.initCaptureState(),this.setStateInputPanel(!1),this.capturing=!0,this.processCapture()}}waitNextFrame(e=!1){return new Promise((n,s)=>{!e&&!this.isCapturing()&&s(new Error("CanvasRecorder is not capturing")),requestAnimationFrame(()=>{n()})})}updateRecordInfo(){if(!this.panelControl)return;const e=this.formatDateHMS(this.countVideoTime),n=this.formatDateHMS(performance.now()-this.realStartTime);this.panelControl.updateRecordInfo(e,n)}snapshotCanvas(e){return new Promise((n,s)=>{if(!this.canvas){s(new Error("Canvas is not set"));return}const{type:r,quality:a}=this.options,{type:u=r,quality:p=a,resolution:d=1}=e||{};this.canvas.toBlob(c=>{if(!c){s(new Error("Blob is null"));return}d!==1?this.resizeBlob(c,u,d).then(n).catch(s):n(c)},`image/${u}`,p)})}async resizeBlob(e,n,s){const r=await P.blobToHtmlImage(e,!0,!1);if(!r)throw new Error("Can not convert blob to image");const a=s/window.devicePixelRatio;r.width*=a,r.height*=a;const u=await P.elementToBlob(r,n);if(URL.revokeObjectURL(r.src),!u)throw new Error("Can not convert image to blob");return u}async stopCaptureAsync(){return this.capturing=!1,new Promise(e=>{const n=setInterval(()=>{this.requestCount===this.requestFinishCount&&(clearInterval(n),this.setStateInputPanel(!0),e())},500)})}async snapshotFrameAsync(e){try{if(!this.canvas)return console.warn("Canvas is not set"),null;const{force:n=!1}=e||{};await this.waitNextFrame(n);const s=await this.snapshotCanvas(e);if(!s)throw new Error("Image data is null");return s}catch(n){return console.error("snapshotFrame",n),null}}downloadImage(e){const n=document.createElement("a"),s=`screenshot-${this.getDateFilename()}`;n.download=s,n.href=URL.createObjectURL(e);const r=`image/${this.options.type}`;n.dataset.downloadurl=[r,n.download,n.href].join(":"),n.click(),URL.revokeObjectURL(n.href),n.remove()}async downloadImagesAsync(){try{if(this.isCapturing())return;this.setStateInputPanel(!1);const e=document.createElement("a"),n=`images-${this.getDateFilename()}`;e.download=n;const s=await H(this.imageList).blob();e.href=URL.createObjectURL(s),e.click(),URL.revokeObjectURL(e.href),e.remove()}catch(e){console.error("downloadZipImages",e)}}getRecordImages(){return this.imageList.map(e=>e.input)}createCanvas(e,n){const s=Z.createCanvas({type:"canvas"});return s?(s.canvas.width=e,s.canvas.height=n,s.canvas):(console.warn("Can not create canvas"),null)}getPaddingName(e){const n=e.toString().length,s=5;let r="";for(let a=0;a<s-n;a++)r+="0";return r+e.toString()}getDateFilename(){const e=new Date;return`${e.toLocaleTimeString()}-${e.toLocaleDateString()}`}formatDateHMS(e,n=!1){const s=new Date(e).toISOString();return n?s.slice(11,-5):s.slice(14,-5)}}f("i",Object.freeze(Object.defineProperty({__proto__:null,default:J},Symbol.toStringTag,{value:"Module"})))}}});
