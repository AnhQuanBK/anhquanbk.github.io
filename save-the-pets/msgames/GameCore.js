var Ko=Object.defineProperty;var th=(J,v,p)=>v in J?Ko(J,v,{enumerable:!0,configurable:!0,writable:!0,value:p}):J[v]=p;var c=(J,v)=>Ko(J,"name",{value:v,configurable:!0});var u=(J,v,p)=>th(J,typeof v!="symbol"?v+"":v,p);System.register(["./bundle/core.js","./bundle/__commonjsHelpers__.js","./bundle/canvas-recorder.js"],function(J,v){"use strict";var p,L,kr,oe,G,ce,Vr,Qt;return{setters:[O=>{p=O.G,L=O.P,kr=O.M,oe=O._,G=O.a,ce=O.C},O=>{Vr=O.g},O=>{Qt=O.d}],execute:c(function(){var ke,Ve,Ue;const{Valid:O,Object:me,String:Xt,Json:Ur}=p.Utils,Be="is invalid",Y=class Y{static addDefaultData(t){O.isObject(t)||this.prototype.exception("default data",Be),t=Ur.clone(t);const{name:e}=this;O.isObject(Y.data[e])||(Y.data[e]={}),Y.data[e]=me.merge(Y.data[e],t),console.debug(`${e} default data:`,Y.data[e])}static getDefaultData(){const{name:t}=this;return Ur.clone(Y.data[t])}static addValidateFunction(t,e){O.isString(t)||this.prototype.exception("validate key",Be),typeof e!="function"&&this.prototype.exception("validate function",Be);const s=`validate${Xt.capitalize(t)}`;me.assign(this.prototype,{[s]:e})}constructor(t){this.defaultData(),this.processData(t)}processData(t){this.validateStructure(t),this.validateData(t),this.setupData(t)}defaultData(){const{name:t}=this.constructor;this.lazyDefaultData(Y.data[t])}lazyDefaultData(t){O.isObject(t)||this.exception("data",Be);for(const e in t)if(me.hasOwn(t,e)){const s=t[e];me.assign(this,{[e]:s})}}lazyValidateStructure(t){O.isObject(t)||this.exception("structure","is not object");const e=this.getKeys();for(const s of e){const n=this[s];n===void 0&&this.exception("structure",`has no key ${s}`),!me.hasOwn(t,s)&&n!==void 0&&this.setDefaultData(s,t)}}setDefaultData(t,e){O.isObject(e)||this.exception("data",Be);const s=this[t];s===void 0&&this.exception("default",`has no key ${t}`),me.assign(e,{[t]:s})}lazyValidateData(t){const e=this.getKeys();for(const s of e){const n=t[s],a=Xt.removeDiacritics(s).replace(/[^a-zA-Z0-9]/g,""),i=`validate${Xt.capitalize(a)}`,r=this[i];if(typeof r=="function")try{r.call(this,n)}catch(o){console.warn(o),this.setDefaultData(s,t)}else this.exception("validate",`has no function ${i}`)}}lazySetupData(t){const e=this.getKeys();for(const s of e){const n=t[s];me.assign(this,{[s]:n})}}validate(){this.validateData(this.toObject())}exception(t,e){throw new Error(`${this.constructor.name}: ${t} ${e}`)}toObject(){return Object.fromEntries(Object.entries(this).filter(([t])=>t!=="toObject"))}getKeys(){return Object.keys(this).filter(t=>t!=="toObject")}};c(Y,"BaseDtos"),u(Y,"data",{});let F=Y;p.Dtos={Base:F};const Ho={score:"score",endlessScore:"endlessScore",settings:"settings",gameData:"gameData",remoteConfig:"remoteConfig",isFirstLogin:"isFirstLogin",dailyRewarded:"dailyRewarded",notificationData:"notificationData"},le={ASID:null,playerId:"0000",name:"Guest",photo:"",locale:"en_US",connectedPlayers:{},data:{dailyRewarded:{logDays:[],lastRewarded:0},score:0,endlessScore:0,settings:{sound:!0,music:!0,vibrate:!0,language:"en"},gameData:{coins:0,level:1},isFirstLogin:!0,notificationData:{D1:{arrivalDate:0},D2:{arrivalDate:0},D3:{arrivalDate:0},D4:{arrivalDate:0},D5:{arrivalDate:0},D6:{arrivalDate:0},D7:{arrivalDate:0}}}},{Valid:je}=p.Utils,{playerId:qo,name:zo,photo:Yo,locale:Qo}=le,We="is invalid",ea=class ea extends F{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateId(t){(!je.isString(t)||!t)&&this.exception("_id",We)}validatePlayerId(t){(!je.isString(t)||!t)&&this.exception("playerId",We)}validateName(t){(!je.isString(t)||!t)&&this.exception("name",We)}validatePhoto(t){je.isString(t)||this.exception("photo",We)}validateLocale(t){(!je.isString(t)||!t)&&this.exception("locale",We)}toObject(){return super.toObject()}};c(ea,"PlayerInfoDtos");let Ne=ea;Ne.addDefaultData({playerId:qo,name:zo,photo:Yo,locale:Qo});const Z=new Ne({playerId:"10",name:"Your Friend"}).toObject(),ta=class ta extends Error{constructor(e){super(e);u(this,"code");this.code="CREATE_MATCH_FAILED"}};c(ta,"ACreateMatchFailed");let q=ta;const sa=class sa extends q{constructor(t){super(t),this.name="PlayerIdNotValid",this.message=t??"Player id is not valid"}};c(sa,"PlayerIdNotValid");let E=sa;const{Dtos:Jt,Utils:{Array:Xo,Object:Jo,Json:Zt,Valid:Br},Events:Zo}=p,na=class na{constructor(t){u(this,"game");u(this,"initContext",c(()=>{const t={contextId:GameSDK.context.getID()??"",contextType:GameSDK.context.getType(),entryPointData:GameSDK.getEntryPointData()},e=new Jt.Context.Info(t),{contextId:s,contextType:n,entryPointData:a}=e.toObject();this.game.context.receiveContext(s,n,a)},"initContext"));u(this,"initPlayer",c(async()=>{const{player:t}=this.game,e=this.getPlayerInfo();console.info("playerInfo",Zt.clone(e));const s=Xo.unique(Jo.vals(Ho));console.debug("dataKeys",s);const n=await GameSDK.player.getDataAsync(s);console.debug("rawData",Zt.clone(n));const a=new Jt.Player.Data(n).toObject();console.info("playerData",Zt.clone(a)),t.receiveData(e,a),this.game.event.emit(Zo.PLAYER_INFO_LOADED)},"initPlayer"));u(this,"getPlayerInfo",c(()=>{try{const t=GameSDK.player.getID();let e=GameSDK.player.getName();const s=GameSDK.player.getPhoto(),n=GameSDK.getLocale();if(!Br.isString(t))throw new E;return Br.isString(e)||(e="You"),new Jt.Player.Info({playerId:t,name:e,photo:s,locale:n}).toObject()}catch{return Z}},"getPlayerInfo"));this.game=t}};c(na,"StateInitiator");let es=na;const aa=class aa extends Error{constructor(e,s){super(e);u(this,"payload");this.name="BadRequest",this.message=e??"This request is bad",this.payload=s}};c(aa,"BadRequest");let Ke=aa;const ia=class ia extends Error{constructor(e,s){super(e);u(this,"payload");this.name="RequestTimeout",this.message=e??"This request is timeout",this.payload=s}};c(ia,"RequestTimeout");let He=ia;const{Utils:ec,Configs:tc}=p,{AppId:jr,Network:ts}=tc,sc=c(f=>{if(!f.ok)throw new Ke(void 0,{response:f})},"validateResponse"),Wr=c(()=>{const f=window.game.auth.getToken();return{token:f,timeout:ts.Timeout,headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"}}},"defaultConfig"),Kr=c((f,t,e,s)=>async()=>{try{if(!jr)throw new Ke("AppId is not defined");const n=`${f}/apps/${jr}/${t}`,a=new AbortController;e.signal=a.signal;const i=setTimeout(()=>{a.abort()},e.timeout);p.Utils.Valid.isObject(s)&&(e.body=JSON.stringify(s));const r=await fetch(n,e);return clearTimeout(i),sc(r),await r.json()||{}}catch(n){if(n instanceof Ke)return null;throw n instanceof Object&&"name"in n&&n.name==="AbortError"?new He:n}},"requester"),ss=c(async(f,t)=>{try{return f()}catch(e){if(e instanceof He&&t>0)try{return await ec.Time.sleepAsync(600),await ss(f,t-1)}catch{return{}}return e instanceof He?{}:(console.warn("Request error",e),{})}},"handleRequest"),we=c(async(f,t,e,s=ts.Retries)=>{try{const n={...Wr(),...t,method:"GET"},a=Kr(e,f,n);return await ss(a,s)}catch(n){return console.warn("Get error",n),{}}},"get"),k=c(async(f,t,e,s,n=ts.Retries)=>{try{const a={...Wr(),...e,method:"POST"},i=Kr(s,f,a,t);return await ss(i,n)}catch(a){return console.warn("Post error",a),{}}},"post"),{Configs:{Notification:{ApiUrl:nc}},Utils:{Object:ac}}=p,ic=c(async f=>{if(!ac.hasOwn(f,"playerId"))throw new Error("Missing playerId");const{playerId:t}=f;await k(`players/${t}`,f,{},nc,10)},"updatePlayerProfileNotificationAsync");var Hr=(f=>(f.IDLE="idle",f.LOADING="loading",f.FILLED="filled",f.SHOWING="showing",f))(Hr||{});const qr=Hr;var zr=(f=>(f.BANNER="banner",f.INTERSTITIAL="interstitial",f.REWARDED_VIDEO="rewarded_video",f.REWARDED_INTERSTITIAL="rewarded_interstitial",f))(zr||{});const Q=zr;let ut=(ke=class extends Error{constructor(e,s){super(s);u(this,"code");this.code=e,this.message=s}},c(ke,"AdError"),ke);const ra=class ra{constructor(t,e){u(this,"type");u(this,"service");u(this,"placementId");u(this,"_status");this.type=t,this._status=qr.IDLE,this.placementId=e}setStatus(t){this._status!==t&&(this._status=t)}get status(){return this._status}exception(t){throw new ut("AD_INSTANCE_ERROR",t)}};c(ra,"BaseInstance");let ns=ra,Yr=(Ve=class extends ns{loadAsync(){this.exception("This method is not implemented")}showAsync(){this.exception("This method is not implemented")}hideAsync(){this.exception("Unsupported method")}},c(Ve,"AdInstance"),Ve);p.Plugins.Ads={Types:Q,Status:qr,AdError:ut,AdInstance:Yr};const{Array:pt,Object:Qr}=p.Utils,oa=class oa extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"enabled");u(this,"config");u(this,"lastCallAdShownTime");u(this,"isAdFullSizeShowed");u(this,"ads",{});u(this,"safeAreaBottom")}init(){this.lastCallAdShownTime={[Q.BANNER]:0,[Q.INTERSTITIAL]:0,[Q.REWARDED_VIDEO]:0,[Q.REWARDED_INTERSTITIAL]:0},this.isAdFullSizeShowed=!1,this.calculateSafeAreaBottom()}calculateSafeAreaBottom(){try{const e=getComputedStyle(document.documentElement).getPropertyValue("--sab");this.safeAreaBottom=parseInt(e,10),isNaN(this.safeAreaBottom)&&(this.safeAreaBottom=0)}catch{this.safeAreaBottom=0}}configure(e){this.config=e,this.enabled=this.config.Enabled}checkEnabled(){if(!this.enabled)throw new ut("ADS_NOT_ENABLED","Ads is't enabled")}isAdFullSizeShowing(){return this.isAdFullSizeShowed}setAdInstance(e,s,n){const a=`${e}-${s}`;if(this.ads[a]){console.warn(`AdsPlugin: Ad instance with placementId ${s} already exists`);return}this.ads[a]={type:e,placementId:s,interval:null,instance:new n(e,s)}}async loadAdAsync(e,s){this.checkEnabled(),await this.getAd(e,s).instance.loadAsync()}async showAdAsync(e,s){if(this.checkEnabled(),!this.canbeShowAd(e,s)){console.warn(`AdsPlugin: This ad ${e} is not ready to be shown`);return}const{event:n}=this.game,a=this.getAd(e,s);try{n.emit(p.Events.AD_SHOWING,{type:e,placementId:s}),this.isAdFullSizeShowed=!0,await a.instance.showAsync(),this.lastCallAdShownTime[e]=Date.now()/1e3}finally{n.emit(p.Events.AD_CLOSED,{type:e,placementId:s}),this.isAdFullSizeShowed=!1}}getAdStatus(e,s){return this.checkEnabled(),this.getAd(e,s).instance.status}getAd(e,s){let n=null;if(s?n=this.getAdByPlacementId(s,e):n=this.getPriorityAdByType(e),!n)throw new ut("AD_INSTANCE_NOT_INITIATED","The instance ads not yet initiated");return n}getAdsByType(e){return Qr.vals(this.ads).filter(s=>s.type===e)}getAdByPlacementId(e,s){const n=Qr.vals(this.ads),a=pt.search(n,i=>i.placementId===e&&(!s||i.type===s));return a||null}getPriorityAdByType(e){const s=this.getAdsByType(e);if(!s.length)return null;const n=pt.search(s,a=>a.type===e);return n||null}canbeShowAd(e,s){return this.canbeShowAdByTime(e,s)}canbeShowAdByTime(e,s){try{const n=Date.now()/1e3;let a;if(s)a=this.getCommonAdConfig(s);else{const h=this.getPriorityAdByType(e);if(!h)return!1;a=this.getCommonAdConfig(h.placementId)}const{SecondsBetweenAds:i,SecondsFirstTime:r}=a,o=n-this.lastCallAdShownTime[e],l=o>i,d=o>r;return console.debug("[AdsPlugin] canbeShowAdByTime",{type:e,now:n,lastShownTime:this.lastCallAdShownTime[e],period:o,adConfig:a,canbeShowByTime:l,canbeShowFirstTime:d}),this.lastCallAdShownTime[e]>0?l:d}catch(n){return console.warn(`Error while checking canbe show ${e} ad by time`,n),!1}}canbeShowBannerAd(e){try{const s=this.getBannerConfig(e),{Platform:n}=s;if(n==="ALL")return!0;const a=GameSDK.getPlatform();return a?a===n:!1}catch(s){return console.warn("Error while checking canbeShowBannerAd",s),!1}}async showBannerAdAsync(e,s=!0){this.checkEnabled();const n=this.getAd(Q.BANNER,e);if(!this.canbeShowBannerAd(n.placementId))throw new Error("Banner ad can not be shown");this.cleanBannerReloadTimer(n),s?await this.showBannerAdWithSchedule(n):await this.showBannerAdOnce(n)}async showBannerAdOnce(e){const{event:s}=this.game;if(this.isAdFullSizeShowing()){console.warn("Show banner ad skipped because ad full size is showing");return}try{await e.instance.showAsync(),s.emit(p.Events.AD_SHOWING,{type:Q.BANNER,placementId:e.placementId})}catch(n){const a=n instanceof Error?n:new Error("AdsPlugin.startShowBannerAdInterval: Failed to show banner ad");try{await e.instance.hideAsync()}catch(i){console.warn("AdsPlugin.startShowBannerAdInterval: Failed to call ad.instance.hideAsync after show banner ad failed",i)}s.emit(p.Events.AD_FAILED,{type:Q.BANNER,placementId:e.placementId,error:a})}}async showBannerAdWithSchedule(e){await this.showBannerAdOnce(e);const s=this.getBannerConfig(e.placementId),{SecondsReload:n}=s;if(n<=0){console.warn("Banner ad reload time is less than 0");return}const a=c(()=>this.showBannerAdWithSchedule(e),"cb");e.interval=setTimeout(a,n*1e3)}async hideBannerAdAsync(e){this.checkEnabled();const s=this.getAd(Q.BANNER,e);this.cleanBannerReloadTimer(s),await s.instance.hideAsync();const{event:n}=this.game;n.emit(p.Events.AD_CLOSED,{type:Q.BANNER,placementId:e})}cleanBannerReloadTimer(e){try{const{interval:s}=e;if(!s)return;clearInterval(s)}catch(s){console.warn("Error while cleaning banner reload timer",s)}}getCommonAdConfig(e){const s=[...this.config.InterstitialAdOptions,...this.config.RewardedVideoAdOptions,...this.config.RewardedInterstitialAdOptions],n=pt.search(s,a=>a.PlacementId===e);if(!n)throw new Error(`Ad config with placementId ${e} not found`);return n}getBannerConfig(e){const s=pt.search(this.config.BannerDisplayAdOptions,n=>n.PlacementId===e);if(!s)throw new Error(`Banner config with placementId ${e} not found`);return s}getBannerHeight(e,s,n=!0){this.checkEnabled();const a=this.getBannerConfig(e),i=GameSDK.getBannerHeight(a);return n?(this.safeAreaBottom<=0&&this.calculateSafeAreaBottom(),(i+this.safeAreaBottom)*s):i*s}getSafeAreaBottom(e){return this.safeAreaBottom<=0&&this.calculateSafeAreaBottom(),this.safeAreaBottom*e}};c(oa,"AdsPlugin");let as=oa;const m={APP_LAUNCH:"app_launch",APP_INITIALIZED:"app_initialized",ENGINE_READY:"engine_ready",LOAD_START:"load_start",LOAD_COMPLETE:"load_complete",APP_READY:"app_ready",PAGE_VIEW:"page_view",SCREEN_OPEN:"screen_open",BUTTON_CLICK:"button_click",TUTORIAL_BEGIN:"tutorial_begin",TUTORIAL_STEP:"tutorial_step",TUTORIAL_COMPLETE:"tutorial_complete",MATCH_START:"match_start",MATCH_RESCUE:"match_rescue",MATCH_END:"match_end",LEVEL_START:"level_start",LEVEL_RESCUE:"level_rescue",LEVEL_END:"level_end",USE_ITEM:"use_item",EARN_ITEM:"earn_item",GET_FREE_ITEM:"get_free_item",SHARE:"share",INVITE:"invite",MESSAGE:"message",SHORTCUT_CREATE:"shortcut_create",SHORTCUT_CREATE_POPUP:"shortcut_create_popup",BOT_SUBSCRIBE:"bot_subscribe",BOT_SUBSCRIBE_POPUP:"bot_subscribe_popup",AD_INIT:"ad_init",AD_LOAD:"ad_load",AD_LOAD_FAILED:"ad_load_failed",AD_SHOWING:"ad_showing",AD_SHOW:"ad_show",AD_SHOW_FAILED:"ad_show_failed",AD_REWARD:"ad_reward",NEW_USER:"new_user",RETURNING_USER:"returning_user",JOIN_GROUP:"join_group",TOURNAMENT_START:"tournament_start",TOURNAMENT_SHARE:"tournament_share",TOURNAMENT_CREATE:"tournament_create",TOURNAMENT_POST_SCORE:"tournament_post_score"},ca=class ca{constructor(){u(this,"history",[]);u(this,"missing",[]);u(this,"outOfOrder",[]);u(this,"completed",!1);u(this,"failed",!1);u(this,"warned",[]);u(this,"debug",!1)}addEvent(t,e){if(this.completed||this.failed){this.debugLog("Skip event:",t);return}this.history.push(t),this.validateAndUpdate(t)}validateAndUpdate(t){const e=this.validateFunnelState();if(e.hasFailed){this.failed=!0,this.logValidationError();return}e.hasWarnings&&this.handleWarnings(e.warnings),this.checkFunnelCompletion(t)}validateFunnelState(){const t={hasFailed:!1,hasWarnings:!1,warnings:[]},s=this.getCurrentSteps().filter(a=>a.required);for(let a=0;a<s.length;a++){const i=s[a],r=this.history.indexOf(i.name);if(r===-1)return this.missing=[i.name],t.hasFailed=!0,t;if(a>0){const o=s[a-1];if(this.history.indexOf(o.name)>r)return this.missing=[o.name],t.hasFailed=!0,t}}const n=this.validateDependencies();return n.length>0&&(t.hasWarnings=!0,t.warnings=n,this.outOfOrder=n),t}getCurrentSteps(){const t=this.history[this.history.length-1],e=this.funnelSteps.findIndex(s=>s.name===t);return this.funnelSteps.slice(0,e+1)}validateDependencies(){const t=[];return this.history.forEach((e,s)=>{var i;const n=this.funnelSteps.find(r=>r.name===e);if(!((i=n==null?void 0:n.dependencies)!=null&&i.length))return;const a=n.dependencies.find(r=>!this.history.includes(r)||this.history.indexOf(r)>s);a&&!this.warned.includes(e)&&(t.push({event:e,missingDependency:a}),this.warned.push(e))}),t}checkFunnelCompletion(t){const e=this.funnelSteps[this.funnelSteps.length-1];if(t!==e.name)return;this.funnelSteps.filter(n=>n.required).every(n=>this.history.includes(n.name))&&(this.completed=!0,this.logCompletion())}handleWarnings(t){for(const e of t)console.warn(`âš ï¸ [${this.constructor.name}] Event ${e.event} is out of order. Missing: ${e.missingDependency}`)}logValidationError(){const t=this.constructor.name;this.missing.length&&console.error(`âš ï¸ [${t}] Missing required: ${this.missing.join(", ")}`),console.debug(`â„¹ï¸ [${t}] History:`,this.history)}logCompletion(){const t=this.constructor.name;this.outOfOrder.length>0?console.warn(`âš ï¸ [${t}] Completed with out of order events:`,{history:this.history,outOfOrder:this.outOfOrder}):console.info(`ðŸŽ¯ [${t}] Completed`,{history:this.history})}debugLog(...t){this.debug&&console.debug(`ðŸ” [${this.constructor.name}]`,...t)}isFunnelCompleted(){return this.completed}isFunnelFailed(){return this.failed}getEventHistory(){return[...this.history]}getMissingEvents(){return[...this.missing]}getOutOfOrderEvents(){return[...this.outOfOrder]}};c(ca,"BaseFunnel");let Le=ca;const la=class la extends Le{constructor(){super(...arguments);u(this,"debug",!1);u(this,"funnelSteps",[{name:m.AD_LOAD_FAILED,required:!1,payload:{service:this.service},description:"Platform ad load failed (trigger for adsense)"},{name:m.AD_LOAD,required:!0,payload:{service:"adsense"},description:"Start loading adsense ad"},{name:m.AD_LOAD_FAILED,required:!1,dependencies:[m.AD_LOAD],payload:{service:"adsense"},description:"Adsense ad load failed"},{name:m.AD_SHOWING,required:!0,dependencies:[m.AD_LOAD],payload:{service:"adsense"},description:"Adsense ad is showing"},{name:m.AD_SHOW,required:!1,dependencies:[m.AD_SHOWING],payload:{service:"adsense"},description:"Adsense ad shown successfully"},{name:m.AD_SHOW_FAILED,required:!1,dependencies:[m.AD_SHOWING],payload:{service:"adsense"},description:"Adsense ad show failed"},{name:m.AD_LOAD,required:!1,payload:{service:"adsense"},description:"Preload adsense ad"}])}get service(){return(GameSDK==null?void 0:GameSDK.getSDKName())??"GameCore"}addEvent(e,s){((s==null?void 0:s.service)==="adsense"||e===m.AD_LOAD_FAILED&&(s==null?void 0:s.service)==="platform")&&super.addEvent(e,s)}};c(la,"AdsenseFunnel");let is=la;const da=class da extends Le{constructor(){super(...arguments);u(this,"debug",!1);u(this,"funnelSteps",[{name:m.APP_LAUNCH,required:!0,description:"Application launched"},{name:m.APP_INITIALIZED,required:!0,dependencies:[m.APP_LAUNCH],description:"Application initialized"},{name:m.ENGINE_READY,required:!0,dependencies:[m.APP_INITIALIZED],description:"Game engine initialized"},{name:m.LOAD_START,required:!0,dependencies:[m.ENGINE_READY],description:"Start loading game assets"},{name:m.LOAD_COMPLETE,required:!0,dependencies:[m.LOAD_START],description:"Game assets loaded completely"},{name:m.APP_READY,required:!0,dependencies:[m.LOAD_COMPLETE],description:"Game is ready to play"}])}};c(da,"CorecosFunnel");let rs=da;const ha=class ha extends Le{constructor(){super(...arguments);u(this,"debug",!1);u(this,"funnelSteps",[{name:m.AD_LOAD,required:!0,payload:{service:this.service},description:"Start loading platform ad"},{name:m.AD_LOAD_FAILED,required:!1,dependencies:[m.AD_LOAD],payload:{service:this.service},description:"Platform ad load failed"},{name:m.AD_SHOWING,required:!0,dependencies:[m.AD_LOAD],payload:{service:this.service},description:"Platform ad is showing"},{name:m.AD_SHOW,required:!1,dependencies:[m.AD_SHOWING],payload:{service:this.service},description:"Platform ad shown successfully"},{name:m.AD_SHOW_FAILED,required:!1,dependencies:[m.AD_SHOWING],payload:{service:this.service},description:"Platform ad show failed"},{name:m.AD_LOAD,required:!1,payload:{service:this.service},description:"Preload platform ad"}])}get service(){return(GameSDK==null?void 0:GameSDK.getSDKName())??"GameCore"}addEvent(e,s){(s==null?void 0:s.service)===this.service&&super.addEvent(e,s)}};c(ha,"PlatformAdsFunnel");let os=ha;const{String:Ae,Valid:rc}=p.Utils;let oc=(Ue=class{constructor(t,e,s){u(this,"game");u(this,"name");u(this,"color");u(this,"options");u(this,"selfLog");u(this,"currentPath");this.game=t,this.name=e,this.options=s,this.color=s.color||"#FFF",this.selfLog=s.log,this.currentPath="/",console.info(`%c${this.name}: init`,`color: ${this.color}`,this.options)}event(t,e){this.logInfo("event",{name:t,payload:e});const s=this.formatEventName(t);this.processEvent(s,e)}logInfo(t,e){this.selfLog&&console.info(`%c${this.name}: ${t}`,`color: ${this.color}`,e)}pageview(t){let e=this.getPageTitle(t);e=this.addGameModeToPageTitle(e),document.title=e,this.event(m.PAGE_VIEW,{path_path:t,page_title:e})}levelStart(t,e,s){this.event(m.LEVEL_START,{level:t,score:e,level_name:this.getLevelName(t),game_mode:s?Ae.toUpperCamelCase(s):void 0})}levelFail(t,e,s){this.event(m.LEVEL_END,{level:t,score:e,success:!1,level_name:this.getLevelName(t),game_mode:s?Ae.toUpperCamelCase(s):void 0})}levelRescue(t,e,s){this.event(m.LEVEL_RESCUE,{level:t,score:e,level_name:this.getLevelName(t),game_mode:s?Ae.toUpperCamelCase(s):void 0})}levelComplete(t,e,s){this.event(m.LEVEL_END,{level:t,score:e,success:!0,level_name:this.getLevelName(t),game_mode:s?Ae.toUpperCamelCase(s):void 0})}initAdEvent(t){const{adService:e,state:s}=t;this.event(m.AD_INIT,{ad_service:e,state:s})}loadAdEvent(t){const{type:e,placement:s,service:n}=t;this.event(m.AD_LOAD,{ad_type:e,screen_name:s,ad_service:n})}showAdEvent(t){const{type:e,placement:s,service:n}=t;this.event(m.AD_SHOW,{ad_type:e,screen_name:s,ad_service:n})}loadInterstitialAd(t){const{placement:e,service:s}=t;this.loadAdEvent({type:"interstitial",placement:e,service:s})}showInterstitialAd(t){const{placement:e,service:s}=t;this.showAdEvent({type:"interstitial",placement:e,service:s})}loadRewardedVideoAd(t){const{placement:e,service:s}=t;this.loadAdEvent({type:"rewarded_video",placement:e,service:s})}showRewardedVideoAd(t){const{placement:e,service:s}=t;this.showAdEvent({type:"rewarded_video",placement:e,service:s})}receiveVideoReward(t){const{placement:e,service:s}=t;this.event(m.AD_REWARD,{screen_name:e,ad_service:s})}loadRewardedInterstitialAd(t){const{placement:e,service:s}=t;this.loadAdEvent({type:"rewarded_interstitial",placement:e,service:s})}showRewardedInterstitialAd(t){const{placement:e,service:s}=t;this.showAdEvent({type:"rewarded_interstitial",placement:e,service:s})}receiveInterstitialReward(t){const{placement:e,service:s}=t;this.event(m.AD_REWARD,{screen_name:e,ad_service:s})}loadAdFail(t){const{type:e,placement:s,service:n}=t;this.event(m.AD_LOAD_FAILED,{ad_type:e,screen_name:s,ad_service:n})}showAdFail(t){const{type:e,placement:s,service:n}=t;this.event(m.AD_SHOW_FAILED,{ad_type:e,screen_name:s,ad_service:n})}showingAd(t){const{type:e,placement:s,service:n}=t;this.event(m.AD_SHOWING,{ad_type:e,screen_name:s,ad_service:n})}formatEventName(t){return t.toLowerCase().replace(/:/g,"_")}getLevelName(t){return`Level ${Ae.padStart(t.toString(),5,"0")}`}getPageTitle(t){const e=t.split("/").pop();if(!rc.isString(e))return t;const s=e.replace(/([-_\s.])/g," $1");return Ae.toUpperCamelCase(s)}addGameModeToPageTitle(t){const{match:e}=this.game,s=e.getMatchState();let{mode:n}=s;return n||(n="Normal"),`${Ae.toUpperCamelCase(n)}::${t}`}},c(Ue,"BaseAnalytics"),Ue);p.Plugins.Analytics={Events:m,BaseFunnel:Le,BaseAnalytics:oc};const ua=class ua extends L.Plugins.BasePlugin{constructor(e){super(e);u(this,"analytics",[]);u(this,"placement","unknown");u(this,"funnels",[]);u(this,"pageview",c(e=>{if(!this.isActive())return;this.placement=e;const s=this.getPageByKey(e);for(const n of this.analytics)n.pageview(s);this.logFunnelEvent(m.PAGE_VIEW)},"pageview"));this.initFunnels()}add(e){this.analytics.some(n=>n.name===e.name)||this.analytics.push(e)}isActive(){return this.analytics.length>=1}initFunnels(){this.addFunnel(new rs),this.addFunnel(new is),this.addFunnel(new os)}addFunnel(e){this.funnels.push(e)}logFunnelEvent(e,s){for(const n of this.funnels)n.addEvent(e,s)}event(e,s){if(this.isActive()){for(const n of this.analytics)n.event(e,s);this.logFunnelEvent(e,s)}}levelStart(e,s,n){if(this.isActive()){for(const a of this.analytics)a.levelStart(e,s,n);this.logFunnelEvent(m.LEVEL_START,{score:s,mode:n})}}levelRescue(e,s,n){if(this.isActive()){for(const a of this.analytics)a.levelRescue(e,s,n);this.logFunnelEvent(m.LEVEL_RESCUE,{score:s,mode:n})}}levelFail(e,s,n){if(this.isActive()){for(const a of this.analytics)a.levelFail(e,s,n);this.logFunnelEvent(m.LEVEL_END,{score:s,mode:n})}}levelComplete(e,s,n){if(this.isActive()){for(const a of this.analytics)a.levelComplete(e,s,n);this.logFunnelEvent(m.LEVEL_END,{score:s,mode:n})}}initAdEvent(e){if(this.isActive())for(const s of this.analytics)s.initAdEvent(e)}loadInterstitialAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.loadInterstitialAd(s);this.logFunnelEvent(m.AD_LOAD,s)}showInterstitialAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.showInterstitialAd(s);this.logFunnelEvent(m.AD_SHOW,s)}loadRewardedVideoAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.loadRewardedVideoAd(s);this.logFunnelEvent(m.AD_LOAD,s)}showRewardedVideoAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.showRewardedVideoAd(s);this.logFunnelEvent(m.AD_SHOW,s)}receiveVideoReward(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.receiveVideoReward(s);this.logFunnelEvent(m.AD_REWARD,s)}loadRewardedInterstitialAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.loadRewardedInterstitialAd(s);this.logFunnelEvent(m.AD_LOAD,s)}showRewardedInterstitialAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.showRewardedInterstitialAd(s);this.logFunnelEvent(m.AD_SHOW,s)}receiveInterstitialReward(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.receiveInterstitialReward(s);this.logFunnelEvent(m.AD_REWARD,s)}loadAdFail(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.loadAdFail(s);this.logFunnelEvent(m.AD_LOAD_FAILED,s)}showAdFail(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.showAdFail(s);this.logFunnelEvent(m.AD_SHOW_FAILED,s)}showingAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const n of this.analytics)n.showingAd(s);this.logFunnelEvent(m.AD_SHOWING,s)}getPageByKey(e){let s=e;if(s.indexOf("_")>-1){let i=s.replace(/_/g,"-");return i=i.toLowerCase(),i}let n=s.length-1,a="";for(;n>0;){a=s.charAt(n);const i=isNaN(parseInt(a,10)),r=a===a.toUpperCase();i&&r&&(s=`${s.slice(0,n)}-${s.slice(n)}`),n--}return s.toLowerCase()}};c(ua,"AnalyticsPlugin");let cs=ua;const pa=class pa{constructor(t){u(this,"key");this.key=t}getKey(){return this.key}};c(pa,"BaseAudioPlayer");let ls=pa;var cc=Object.defineProperty,lc=Object.getOwnPropertyDescriptor,dc=c((f,t,e,s)=>{for(var n=s>1?void 0:s?lc(t,e):t,a=f.length-1,i;a>=0;a--)(i=f[a])&&(n=(s?i(t,e,n):i(n))||n);return s&&n&&cc(t,e,n),n},"__decorateClass$2");const{Decorator:Xr}=p.Utils,ya=class ya{constructor(t){u(this,"id");u(this,"isMuteAll");u(this,"masterVolume");u(this,"audioClips");this.id=t,this.masterVolume=1,this.isMuteAll=!1,this.audioClips={}}getId(){return this.id}getAudioClip(t){return this.audioClips[t]?this.audioClips[t]:null}setAudioClip(t,e){this.audioClips[t]={...this.audioClips[t],...e}}async play(t,e){const s=this.getAudioClip(t);if(s){const{audioPlayer:n}=s;this.playWithRealConfig(n,e)}else await this.loadAndPlay(t,e)}async loadAndPlay(t,e){const s=await this.onLoadAudio(t,e);if(!s)return;const{volume:n=1}=e||{};this.setAudioClip(t,{volume:n,audioPlayer:s}),this.playWithRealConfig(s,e)}playWithRealConfig(t,e){if(e){const{volume:s=1}=e;e.volume=this.masterVolume*s}t.play(e)}pause(t){const e=this.getAudioClip(t);if(!e)return!1;const{audioPlayer:s}=e;return s.pause(),!0}resume(t){const e=this.getAudioClip(t);if(!e)return!1;const{audioPlayer:s}=e;return s.resume(),!0}stop(t){const e=this.getAudioClip(t);if(!e)return!1;const{audioPlayer:s}=e;return s.stop(),!0}stopAll(){this.callAudioPlayers("stop")}muteAll(){this.isMuteAll||(this.isMuteAll=!0,this.callAudioPlayers("mute"))}unmuteAll(){this.isMuteAll&&(this.isMuteAll=!1,this.callAudioPlayers("unmute"))}setVolume(t){this.masterVolume=t,this.callAudioPlayers("setVolume")}getVolume(){return this.masterVolume}queueAudioPlayer(t,e){try{const{audioPlayer:s,volume:n=1}=t;switch(e){case"play":s.play();break;case"pause":s.pause();break;case"resume":s.resume();break;case"stop":s.stop();break;case"mute":s.setVolume(0);break;case"unmute":case"setVolume":s.setVolume(this.masterVolume*n);break;default:throw new Error(`Unsupported function: ${e}`)}}catch(s){console.warn("queueAudioPlayer",s)}}callAudioPlayers(t){const{Object:e}=p.Utils,s=e.vals(this.audioClips);for(const n of s)this.queueAudioPlayer(n,t)}};c(ya,"BaseChannelManager");let yt=ya;dc([Xr.tryCatch(),Xr.validateParams("string")],yt.prototype,"loadAndPlay",1);var hc=Object.defineProperty,uc=Object.getOwnPropertyDescriptor,pc=c((f,t,e,s)=>{for(var n=s>1?void 0:s?uc(t,e):t,a=f.length-1,i;a>=0;a--)(i=f[a])&&(n=(s?i(t,e,n):i(n))||n);return s&&n&&hc(t,e,n),n},"__decorateClass$1");p.Plugins.Audio={BaseAudioPlayer:ls,BaseChannelManager:yt};const{Decorator:Jr}=p.Utils,fa=class fa extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"firstChannelId");u(this,"channels",{})}addChannel(e){const s=e.getId();this.channels[s]=e,this.firstChannelId||(this.firstChannelId=s)}getChannel(e){if(e===void 0)return this.channels[this.firstChannelId];const s=this.channels[e];if(!s)throw new Error(`Channel ${e} not found`);return s}async play(e,s,n){await this.getChannel(n).play(e,s)}pause(e,s){try{this.getChannel(s).pause(e)}catch(n){console.warn("pauseSound",n)}}resume(e,s){try{this.getChannel(s).resume(e)}catch(n){console.warn("resumeSound",n)}}stop(e,s){try{this.getChannel(s).stop(e)}catch(n){console.warn("stopSound",n)}}stopAll(e){try{this.getChannel(e).stopAll()}catch(s){console.warn("stopAllSounds",s)}}mute(e){try{this.getChannel(e).muteAll()}catch(s){console.warn("mute",s)}}unmute(e){try{this.getChannel(e).unmuteAll()}catch(s){console.warn("unmute",s)}}setVolume(e,s){try{this.getChannel(s).setVolume(e)}catch(n){console.warn("setSoundVolume",n)}}getVolume(e){try{return this.getChannel(e).getVolume()}catch(s){return console.warn("getSoundVolume",s),-1}}};c(fa,"AudioPlugin");let ft=fa;pc([Jr.tryCatch(),Jr.validateParams("string")],ft.prototype,"play",1);const yc={token:"",isRequesting:!1},ga=class ga extends L.Plugins.BasePlugin{init(){const{storage:t}=this.game;t.addStorage("auth",yc)}async requestToken(){const{storage:t}=this.game;try{if(t.getStorageData("auth","isRequesting")||t.getStorageData("auth","token")!=="")return;t.setStorageData("auth","isRequesting",!0);const a=(await GameSDK.player.getSignedPlayerInfoAsync()).getSignature();t.setStorageData("auth","token",a)}catch(e){if(p.Utils.Object.hasOwn(e,"code")&&e.code==="PENDING_REQUEST")return;t.setStorageData("auth","token",""),console.error(e)}finally{t.setStorageData("auth","isRequesting",!1)}}getToken(){const{storage:t}=this.game;return t.getStorageData("auth","token")??""}};c(ga,"AuthPlugin");let ds=ga;var Zr=(f=>(f.SOLO="solo",f.TOURNAMENT="tournament",f.SHARE_INVITE="share_invite",f.MATCHING_GROUP="matching_group_match",f.CHALLENGE_FRIEND="challenge_friend_match",f))(Zr||{});const De=Zr,Ie=kr,{Configs:fc,Utils:{Array:gc,Valid:mc,Browser:wc}}=p,ma=class ma{constructor(t){u(this,"game");this.game=t}isValidContextType(t){return["THREAD","POST","SOLO","GROUP"].indexOf(t)>=0}isValidEntryPointData(t){return mc.isObject(t)}isTournamentEntryPoint(t){return gc.has(["facebook~game_list~tournaments","fb_feed_tournament_unit","messenger~bot_thread~tournaments"],t)}receiveContext(t,e,s){const{storage:n}=this.game;n.setStorageData("context","contextId",t),this.isValidEntryPointData(s)?n.setStorageData("context","entryPointData",s):console.warn(`Invalid context type: ${e}`),this.isValidContextType(e)?n.setStorageData("context","contextType",e):console.warn(`Invalid context type: ${e}`)}async detectContextSessionType(){const{storage:t}=this.game,e=t.getStorageData("context","entryPointData"),{type:s}=e??{},{SOLO:n,TOURNAMENT:a,MATCHING_GROUP:i,SHARE_INVITE:r,CHALLENGE_FRIEND:o}=De;let l=n;if(s===a&&(l=a),s===i&&(l=i),(s===o||s===r)&&(l=o),l===n)try{fc.Core.FastCheckTournamentContext?l=this.fastCheckTournamentContext()||l:l=await this.outdatedCheckTournamentContext()||l}catch{}t.setStorageData("context","sessionContextType",l)}fastCheckTournamentContext(){const e=wc.getQueryParams().entry_point;return typeof e!="string"||!this.isTournamentEntryPoint(e)?!1:De.TOURNAMENT}async outdatedCheckTournamentContext(){return"getTournamentAsync"in GameSDK&&(await GameSDK.getTournamentAsync()).getEndTime()>Date.now()/1e3?De.TOURNAMENT:!1}detectContextGameMode(){const{player:t,storage:e}=this.game,s=e.getStorageData("context","entryPointData"),n=e.getStorageData("context","sessionContextType"),a=t.getPlayerId(),{matchId:i,playerId:r,opponentId:o=Z.playerId}=s??{},l=a===r,h=o===Z.playerId||[o,r].indexOf(a)>=0,{TOURNAMENT:y,MATCHING_GROUP:g,SHARE_INVITE:A,CHALLENGE_FRIEND:I}=De;let w=Ie.SINGLE;n===y&&(w=Ie.TOURNAMENT),n===A&&!l&&(w=Ie.CHALLENGE_FRIEND),n===I&&i&&h&&(w=Ie.CHALLENGE_FRIEND),n===g&&(w=Ie.MATCHING_GROUP),e.setStorageData("context","contextGameMode",w)}};c(ma,"Context");let hs=ma;const wa=class wa extends Error{constructor(t){super(t),this.name="PlayerHasFinishedMatch",this.message=t??"Player has finished match"}};c(wa,"PlayerHasFinishedMatch");let gt=wa;const Aa=class Aa extends Error{constructor(t){super(t),this.name="PlayerNotJoinInMatch",this.message=t||"Player is not join in match"}};c(Aa,"PlayerNotJoinInMatch");let qe=Aa;const{Events:mt,Plugins:{Analytics:eo},Utils:{Valid:Ac}}=p,Da=class Da{constructor(t){u(this,"game");this.game=t}async processContextData(){const{player:t,storage:e,monitorError:s}=this.game,n=e.getStorageData("context","contextId")??"",a=e.getStorageData("context","entryPointData")??{},i=e.getStorageData("context","sessionContextType")??"",{type:r,matchId:o,playerId:l,opponentId:d,playerScore:h,action:y}=a;y&&await this.processEntryPointAction(y);const g=t.isFirstLogin();setTimeout(()=>{this.logUserAnalytics(g)},1e3);const{TOURNAMENT:A,SHARE_INVITE:I,MATCHING_GROUP:w,CHALLENGE_FRIEND:T}=De;if(i===A)try{await this.processTournamentModeAsync(n);return}catch{s==null||s.sendException(new Error("Process Tournament Fail"),{contextId:n,isFirstLogin:g,entryPointData:a,playerData:t.getPlayerData()})}if(i===T){if(r===I&&typeof l=="string"){await this.processChallengeFromPostAsync(l);return}if(r===T&&typeof o=="string"&&typeof l=="string"&&typeof d=="string"){await this.processChallengeFromMessageAsync({contextId:n,matchId:o,playerId:l,opponentId:d});return}}if(i===w&&typeof l=="string"&&typeof h=="number"){await this.processMatchingGroupModeAsync(l,h);return}if(g){await this.processSingleModeAsync(!0),t.loggedIn();return}this.switchToDashboardScene()}logUserAnalytics(t){try{const{player:e,analytics:s}=this.game;if(t)s.event(eo.Events.NEW_USER);else{const{coins:n}=e.getPlayerData().gameData;s.event(eo.Events.RETURNING_USER,{coins:n})}}catch{}}async processEntryPointAction(t){try{const{player:e}=this.game;switch(t){case"reset_data":e.setPlayerDataByName("score",0),e.setPlayerDataByName("endlessScore",0),e.setGameData({coins:0,level:1}),await e.syncProfileToServer();break;case"enable_debug":e.setPlayerDataByName("debug",!0);break;case"set_locale_en":this.requestSetLocale("en");break;case"set_locale_ru":this.requestSetLocale("ru");break}}catch(e){console.warn("processEntryPointAction",e)}}requestSetLocale(t){const{event:e}=this.game;e.emit(mt.REQUEST_LANGUAGE,{locale:t})}async processTournamentModeAsync(t){const{match:e,player:s}=this.game,n=s.getPlayerId();if(Ac.isEmpty(t))throw new Error("Cannot get contextId");await e.tournament.continue.processAsync({playerId:n,contextId:t}),this.switchToGameScene()}async processChallengeFromPostAsync(t){const{match:e,player:s}=this.game,n=s.getPlayerId();if(n===t)await e.single.start.processAsync({playerId:n});else try{await e.challenge.friend.processAsync({playerId:n,opponentId:t})}catch(i){console.warn("processChallengeFromPostAsync",i),await e.single.start.processAsync({playerId:n})}this.switchToGameScene()}async processChallengeFromMessageAsync(t){try{await this.processContinueChallengeFromMessageAsync(t)}catch(e){if(console.warn("processContinueChallengeFromMessageAsync",e),e instanceof gt){await this.processAwaitChallengeFromMessageAsync(t);return}if(e instanceof qe){await this.processJoinChallengeFromMessageAsync(t);return}this.switchToDashboardScene()}}async processContinueChallengeFromMessageAsync(t){const{contextId:e,matchId:s,playerId:n,opponentId:a}=t,{match:i,player:r}=this.game,o=r.getPlayerId();if(n===o)await i.challenge.continue.processAsync({contextId:e,matchId:s,playerId:o,opponentId:a});else{const d=a===Z.playerId;await i.challenge.continue.processAsync({contextId:e,matchId:s,playerId:o,opponentId:d?a:n})}this.switchToGameScene()}async processJoinChallengeFromMessageAsync(t){const{contextId:e,matchId:s,playerId:n}=t,{match:a,player:i}=this.game,r=i.getPlayerId();await a.challenge.join.processAsync({contextId:e,matchId:s,playerId:r,opponentId:n}),this.switchToGameScene()}async processAwaitChallengeFromMessageAsync(t){const{contextId:e,matchId:s,playerId:n}=t,{match:a,player:i}=this.game,r=i.getPlayerId();try{await a.challenge.await.processAsync({contextId:e,matchId:s,playerId:r,opponentId:n}),this.switchToChallengeResultScene()}catch(o){console.warn("processAwaitChallengeFromMessageAsync",o),await this.processResultChallengeFromMessageAsync(t)}}async processResultChallengeFromMessageAsync(t){const{contextId:e,matchId:s,playerId:n}=t,{match:a,player:i}=this.game,r=i.getPlayerId();try{await a.challenge.result.processAsync({contextId:e,matchId:s,playerId:r,opponentId:n}),this.switchToChallengeResultScene()}catch{this.switchToDashboardScene()}}async processMatchingGroupModeAsync(t,e){const{match:s,player:n}=this.game;await s.group.join.processAsync({playerId:n.getPlayerId(),opponentId:t,opponentScore:e}),this.switchToGameScene()}async processSingleModeAsync(t){const{match:e,player:s}=this.game,n=s.getPlayerId();t&&await e.handler.setMatchCustomData({level:0}),await e.single.start.processAsync({playerId:n}),this.switchToGameScene()}switchToDashboardScene(){const{event:t}=this.game;t.emit(mt.SWITCH_SCENE,{sceneName:"DashboardScene",sceneData:{isFromLoader:!0}})}switchToGameScene(){const{event:t}=this.game;t.emit(mt.SWITCH_SCENE,{sceneName:"GameScene",sceneData:{isFromLoader:!0}})}switchToChallengeResultScene(){const{event:t}=this.game;t.emit(mt.SWITCH_SCENE,{sceneName:"ChallengeResultScene",sceneData:{isFromLoader:!0}})}};c(Da,"Loader");let us=Da;const to={processed:!1,contextId:"",contextType:"SOLO",entryPointData:{},contextGameMode:"",sessionContextType:""},{Events:Dc}=p,Ia=class Ia extends L.Plugins.BasePlugin{constructor(e){super(e);u(this,"context");u(this,"loader");this.loader=new us(e),this.context=new hs(e)}init(){const{storage:e}=this.game;e.addStorage("context",to)}getSessionContextTypes(){return De}async processContextData(){try{await this.loader.processContextData()}catch(e){console.error("processContextData",e),this.switchToDashboardScene()}}async detectContextSessionType(){try{await this.context.detectContextSessionType()}catch(e){console.error("detectContextSessionType",e)}}detectContextGameMode(){this.context.detectContextGameMode()}receiveContext(e,s,n){this.context.receiveContext(e,s,n)}switchToDashboardScene(){const{event:e}=this.game;e.emit(Dc.SWITCH_SCENE,{sceneName:"DashboardScene"})}};c(Ia,"ContextPlugin");let ps=Ia;const{Valid:ys}=p.Utils,{contextId:Ic,contextType:vc,entryPointData:Ec}=to,fs="is invalid",va=class va extends F{constructor(){super(...arguments);u(this,"data")}setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateContextId(e){ys.isString(e)||this.exception("contextId",fs)}validateContextType(e){(!ys.isString(e)||!e)&&this.exception("contextType",fs)}validateEntryPointData(e){ys.isObject(e)||this.exception("entryPointData",fs)}toObject(){return super.toObject()}};c(va,"ContextInfoDtos");let wt=va;wt.addDefaultData({contextId:Ic,contextType:vc,entryPointData:Ec}),p.Dtos.Context={Info:wt};const Pc={0:{id:1,type:"coin",value:300},1:{id:2,type:"coin",value:500},2:{id:3,type:"coin",value:1e3},3:{id:4,type:"coin",value:2e3},4:{id:5,type:"coin",value:3e3},5:{id:6,type:"coin",value:5e3},6:{id:7,type:"coin",value:1e3}},{Object:Sc}=p.Utils,Ea=class Ea{async getDailyRewardsAsync(){return Sc.vals(Pc)}};c(Ea,"DailyRewardsAPI");let gs=Ea;const ze={REWARDED:"rewarded",SKIPPED:"skipped",READY:"ready",WAITING:"waiting"},xc={dailyRewards:{}},{Configs:{DailyRewards:bc},Utils:{Object:Cc}}=p,Pa=class Pa extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"dailyRewardsApi",new gs)}init(){const{storage:e}=this.game;e.addStorage("dailyRewards",xc)}async requestDailyRewardsAsync(){const e=await this.dailyRewardsApi.getDailyRewardsAsync();e.length!==0&&this.receiveDailyRewards(e)}getDailyRewards(){const{storage:e}=this.game,s=e.getStorageData("dailyRewards","dailyRewards");return s||null}logLoginReward(){const{player:e}=this.game,{logDays:s}=e.getPlayerData().dailyRewarded,n=[...s];n[n.length-1]=!0,this.logDailyRewards(n)}logDailyRewards(e,s=!1){const{player:n}=this.game;n.setPlayerDataByName("dailyRewarded",{logDays:e,lastRewarded:s?0:Date.now()})}receiveDailyRewards(e){const{player:s}=this.game,{logDays:n,lastRewarded:a}=s.getPlayerData().dailyRewarded,{CheckInterrupt:i,MaxDays:r}=bc,o=new Date,l=new Date(a),d=new Date(l.toDateString()),h=Math.abs(o.valueOf()-d.valueOf()),g=Math.floor(h/864e5)>1,I=i&&g||n.length>=r,w=I?[!1]:[...n,!1];this.logDailyRewards(w);const T=e.map((x,dt)=>{const ge=dt<w.length,Zd=w.length===dt+1,eh=w[dt]===!1;let ht=ze.WAITING;return Zd?ht=ze.READY:I?ht=ze.WAITING:ge&&eh?ht=ze.SKIPPED:ge&&(ht=ze.REWARDED),{...x,status:ht}}),H=Cc.keyBy(T,"id");this.setDailyRewards(H)}setDailyRewards(e){const{storage:s}=this.game;s.setStorageData("dailyRewards","dailyRewards",e)}};c(Pa,"DailyRewardsPlugin");let ms=Pa;var ws={exports:{}};ws.exports,function(f){var t=Object.prototype.hasOwnProperty,e="~";function s(){}c(s,"Events"),Object.create&&(s.prototype=Object.create(null),new s().__proto__||(e=!1));function n(o,l,d){this.fn=o,this.context=l,this.once=d||!1}c(n,"EE");function a(o,l,d,h,y){if(typeof d!="function")throw new TypeError("The listener must be a function");var g=new n(d,h||o,y),A=e?e+l:l;return o._events[A]?o._events[A].fn?o._events[A]=[o._events[A],g]:o._events[A].push(g):(o._events[A]=g,o._eventsCount++),o}c(a,"addListener");function i(o,l){--o._eventsCount===0?o._events=new s:delete o._events[l]}c(i,"clearEvent");function r(){this._events=new s,this._eventsCount=0}c(r,"EventEmitter"),r.prototype.eventNames=c(function(){var l=[],d,h;if(this._eventsCount===0)return l;for(h in d=this._events)t.call(d,h)&&l.push(e?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(d)):l},"eventNames"),r.prototype.listeners=c(function(l){var d=e?e+l:l,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var y=0,g=h.length,A=new Array(g);y<g;y++)A[y]=h[y].fn;return A},"listeners"),r.prototype.listenerCount=c(function(l){var d=e?e+l:l,h=this._events[d];return h?h.fn?1:h.length:0},"listenerCount"),r.prototype.emit=c(function(l,d,h,y,g,A){var I=e?e+l:l;if(!this._events[I])return!1;var w=this._events[I],T=arguments.length,H,x;if(w.fn){switch(w.once&&this.removeListener(l,w.fn,void 0,!0),T){case 1:return w.fn.call(w.context),!0;case 2:return w.fn.call(w.context,d),!0;case 3:return w.fn.call(w.context,d,h),!0;case 4:return w.fn.call(w.context,d,h,y),!0;case 5:return w.fn.call(w.context,d,h,y,g),!0;case 6:return w.fn.call(w.context,d,h,y,g,A),!0}for(x=1,H=new Array(T-1);x<T;x++)H[x-1]=arguments[x];w.fn.apply(w.context,H)}else{var dt=w.length,ge;for(x=0;x<dt;x++)switch(w[x].once&&this.removeListener(l,w[x].fn,void 0,!0),T){case 1:w[x].fn.call(w[x].context);break;case 2:w[x].fn.call(w[x].context,d);break;case 3:w[x].fn.call(w[x].context,d,h);break;case 4:w[x].fn.call(w[x].context,d,h,y);break;default:if(!H)for(ge=1,H=new Array(T-1);ge<T;ge++)H[ge-1]=arguments[ge];w[x].fn.apply(w[x].context,H)}}return!0},"emit"),r.prototype.on=c(function(l,d,h){return a(this,l,d,h,!1)},"on"),r.prototype.once=c(function(l,d,h){return a(this,l,d,h,!0)},"once"),r.prototype.removeListener=c(function(l,d,h,y){var g=e?e+l:l;if(!this._events[g])return this;if(!d)return i(this,g),this;var A=this._events[g];if(A.fn)A.fn===d&&(!y||A.once)&&(!h||A.context===h)&&i(this,g);else{for(var I=0,w=[],T=A.length;I<T;I++)(A[I].fn!==d||y&&!A[I].once||h&&A[I].context!==h)&&w.push(A[I]);w.length?this._events[g]=w.length===1?w[0]:w:i(this,g)}return this},"removeListener"),r.prototype.removeAllListeners=c(function(l){var d;return l?(d=e?e+l:l,this._events[d]&&i(this,d)):(this._events=new s,this._eventsCount=0),this},"removeAllListeners"),r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=e,r.EventEmitter=r,f.exports=r}(ws);var Nc=ws.exports;const Lc=Vr(Nc),de=new Lc,Oc={names:[],history:[]},Sa=class Sa extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"enableLog",!1);u(this,"muteEvents",[])}init(){const{storage:e}=this.game;e.addStorage("event",Oc)}enableLogEvent(){this.enableLog=!0}on(e,s){this.validateCallback(s),this.addEventName(e),this.addHistory(e,"on","listening"),de.on(e,s)}once(e,s){this.validateCallback(s),this.addEventName(e),this.addHistory(e,"once","listening"),de.once(e,s)}catchUp(e,s){if(this.validateCallback(s),this.once(e,s),!(this.getEventEmitCount(e)>0))return;const{payload:a}=this.getLastEventInfo(e)??{};this.emit(e,a)}off(e,s){this.validateCallback(s),de.off(e,s),this.addHistory(e,"action","removed")}mute(e){this.muteEvents.indexOf(e)>-1||this.muteEvents.push(e)}clear(e){de.removeAllListeners(e),this.addHistory(e,"action","removed")}emit(e,s){if(this.muteEvents.indexOf(e)>-1)return;let n=[];s&&(n=[s]),this.addHistory(e,"action","called",s),de.emit(e,...n)}validateCallback(e){if(typeof e!="function")throw new Error("Callback must be a function")}addEventName(e){const{storage:s}=this.game,n=s.getStorageData("event","names");n&&n.indexOf(e)<0&&n.push(e)}getEventListeners(){const e=de.eventNames();return Object.keys(e)}getHistory(){const{storage:e}=this.game;return e.getStorageData("event","history")??[]}getEventEmitCount(e){return this.getHistory().filter(n=>n.name===e&&n.status==="called").length}getLastEventInfo(e){const s=this.getHistory();let n=null;for(let a=s.length-1;a>=0;a--)if(s[a].name===e){n=s[a];break}return n}getTypeFromHistory(e){const s=this.getLastEventInfo(e);return(s==null?void 0:s.type)??null}getCallsFromHistory(e){const s=this.getLastEventInfo(e);return(s==null?void 0:s.called)??0}addHistory(e,s,n,a){const r=this.getTypeFromHistory(e)??s,o=this.getCallsFromHistory(e),l=n==="called"?o+1:o;this.getHistory().push({type:r,status:n,name:e,called:l,payload:a??{}}),this.logEventInfo(e,r,n,l)}logEventInfo(e,s,n,a){if(this.enableLog){if(n==="listening"){console.info(`Event (${s}) ${e}: ${n}`);const i=de.listenerCount(e);i>1&&console.warn(`Event ${e} has ${i} listener`)}else s!=="action"&&console.info(`Event (${s}) ${e}: ${n} (${a} times)`);n==="called"&&de.listenerCount(e)<=0&&console.warn(`Event ${e} is called but not listening`)}}};c(Sa,"EventPlugin");let As=Sa;const Tc='nunito,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif',{Configs:_c,Utils:Rc}=p,{Object:Ds}=Rc,{Enabled:Mc,WideframeConfigs:Is}=_c.FrameCapture,$c=c(async f=>{if(!Mc)return console.warn("FrameCapture is not enabled"),null;const t=Fc(f);if(!t)return null;Gc(t,Is.ResultChallenge);const{frameCapture:e}=window.game,{Width:s,Height:n}=Is.ResultChallenge;return e.captureAsync({name:"ResultChallenge",width:s,height:n,renderOptions:t})},"renderResultChallenge"),Gc=c((f,t)=>{const{Width:e,Height:s,Wideframe:n}=t;f.wideframe={name:"result-challenge",type:"image",depth:0,image:n,size:[e,s],position:[0,0]}},"addWideframe$2"),Fc=c(f=>{try{const{playerId:t="10",playerPhoto:e="",playerScore:s=0,opponentId:n="20",opponentPhoto:a="",opponentScore:i=0,isPlayerFinished:r,isOpponentFinished:o}=f,{RenderOptions:l}=Is.ResultChallenge,d=Ds.clone(l);if(!d)return null;const h=Ds.clear(d),y=Ds.camelCaseKeys(h),{playerPhoto:g,opponentPhoto:A}=y,I=s===i,w=s>i,T=r??o,H=r&&o;return g.type==="image"&&(g.name=`${t}`,g.image=e),A.type==="image"&&(A.name=`${n}`,A.image=a),T&&kc(y,{playerScore:s,opponentScore:i,isPlayerFinished:r,isOpponentFinished:o}),!H||I?(delete y.leftCrown,delete y.rightCrown,y):(w?delete y.rightCrown:delete y.leftCrown,y)}catch(t){return console.warn("getRenderOptionsShareScore",t),null}},"getRenderOptions$2"),kc=c((f,t)=>{const{leftScore:e,rightScore:s}=f,{playerScore:n=0,opponentScore:a=0,isPlayerFinished:i,isOpponentFinished:r}=t;(e==null?void 0:e.type)==="text"&&(e.text=i?`${n}`:"???"),(s==null?void 0:s.type)==="text"&&(s.text=r?`${a}`:"???")},"addRenderScores"),{Configs:Vc,Utils:Uc}=p,{Object:vs}=Uc,{Enabled:Bc,WideframeConfigs:Es}=Vc.FrameCapture,jc=c(async f=>{if(!Bc)return console.warn("FrameCapture is not enabled"),null;const t=Kc(f);if(!t)return null;Wc(t,Es.ShareLeaderboard);const{frameCapture:e}=window.game,{Width:s,Height:n}=Es.ShareLeaderboard;return e.captureAsync({name:"ShareLeaderboard",width:s,height:n,renderOptions:t})},"renderShareLeaderboard"),Wc=c((f,t)=>{const{Width:e,Height:s,Wideframe:n}=t;f.wideframe={name:"share-leaderboard",type:"image",depth:0,image:n,size:[e,s],position:[0,0]}},"addWideframe$1"),Kc=c(f=>{try{const{playerId:t,playerPhoto:e,leaders:s}=f,{RenderOptions:n}=Es.ShareLeaderboard,a=vs.clone(n);if(!a)return null;const i=vs.clear(a),r=vs.camelCaseKeys(i),{avatar:o}=r;return o.type==="image"&&(o.name=`${t}`,o.image=e),Hc(r,s),r}catch(t){return console.warn("getRenderOptionsShareScore",t),null}},"getRenderOptions$1"),Hc=c((f,t)=>{const e="600 48px";t.forEach((s,n)=>{const{id:a,name:i,photo:r,score:o}=s;let l=1294+180*n;f[`photo_${a}`]={depth:-1,name:a,type:"image",image:r,size:[96,96],position:[436,l]},l=1360+180*n,f[`name_${a}`]={font:e,depth:1,name:a,type:"text",text:i,position:[600,l]},f[`score_${a}`]={font:e,depth:1,name:a,type:"text",text:`${o}`,position:[100,l]}})},"addLeaders"),{Configs:qc,Utils:zc}=p,{Object:Ps}=zc,{Enabled:Yc,WideframeConfigs:Ss}=qc.FrameCapture,Qc=c(async f=>{if(!Yc)return console.warn("FrameCapture is not enabled"),null;const t=Jc(f);if(!t)return null;Xc(t,Ss.ShareScore);const{frameCapture:e}=window.game,{Width:s,Height:n}=Ss.ShareScore;return e.captureAsync({name:"ShareScore",width:s,height:n,renderOptions:t})},"renderShareScore"),Xc=c((f,t)=>{const{Width:e,Height:s,Wideframe:n}=t;f.wideframe={name:"share-score",type:"image",depth:0,image:n,size:[e,s],position:[0,0]}},"addWideframe"),Jc=c(f=>{try{const{playerId:t,playerPhoto:e,playerScore:s}=f,{RenderOptions:n}=Ss.ShareScore,a=Ps.clone(n);if(!a)return null;const i=Ps.clear(a),r=Ps.camelCaseKeys(i);console.log("renderOptions",r);const{avatar:o,playerScore:l}=r;return o.type==="image"&&(o.name=`${t}`,o.image=e),l.type==="text"&&(l.text=`${s}`),r}catch(t){return console.warn("getRenderOptionsShareScore",t),null}},"getRenderOptions"),{Configs:{FrameCapture:{Options:xs}},Utils:{Browser:Zc,Image:At,Object:Ye,Valid:Dt}}=p,xa=class xa extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"width");u(this,"height");u(this,"canvas",null);u(this,"context",null);u(this,"testRenderOptions",null);u(this,"caches",{});u(this,"wideframe",{})}init(){this.addWideframeRender("renderShareScore",Qc),this.addWideframeRender("renderResultChallenge",$c),this.addWideframeRender("renderShareLeaderboard",jc)}async preloadAsync(e){const{renderOptions:s}=e;await this.loadImages(s)}async captureAsync(e){const{width:s,height:n,renderOptions:a}=e;return await this.loadImages(a),this.width=s,this.height=n,this.createCanvas(),this.drawObjects(a),this.snapshotFrameAsync()}addWideframeRender(e,s){this.wideframe[e]=s}setTestRenderOptions(e){if(!e){this.testRenderOptions=null;return}const s=Ye.camelCaseKeys(e);this.testRenderOptions=Ye.merge(this.testRenderOptions,s)}createCanvas(){if(!this.canvas){const e=Zc.createCanvas({type:"canvas",contextAttributes:{alpha:!1,desynchronized:!0,willReadFrequently:!0},contextType:"2d"});this.canvas=e==null?void 0:e.canvas,this.context=e==null?void 0:e.context}if(!this.canvas)throw new Error("Failed to create canvas");this.context&&this.context.clearRect(0,0,this.width,this.height),this.canvas.width=this.width,this.canvas.height=this.height}async loadImages(e){const s=Ye.vals(e).filter(r=>r.type==="image"),n=this.prepareLoadImages(s),a=Ye.vals(n);if(a.length<1)return;const i=await Promise.all(a);this.cacheImages(n,i)}prepareLoadImages(e){const s={};for(const n of e){const{name:a,image:i,fallbackImage:r}=n,o=this.caches[a];!Dt.isString(i)||o||(i===""&&Dt.isString(r)&&(n.image=r),console.debug("prepareLoadImages",n),s[a]=new Promise(l=>{At.loadImage(i).then(h=>{l(h)}).catch(()=>{Dt.isString(r)?(n.image=r,At.loadImage(n.image).then(h=>{l(h)}).catch(()=>{l(null)})):l(null)})}))}return s}cacheImages(e,s){for(const n in e){const a=s.shift();a&&(this.caches[n]=a)}}drawObjects(e){const s=Ye.vals(e).sort((n,a)=>n.depth-a.depth);for(const n of s)switch(n.type){case"text":this.drawText(n);break;case"image":this.drawImage(n);break}}drawText(e){if(!this.canvas||!this.context)return;const{position:s,font:n,text:a,color:i,lineWidth:r,textAlign:o}=e;this.context.font=`${n} ${Tc}`,this.context.fillStyle=i??"#ffffff",r&&(this.context.lineWidth=r),o&&(this.context.textAlign=o),console.debug("drawText",e);const[l,d]=s;this.context.fillText(a,l,d)}drawImage(e){if(!this.canvas||!this.context)return;const{name:s,size:n,position:a,fallbackImage:i}=e;let r=this.caches[s];if(!r&&i&&(r=this.caches[i]),!r)throw new Error(`Image ${s} not found`);console.debug("drawImage",e);const[o,l]=a,[d,h]=n;this.context.drawImage(r,o,l,d,h)}async snapshotFrameAsync(){if(!this.canvas)return null;let e=null;if(xs.UseBlobIfPossible&&"toBlob"in this.canvas?e=await this.createAsBlob():e=this.createAsDataImage(),!e)throw new Error("Image data is null");return Dt.isDebugger()&&At.logImage(e),e}createAsDataImage(){if(!this.canvas||!this.context)return null;const{Quality:e,RenderType:s}=xs;return this.context.canvas.toDataURL(`image/${s}`,e)}createAsBlob(){return new Promise(e=>{if(!this.canvas){e(null);return}const{Quality:s,RenderType:n}=xs;this.canvas.toBlob(a=>{if(!a){e(null);return}At.blobToDataImage(a).then(i=>{e(i)})},`image/${n}`,s)})}};c(xa,"FrameCapturePlugin");let bs=xa;const ba=class ba extends Error{constructor(e,s){const n=String(e);super(`Text with key "${n}" not found in locale "${s}"`);u(this,"key");u(this,"locale");this.name="MissingKeyInLocaleError",this.key=n,this.locale=s}};c(ba,"MissingKeyInLocaleError");let Qe=ba;const Ca=class Ca extends Error{constructor(e){super(`Locale "${e}" not found`);u(this,"locale");this.name="LocaleNotFoundError",this.locale=e}};c(Ca,"LocaleNotFoundError");let It=Ca;const{Utils:{Object:Cs,Function:so}}=p,Na=class Na extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"locale");u(this,"fallbackLocale");u(this,"data",{})}setFallbackLocale(e){this.fallbackLocale=e}hasTextKey(e,s){const n=s??this.getCurrentLocale(),{text:a}=this.getLocaleData(n);return Cs.hasOwn(a,e)}hasTextureKey(e,s){const n=s??this.getCurrentLocale(),{texture:a}=this.getLocaleData(n);return Cs.hasOwn(a,e)}add(e,s,n=!1){this.data[e]=s,n&&this.setFallbackLocale(e)}choose(e){this.locale=e;const{event:s}=this.game;s.emit(p.Events.LANGUAGE_CHANGED,{locale:e})}async getText(e,s,n,a=!1){try{return await this.uncaughtGetText(e,s,n,!a)}catch(i){return i instanceof Qe||i instanceof It?console.warn(i.message):console.error(i),String(e)}}async getTexture(e,s,n=!1){return await this.uncaughtGetTexture(e,s,!n)}async uncaughtGetText(e,s=[],n,a=!0){if(!a||this.fallbackLocale===void 0){const o=this.getRawText(e,n??this.getCurrentLocale());return this.replaceVariables(o,s)}const i=this.fallbackLocale,r=await so.retry(()=>this.getRawText(e,n??this.getCurrentLocale()),()=>this.getRawText(e,i));return this.replaceVariables(r,s)}getRawText(e,s){if(!this.hasTextKey(e,s))throw new Qe(e,s);const{text:n}=this.getLocaleData(s);return n[e]}async uncaughtGetTexture(e,s,n=!0){if(!n||this.fallbackLocale===void 0)return this.getRawTexture(e,s??this.getCurrentLocale());const a=this.fallbackLocale;return await so.retry(()=>this.getRawTexture(e,s??this.getCurrentLocale()),()=>this.getRawTexture(e,a))}getRawTexture(e,s){if(!this.hasTextureKey(e,s))throw new Qe(e,s);const{texture:n}=this.getLocaleData(s);return n[e]}getCurrentLocale(){return this.locale??"en"}getLocaleData(e){const s=e??this.getCurrentLocale();if(!Cs.hasOwn(this.data,s))throw new It(s);return this.data[s]}replaceVariables(e,s){const n=s.length;if(n===0)return e;let a=e;for(let i=0;i<n;i++){const r=s[i],o=`%{${i}}`;a=a.replace(o,r)}return a}};c(Na,"LanguagePlugin");let Ns=Na;const el=J("D",{_id:"",name:"",createdBy:"",description:"",expireTime:7*24*60*60*1e3,type:"app_leaderboard",timezone:"utc+0",createdAt:"2024-01-01T09:00:00.000Z",sortOrder:"desc",statistics:"max",resettable:"manually",resetScore:0,numberOfLeaders:15,amountPlayer:15}),{Configs:tl,Utils:sl}=p,{Object:Xe,String:no,Valid:ao}=sl,{OtherHost:Je,Mockup:Ze,AppId:nl}=tl,La=class La{constructor(){u(this,"mockAPI")}async initMockAPI(){if(this.mockAPI)return;const t=(await oe(async()=>{const{default:e}=await v.import("./bundle/LeaderboardAPIMock.js");return{default:e}},void 0,v.meta.url)).default;if(typeof t!="function")throw new Error("Cannot load LeaderboardAPIMock");this.mockAPI=new t}async getLeadersAsync(t,e,s){const n=no.params(s);let a;return Ze.Leaderboards.Enabled?(await this.initMockAPI(),"playerIds"in s?a=await this.mockAPI.getPlayers(t,s):a=await this.mockAPI.getLeaders(t,s)):a=await we(`${e}?${n}`,{},Je),!Xe.hasOwn(a,"data")||!Array.isArray(a.data)?[]:a.data}async getLeaderboardAsync(t){let e;const s=`leaderboards/${t}`;return Ze.Leaderboards.Enabled?(await this.initMockAPI(),e=await this.mockAPI.getLeaderboardAsync(t)):(e=await we(s,{},Je),Xe.hasOwn(e,"data")&&ao.isObject(e.data)&&(e=e.data)),e}async getLeaderboardsAsync(t){let e;const s=p.Utils.String.params(t);return Ze.Leaderboards.Enabled?(await this.initMockAPI(),e=await this.mockAPI.getLeaderboardsAsync(t)):(e=await we(`leaderboards?${s}`,{},Je),Xe.hasOwn(e,"data")&&Array.isArray(e.data)?e=e.data:e=[]),e}async setLeaderboardScoreAsync(t){const{leaderboardId:e,playerId:s,score:n}=t;Ze.Leaderboards.Enabled?(await this.initMockAPI(),await this.mockAPI.setScoreAsync(e,s,n)):await k(`leaderboards/${e}/players/${s}`,{score:n},{},Je)}async createLeaderboardAsync(t){const e=t._id??no.generateObjectId(),s=t.numberOfLeaders,n={...el,...t,_id:e,appId:nl,numberOfLeaders:s},a="leaderboards";let i;if(Ze.Leaderboards.Enabled?(await this.initMockAPI(),i=await this.mockAPI.createLeaderboard(n)):(i=await k(a,n,{},Je),Xe.hasOwn(i,"data")&&ao.isObject(i.data)&&(i=i.data)),!Xe.hasOwn(i,"_id")||i._id!==e)throw new Error("Create leaderboard failed");return e}};c(La,"LeaderboardAPI");let Ls=La;const io={limit:0,offset:0,leaders:{},isRequesting:!1,amountPlayer:0},al={leaderboards:{}},{Utils:{Array:il,Valid:rl,Json:ro,Object:vt}}=p,Oa=class Oa extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"lbAPI",new Ls);u(this,"configs")}init(){const{storage:e}=this.game;e.addStorage("leaderboard",al),this.configs={}}addLeaderboard(e){const{name:s,type:n,leaderboardId:a,autoSortRank:i}=e;if(this.getLeaderboard(s)){console.warn(`Leaderboard with name ${s} already exists`);return}let o=`leaderboards/${a}/`;(n==="global"||n==="tournament")&&(o+="leaders"),n==="friends"&&(o+="players"),this.configs[s]={id:a,name:s,type:n,host:o,autoSortRank:i};const l=ro.clone(io);this.setLeaderboard(s,{...l})}async requestLeaderboardsAsync(e){try{return await this.lbAPI.getLeaderboardsAsync(e)}catch(s){return console.warn("requestGlobalLeaderboardsAsync",s),[]}}async requestLeaderboardAsync(e,s){try{this.validateLeaderboard(e),this.clearLeaderboard(e),this.setLeaderboard(e,{isRequesting:!0});const{id:n,type:a,host:i}=this.configs[e];let r=[];if(a==="friends"){const{player:o}=this.game,l=o.getPlayerId(),d=o.getConnectedPlayerIds(s,0),h=[l,...d];this.configs[e].playerIds=[...h],r=await this.lbAPI.getLeadersAsync(n,i,{playerIds:h})}else r=await this.lbAPI.getLeadersAsync(n,i,{limit:s,offset:0});if(r.length===0)return;await this.receiveLeaderboardAsync(e,r),this.setLeaderboard(e,{limit:s,offset:0})}finally{const n=await this.lbAPI.getLeaderboardAsync(this.configs[e].id),a=n?n.resettable:"",i=n?n.amountPlayer:0;this.setLeaderboard(e,{isRequesting:!1,resettable:a,amountPlayer:i})}}async loadMoreLeaderboardAsync(e,s){const n=this.getLeaderboard(e);if(n){if(this.configs[e].type==="friends"){console.warn("Cannot load more leaderboard with type friend");return}try{this.setLeaderboard(e,{isRequesting:!0});const{id:a,host:i}=this.configs[e],{offset:r,limit:o}=n,l=r+o,d=await this.lbAPI.getLeadersAsync(a,i,{limit:s,offset:l});if(d.length===0)return;this.receiveLeaderboardAsync(e,d),this.setLeaderboard(e,{limit:s,offset:l})}finally{this.setLeaderboard(e,{isRequesting:!1})}}}getLeaderboard(e){const{storage:s}=this.game,n=s.getStorageData("leaderboard","leaderboards");return!n||!n[e]?null:n[e]}async getLeadersByPlayerIdsAsync(e,s){try{this.validateLeaderboard(e);const{id:n}=this.configs[e],a=`leaderboards/${n}/players`,i=await this.lbAPI.getLeadersAsync(n,a,{playerIds:s});return i.length===0?[]:this.toLeaders(i)}catch(n){return console.warn(n),[]}}async getLeaderboardResponseAsync(e){return await this.lbAPI.getLeaderboardAsync(e)}clearLeaderboard(e){try{this.validateLeaderboard(e);const s=ro.clone(io);this.setLeaderboard(e,null),this.setLeaderboard(e,{...s})}catch(s){console.warn(s)}}isLeaderboardEmpty(e){const s=this.getLeaderboard(e);if(!s)return!0;const{leaders:n}=s;return Object.keys(n).length===0}isExistLeaderboardId(e){const{configs:s}=this;return vt.vals(s).some(n=>n.id===e)}getLeaderboardName(e){const{configs:s}=this,n=il.search(vt.vals(s),a=>a.id===e);return n?n.name:null}async setLeaderboardScoreAsync(e,s,n){try{if(GameSDK.extra.isGuest)return;this.validateLeaderboard(e);const{id:a}=this.configs[e],i=await this.getLastScoreOnLeaderboard(e,s);if(i&&n<=i)return;await this.lbAPI.setLeaderboardScoreAsync({leaderboardId:a,playerId:s,score:n})}catch(a){console.warn(a)}}async getLastScoreOnLeaderboard(e,s){const n=await this.getLeadersByPlayerIdsAsync(e,[s]);return n.length===0?null:n[0].score}async createLeaderboardAsync(e){return this.lbAPI.createLeaderboardAsync(e)}validateLeaderboard(e){const s=this.getLeaderboard(e);if(!rl.isObject(s))throw new Error(`Leaderboard with name ${e} not found`)}setLeaderboard(e,s){if(!s)return;const{storage:n}=this.game;n.setStorageData("leaderboard","leaderboards",{[e]:s})}async receiveLeaderboardAsync(e,s){this.validateLeaderboard(e);const a=(await this.toLeaders(s)).filter(h=>h.name&&h.photo),{leaders:i={}}=this.getLeaderboard(e)??{},r=a.filter(h=>i[h.playerId]?(i[h.playerId]=h,!1):!0),o=vt.vals(i);r.length>0&&o.unshift(...r);let l=o.sort((h,y)=>y.score-h.score);this.configs[e].autoSortRank&&(l=l.map((h,y)=>({...h,rank:y+1})));const d=vt.keyBy(l,"playerId");this.setLeaderboard(e,{leaders:d})}async toLeaders(e){const{profile:s}=this.game,n=e.map(o=>o.playerId);await s.requestProfiles(n);const a=s.getProfiles();return e.map(o=>{const{playerId:l}=o,d=a[l];return d?{...o,name:d.name,photo:d.photo}:{...o,name:"Nameless",photo:"default"}}).map(o=>({...o,score:parseInt(o.score,10)}))}};c(Oa,"LeaderboardPlugin");let Os=Oa;const Ta=class Ta{constructor(){u(this,"APIHost")}setAPIHost(t){this.APIHost=t}getAPIHost(){return this.APIHost}};c(Ta,"BaseAPI");let Ts=Ta;const{Utils:oo}=p,_a=class _a extends Ts{async createSingleMatchAsync(t){const s=await k("single-matches",t,{},this.getAPIHost());return this.returnValidMatchData(s)}async getSingleMatchDetailAsync(){const e=await we("single-matches/active",{},this.getAPIHost());return this.returnValidMatchData(e)}async updateSingleMatchMoveAsync(t,e){const s=`single-matches/${t}/move`,n=await k(s,e,{},this.getAPIHost());return this.returnValidMatchData(n)}async finishSingleMatchAsync(t){const e=`single-matches/${t}/finish`,s=await k(e,{},{},this.getAPIHost());return this.returnValidMatchData(s)}async createEndlessMatchAsync(t){const s=await k("endless-matches",t,{},this.getAPIHost());return this.returnValidMatchData(s)}async getEndlessMatchDetailAsync(){const e=await we("endless-matches/active",{},this.getAPIHost());return this.returnValidMatchData(e)}async updateEndlessMatchMilestoneAsync(t,e){const s=`endless-matches/${t}/milestone`,n=await k(s,e,{},this.getAPIHost());return this.returnValidMatchData(n)}async finishEndlessMatchAsync(t){const e=`endless-matches/${t}/finish`,s=await k(e,{},{},this.getAPIHost());return this.returnValidMatchData(s)}async createMatchAsync(t){const s=await k("matches",t,{},this.getAPIHost());return this.returnValidMatchData(s)}async joinMatchAsync(t){const e=`matches/${t}/join`,s=await k(e,{},{},this.getAPIHost());return this.returnValidMatchData(s)}async getMatchDetailByIdAsync(t){const e=`matches/${t}`,s=await we(e,{},this.getAPIHost());return this.returnValidMatchData(s)}async finishMatchAsync(t){const{matchId:e="",score:s=0,level:n=0,extraData:a={}}=t,i=`matches/${e}/finish`,r=await k(i,{matchId:e,score:s,level:n,extraData:a},{},this.getAPIHost());return this.returnValidMatchData(r)}returnValidMatchData(t){let e={};return!oo.Valid.isObject(t)||!oo.Object.hasOwn(t,"data")||(e=t.data),e}};c(_a,"MatchAPI");let _s=_a;const Ra=class Ra{constructor(t){u(this,"matchAPI");this.createAPI(),this.setAPIConfig(t)}createAPI(){this.matchAPI=new _s}setAPIConfig(t){t.matchAPIHost&&this.matchAPI.setAPIHost(t.matchAPIHost)}setMatchAPIInstance(t){this.matchAPI=t}getMatchAPI(){return this.matchAPI}};c(Ra,"APIHandler");let Rs=Ra;const Ma=class Ma{constructor(t,e){u(this,"game");u(this,"match");this.game=t,this.match=e}startLog(t){this.match.useCPUProfile&&console.profile(this.constructor.name),console.group(`ðŸš€ ${this.constructor.name}`),t&&console.log("ðŸ“¦ ? Payload:",t)}endLog(){console.groupEnd(),this.match.useCPUProfile&&console.profileEnd()}async processAsync(t){throw new Error("Not implemented")}};c(Ma,"BaseConcrete");let P=Ma;const $a=class $a extends q{constructor(t){super(t),this.name="LevelNotDefined",this.message=t??"Level is not defined"}};c($a,"LevelNotDefined");let Et=$a;const Ga=class Ga extends q{constructor(t){super(t),this.name="MatchModeNotDefined",this.message=t??"Match id is not defined"}};c(Ga,"MatchModeNotDefined");let et=Ga;const{Object:Ms,Valid:ol}=p.Utils,Fa=class Fa{constructor(t){u(this,"game");u(this,"match");u(this,"nextHandler");this.game=t.game,this.match=t.match,this.nextHandler=null}setNext(t){return this.nextHandler=t,t}async processAsync(t){console.groupCollapsed(`âž¡ï¸ ${this.constructor.name}`),this.logData("Before",t)}async nextAsync(t){this.logData("After",t),console.groupEnd(),this.nextHandler&&await this.nextHandler.processAsync(t)}logData(t,e){if(!ol.isDebugger())return;console.groupCollapsed(`ðŸ“¦ MatchState: ${t}`);const{profiles:s,customData:n,...a}=e;console.info("ðŸ’¾ Base"),console.table(Ms.clone(a)),console.info("ðŸ’¾ Profile"),console.table(Ms.clone(s)),console.info("ðŸ’¾ Custom"),console.table(Ms.clone(n)),console.groupEnd()}};c(Fa,"BaseHandler");let D=Fa;const{Plugins:cl,Utils:ll}=p,{Analytics:dl}=cl,{String:co,Valid:lo}=ll,ka=class ka extends D{async processAsync(t){super.processAsync(t);const{mode:e,customData:s}=t,{level:n}=s;this.validateMode(e),this.validateLevel(n);const{analytics:a}=this.game;a.event(dl.Events.MATCH_START,{level:n,game_mode:co.toUpperCamelCase(e),level_name:this.getLevelName(n)}),await this.nextAsync(t)}validateMode(t){if(!lo.isString(t))throw new et}validateLevel(t){if(!lo.isNumber(t))throw new Et}getLevelName(t){return`Level ${co.padStart(t.toString(),5,"0")}`}};c(ka,"LogMatchStartHandler");let V=ka;const U={OPEN:"open",ACTIVE:"active",FINISHED:"finished"},Va=class Va extends D{async processAsync(t){super.processAsync(t);const{mode:e,status:s}=t;let n=e??Ie.SINGLE;s===U.FINISHED&&(n=Ie.SINGLE),this.contextGameModeDetected(n),await this.nextAsync(t)}contextGameModeDetected(t){const{storage:e}=this.game;e.setStorageData("context","contextGameMode",t)}};c(Va,"ContextGameModeHandler");let N=Va;const Ua=class Ua extends Error{constructor(t){super(t),this.name="GetMatchDetailFailed",this.message=t??"Get match detail failed"}};c(Ua,"GetMatchDetailFailed");let tt=Ua;const Ba=class Ba extends Error{constructor(t){super(t),this.name="MatchAreNotActive",this.message=t??"Match are not active"}};c(Ba,"MatchAreNotActive");let Pt=Ba;const ja=class ja extends q{constructor(t){super(t),this.name="MatchIdNotValid",this.message=t??"Match id is not valid"}};c(ja,"MatchIdNotValid");let z=ja;const Wa=class Wa extends Error{constructor(t){super(t),this.name="OpponentHasFinishedMatch",this.message=t||"Opponent has finished match"}};c(Wa,"OpponentHasFinishedMatch");let $s=Wa;const Ka=class Ka extends q{constructor(t){super(t),this.name="OpponentIdNotValid",this.message=t??"Opponent id is not valid"}};c(Ka,"OpponentIdNotValid");let _=Ka;const Ha=class Ha extends Error{constructor(t){super(t),this.name="PlayerNotCurrentInMatch",this.message=t??"The player is not currently in this match"}};c(Ha,"PlayerNotCurrentInMatch");let st=Ha;const qa=class qa extends Error{constructor(t){super(t),this.name="PlayerNotFinishedMatch",this.message=t||"Player not finished match"}};c(qa,"PlayerNotFinishedMatch");let St=qa;const{Dtos:hl}=p,za=class za extends D{async processAsync(t){super.processAsync(t),this.validateMatchData(t);const e=await this.getMatchAsync(t),s=new hl.Match.Data(e).toObject();this.validateAwaitMatchData(t,s),this.updateMatchData(t,s),this.validateMatchStatus(t),this.validatePlayerTurn(t),this.validateOpponentTurn(t),await this.nextAsync(t)}validateMatchData(t){const{id:e}=t;if(typeof e!="string")throw new z}validateMatchStatus(t){const{status:e}=t;if(e!==U.ACTIVE)throw new Pt}validateAwaitMatchData(t,e){const{id:s,customData:n}=t,{_id:a,whitePlayerId:i,blackPlayerId:r}=e;if(typeof a!="string"||a!==s)throw new tt;const{playerId:o}=n,l=i===o,d=r===o;if(!l&&r===Z.playerId)throw new qe;if(!l&&!d)throw new st}validatePlayerTurn(t){const{profiles:e,customData:s}=t,{playerId:n}=s;if(typeof n!="string")throw new E;const{finished:a}=e[n];if(!a)throw new St}validateOpponentTurn(t){const{profiles:e,customData:s}=t,{opponentId:n}=s;if(typeof n!="string")throw new _;const{finished:a}=e[n];if(a)throw new $s}async getMatchAsync(t){const{id:e}=t;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):{}}updateMatchData(t,e){const{customData:s}=t,{whitePlayerId:n,blackPlayerId:a,whitePlayerScore:i,blackPlayerScore:r,whitePlayerFinish:o,blackPlayerFinish:l,status:d}=e;t.status=d;const h=n===s.playerId,y=h?n:a,g=h?a:n;t.customData.playerId=y,t.customData.opponentId=g,t.profiles[y]||(t.profiles[y]={id:y,name:"",photo:"",finished:!1}),t.profiles[g]||(t.profiles[g]={id:g,name:"",photo:"",finished:!1});const A=h?i:r,I=h?r:i;t.profiles[y].score=A,t.profiles[g].score=I;const w=h?o:l,T=h?l:o;t.profiles[y].finished=w,t.profiles[g].finished=T}};c(za,"AwaitMatchHandler");let Gs=za;const Fs={level:1,rescued:0,contextId:null,playerId:null,opponentId:null,tournamentId:null,leaderboardId:null},Ya=class Ya extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.initializeMatch(e),await this.nextAsync(e)}initializeMatch(e){const{id:s,mode:n,customData:a}=this.payload;e.id=s??null,e.mode=n||null,e.status=U.OPEN,e.startAt=0,e.finishAt=0,e.profiles={},e.customData={...Fs,...e.customData,...a}}};c(Ya,"PrepareMatchHandler");let R=Ya;const ve=De,Qa=class Qa extends Error{constructor(t){super(t),this.name="UnavailableFeature",this.message=`Unavailable feature: ${t}`}};c(Qa,"UnavailableFeature");let S=Qa;const Xa=class Xa extends q{constructor(t){super(t),this.name="ContextIdNotValid",this.message=t??"Context id is not valid"}};c(Xa,"ContextIdNotValid");let B=Xa;const Ja=class Ja extends D{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesAwaitingAsync(t);e&&this.sendMessageAsync(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:n,opponentId:a}=s;if(!e||typeof e!="string")throw new z;if(!n||typeof n!="string")throw new B;if(!a||typeof a!="string")throw new _}async createWideframesAwaitingAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:n}=t,{playerId:a,opponentId:i}=n;if(!a||!i)return null;const r=s[a],o=s[i],{photo:l,score:d=0,finished:h}=r;if(!h)return null;const{photo:y,score:g=0,finished:A}=o;return A?null:await e.wideframe.renderResultChallenge({playerId:a,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:g,isPlayerFinished:!0,isOpponentFinished:!1})}catch(e){return console.warn("createWideframesAwaitingAsync",e),null}}async sendMessageAsync(t,e){const{id:s,profiles:n,customData:a}=t,{playerId:i,opponentId:r}=a;if(!i||typeof i!="string")throw new E;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const{name:o}=n[i],l={data:{type:ve.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"ChÆ¡i ngay"}},text:{default:`${o} is waiting for you to finish this game. Play now!`,localizations:{vi_VN:`${o} Ä‘ang chá» báº¡n káº¿t thÃºc tráº­n Ä‘áº¥u. ChÆ¡i ngay!`}},image:e,strategy:"LAST",notification:"PUSH"};await GameSDK.extra.updateAsync(l)}};c(Ja,"SendAwaitingMessageHandler");let ks=Ja;const Za=class Za extends D{async processAsync(t){await this.nextAsync(t)}async nextAsync(t){this.nextHandler&&await this.nextHandler.processAsync(t)}};c(Za,"NothingHandler");let b=Za;const ei=class ei extends q{constructor(t){super(t),this.name="ProfileNotFound",this.message=t??"Profile not found"}};c(ei,"ProfileNotFound");let j=ei;const{Dtos:ul}=p,ti=class ti extends D{async processAsync(t){super.processAsync(t),this.validateData(t);const{customData:e}=t,{playerId:s,opponentId:n}=e;let a=s;const i=await this.getProfile(a);if(!i)throw new j;if(this.updateMatchProfile(t,a,i),a=n,a!==Z.playerId){const r=await this.getProfile(a);if(!r)throw new j;this.updateMatchProfile(t,a,r)}else this.updateMatchProfile(t,a);await this.nextAsync(t)}validateData(t){const{customData:e}=t,{playerId:s,opponentId:n}=e;if(!s||typeof s!="string")throw new E;if(!n||typeof n!="string")throw new _}async getProfile(t){const{profile:e}=this.game;return await e.requestProfiles([t]),e.getProfiles()[t]}updateMatchProfile(t,e,s){const{name:n,photo:a}=s??Z,i=new ul.Match.Profile({id:e,name:n,photo:a}).toObject();t.profiles[e]?(t.profiles[e].name=i.name,t.profiles[e].photo=i.photo):t.profiles[e]=i}};c(ti,"GetMatchProfilesHandler");let X=ti;const si=class si extends P{async processAsync(t){try{this.startLog(t);const{matchId:e,playerId:s,opponentId:n}=t,a=new b(this),i=new R(this,{id:e,mode:G.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:n}});a.setNext(i);const r=new Gs(this);i.setNext(r);const o=new X(this);r.setNext(o);const l=new ks(this);o.setNext(l);const d=new V(this);l.setNext(d);const h=new N(this);d.setNext(h);const y=this.match.getMatchState();await a.processAsync(y)}finally{this.endLog()}}};c(si,"AwaitChallengeMatchConcrete");let Vs=si;const ni=class ni extends q{constructor(t){super(t),this.name="CreateContextFailed",this.message=t??"Create context failed"}};c(ni,"CreateContextFailed");let nt=ni;const{Valid:ho,Object:uo}=p.Utils,ai=class ai extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{opponentId:s}=this.payload,n=await this.createAsync(s);e.customData.contextId=n,await this.nextAsync(e)}async createAsync(e){try{await GameSDK.context.createAsync(e)}catch(n){this.validateError(n)}const s=GameSDK.context.getID();if(!ho.isString(s))throw new nt;return s}validateError(e){if(!uo.hasOwn(e,"code"))throw e;if(e.code!=="SAME_CONTEXT"){if(e.code==="INVALID_PARAM"){if(!this.isNotConnectedPlayerError(e))throw e;return}throw e}}validateErrorMessage(e){if(!uo.hasOwn(e,"message")||!ho.isString(e.message))throw e}isNotConnectedPlayerError(e){return this.validateErrorMessage(e),e.message.indexOf("is not a connected player of the current player")>-1}};c(ai,"CreateContextHandler");let Us=ai;const ii=class ii extends q{constructor(t){super(t),this.name="MatchAreNotOpen",this.message=t??"Match are not open"}};c(ii,"MatchAreNotOpen");let Oe=ii;const{Dtos:pl}=p,ri=class ri extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.validateData(e);const s=await this.createMatchAsync(e),n=new pl.Match.Data(s).toObject();this.updateMatchState(e,n),await this.nextAsync(e)}validateData(e){const{status:s,customData:n}=e,{opponentId:a}=n;if(typeof a!="string")throw new _;if(s!==U.OPEN)throw new Oe}async createMatchAsync(e){const{opponentId:s}=e.customData,{extraData:n}=this.payload;if(!s)return{};const a={opponentPlayerId:s,extraData:n};return this.match.api.getMatchAPI().createMatchAsync(a)}updateMatchState(e,s){const{customData:n}=e,{_id:a,whitePlayerId:i,blackPlayerId:r,whitePlayerFinish:o,blackPlayerFinish:l}=s,d=i===n.opponentId;e.id=a||null;const h=d?r:i,y=d?i:r;e.customData.playerId=h,e.customData.opponentId=y,e.profiles[h]||(e.profiles[h]={id:h,name:"",photo:"",finished:!1}),e.profiles[y]||(e.profiles[y]={id:y,name:"",photo:"",finished:!1});const g=d?l:o,A=d?o:l;e.profiles[h].finished=g,e.profiles[y].finished=A}};c(ri,"CreateMatchHandler");let xt=ri;const oi=class oi extends D{async processAsync(t){if(super.processAsync(t),t.status!==U.OPEN)throw new Oe;this.startMatch(t),await this.nextAsync(t)}startMatch(t){t.status=U.ACTIVE,t.startAt=Date.now()}};c(oi,"StartMatchHandler");let W=oi;const ci=class ci extends D{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesChallengeAsync(t);e&&this.sendMessageAsync(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:n,opponentId:a}=s;if(!e||typeof e!="string")throw new z;if(!n||typeof n!="string")throw new B;if(!a||typeof a!="string")throw new _}async createWideframesChallengeAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:n}=t,{playerId:a,opponentId:i}=n;if(!a||!i)return null;const r=s[a],o=s[i],{photo:l,score:d=0}=r,{photo:h,score:y=0}=o;return await e.wideframe.renderResultChallenge({playerId:a,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:h,opponentScore:y,isPlayerFinished:!1,isOpponentFinished:!1})}catch(e){return console.warn("createWideframesChallengeAsync",e),null}}async sendMessageAsync(t,e){const{id:s,profiles:n,customData:a}=t,{playerId:i,opponentId:r}=a;if(!i||typeof i!="string")throw new E;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const{name:o}=n[i],l={data:{type:ve.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"ChÆ¡i ngay"}},text:{default:`${o} challenges you`,localizations:{vi_VN:`${o} thá»­ thÃ¡ch báº¡n trong tráº­n Ä‘áº¥u nÃ y. ChÆ¡i ngay!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};await GameSDK.extra.updateAsync(l)}};c(ci,"SendChallengeMessageHandler");let bt=ci;const li=class li extends P{async processAsync(t){try{this.startLog(t);const{playerId:e,opponentId:s}=t,n=new b(this),a=new Us(this,{opponentId:s});n.setNext(a);const i=new R(this,{mode:G.CHALLENGE_FRIEND,customData:{playerId:e,opponentId:s}});a.setNext(i);const r=new xt(this,{extraData:t.extraData});i.setNext(r);const o=new X(this);r.setNext(o);const l=new W(this);o.setNext(l);const d=new V(this);l.setNext(d);const h=new bt(this);d.setNext(h);const y=new N(this);h.setNext(y);const g=this.match.getMatchState();await n.processAsync(g)}finally{this.endLog()}}};c(li,"ChallengeFriendConcrete");let Bs=li;const di=class di extends Error{constructor(t){super(t),this.name="SameContext",this.message=t??"Same context"}};c(di,"SameContext");let at=di;const{Utils:po}=p,hi=class hi extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{contextId:s}=this.payload;await this.switchAsync(s),e.customData.contextId=s,await this.nextAsync(e)}checkSameContext(e){const s=e==="SOLO",n=GameSDK.context.getID();if(n===e)throw new at;if(s&&n===null)throw new at}async switchAsync(e){const s=e==="SOLO";try{this.checkSameContext(e),await GameSDK.context.switchAsync(e,s)}catch(n){if(n instanceof at)return;if(!po.Object.hasOwn(n,"code"))throw n;if(po.Device.isAndroid()&&s&&n.code==="INVALID_PARAM")return;if(n.code!=="SAME_CONTEXT")throw n}}};c(hi,"SwitchContextHandler");let Te=hi;const{Dtos:yl}=p,ui=class ui extends D{async processAsync(t){super.processAsync(t),this.validateMatchData(t);const e=await this.getMatchAsync(t),s=new yl.Match.Data(e).toObject();this.validateContinueMatchData(t,s),this.updateMatchData(t,s),this.validatePlayerTurn(t),await this.nextAsync(t)}validateMatchData(t){const{id:e,status:s}=t;if(typeof e!="string")throw new z;if(s!==U.OPEN)throw new Oe}validateContinueMatchData(t,e){const{id:s,customData:n}=t,{_id:a,whitePlayerId:i,blackPlayerId:r}=e;if(typeof a!="string"||a!==s)throw console.warn("ðŸ¤– ? respMatchDataValidated",e),new tt;const{playerId:o}=n,l=i===o,d=r===o;if(!l&&r===Z.playerId)throw new qe;if(!l&&!d)throw new st}validatePlayerTurn(t){const{profiles:e,customData:s}=t,{playerId:n}=s;if(typeof n!="string")throw new E;const{finished:a}=e[n];if(a)throw new gt}async getMatchAsync(t){const{id:e}=t;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):{}}updateMatchData(t,e){const{customData:s}=t,{whitePlayerId:n,blackPlayerId:a,whitePlayerScore:i,blackPlayerScore:r,whitePlayerFinish:o,blackPlayerFinish:l}=e,d=n===s.playerId,h=d?n:a,y=d?a:n;t.customData.playerId=h,t.customData.opponentId=y,t.profiles[h]||(t.profiles[h]={id:h,name:"",photo:"",finished:!1}),t.profiles[y]||(t.profiles[y]={id:y,name:"",photo:"",finished:!1});const g=d?i:r,A=d?r:i;t.profiles[h].score=g,t.profiles[y].score=A;const I=d?o:l,w=d?l:o;t.profiles[h].finished=I,t.profiles[y].finished=w}};c(ui,"ContinueMatchHandler");let js=ui;const pi=class pi extends D{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesCurrentScoreAsync();e&&this.sendMessageAsync(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:n,opponentId:a}=s;if(!e||typeof e!="string")throw new z;if(!n||typeof n!="string")throw new B;if(!a||typeof a!="string")throw new _}async createWideframesCurrentScoreAsync(){try{const{player:t,frameCapture:e}=this.game,{playerId:s,photo:n}=t.getPlayer(),{profiles:a}=this.match.getMatchState(),{score:i=0}=a[s]||{};return await e.wideframe.renderShareScore({playerId:s,playerPhoto:n,playerScore:i})}catch(t){return console.warn("createWideframesCurrentScoreAsync",t),null}}async sendMessageAsync(t,e){const{id:s,profiles:n,customData:a}=t,{playerId:i,opponentId:r}=a;if(!i||typeof i!="string")throw new E;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const{name:o}=n[i],l={data:{type:ve.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"ChÆ¡i ngay"}},text:{default:`${o} made an update.`,localizations:{vi_VN:`${o} Ä‘Ã£ cáº­p nháº­t tráº­n Ä‘áº¥u. ChÆ¡i ngay!`}},image:e,strategy:"LAST",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(l)}};c(pi,"SendUpdateMessageHandler");let Ws=pi;const yi=class yi extends P{async processAsync(t){try{this.startLog(t);const{contextId:e,matchId:s,playerId:n,opponentId:a}=t,i=new b(this),r=new Te(this,{contextId:e});i.setNext(r);const o=new R(this,{id:s,mode:G.CHALLENGE_FRIEND,customData:{playerId:n,opponentId:a}});r.setNext(o);const l=new js(this);o.setNext(l);const d=new X(this);l.setNext(d);const h=new W(this);d.setNext(h);const y=new Ws(this);h.setNext(y);const g=new V(this);y.setNext(g);const A=new N(this);g.setNext(A);const I=this.match.getMatchState();await i.processAsync(I)}finally{this.endLog()}}};c(yi,"ContinueChallengeMatchConcrete");let Ks=yi;const{Plugins:fl,Utils:gl}=p,{Analytics:ml}=fl,{String:yo,Valid:fo}=gl,fi=class fi extends D{async processAsync(t){super.processAsync(t);const{customData:e,mode:s,startAt:n,finishAt:a}=t,{level:i}=e;this.validateMode(s),this.validateLevel(i);const{analytics:r}=this.game,o=Math.floor((a-n)/1e3);r.event(ml.Events.MATCH_END,{level:i,game_mode:yo.toUpperCamelCase(s),level_name:this.getLevelName(i),time_played:o}),await this.nextAsync(t)}validateMode(t){if(!fo.isString(t))throw new et}validateLevel(t){if(!fo.isNumber(t))throw new Et}getLevelName(t){return`Level ${yo.padStart(t.toString(),5,"0")}`}};c(fi,"LogMatchFinishedHandler");let Ee=fi;const gi=class gi extends Error{constructor(t){super(t),this.name="LeaderboardNotExist",this.message=t??"Leaderboard not exist in game"}};c(gi,"LeaderboardNotExist");let Ct=gi;const mi=class mi extends Error{constructor(t){super(t),this.name="ScoreNotValid",this.message=t??"Score is not valid"}};c(mi,"ScoreNotValid");let it=mi;const{Utils:{Valid:wl},Configs:{Leaderboards:{LeaderboardList:Al}}}=p,wi=class wi extends D{constructor(e){super(e);u(this,"payload");this.payload={score:0,playerId:""}}async processAsync(e){super.processAsync(e),this.setupSetScorePayload(e),"submitGameResultsAsync"in GameSDK.extra&&await GameSDK.extra.submitGameResultsAsync(this.payload.score);for(const s of Al){const{Id:n,Mode:a}=s;!e.mode||!this.checkLeaderboardMode(a,e.mode)||this.setLeaderboardScoreAsync({leaderboardId:n,...this.payload})}await this.nextAsync(e)}checkLeaderboardMode(e,s){return e==="single"&&s!=="endless"||e==="endless"&&s==="endless"}async setupSetScorePayload(e){const{profiles:s,customData:n}=e,{playerId:a}=n;if(!a||!s[a])throw new j;const{score:i}=s[a];if(!wl.isNumber(i))throw new it;this.payload={score:i,playerId:a}}async setLeaderboardScoreAsync(e){try{const{playerId:s,score:n,leaderboardId:a}=e,i=this.game.leaderboard.getLeaderboardName(a);if(!i)throw new Ct;await this.game.leaderboard.setLeaderboardScoreAsync(i,s,n)}catch(s){console.warn("setLeaderboardScoreAsync",s)}}};c(wi,"PostGlobalLeaderboardsScoreHandler");let _e=wi;const{Dtos:Dl,Utils:Il}=p,{Valid:Nt,Object:vl}=Il,Ai=class Ai extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.validateMatchData(e);const{useAPI:s}=this.payload;if(s){const n=await this.finishMatchAsync(e),a=new Dl.Match.Data(n).toObject();this.updateMatchFromAPI(e,a)}else this.updateMatchData(e);this.updateMatchState(e),await this.nextAsync(e)}validateMatchData(e){const{status:s,profiles:n,customData:a}=e;if(s!==U.ACTIVE)throw new Pt;const{playerId:i}=a;if(!i||!vl.hasOwn(n,i))throw new st}updateMatchData(e){const{playerId:s}=e.customData;if(!Nt.isString(s))throw new E;e.profiles[s].finished=!0}updateMatchState(e){e.status=U.FINISHED,e.finishAt=Date.now()}async finishMatchAsync(e){const{id:s,profiles:n,customData:a}=e,{level:i,playerId:r}=a;if(!Nt.isString(r))throw new E;const{score:o}=n[r],{extraData:l}=this.payload,d={matchId:s??"",score:o,level:i,extraData:l};return this.match.api.getMatchAPI().finishMatchAsync(d)}updateMatchFromAPI(e,s){const{playerId:n,opponentId:a}=e.customData;if(!Nt.isString(n))throw new E;if(!Nt.isString(a))throw new _;const{whitePlayerId:i,whitePlayerScore:r,blackPlayerScore:o,whitePlayerFinish:l,blackPlayerFinish:d}=s,h=n===i,y=h?r:o,g=h?o:r,A=h?l:d,I=h?d:l;e.profiles[n].score=y,e.profiles[a].score=g,e.profiles[n].finished=A,e.profiles[a].finished=I}};c(Ai,"FinishMatchHandler");let Pe=Ai;const Di=class Di extends D{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesResultAsync(t);e&&this.progressSendFinishedMessage(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:n,opponentId:a}=s;if(!e||typeof e!="string")throw new z;if(!n||typeof n!="string")throw new B;if(!a||typeof a!="string")throw new _}async createWideframesResultAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:n}=t,{playerId:a,opponentId:i}=n;if(!a||!i)return null;const r=s[a],o=s[i],{photo:l,score:d=0,finished:h}=r,{photo:y,score:g=0,finished:A}=o;return await e.wideframe.renderResultChallenge({playerId:a,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:g,isPlayerFinished:!!h,isOpponentFinished:!!A})}catch(e){return console.warn("createWideframesResultAsync",e),null}}progressSendFinishedMessage(t,e){const{profiles:s,customData:n}=t,{playerId:a,opponentId:i}=n;if(!a||typeof a!="string")throw new E;if(!i||typeof i!="string")throw new _;const{score:r=0,finished:o}=s[a],{score:l=0,finished:d}=s[i];o?this.sendFinishMessageAsync(t,e):d&&r>l?this.sendBestScoreMessageAsync(t,e):this.sendPlayTurnMessageAsync(t,e)}async sendFinishMessageAsync(t,e){const{id:s,profiles:n,customData:a}=t,{playerId:i,opponentId:r}=a;if(!i||typeof i!="string")throw new E;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const{name:o}=n[i],l={data:{type:ve.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r,status:U.FINISHED},action:"CUSTOM",template:"finished",cta:{default:"See result",localizations:{vi_VN:"Xem káº¿t quáº£"}},text:{default:`${o} just finished. Check them now.`,localizations:{vi_VN:`${o} vá»«a hoÃ n thÃ nh mÃ n chÆ¡i. Nháº¥n Ä‘á»ƒ xem káº¿t quáº£ tráº­n Ä‘áº¥u.`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(l)}async sendPlayTurnMessageAsync(t,e){const{id:s,profiles:n,customData:a}=t,{playerId:i,opponentId:r}=a;if(!i||typeof i!="string")throw new E;const{name:o,score:l}=n[i],d={data:{type:ve.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r,status:U.ACTIVE},action:"CUSTOM",template:"finished",cta:{default:"Play",localizations:{vi_VN:"ChÆ¡i ngay"}},text:{default:`${o} got ${l} scores. So easy! Can you?`,localizations:{vi_VN:`${o} Ä‘Ã£ Ä‘áº¡t ${l} Ä‘iá»ƒm! Nháº¥n ChÆ¡i Ä‘á»ƒ so tÃ i!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(d)}async sendBestScoreMessageAsync(t,e){const{id:s,profiles:n,customData:a}=t,{playerId:i,opponentId:r}=a;if(!i||typeof i!="string")throw new E;const{name:o,score:l}=n[i],d={data:{type:ve.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r,status:U.FINISHED},action:"CUSTOM",template:"pass_score",cta:{default:"See result",localizations:{vi_VN:"Xem káº¿t quáº£"}},text:{default:`${o} beat your high score. Their score: ${l}`,localizations:{vi_VN:`${o} Ä‘Ã£ vÆ°á»£t qua Ä‘iá»ƒm sá»‘ cá»§a báº¡n, vá»›i ${l} Ä‘iá»ƒm!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(d)}};c(Di,"SendFinishedMessageHandler");let Hs=Di;const Ii=class Ii extends D{async processAsync(t){super.processAsync(t),this.setPlayerBestScore(t),await this.nextAsync(t)}setPlayerBestScore(t){const{profiles:e,customData:s}=t,{playerId:n}=s;if(!n||!e[n])throw new j;const{player:a}=this.game,i=a.getBestScore()||0,{score:r=0}=e[n];r<=i||(a.setBestScore(r),e[n].bestScore=r)}};c(Ii,"SetPlayerBestScoreHandler");let Re=Ii;const vi=class vi extends P{async processAsync(t){try{this.startLog(t);const{extraData:e}=t??{},s=new b(this),n=new Pe(this,{useAPI:!0,extraData:e});s.setNext(n);const a=new Hs(this);n.setNext(a);const i=new Ee(this);a.setNext(i);const r=new Re(this);i.setNext(r);const o=new _e(this);r.setNext(o);const l=new N(this);o.setNext(l);const d=this.match.getMatchState();await s.processAsync(d)}finally{this.endLog()}}};c(vi,"FinishChallengeMatchConcrete");let qs=vi;const Ei=class Ei extends Error{constructor(t){super(t),this.name="ContextAreSolo",this.message=t??"Context are solo"}};c(Ei,"ContextAreSolo");let zs=Ei;const Pi=class Pi extends Error{constructor(t){super(t),this.name="ContextNotChallenge",this.message=t??"Context is not a challenge"}};c(Pi,"ContextNotChallenge");let Ys=Pi;const Si=class Si extends Error{constructor(t){super(t),this.name="NetworkFailure",this.message=t??"Network failure"}};c(Si,"NetworkFailure");let Qs=Si;const{Utils:El,Dtos:Pl}=p,{Array:Sl,Object:xl}=El,xi=class xi extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.checkCurrentContext();const s=await this.getOpponentIdFromContextAsync();e.customData.opponentId=s,await this.nextAsync(e)}checkCurrentContext(){const e=GameSDK.context.getID();if(typeof e!="string")throw new B;if(e==="SOLO")throw new zs}async getOpponentIdFromContextAsync(){const{ignoreId:e}=this.payload,s=await this.getContextPlayers([e]);if(s.length>1)throw new Ys;let n=Z;return s.length===1&&(n=s[0]),n.playerId}async getContextPlayers(e){try{const s=await GameSDK.context.getPlayersAsync(),n=[];for(const a of s){const i=a.getID();if(e.indexOf(i)>-1)continue;const r=a.getName();if(!r)continue;const o=a.getPhoto();n.push(new Pl.Player.Info({playerId:i,name:r,photo:o}).toObject())}return Sl.unique(n)}catch(s){if(xl.hasOwn(s,"code")&&s.code==="NETWORK_FAILURE")throw new Qs;return[]}}};c(xi,"GetOpponentChallengeContextHandler");let Lt=xi;const bi=class bi extends Error{constructor(t){super(t),this.name="ContextIsTournament",this.message=t??"Context is a tournament"}};c(bi,"ContextIsTournament");let rt=bi;const{Object:bl}=p.Utils,Ci=class Ci extends D{async processAsync(t){super.processAsync(t);const e=await this.chooseAsync();await this.checkContextTournament(),t.customData.contextId=e,await this.nextAsync(t)}async chooseAsync(){try{await GameSDK.context.chooseAsync({filters:["INCLUDE_EXISTING_CHALLENGES"],minSize:2,maxSize:2})}catch(e){if(!bl.hasOwn(e,"code")||e.code!=="SAME_CONTEXT")throw e}const t=GameSDK.context.getID();if(typeof t!="string")throw new nt;return t}async checkContextTournament(){try{if(!GameSDK.context.getID())return;throw"getTournamentAsync"in GameSDK?(await GameSDK.getTournamentAsync(),new rt):new S("getTournamentAsync")}catch(t){if(t instanceof rt)throw t}}};c(Ci,"ChooseContextHandler");let Xs=Ci;const Ni=class Ni extends P{async processAsync(t){try{this.startLog(t);const{playerId:e}=t,s=new b(this),n=new Xs(this);s.setNext(n);const a=new R(this,{mode:G.CHALLENGE_FRIEND,customData:{playerId:e}});n.setNext(a);const i=new Lt(this,{ignoreId:e});a.setNext(i);const r=new xt(this,{extraData:t.extraData});i.setNext(r);const o=new X(this);r.setNext(o);const l=new W(this);o.setNext(l);const d=new V(this);l.setNext(d);const h=new bt(this);d.setNext(h);const y=new N(this);h.setNext(y);const g=this.match.getMatchState();await s.processAsync(g)}finally{this.endLog()}}};c(Ni,"InviteFriendsConcrete");let Js=Ni;const Li=class Li extends Error{constructor(t){super(t),this.name="JoinMatchFailed",this.message=t??"Join match failed"}};c(Li,"JoinMatchFailed");let Zs=Li;const Oi=class Oi extends Error{constructor(t){super(t),this.name="MatchAreFinished",this.message=t??"Match are finished"}};c(Oi,"MatchAreFinished");let en=Oi;const Ti=class Ti extends Error{constructor(t){super(t),this.name="OtherPlayerHasJoinedMatch",this.message=t??"Other player has joined match"}};c(Ti,"OtherPlayerHasJoinedMatch");let tn=Ti;const{Dtos:Cl}=p,_i=class _i extends D{async processAsync(t){super.processAsync(t),this.validateMatchData(t);const e=await this.joinMatchAsync(t),s=new Cl.Match.Data(e).toObject();this.validateJoinMatchData(t,s),this.updateMatchData(t,s),await this.nextAsync(t)}validateMatchData(t){const{status:e}=t;if(e!==U.OPEN)throw new Oe}validateJoinMatchData(t,e){const{id:s,customData:n}=t,{_id:a,blackPlayerId:i,whitePlayerId:r,whitePlayerFinish:o,blackPlayerFinish:l}=e,d=i===n.playerId,h=r===n.opponentId;if(typeof a!="string"||a!==s||!h)throw console.warn("ðŸ¤– ? matchData",e),new Zs;if(o&&l)throw new en;if(!d)throw new tn}async joinMatchAsync(t){const{id:e}=t;return e?this.match.api.getMatchAPI().joinMatchAsync(e):{}}updateMatchData(t,e){const{customData:s}=t,{whitePlayerId:n,blackPlayerId:a,whitePlayerScore:i,blackPlayerScore:r,whitePlayerFinish:o,blackPlayerFinish:l}=e,d=n===s.playerId,h=d?n:a,y=d?a:n;t.customData.playerId=h,t.customData.opponentId=y,t.profiles[h]||(t.profiles[h]={id:h,name:"",photo:"",finished:!1}),t.profiles[y]||(t.profiles[y]={id:y,name:"",photo:"",finished:!1});const g=d?i:r,A=d?r:i;t.profiles[h].score=g,t.profiles[y].score=A;const I=d?o:l,w=d?l:o;t.profiles[h].finished=I,t.profiles[y].finished=w}};c(_i,"JoinMatchHandler");let sn=_i;const Ri=class Ri extends D{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesAcceptedAsync(t);e&&this.sendMessageAsync(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:n,opponentId:a}=s;if(!e||typeof e!="string")throw new z;if(!n||typeof n!="string")throw new B;if(!a||typeof a!="string")throw new _}async createWideframesAcceptedAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:n}=t,{playerId:a,opponentId:i}=n;if(!a||!i)return null;const r=s[a],o=s[i],{photo:l,score:d=0,finished:h}=r;if(h)return null;const{photo:y,score:g=0,finished:A}=o;return A?await e.wideframe.renderResultChallenge({playerId:a,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:g,isPlayerFinished:!1,isOpponentFinished:!0}):null}catch(e){return console.warn("createWideframesAcceptedAsync",e),null}}async sendMessageAsync(t,e){const{id:s,profiles:n,customData:a}=t,{playerId:i,opponentId:r}=a;if(!i||typeof i!="string")throw new E;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const{name:o}=n[i],l={data:{type:ve.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"ChÆ¡i ngay"}},text:{default:`${o} accepted the challenge.`,localizations:{vi_VN:`${o} Ä‘Ã£ cháº¥p nháº­n tham gia tráº­n Ä‘áº¥u.`}},image:e,strategy:"LAST",notification:"PUSH"};await GameSDK.extra.updateAsync(l)}};c(Ri,"SendAcceptedMessageHandler");let nn=Ri;const Mi=class Mi extends P{async processAsync(t){try{this.startLog(t);const{matchId:e,playerId:s,opponentId:n}=t,a=new b(this),i=new R(this,{id:e,mode:G.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:n}});a.setNext(i);const r=new sn(this);i.setNext(r);const o=new X(this);r.setNext(o);const l=new W(this);o.setNext(l);const d=new nn(this);l.setNext(d);const h=new V(this);d.setNext(h);const y=new N(this);h.setNext(y);const g=this.match.getMatchState();await a.processAsync(g)}finally{this.endLog()}}};c(Mi,"JoinChallengeMatchConcrete");let an=Mi;const go={_id:"",status:"",winnerId:"",whitePlayerId:"",blackPlayerId:"",whitePlayerScore:0,blackPlayerScore:0,whitePlayerFinish:!1,blackPlayerFinish:!1},{Valid:ee}=p.Utils,te="is invalid",$i=class $i extends F{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateId(t){(!ee.isString(t)||!t)&&this.exception("_id",te)}validateStatus(t){(!ee.isString(t)||!t)&&this.exception("status",te)}validateWinnerId(t){t!==null&&(!ee.isString(t)||!t)&&this.exception("winnerId",te)}validateWhitePlayerId(t){(!ee.isString(t)||!t)&&this.exception("whitePlayerId",te)}validateBlackPlayerId(t){(!ee.isString(t)||!t)&&this.exception("blackPlayerId",te)}validateWhitePlayerScore(t){ee.isNumber(t)||this.exception("whitePlayerScore",te)}validateBlackPlayerScore(t){ee.isNumber(t)||this.exception("blackPlayerScore",te)}validateWhitePlayerFinish(t){ee.isBoolean(t)||this.exception("whitePlayerFinish",te)}validateBlackPlayerFinish(t){ee.isBoolean(t)||this.exception("blackPlayerFinish",te)}toObject(){return super.toObject()}static getDefaultData(){return go}};c($i,"RespMatchDataDtos");let ot=$i;ot.addDefaultData(go);const Gi=class Gi extends Error{constructor(t){super(t),this.name="MatchAreNotFinished",this.message=t||"Match are not finished"}};c(Gi,"MatchAreNotFinished");let rn=Gi;const Fi=class Fi extends Error{constructor(t){super(t),this.name="OpponentNotFinishedMatch",this.message=t||"Opponent not finished match"}};c(Fi,"OpponentNotFinishedMatch");let on=Fi;const ki=class ki extends D{async processAsync(t){super.processAsync(t),this.validateMatchData(t);const e=await this.getMatchAsync(t),s=new ot(e).toObject();this.validateResultMatchData(t,s),this.updateMatchData(t,s),this.validatePlayerTurn(t),this.validateOpponentTurn(t),await this.nextAsync(t)}validateMatchData(t){const{id:e}=t;if(typeof e!="string")throw new z}validateResultMatchData(t,e){const{id:s}=t,{_id:n,whitePlayerFinish:a,blackPlayerFinish:i}=e;if(typeof n!="string"||n!==s)throw new tt;if(!a&&!i)throw new rn}validatePlayerTurn(t){const{profiles:e,customData:s}=t,{playerId:n}=s;if(typeof n!="string")throw new E;const{finished:a}=e[n];if(!a)throw new St}validateOpponentTurn(t){const{profiles:e,customData:s}=t,{opponentId:n}=s;if(typeof n!="string")throw new _;const{finished:a}=e[n];if(!a)throw new on}async getMatchAsync(t){const{id:e}=t;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):{}}updateMatchData(t,e){const{customData:s}=t,{whitePlayerId:n,blackPlayerId:a,whitePlayerScore:i,blackPlayerScore:r,whitePlayerFinish:o,blackPlayerFinish:l}=e,d=n===s.playerId,h=d?n:a,y=d?a:n;t.customData.playerId=h,t.customData.opponentId=y,t.profiles[h]||(t.profiles[h]={id:h,name:"",photo:"",finished:!0}),t.profiles[y]||(t.profiles[y]={id:y,name:"",photo:"",finished:!0});const g=d?i:r,A=d?r:i;t.profiles[h].score=g,t.profiles[y].score=A;const I=d?o:l,w=d?l:o;t.profiles[h].finished=I,t.profiles[y].finished=w}};c(ki,"ResultMatchHandler");let cn=ki;const Vi=class Vi extends P{async processAsync(t){try{this.startLog(t);const{matchId:e,playerId:s,opponentId:n}=t,a=new b(this),i=new R(this,{id:e,mode:G.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:n}});a.setNext(i);const r=new cn(this);i.setNext(r);const o=new X(this);r.setNext(o);const l=new N(this);o.setNext(l);const d=this.match.getMatchState();await a.processAsync(d)}finally{this.endLog()}}};c(Vi,"ResultChallengeMatchConcrete");let ln=Vi;const Ui=class Ui extends P{constructor(){super(...arguments);u(this,"fallbackSingleMode");u(this,"startFLowChallengeFriend",c(async e=>{try{return await this.match.challenge.invite.processAsync(e),!0}catch(s){return s}},"startFLowChallengeFriend"));u(this,"startFlowTournament",c(async e=>{try{const s=GameSDK.context.getID();if(typeof s!="string")throw new B;await this.match.tournament.continue.processAsync({playerId:e,contextId:s})}catch{await this.startFlowSingle(e)}},"startFlowTournament"));u(this,"startFlowSingle",c(async e=>{if(!this.fallbackSingleMode){console.warn("Fallback single mode is not enabled");return}await this.match.single.start.processAsync({playerId:e})},"startFlowSingle"))}async processAsync(e){try{this.startLog(e);const{playerId:s,extraData:n,fallbackSingleMode:a}=e;this.fallbackSingleMode=a;const i=await this.startFLowChallengeFriend({playerId:s,extraData:n});if(i===!0)return;i instanceof rt?await this.startFlowTournament(s):await this.startFlowSingle(s)}finally{this.endLog()}}};c(Ui,"ChooseContextConcrete");let dn=Ui;const Bi=class Bi extends D{async processAsync(t){super.processAsync(t),this.setPlayerEndlessScore(t),await this.nextAsync(t)}setPlayerEndlessScore(t){const{profiles:e,customData:s}=t,{playerId:n}=s;if(!n||!e[n])throw new j;const{player:a}=this.game,i=a.getBestEndlessScore()??0,{endlessScore:r=0}=e[n],o=i<r?r:i;a.setBestEndlessScore(o),e[n].bestEndlessScore=o}};c(Bi,"SetPlayerEndlessScoreHandler");let hn=Bi;const ji=class ji extends P{async processAsync(){try{this.startLog();const t=new b(this),e=new Pe(this,{useAPI:!1});t.setNext(e);const s=new Ee(this);e.setNext(s);const n=new hn(this);s.setNext(n);const a=new _e(this);n.setNext(a);const i=new N(this);a.setNext(i);const r=this.match.getMatchState();await t.processAsync(r)}finally{this.endLog()}}};c(ji,"FinishEndlessConcrete");let un=ji;const Wi=class Wi extends Error{constructor(t){super(t),this.name="ProfileIdNotDefined",this.message=t??"Profile id is not defined"}};c(Wi,"ProfileIdNotDefined");let pn=Wi;const{Dtos:Nl}=p,Ki=class Ki extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{profileId:s}=this.payload;if(!s)throw new pn;const{player:n}=this.game,a=n.getPlayerId();let i;if(s===a)i=this.getPlayerProfile();else if(i=await this.getProfileAsync(s),!i)throw new j;this.updateMatchData(i,e),await this.nextAsync(e)}getPlayerProfile(){const{player:e}=this.game,{playerId:s,name:n,photo:a,locale:i}=e.getPlayer();return{playerId:s,name:n,photo:a,locale:i}}async getProfileAsync(e){const{profile:s}=this.game;return await s.requestProfiles([e]),s.getProfiles()[e]}updateMatchData(e,s){const{playerId:n,name:a,photo:i}=e,r=new Nl.Match.Profile({id:n,name:a,photo:i}).toObject();s.profiles[n]=r}};c(Ki,"GetProfileHandler");let Se=Ki;const Hi=class Hi extends P{async processAsync(t){try{this.startLog(t);const{playerId:e}=t,s=new b(this),n=new Te(this,{contextId:"SOLO"});s.setNext(n);const a=new R(this,{id:"234567",mode:G.ENDLESS,customData:{playerId:e}});n.setNext(a);const i=new W(this);a.setNext(i);const r=new Se(this,{profileId:e});i.setNext(r);const o=new V(this);r.setNext(o);const l=new N(this);o.setNext(l);const d=this.match.getMatchState();await s.processAsync(d)}finally{this.endLog()}}};c(Hi,"StartEndlessConcrete");let yn=Hi;const qi=class qi extends Error{constructor(t){super(t),this.name="LeaderboardIdNotValid",this.message=t??"Leaderboard id is not valid"}};c(qi,"LeaderboardIdNotValid");let xe=qi;const{Valid:mo}=p.Utils,zi=class zi extends D{constructor(e,s){super(e);u(this,"payload");u(this,"leaderboardPayload");this.payload=s}async processAsync(e){super.processAsync(e),this.setupSetScorePayload(e),"submitGameResultsAsync"in GameSDK.extra&&await GameSDK.extra.submitGameResultsAsync(this.payload.score),this.setLeaderboardScoreAsync(),await this.nextAsync(e)}async setupSetScorePayload(e){const{profiles:s,customData:n}=e,{playerId:a}=n;if(!a||!s[a])throw new j;const{score:i,leaderboardId:r}=this.payload;if(!mo.isNumber(i))throw new it;if(!mo.isString(r))throw new xe;this.leaderboardPayload={score:i,playerId:a,leaderboardId:r}}async setLeaderboardScoreAsync(){try{const{playerId:e,score:s,leaderboardId:n}=this.leaderboardPayload,a=this.game.leaderboard.getLeaderboardName(n);if(!a)throw new Ct;await this.game.leaderboard.setLeaderboardScoreAsync(a,e,s)}catch(e){console.warn("setLeaderboardScoreAsync",e)}}};c(zi,"SetLeaderboardScoreHandler");let Ot=zi;const{Valid:Ll}=p.Utils,Yi=class Yi extends Ot{constructor(t){super(t,{score:0,leaderboardId:""})}async setupSetScorePayload(t){const{profiles:e,customData:s}=t,{playerId:n,leaderboardId:a}=s;if(!a)throw new xe;if(!n||!e[n])throw new j;const{score:i}=e[n];if(!Ll.isNumber(i))throw new it;this.payload.score=i,this.payload.leaderboardId=a,super.setupSetScorePayload(t)}};c(Yi,"PostLeaderboardScoreHandler");let ct=Yi;const Qi=class Qi extends D{async processAsync(t){super.processAsync(t),this.validateData(t),this.progressSendGroupMessage(t),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:n,opponentId:a}=s;if(!e||typeof e!="string")throw new z;if(!n||typeof n!="string")throw new B;if(!a||typeof a!="string")throw new _}async createWideframesResultGroupAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:n}=t,{playerId:a,opponentId:i}=n;if(!a||!i)return null;const r=s[a],o=s[i],{photo:l,score:d=0}=r,{photo:h,score:y=0}=o;return await e.wideframe.renderResultChallenge({playerId:a,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:h,opponentScore:y,isPlayerFinished:!0,isOpponentFinished:!0})}catch(e){return console.warn("createWideframesResultGroupAsync",e),null}}async createWideframesBestScoreAsync(t){try{const{player:e,frameCapture:s}=this.game,{playerId:n}=t.customData,{playerId:a,photo:i,data:r}=e.getPlayer();if(n!==a)return null;const{score:o}=r||{};return await s.wideframe.renderShareScore({playerId:a,playerPhoto:i,playerScore:o})}catch(e){return console.warn("createWideframesBestScoreAsync",e),null}}async progressSendGroupMessage(t){const{profiles:e,customData:s}=t,{playerId:n,opponentId:a}=s;if(a&&typeof a=="string"){if(!n||typeof n!="string")throw new E;const{score:r=0}=e[n]||{},{score:o=0}=e[a]||{};if(r>o){const l=await this.createWideframesResultGroupAsync(t);if(!l)return;this.sendBestScoreMessageAsync(t,l);return}}const i=await this.createWideframesBestScoreAsync(t);i&&this.sendChallengeMessageAsync(t,i)}async sendBestScoreMessageAsync(t,e){const{profiles:s,customData:n}=t,{playerId:a}=n;if(!a||typeof a!="string")throw new E;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const{name:i,score:r}=s[a],l={data:{type:this.game.context.getSessionContextTypes().MATCHING_GROUP,playerId:a,playerName:i,playerScore:r},action:"CUSTOM",template:"play_turn",cta:{default:"Play",localizations:{vi_VN:"ChÆ¡i"}},text:{default:`${i} beats your high score. Their score: ${r}.`,localizations:{vi_VN:`${i} vá»«a vÆ°á»£t Ä‘iá»ƒm sá»‘ cao nháº¥t cá»§a báº¡n! ChÆ¡i láº§n ná»¯a chá»©?`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(l)}async sendChallengeMessageAsync(t,e){const{profiles:s,customData:n}=t,{playerId:a}=n;if(!a||typeof a!="string")throw new E;const{name:i,score:r}=s[a],l={data:{type:this.game.context.getSessionContextTypes().MATCHING_GROUP,playerId:a,playerName:i,playerScore:r},action:"CUSTOM",template:"play_turn",cta:{default:"Play",localizations:{vi_VN:"ChÆ¡i ngay"}},text:{default:`${i} got ${r} scores. So easy! Can you?`,localizations:{vi_VN:`${i} Ä‘Ã£ Ä‘áº¡t ${r} Ä‘iá»ƒm! QuÃ¡ dá»… luÃ´n. ChÆ¡i láº¡i nÃ o!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(l)}};c(Qi,"SendGroupMessageHandler");let fn=Qi;const Xi=class Xi extends P{async processAsync(){try{this.startLog();const t=new b(this),e=new Pe(this,{useAPI:!1});t.setNext(e);const s=new fn(this);e.setNext(s);const n=new Ee(this);s.setNext(n);const a=new Re(this);n.setNext(a);const i=new ct(this);a.setNext(i);const r=new N(this);i.setNext(r);const o=this.match.getMatchState();await t.processAsync(o)}finally{this.endLog()}}};c(Xi,"FinishGroupConcrete");let gn=Xi;const{Dtos:Ol}=p,Ji=class Ji extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.updateProfileMatchData(e),await this.nextAsync(e)}updateProfileMatchData(e){const{id:s}=this.payload,{profiles:n}=e;if(!n[s])throw new j;const a={...n[s],...this.payload},i=new Ol.Match.Profile(a).toObject();n[i.id]=i}};c(Ji,"SetProfileDataHandler");let Me=Ji;const Zi=class Zi extends P{async processAsync(t){try{this.startLog(t);const{playerId:e,opponentId:s,opponentScore:n}=t,a=new b(this),i=new R(this,{id:"7749",mode:G.MATCHING_GROUP,customData:{playerId:e,opponentId:s}});a.setNext(i);const r=new X(this);i.setNext(r);const o=new Me(this,{id:e,score:n});r.setNext(o);const l=new W(this);o.setNext(l);const d=new V(this);l.setNext(d);const h=new N(this);d.setNext(h);const y=this.match.getMatchState();await a.processAsync(y)}finally{this.endLog()}}};c(Zi,"JoinGroupConcrete");let mn=Zi;const er=class er extends Error{constructor(t){super(t),this.name="MatchGroupNotSupported",this.message=t??"Match group is not supported"}};c(er,"MatchGroupNotSupported");let Tt=er;const tr=class tr extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),await this.checkMatchGroupSupported();const s=await this.matchingGroup();e.customData.contextId=s,await this.nextAsync(e)}async checkMatchGroupSupported(){if(!("getSupportedAPIs"in GameSDK))throw new S("getSupportedAPIs");if(!("checkCanPlayerMatchAsync"in GameSDK.extra))throw new S("checkCanPlayerMatchAsync");if(!(GameSDK.getSupportedAPIs().indexOf("checkCanPlayerMatchAsync")>-1))throw new Tt;if(!await GameSDK.extra.checkCanPlayerMatchAsync())throw new Tt}async matchingGroup(){if(!("matchPlayerAsync"in GameSDK.extra))throw new S("matchPlayerAsync");const{matchTag:e,autoSwitch:s=!1,onlyExisting:n=!1}=this.payload;await GameSDK.extra.matchPlayerAsync(e,s,n);const a=GameSDK.context.getID();if(typeof a!="string")throw new nt;return a}};c(tr,"GroupContextHandler");let wn=tr;const sr=class sr extends P{async processAsync(t){try{this.startLog(t);const{matchTag:e,playerId:s,options:n}=t,a=new b(this),i=new wn(this,{matchTag:e,...n});a.setNext(i);const r=new R(this,{id:"7749",mode:G.MATCHING_GROUP,customData:{playerId:s}});i.setNext(r);const o=new Lt(this,{ignoreId:s});r.setNext(o);const l=new W(this);o.setNext(l);const d=new X(this);l.setNext(d);const h=new V(this);d.setNext(h);const y=new N(this);h.setNext(y);const g=this.match.getMatchState();await a.processAsync(g)}finally{this.endLog()}}};c(sr,"StartGroupConcrete");let An=sr;const nr=class nr extends P{async processAsync(){try{this.startLog();const t=new b(this),e=new Pe(this,{useAPI:!1});t.setNext(e);const s=new Ee(this);e.setNext(s);const n=new Re(this);s.setNext(n);const a=new _e(this);n.setNext(a);const i=new N(this);a.setNext(i);const r=this.match.getMatchState();await t.processAsync(r)}finally{this.endLog()}}};c(nr,"FinishSingleConcrete");let Dn=nr;const ar=class ar extends P{async processAsync(t){try{this.startLog(t);const{playerId:e}=t,s=new b(this),n=new Te(this,{contextId:"SOLO"});s.setNext(n);const a=new R(this,{id:"123456",mode:G.SINGLE,customData:{playerId:e}});n.setNext(a);const i=new W(this);a.setNext(i);const r=new Se(this,{profileId:e});i.setNext(r);const o=new V(this);r.setNext(o);const l=new N(this);o.setNext(l);const d=this.match.getMatchState();await s.processAsync(d)}finally{this.endLog()}}};c(ar,"StartSingleConcrete");let In=ar;const{Plugins:Tl,Utils:_l}=p,{Analytics:Rl}=Tl,{String:Ml,Valid:$l}=_l,ir=class ir extends D{async processAsync(t){super.processAsync(t);const{mode:e,customData:s}=t;this.validateMode(e);const{analytics:n}=this.game,{tournamentId:a,leaderboardId:i}=s;n.event(Rl.Events.TOURNAMENT_START,{success:!0,game_mode:Ml.toUpperCamelCase(e),tournament_id:a,leaderboard_id:i}),await this.nextAsync(t)}validateMode(t){if(!$l.isString(t))throw new et}};c(ir,"LogTournamentStartHandler");let _t=ir;const rr=class rr extends Error{constructor(t){super(t),this.name="TournamentIdNotValid",this.message=t??"Tournament id is not valid"}};c(rr,"TournamentIdNotValid");let Rt=rr;const{Valid:vn}=p.Utils,or=class or extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{contextId:s}=this.payload;this.validateContextId(s);const n=await GameSDK.getTournamentAsync(),a=n.getID().toString();this.validateTournamentId(a);const i=JSON.parse(n.getPayload()||"{}"),{leaderboardId:r}=i;this.validateLeaderboardId(r),e.customData.contextId=s,e.customData.tournamentId=a,e.customData.leaderboardId=r,await this.nextAsync(e)}validateContextId(e){if(!vn.isString(e))throw new B}validateTournamentId(e){if(!vn.isString(e))throw new Rt}validateLeaderboardId(e){if(!vn.isString(e)||e==="")throw new xe}};c(or,"ContinueTournamentHandler");let En=or;const cr=class cr extends P{async processAsync(t){try{this.startLog(t);const{playerId:e,contextId:s}=t,n=new b(this),a=new En(this,{contextId:s});n.setNext(a);const i=new R(this,{id:"1997",mode:G.TOURNAMENT,customData:{playerId:e}});a.setNext(i);const r=new W(this);i.setNext(r);const o=new Se(this,{profileId:e});r.setNext(o);const l=new V(this);o.setNext(l);const d=new _t(this);l.setNext(d);const h=new N(this);l.setNext(h);const y=this.match.getMatchState();await n.processAsync(y)}finally{this.endLog()}}};c(cr,"ContinueTournamentConcrete");let Pn=cr;const{Plugins:Gl}=p,{Analytics:Fl}=Gl,lr=class lr extends D{async processAsync(t){super.processAsync(t);const{customData:e}=t,{analytics:s}=this.game,{tournamentId:n,leaderboardId:a}=e;s.event(Fl.Events.TOURNAMENT_CREATE,{success:!0,tournament_id:n,leaderboard_id:a}),await this.nextAsync(t)}};c(lr,"LogTournamentCreateHandler");let Sn=lr;const dr=class dr extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),await this.createTournamentAsync(),await this.updateMatchStateAsync(e),await this.nextAsync(e)}async createTournamentAsync(){const{name:e,score:s,customData:n}=this.payload;await GameSDK.tournament.createAsync({initialScore:s,config:{title:e,tournamentTitle:e},data:n})}async updateMatchStateAsync(e){try{if(!("getTournamentAsync"in GameSDK))throw new S("getTournamentAsync");const s=await GameSDK.getTournamentAsync(),n=s.getContextID(),a=s.getID().toString(),{playerId:i}=this.payload;e.customData.playerId=i,e.customData.contextId=n,e.customData.tournamentId=a}catch(s){if(s instanceof S)return}}};c(dr,"CreateTournamentHandler");let xn=dr;const{Valid:wo}=p.Utils,hr=class hr extends D{constructor(e,s){super(e);u(this,"payload");u(this,"leaderboardPayload");this.payload=s}async processAsync(e){super.processAsync(e),this.validatePayload(),await this.setupCreatePayload(e),await this.createLeaderboardAsync(e),await this.nextAsync(e)}validatePayload(){const{leaderboardId:e}=this.payload;if(!wo.isString(e))throw new xe}validatePlayerId(e){if(!wo.isString(e))throw new E}async setupCreatePayload(e){const{playerId:s}=e.customData;this.validatePlayerId(s);const{name:n,leaderboardId:a,customData:i}=this.payload;this.leaderboardPayload={_id:a,name:n??"",createdBy:s,description:JSON.stringify(i)}}async createLeaderboardAsync(e){const s=await this.game.leaderboard.createLeaderboardAsync(this.leaderboardPayload);e.customData.leaderboardId=s}};c(hr,"CreateLeaderboardHandler");let bn=hr;const ur=class ur extends P{async processAsync(t){try{this.startLog(t);const{playerId:e,name:s,score:n,leaderboardId:a,payload:i}=t,r=new b(this),o=new Te(this,{contextId:"SOLO"});r.setNext(o);const l=new xn(this,{name:s,score:n,playerId:e,customData:i});o.setNext(l);const d=new Se(this,{profileId:e});l.setNext(d);const h=new Me(this,{id:e,score:n});d.setNext(h);const y=new bn(this,{name:s,customData:i,leaderboardId:a});h.setNext(y);const g=new ct(this);y.setNext(g);const A=new Sn(this);g.setNext(A);const I=this.match.getMatchState();await r.processAsync(I)}finally{this.endLog()}}};c(ur,"CreateTournamentConcrete");let Cn=ur;const{Analytics:Ao}=p.Plugins,{Valid:kl}=p.Utils,pr=class pr extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.validateData(e),await this.postScoreTournamentAsync(e),await this.nextAsync(e)}validateData(e){const{profiles:s,customData:n}=e,{playerId:a}=n;if(this.validatePlayerId(a),!s[a])throw new j}validatePlayerId(e){if(!kl.isString(e))throw new E}getPlayerProfile(e){const{profiles:s,customData:n}=e,{playerId:a}=n;return this.validatePlayerId(a),s[a]}isNewBestScore(e){const s=this.getPlayerProfile(e),{score:n=0,bestScore:a=0}=s;return n>a}async postScoreTournamentAsync(e){const{analytics:s}=window.game,n=this.getPlayerProfile(e),{score:a=0}=n;let i=null,r=!1;const{checkBestScore:o}=this.payload,l=this.isNewBestScore(e);try{if(!("getTournamentAsync"in GameSDK))throw new S("getTournamentAsync");await GameSDK.getTournamentAsync(),!o||l?(i=Ao.Events.TOURNAMENT_SHARE,await GameSDK.tournament.shareAsync({score:a})):(i=Ao.Events.TOURNAMENT_POST_SCORE,await GameSDK.tournament.postScoreAsync(a)),r=!0}catch(d){console.warn("Post Score Tournament",d)}finally{i&&s.event(i,{success:r})}}};c(pr,"PostScoreTournamentHandler");let Nn=pr;const yr=class yr extends P{async processAsync(t){try{this.startLog(t);const{playerId:e,bestScore:s}=t,n=new b(this),a=new Pe(this,{useAPI:!1});n.setNext(a);const i=new Me(this,{id:e,bestScore:s});a.setNext(i);const r=new Nn(this,{checkBestScore:!1});i.setNext(r);const o=new Ee(this);r.setNext(o);const l=new Re(this);o.setNext(l);const d=new ct(this);l.setNext(d);const h=new _e(this);d.setNext(h);const y=new N(this);h.setNext(y);const g=this.match.getMatchState();await n.processAsync(g)}finally{this.endLog()}}};c(yr,"FinishTournamentConcrete");let Ln=yr;const{Valid:On,Object:Vl}=p.Utils,fr=class fr extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{tournamentId:s}=this.payload;this.validateTournamentId(s),await this.joinTournamentAsync(s);const n=await GameSDK.getTournamentAsync(),a=n.getContextID();this.validateContextId(a);const i=JSON.parse(n.getPayload()||"{}"),{leaderboardId:r}=i;this.validateLeaderboardId(r),e.customData.contextId=a,e.customData.tournamentId=s,e.customData.leaderboardId=r,await this.nextAsync(e)}validateTournamentId(e){if(!On.isString(e))throw new Rt}validateContextId(e){if(!On.isString(e))throw new B}validateLeaderboardId(e){if(!On.isString(e)||e==="")throw new xe}async joinTournamentAsync(e){if(!("tournament"in GameSDK))throw new S("tournament");try{await GameSDK.tournament.joinAsync(e)}catch(s){if(!Vl.hasOwn(s,"code")||s.code!=="SAME_CONTEXT")throw s}}};c(fr,"JoinTournamentHandler");let Tn=fr;const gr=class gr extends P{async processAsync(t){try{this.startLog(t);const{playerId:e,tournamentId:s}=t,n=new b(this),a=new Tn(this,{tournamentId:s});n.setNext(a);const i=new R(this,{id:"1997",mode:G.TOURNAMENT,customData:{playerId:e}});a.setNext(i);const r=new W(this);i.setNext(r);const o=new Se(this,{profileId:e});r.setNext(o);const l=new V(this);o.setNext(l);const d=new _t(this);l.setNext(d);const h=new N(this);d.setNext(h);const y=this.match.getMatchState();await n.processAsync(y)}finally{this.endLog()}}};c(gr,"JoinTournamentConcrete");let _n=gr;const{Dtos:Ul,Utils:Bl}=p,{Object:jl}=Bl,mr=class mr extends D{constructor(e,s){super(e);u(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.updateMatchCustomData(e),await this.nextAsync(e)}updateMatchCustomData(e){const s=jl.merge(e.customData,this.payload),n=new Ul.Match.CustomData(s).toObject();e.customData=n}};c(mr,"SetMatchCustomDataHandler");let Rn=mr;const Wl={id:null,mode:null,status:null,startAt:0,finishAt:0,profiles:{},customData:{...Fs}},{Configs:Do}=p,wr=class wr extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"base");u(this,"group");u(this,"single");u(this,"endless");u(this,"context");u(this,"challenge");u(this,"tournament");u(this,"api");u(this,"handler");u(this,"useCPUProfile")}init(){this.createMatchData(),this.createAPIHandler(),this.createBaseConcrete(),this.createConcreteFlows(),this.createConcreteHandlers()}setUseCPUProfile(e){this.useCPUProfile=e}createMatchData(){const{storage:e}=this.game;e.addStorage("match",Wl)}getMatchState(){const{storage:e}=this.game;return e.getStorage("match")}createBaseConcrete(){this.base=new P(this.game,this)}createConcreteFlows(){this.createGroupFlows(),this.createSingleFlows(),this.createEndlessFlows(),this.createContextFlows(),this.createChallengeFlows(),this.createTournamentFlows()}createConcreteHandlers(){this.handler={setProfileData:c(async e=>{const s=new Me(this.base,e);await this.processHandlerAsync(s)},"setProfileData"),setMatchCustomData:c(async e=>{const s=new Rn(this.base,e);await this.processHandlerAsync(s)},"setMatchCustomData"),setLeaderboardScore:c(async e=>{const s=new Ot(this.base,e);await this.processHandlerAsync(s)},"setLeaderboardScore")}}createAPIHandler(){const e={appId:Do.AppId,matchAPIHost:Do.ApiHost};this.api=new Rs(e)}createGroupFlows(){this.group={join:new mn(this.game,this),start:new An(this.game,this),finish:new gn(this.game,this)}}createSingleFlows(){this.single={start:new In(this.game,this),finish:new Dn(this.game,this)}}createEndlessFlows(){this.endless={start:new yn(this.game,this),finish:new un(this.game,this)}}createContextFlows(){this.context={choose:new dn(this.game,this)}}createChallengeFlows(){this.challenge={invite:new Js(this.game,this),friend:new Bs(this.game,this),join:new an(this.game,this),await:new Vs(this.game,this),result:new ln(this.game,this),finish:new qs(this.game,this),continue:new Ks(this.game,this)}}createTournamentFlows(){this.tournament={join:new _n(this.game,this),create:new Cn(this.game,this),finish:new Ln(this.game,this),continue:new Pn(this.game,this)}}processHandlerAsync(e){const s=this.getMatchState();return e.processAsync(s)}};c(wr,"MatchPlugin");let Mn=wr;const{Valid:be}=p.Utils,Ce="is invalid",Ar=class Ar extends F{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateLevel(t){(!be.isNumber(t)||t<0)&&this.exception("level",Ce)}validateRescued(t){(!be.isNumber(t)||t<0)&&this.exception("rescued",Ce)}validateContextId(t){be.isString(t)||this.exception("contextId",Ce)}validatePlayerId(t){be.isString(t)||this.exception("playerId",Ce)}validateOpponentId(t){be.isString(t)||this.exception("opponentId",Ce)}validateTournamentId(t){be.isString(t)||this.exception("tournamentId",Ce)}validateLeaderboardId(t){be.isString(t)||this.exception("leaderboardId",Ce)}toObject(){return super.toObject()}static getDefaultData(){return F.getDefaultData()}};c(Ar,"MatchCustomDataDtos");let Mt=Ar;Mt.addDefaultData(Fs);const{Valid:he}=p.Utils,ue="is invalid",Dr=class Dr extends F{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateId(t){(!he.isString(t)||!t)&&this.exception("id",ue)}validateName(t){(!he.isString(t)||!t)&&this.exception("name",ue)}validatePhoto(t){he.isString(t)||this.exception("photo",ue)}validateScore(t){(!he.isNumber(t)||t<0)&&this.exception("score",ue)}validateBestScore(t){(!he.isNumber(t)||t<0)&&this.exception("bestScore",ue)}validateEndlessScore(t){(!he.isNumber(t)||t<0)&&this.exception("endlessScore",ue)}validateBestEndlessScore(t){(!he.isNumber(t)||t<0)&&this.exception("bestEndlessScore",ue)}validateFinished(t){he.isBoolean(t)||this.exception("finished",ue)}toObject(){return super.toObject()}static getDefaultData(){return F.getDefaultData()}};c(Dr,"MatchProfileDtos");let $t=Dr;$t.addDefaultData({id:"",name:"Your Friend",photo:"./assets/images/others/avatar.png",score:0,bestScore:0,finished:!1,endlessScore:0,bestEndlessScore:0}),p.Dtos.Match={Data:ot,CustomData:Mt,Profile:$t};const{Utils:Kl}=p,{ApiHost:Hl}=p.Configs,ql=c(async f=>{let t="players";GameSDK.getSDKName()==="MsGames"&&(t="players?platform=ms-games");const e=await k(t,f,{},Hl,10);return Kl.Object.hasOwn(e,"data")?e.data||{}:{}},"updatePlayerProfileAsync"),{Utils:zl,Configs:Yl}=p,{AppId:Ql}=Yl,{Array:Xl,Object:Gt,Valid:Jl}=zl,Ir=class Ir extends L.Plugins.BasePlugin{init(){const{storage:t}=this.game;t.addStorage("player",le)}async saveToCloud(){try{const t=this.getPlayerData();await GameSDK.player.setDataAsync(t)}catch(t){console.warn(t)}}receiveData(t,e){const{storage:s}=this.game,{playerId:n,name:a,photo:i,locale:r}=t;s.setStorageData("player","playerId",n),s.setStorageData("player","name",a),s.setStorageData("player","photo",i),s.setStorageData("player","locale",r),e&&this.setPlayerData(e)}async syncProfileToServer(){const{storage:t}=this.game,e=this.getPlayer(),{playerId:s,name:n,photo:a,locale:i}=e;let r=this.getPlayerASID();!Jl.isString(r)&&"getASIDAsync"in GameSDK.player&&(r=await GameSDK.player.getASIDAsync()??r,t.setStorageData("player","ASID",`${r}`)),await ql({appId:Ql,ASID:r,playerId:s,name:n,photo:a,locale:i})}setPlayerDataByName(t,e){this.setPlayerData({[t]:e})}setPlayerData(t){const{storage:e}=this.game;e.setStorageData("player","data",t),this.saveToCloud()}setBestScore(t){this.setPlayerDataByName("score",t)}setBestEndlessScore(t){this.setPlayerDataByName("endlessScore",t)}setSetting(t,e){this.setPlayerDataByName("settings",{[t]:e})}setGameData(t){const e=this.getGameData()??{},s=Gt.merge(e,t);this.setPlayerDataByName("gameData",s)}async requestConnectedPlayers(){const{storage:t}=this.game,s=(await GameSDK.player.getConnectedPlayersAsync()).map(i=>{const r=i.getID(),o=i.getName(),l=i.getPhoto();return!r||!o||!l?null:new Ne({playerId:r,name:o,photo:l}).toObject()}),n=Xl.unique(s);if(n.length<1)return;const a=Gt.keyBy(n,"playerId");t.setStorageData("player","connectedPlayers",a)}getPlayer(){const{storage:t}=this.game;return t.getStorage("player")}getPlayerId(){const{storage:t}=this.game;return t.getStorageData("player","playerId")??""}getPlayerASID(){const{storage:t}=this.game;return t.getStorageData("player","ASID")??null}getPlayerLocale(){const{storage:t}=this.game;return t.getStorageData("player","locale")??""}getPlayerData(){const{storage:t}=this.game;return t.getStorageData("player","data")??le.data}getPlayerDataByKey(t){const e=this.getPlayerData();return Gt.hasOwn(e,t)?e[t]:null}getGameData(){return this.getPlayerDataByKey("gameData")}getPlayerSetting(t){const e=this.getPlayerSettings();return Gt.hasOwn(e,t)?e[t]:null}getPlayerSettings(){const{settings:t}=this.getPlayerData();return t}isFirstLogin(){return this.getPlayerDataByKey("isFirstLogin")??le.data.isFirstLogin}loggedIn(){this.setPlayerDataByName("isFirstLogin",!1)}getBestScore(){const{score:t}=this.getPlayerData();return t}getBestEndlessScore(){const{endlessScore:t}=this.getPlayerData();return t}getConnectedPlayers(){const{storage:t}=this.game;return t.getStorageData("player","connectedPlayers")??{}}getConnectedPlayerIds(t,e){const s=this.getConnectedPlayers();return Object.keys(s).slice(e,e+t)}getNotificationData(){return this.getPlayerDataByKey("notificationData")??le.data.notificationData}};c(Ir,"PlayerPlugin");let $n=Ir;const{Dtos:Io,Utils:Zl}=p,{Valid:M}=Zl,{score:vo,endlessScore:ed,settings:td,gameData:sd,isFirstLogin:nd,dailyRewarded:ad,notificationData:id}=le.data,$="is invalid",vr=class vr extends F{processData(t){this.validateStructure(t),t.settings=new Io.Player.Settings(t.settings).toObject(),t.gameData=new Io.Player.GameData(t.gameData).toObject(),this.validateData(t),this.setupData(t)}setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateScore(t){(!M.isNumber(t)||t<0)&&this.exception("score",$)}validateEndlessScore(t){(!M.isNumber(t)||vo<0)&&this.exception("endlessScore",$)}validateSettings(t){M.isObject(t)||this.exception("settings",$)}validateNotificationData(t){M.isObject(t)||this.exception("notificationData",$),(!("D1"in t)||!M.isObject(t.D1))&&this.exception("notificationData.D1",$),(!("D2"in t)||!M.isObject(t.D2))&&this.exception("notificationData.D2",$),(!("D3"in t)||!M.isObject(t.D3))&&this.exception("notificationData.D3",$),(!("D4"in t)||!M.isObject(t.D4))&&this.exception("notificationData.D4",$),(!("D5"in t)||!M.isObject(t.D5))&&this.exception("notificationData.D5",$),(!("D6"in t)||!M.isObject(t.D6))&&this.exception("notificationData.D6",$),(!("D7"in t)||!M.isObject(t.D7))&&this.exception("notificationData.D7",$)}validateGameData(t){M.isObject(t)||this.exception("gameData",$)}validateIsFirstLogin(t){M.isBoolean(t)||this.exception("isFirstLogin",$)}validateDailyRewarded(t){M.isObject(t)||this.exception("dailyRewarded",$)}toObject(){return super.toObject()}};c(vr,"PlayerDataDtos");let Ft=vr;Ft.addDefaultData({score:vo,endlessScore:ed,settings:td,gameData:sd,isFirstLogin:nd,dailyRewarded:ad,notificationData:id});const{Valid:Eo}=p.Utils,{level:rd,coins:od}=le.data.gameData,Er=class Er extends F{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateLevel(t){(!Eo.isNumber(t)||t<0)&&this.exception("level","is invalid")}validateCoins(t){(!Eo.isNumber(t)||t<0)&&this.exception("coins","is invalid")}toObject(){return super.toObject()}};c(Er,"PlayerGameDataDtos");let kt=Er;kt.addDefaultData({level:rd,coins:od});const{Valid:Vt}=p.Utils,{sound:cd,music:ld,vibrate:dd,language:hd}=le.data.settings,Ut="is invalid",Pr=class Pr extends F{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateSound(t){Vt.isBoolean(t)||this.exception("sound",Ut)}validateMusic(t){Vt.isBoolean(t)||this.exception("music",Ut)}validateVibrate(t){Vt.isBoolean(t)||this.exception("vibrate",Ut)}validateLanguage(t){(!Vt.isString(t)||!t)&&this.exception("language",Ut)}toObject(){return super.toObject()}};c(Pr,"PlayerSettingsDtos");let Bt=Pr;Bt.addDefaultData({sound:cd,music:ld,vibrate:dd,language:hd}),p.Dtos.Player={Info:Ne,Data:Ft,Settings:Bt,GameData:kt};const{Configs:ud,Utils:pd}=p,{Object:yd,String:fd}=pd,{ApiHost:gd,Mockup:md}=ud,Sr=class Sr{constructor(){u(this,"mockAPI")}async initMockAPI(){if(this.mockAPI)return;const t=(await oe(async()=>{const{default:e}=await v.import("./bundle/ProfileAPIMock.js");return{default:e}},void 0,v.meta.url)).default;if(typeof t!="function")throw new Error("Cannot load ProfileAPIMock");this.mockAPI=new t}async getPlayersAsync(t){const e=fd.params(t);let s;return md.Profile.Enabled?(await this.initMockAPI(),s=await this.mockAPI.getPlayersAsync(t)):s=await we(`players?${e}`,{},gd),!yd.hasOwn(s,"data")||!Array.isArray(s.data)?[]:s.data}};c(Sr,"ProfileAPI");let Gn=Sr;const Po={profiles:{},profileIds:[]},{Utils:wd,Dtos:Ad}=p,{Array:So,Valid:Dd,Object:Id,Function:vd}=wd,xr=class xr extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"profileAPI",new Gn)}init(){const{storage:e}=this.game;e.addStorage("profile",Po)}async requestProfiles(e){const s=this.getProfileIds(),n=So.difference(e,s);if(n.length<1)return;const i=So.chunk(n,400).map(d=>this.profileAPI.getPlayersAsync({playerIds:d})),o=(await vd.allSettled(i)).reduce((d,h)=>h.status==="fulfilled"?d.concat(h.value):d,[]);if(!this.validateProfilesResponse(o))return;const l=this.convertToProfiles(o);this.setProfiles(l)}getProfile(e){return this.getProfiles()[e]??null}getProfiles(){const{storage:e}=this.game;return e.getStorageData("profile","profiles")??Po.profiles}setProfiles(e){const{storage:s}=this.game;s.setStorageData("profile","profiles",e),s.setStorageData("profile","profileIds",Object.keys(e))}getProfileIds(){const{storage:e}=this.game;return e.getStorageData("profile","profileIds")??[]}validateProfilesResponse(e){return!(!Array.isArray(e)||e.length<1)}convertToProfiles(e){const s={};for(const n of e)Id.hasOwn(n,"playerId")&&Dd.isString(n.playerId)&&(s[n.playerId]=new Ad.Player.Info(n).toObject());return s}};c(xr,"ProfilePlugin");let Fn=xr;const xo="Save The Pets",{Utils:{Object:bo,Valid:Co,Browser:No}}=p,br=class br extends L.Plugins.BasePlugin{constructor(e){super(e);u(this,"storages");u(this,"storageLocalKeys",{});this.storages={}}async addStorage(e,s,n=!1){console.info("addStorage",e,s),this.storages[e]=s,n&&await this.initFromWebStorage(e,s)}async initFromWebStorage(e,s){this.storageLocalKeys[e]=!0;const n=await No.getIndexedDB(`${xo}_S_${e}`);if(!Co.isObject(n))return;const a=Object.keys(s);for(const i of a)bo.hasOwn(n,i)&&typeof s[i]==typeof n[i]&&this.setStorageData(e,i,n[i])}initStorageData(e,s,n){this.storages[e][s]=n}setStorageData(e,s,n){let a;if(Co.isObject(n)){const i=this.getStorageData(e,s);a=bo.merge(i,n)}else a=n;this.storages[e][s]=a}getStorageData(e,s){return this.getStorage(e)[s]}getStorage(e){return this.storages[e]}async updateToWebStorage(e){if(this.storageLocalKeys[e])return this.saveToWebStorage(e)}async saveToWebStorage(e){const s=this.getStorage(e);return No.setIndexedDB(`${xo}_S_${e}`,s)}};c(br,"StoragePlugin");let kn=br;const Cr=class Cr extends L.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"isVisible",!0);u(this,"browserPrefixes",["moz","ms","o","","webkit"]);u(this,"handleVisibilityChange",c(e=>{if(["focus","blur"].indexOf(e)>-1)return e==="focus"?this.onVisibleEvent():this.onHiddenEvent();const n=this.getBrowserPrefix();return this.getHiddenPropertyName(n)in document?this.onHiddenEvent():this.onVisibleEvent()},"handleVisibilityChange"))}init(){const e=this.getBrowserPrefix(),n=[this.getVisibilityEvent(e),"focus","blur"];for(const a of n)window.addEventListener(a,()=>{this.handleVisibilityChange(a)},!1),document.addEventListener(a,()=>{this.handleVisibilityChange(a)},!1);GameSDK.extra&&("onPause"in GameSDK.extra&&GameSDK.extra.onPause(()=>{this.handleVisibilityChange("blur")}),"onResume"in GameSDK.extra&&GameSDK.extra.onResume(()=>{this.handleVisibilityChange("focus")}))}isGameVisible(){return this.isVisible}getHiddenPropertyName(e){return e?`${e}Hidden`:"hidden"}getVisibilityEvent(e){return`${e||""}visibilitychange`}getBrowserPrefix(){for(const e of this.browserPrefixes)if(this.getHiddenPropertyName(e)in document)return e;return""}onVisibleEvent(){this.isVisible||(this.isVisible=!0,this.game.event.emit(p.Events.VISIBILITY_VISIBLE))}onHiddenEvent(){this.isVisible&&(this.isVisible=!1,this.game.event.emit(p.Events.VISIBILITY_HIDDEN))}};c(Cr,"VisibilityPlugin");let Vn=Cr;const{Utils:{Array:jt}}=p,se={IDLE:"idle",LOADING:"loading",LOADED:"loaded",FAILED:"failed"},pe={NOT_STARTED:"not-started",IN_PROGRESS:"in-progress",COMPLETED:"completed",FAILED:"failed"},Lo=["next","preroll","browse","pause","start"],Oo=["reward"],re=class re{static set initStatus(t){var e,s;this._initStatus!==t&&((s=(e=this.game)==null?void 0:e.analytics)==null||s.initAdEvent({adService:"adsense",state:t}),this._initStatus=t)}static get initStatus(){return this._initStatus}static async getRewardedVideoAsync(t){return await this.ensureInitialized(),this.createAdInstance(this.rewardedType,t)}static async getInterstitialAdAsync(t){return await this.ensureInitialized(),this.createAdInstance(this.interstitialType,t)}static async getRewardedInterstitialAsync(t){return await this.ensureInitialized(),this.createAdInstance(this.rewardedType,t)}static setGame(t){this.game=t}static setRewardType(t){jt.has(Oo,t)?this.rewardedType=t:console.warn(`Rewarded Ad type: ${t} is not supported.`)}static setInterstitialType(t){jt.has(Lo,t)?this.interstitialType=t:console.warn(`Interstitial Ad type: ${t} is not supported.`)}static async initAsync(t){try{switch(this.initStatus){case se.LOADED:console.warn("Google AdSense already initiated.");return;case se.LOADING:console.warn("Google AdSense is being initiated.");return}if(!this.validateConfig(t))throw new Error("Invalid Google Ads configuration");this.initStatus=se.LOADING,this.config=t,await this.loadScriptElementAsync(),console.info("Google AdSense initialized successfully")}catch(e){throw this.initStatus=se.FAILED,console.warn("Failed to initialize Google AdSense:",e),e}}static validateConfig(t){if(!t)return console.error("Google Ads config is required"),!1;const{dataAdClient:e,dataAdHost:s}=t;if(!e&&!s)return console.error("Either dataAdClient or dataAdHost is required"),!1;if(t.dataAdFrequencyHint){const n=Number(t.dataAdFrequencyHint);if(isNaN(n)||n<=0)return console.error("dataAdFrequencyHint must be a positive number"),!1}return!0}static async loadScriptElementAsync(){try{await this.injectMainScript(),await this.configureGoogleAds()}catch(t){throw console.warn("Failed to load Google Ads script:",t),t}}static async injectMainScript(){return new Promise((t,e)=>{try{const s=document.createElement("script");this.configureScriptAttributes(s),s.onload=()=>{this.initStatus=se.LOADED,t()},s.onerror=n=>{this.initStatus=se.FAILED,e(new Error(`Failed to load Google Ads script: ${n}`))},document.head.appendChild(s)}catch(s){console.warn("Failed to inject main script:",s),e(s)}})}static async configureGoogleAds(){try{window.adsbygoogle=window.adsbygoogle||[],window.adBreak=t=>adsbygoogle.push(t),window.adConfig=t=>adsbygoogle.push(t),this.config.usePreload&&await this.preloadAdConfig()}catch(t){throw console.warn("Failed to configure Google Ads:",t),t}}static configureScriptAttributes(t){const{dataAdClient:e,dataAdHost:s,dataAdChannel:n,dataAdBreakTest:a,dataAdFrequencyHint:i}=this.config;t.async=!0,t.crossOrigin="anonymous";let r="";i&&t.setAttribute("data-ad-frequency-hint",`${i}s`),e&&(t.setAttribute("data-ad-client",e),r+=`?client=${e}`),n&&t.setAttribute("data-ad-channel",n),s&&(t.setAttribute("data-ad-host",s),r+=`&host=${s}`),a&&t.setAttribute("data-adbreak-test","on"),t.src=`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js${r}`}static async ensureInitialized(){if(this.initStatus!==se.LOADED)throw new Error("Google Ads not initialized. Call initAsync first.");await this.ensurePreloaded()}static async ensurePreloaded(){this.preloadStatus!==pe.COMPLETED&&await this.preloadAdPlacement()}static createAdInstance(t,e){return{getPlacementID:c(()=>e,"getPlacementID"),loadAsync:c(()=>this.preloadAdPlacement(),"loadAsync"),showAsync:c(()=>this.showAd(t,e),"showAsync"),hideAsync:c(()=>Promise.resolve(),"hideAsync")}}static async showAd(t,e){return new Promise((s,n)=>{try{const a=this.createAdBreakConfig({type:t,placementId:e,resolve:s,reject:n});window.adBreak(a)}catch(a){console.warn("Failed to show ad:",a),n(a)}})}static createAdBreakConfig(t){const e=this.createBaseAdBreakConfig({placementId:t.placementId}),{type:s}=t;if(jt.has(Lo,s))return this.createInterstitialAdBreakConfig(e,t);if(jt.has(Oo,s))return this.createRewardAdBreakConfig(e,t);throw new Error(`Ad type: ${s} is not supported.`)}static createBaseAdBreakConfig(t){return{name:t.placementId,beforeAd:c(()=>{},"beforeAd"),adBreakDone:c(e=>{},"adBreakDone")}}static createInterstitialAdBreakConfig(t,{resolve:e,reject:s}){return{...t,type:this.interstitialType,adBreakDone:c(n=>{var a;(a=t.adBreakDone)==null||a.call(t,n),this.handleAdBreakDone({info:n,resolve:e,reject:s})},"adBreakDone")}}static createRewardAdBreakConfig(t,{resolve:e,reject:s}){return{...t,type:this.rewardedType,beforeReward:c(n=>{n()},"beforeReward"),adDismissed:c(()=>{s(new Error("USER_INPUT"))},"adDismissed"),adViewed:c(()=>{e()},"adViewed")}}static handleAdBreakDone(t){const{info:e,resolve:s,reject:n}=t;switch(e.breakStatus){case"viewed":s();break;case"frequencyCapped":n(new Error("AD_FREQUENCY_CAPPED"));break;default:n(new Error(e.breakStatus))}}static async preloadAdPlacement(){return this.initStatus!==se.LOADED?Promise.reject(new Error("Google Ads not initiated.")):this.preloadAdConfig()}static getInitStatus(){return this.initStatus}static getPreloadStatus(){return this.preloadStatus}static async preloadAdConfig(){if(this.preloadStatus!==pe.COMPLETED&&this.preloadStatus!==pe.IN_PROGRESS)return this.preloadStatus=pe.IN_PROGRESS,new Promise((t,e)=>{const s=setTimeout(()=>{this.preloadStatus===pe.IN_PROGRESS&&(this.preloadStatus=pe.FAILED,e(new Error("Failed to preload ad config in time.")))},5e3);window.adConfig({preloadAdBreaks:"on",onReady:c(()=>{clearTimeout(s),this.preloadStatus=pe.COMPLETED,t()},"onReady")})})}};c(re,"GoogleAds"),u(re,"game"),u(re,"_initStatus",se.IDLE),u(re,"preloadStatus",pe.NOT_STARTED),u(re,"config"),u(re,"rewardedType","reward"),u(re,"interstitialType","next");let ye=re;window.GoogleAds=ye;const{Utils:{Object:To},Plugins:{Ads:{Status:K,Types:ne,AdError:Wt,AdInstance:Ed}}}=p,Nr=class Nr extends Ed{constructor(e,s){super(e,s);u(this,"service");u(this,"instance");u(this,"instanceQueue",[]);this.service=GameSDK.getSDKName(),this.instance=null}async loadAsync(){if(console.debug("AdInstance","loadAsync called",{type:this.type,status:this.status,service:this.service,placementId:this.placementId}),!(this.instance&&this.status===K.FILLED)){if(this.status!==K.IDLE)throw new Wt("AD_NOT_READY","Ad is not ready.");try{if(this.instance=await this.createInstanceByType(this.type),this.instance===null)throw new Wt("AD_INSTANCE_NOT_INITIATED","Ad instance didn't initiated.");this.setStatus(K.LOADING),await this.instance.loadAsync(),this.setStatus(K.FILLED),console.debug("AdInstance","loadAsync success",{type:this.type,status:this.status,service:this.service}),this.logAdLoad()}catch(e){throw console.warn("AdInstance","loadAsync failed",{type:this.type,status:this.status,service:this.service}),console.warn(e),this.setStatus(K.IDLE),e instanceof Object&&"code"in e&&e.code==="INVALID_PARAM"&&(this.instance=null),this.instance&&this.pushInstanceToQueue(this.instance),self.game.analytics.loadAdFail({type:this.type,service:this.service}),e}}}async showAsync(){if(console.debug("AdInstance","showAsync called",{type:this.type,status:this.status,service:this.service}),this.status!==K.FILLED)throw new Wt("AD_NOT_FILLED","Ad is not filled.");if(this.instance===null)throw new Wt("AD_INSTANCE_NOT_INITIATED","Ad instance didn't initiated.");let e=!1;try{this.setStatus(K.SHOWING),self.game.analytics.showingAd({type:this.type,service:this.service}),await this.instance.showAsync(),e=!0,this.setStatus(K.IDLE),this.instance=null,console.debug("AdInstance","showAsync success",{type:this.type,status:this.status,service:this.service})}catch(s){throw console.warn("AdInstance","showAsync failed",{type:this.type,status:this.status,service:this.service,error:s}),To.hasOwn(s,"code")&&(s.code==="AD_NOT_LOADED"&&this.setStatus(K.IDLE),["INVALID_PARAM","INVALID_OPERATION","USER_INPUT"].indexOf(`${s.code}`)>-1&&(this.setStatus(K.IDLE),this.instance=null),s.code==="USER_INPUT"&&(e=!0)),this.status===K.SHOWING&&(this.setStatus(K.IDLE),this.instance=null),s}finally{e?this.logAdShown():self.game.analytics.showAdFail({type:this.type,service:this.service})}}async createInstanceByType(e){try{return await this.getAdInstanceByType(e)}catch(s){return To.hasOwn(s,"code")&&s.code==="ADS_TOO_MANY_INSTANCES"?this.getAdInstanceFailed():null}}async getAdInstanceByType(e){switch(e){case ne.REWARDED_VIDEO:return await GameSDK.getRewardedVideoAsync(this.placementId);case ne.INTERSTITIAL:return await GameSDK.getInterstitialAdAsync(this.placementId);case ne.REWARDED_INTERSTITIAL:return await GameSDK.getRewardedInterstitialAsync(this.placementId);default:return null}}getAdInstanceFailed(){if("canBeLoadedAd"in GameSDK.extra){for(const e of this.instanceQueue)if(GameSDK.extra.canBeLoadedAd(e))return this.instanceQueue.splice(this.instanceQueue.indexOf(e),1),e}else return this.instanceQueue.shift()||null;return null}logAdLoad(){switch(this.type){case ne.INTERSTITIAL:self.game.analytics.loadInterstitialAd({service:this.service});break;case ne.REWARDED_VIDEO:self.game.analytics.loadRewardedVideoAd({service:this.service});break;case ne.REWARDED_INTERSTITIAL:self.game.analytics.loadRewardedInterstitialAd({service:this.service});break}}logAdShown(){switch(this.type){case ne.INTERSTITIAL:self.game.analytics.showInterstitialAd({service:this.service});break;case ne.REWARDED_VIDEO:self.game.analytics.showRewardedVideoAd({service:this.service});break;case ne.REWARDED_INTERSTITIAL:self.game.analytics.showRewardedInterstitialAd({service:this.service});break}}pushInstanceToQueue(e){this.instanceQueue.push(e)}};c(Nr,"NormalAdInstance");let Kt=Nr;const{Plugins:{Ads:{Types:Un}}}=p,Lr=class Lr extends Kt{constructor(t,e){super(t,e),this.service="adsense"}async createInstanceByType(t){try{switch(t){case Un.REWARDED_VIDEO:return await ye.getRewardedVideoAsync(this.placementId);case Un.INTERSTITIAL:return await ye.getInterstitialAdAsync(this.placementId);case Un.REWARDED_INTERSTITIAL:return await ye.getRewardedInterstitialAsync(this.placementId);default:return null}}catch(e){return console.warn(e),null}}getAdInstanceFailed(){return null}};c(Lr,"AdSenseInstance");let Bn=Lr;const Or=class Or extends Yr{async loadAsync(){this.exception("Unsupported method")}async showAsync(){this.exception("This method is not implemented")}async hideAsync(){this.exception("This method is not implemented")}};c(Or,"BannerInstance");let jn=Or;const{Status:_o}=p.Plugins.Ads,Tr=class Tr extends jn{async showAsync(){await GameSDK.loadBannerAdAsync(this.placementId),this.setStatus(_o.SHOWING)}async hideAsync(){await GameSDK.hideBannerAdAsync(this.placementId),this.setStatus(_o.IDLE)}};c(Tr,"BannerAdInstance");let Wn=Tr;var Pd=Object.defineProperty,Sd=Object.getOwnPropertyDescriptor,Kn=c((f,t,e,s)=>{for(var n=s>1?void 0:s?Sd(t,e):t,a=f.length-1,i;a>=0;a--)(i=f[a])&&(n=(s?i(t,e,n):i(n))||n);return s&&n&&Pd(t,e,n),n},"__decorateClass");const{BaseAnalytics:xd,Events:ae}=p.Plugins.Analytics,{Events:{VISIBILITY_HIDDEN:bd,VISIBILITY_VISIBLE:Cd},Utils:{Array:Ro,Object:Ht,Image:Nd,Decorator:Hn},Configs:{Analytics:{ClarityAnalytics:Mo}}}=p,$o=Ht.invert(ae),Ld=[ae.SCREEN_OPEN],_r=class _r extends xd{constructor(e,s){super(e,"ClarityAnalytics",{...s,color:"#9692FF"});u(this,"image");u(this,"screenshotCount",4);u(this,"isCapturing",!1);u(this,"isScreenshotByEvent",!1);u(this,"handleVisibilityHidden",c(()=>{var e;(e=this.clarity)==null||e.call(this,"set","Visibility","hidden")},"handleVisibilityHidden"));u(this,"handleVisibilityVisible",c(()=>{var e;(e=this.clarity)==null||e.call(this,"set","Visibility","visible")},"handleVisibilityVisible"));u(this,"makeScreenshotByEvent",c(async(e,s=0)=>{if(!this.game.canvasRecorder||!this.isScreenshotByEvent||!Ht.hasOwn($o,e))return;const a=$o[e];Ro.has(Mo.ScreenshotCanvas.ByEvent,a)&&(await this.setScreenshotToHtml(),s<this.screenshotCount&&setTimeout(()=>this.makeScreenshotByEvent(e,s+1),300))},"makeScreenshotByEvent"));u(this,"setScreenshotToHtml",c(async()=>{try{if(this.isCapturing||(this.isCapturing=!0,!this.image))return;const e=await this.captureScreenshot();if(!e)return;this.image.src=e}finally{this.isCapturing=!1}},"setScreenshotToHtml"));this.setupScreenshots(),this.listenVisibilityEvents()}get clarity(){return Ht.hasOwn(window,"clarity")?window.clarity:null}setUser(e){var s;(s=this.clarity)==null||s.call(this,"identify",e)}listenVisibilityEvents(){this.game.event.on(bd,this.handleVisibilityHidden),this.game.event.on(Cd,this.handleVisibilityVisible)}processEvent(e,s){var n;this.setTagByEvent(e,s),this.makeScreenshotByEvent(e),!Ro.has(Ld,e)&&((n=this.clarity)==null||n.call(this,"event",e,s))}setTagByEvent(e,s){if(s)switch(e){case ae.PAGE_VIEW:case ae.SCREEN_OPEN:this.setPageTag(s);break;case ae.AD_SHOWING:this.setAdTag(s);break;case ae.BUTTON_CLICK:this.setButtonTag(s);break;case ae.TUTORIAL_STEP:this.setTutorialTag(s);break;case ae.LEVEL_START:this.setLevelTag(s);break;case ae.USE_ITEM:this.setItemTag(s);break}}setPageTag(e){var n;if(!e.page_title&&!e.path_path)return;const s=e.page_title||e.path_path;s&&((n=this.clarity)==null||n.call(this,"set","Page",s),window.location.hash=s)}setAdTag(e){var n;if(!e.ad_type||!e.ad_service)return;const s=`${e.ad_type}:${e.ad_service}`;(n=this.clarity)==null||n.call(this,"set","Ad",s)}setButtonTag(e){var n;if(!e.button_name||!e.screen_name)return;const s=`${e.button_name}:${e.screen_name}`;(n=this.clarity)==null||n.call(this,"set","Button",s)}setTutorialTag(e){var n;if(!e.step)return;const s=e.step.toString();(n=this.clarity)==null||n.call(this,"set","Tutorial",s)}setLevelTag(e){var n;if(!e.level_name||!e.game_mode)return;const s=`${e.game_mode}:${e.level_name}`;(n=this.clarity)==null||n.call(this,"set","Level",s)}setItemTag(e){var s;e.item_name&&((s=this.clarity)==null||s.call(this,"set","Item",e.item_name))}setupScreenshots(){if(typeof FileReader>"u"){console.warn("FileReader is not supported");return}this.initImage();const{ByEvent:e,Interval:s}=Mo.ScreenshotCanvas;if(e.length>0){this.isScreenshotByEvent=!0;return}setInterval(this.setScreenshotToHtml,s)}initImage(){if(this.image)return;const e=document.getElementById("Cocos3dGameContainer");e&&(this.image=document.createElement("img"),this.image.id="clarity-screenshot",this.image.setAttribute("data-clarity-unmask","true"),Ht.assign(this.image.style,{position:"absolute",display:"flex",width:"100%",top:0,left:0,pointerEvents:"none"}),e.insertBefore(this.image,e.firstChild))}async captureScreenshot(){if(!this.game.canvasRecorder)return null;const e=await this.game.canvasRecorder.snapshotFrameAsync({force:!0,type:"jpeg",quality:.1,resolution:.5});return this.game.canvasRecorder.waitNextFrame(),e?await Nd.blobToDataImage(e):null}};c(_r,"ClarityAnalytics");let $e=_r;Kn([Hn.tryCatch()],$e.prototype,"setupScreenshots",1),Kn([Hn.tryCatch()],$e.prototype,"initImage",1),Kn([Hn.tryCatch()],$e.prototype,"captureScreenshot",1);const{BaseAnalytics:Od,Events:Go}=p.Plugins.Analytics,Td=[Go.BUTTON_CLICK,Go.SCREEN_OPEN],{Utils:{Array:_d}}=p,Rr=class Rr extends Od{constructor(e,s){super(e,"FacebookAnalytics",{...s,color:"#0F52BA"});u(this,"prefix");this.prefix=s.prefix}processEvent(e,s){if(!("logEvent"in GameSDK.extra)||_d.has(Td,e))return;const n=this.addPrefixToEventName(e);GameSDK.extra.logEvent(n,1,s)}addPrefixToEventName(e){return`${this.prefix}_${e}`}};c(Rr,"FacebookAnalytics");let qn=Rr;const{BaseAnalytics:Rd,Events:Md}=p.Plugins.Analytics,$d=[Md.SCREEN_OPEN],{Utils:{Array:Gd}}=p,Mr=class Mr extends Rd{constructor(t,e){super(t,"FirebaseAnalytics",{...e,color:"#FFCA28"})}setUser(t,e){var s,n;(n=(s=this.game.firebase)==null?void 0:s.services.analytics)==null||n.setUser(t,e)}processEvent(t,e){var s,n;Gd.has($d,t)||(n=(s=this.game.firebase)==null?void 0:s.services.analytics)==null||n.event(t,e)}};c(Mr,"FirebaseAnalytics");let zn=Mr;const{BaseAnalytics:Fd,Events:Ge}=p.Plugins.Analytics,kd=[Ge.SCREEN_OPEN],{Utils:{Array:Vd}}=p,$r=class $r extends Fd{constructor(t,e){super(t,"GoogleAnalytics",{...e,color:"#E35335"})}processEvent(t,e){Vd.has(kd,t)||(this.customEvent(t,e),gtag("event",t,e))}customEvent(t,e){switch(t){case Ge.AD_SHOW:case Ge.AD_SHOW_FAILED:case Ge.AD_SHOWING:case Ge.USE_ITEM:case Ge.EARN_ITEM:this.addLevelName(e);break}}addLevelName(t){if(!t||!(game!=null&&game.match))return;const s=game.match.getMatchState().customData.level;s<0||(t.level_name=this.getLevelName(s))}};c($r,"GoogleAnalytics");let Yn=$r;const{BaseAnalytics:Ud,Events:Fo}=p.Plugins.Analytics,Bd=[Fo.LEVEL_START,Fo.LEVEL_END],{Utils:{Array:jd}}=p,Gr=class Gr extends Ud{constructor(t){super(t,"YandexAnalytics",{color:"#FFB02E"})}processEvent(t){"logEvent"in GameSDK.extra&&jd.has(Bd,t)&&GameSDK.extra.logEvent(t)}};c(Gr,"YandexAnalytics");let Qn=Gr;const Wd="production",Xn="15",{Dtos:Kd,Events:Fe,Configs:{AppId:Hd,Ads:ie,Analytics:qt,AdaptivePerformance:ko,Debugger:fe,Firebase:Vo,Notification:qd,RemoteConfig:Uo,PerformanceMonitor:zd},Plugins:{Ads:{Types:zt}},Utils:{Object:Bo,Json:lt,String:jo,Valid:Yd,Mark:C}}=p,Fr=class Fr extends L.Game{constructor(){super(...arguments);u(this,"markName","Core Initialize");u(this,"modulePlugins",[]);u(this,"addDevPlugins",c(()=>{var n;const{ListPlayerDevIds:e}=fe,s=(n=GameSDK==null?void 0:GameSDK.player)==null?void 0:n.getID();!s||e.indexOf(s)<0||(this.addConsolePlugin(),this.addProfilerPlugin())},"addDevPlugins"));u(this,"handleProtectGameInstance",c(()=>{const e=this.event.getEventEmitCount(ce.MODULE_PLUGIN_READY),s=this.modulePlugins.length;e<s||(window.game=Object.freeze(window.game),console.warn("window.game",window.game))},"handleProtectGameInstance"));u(this,"initCanvasRecorderPlugin",c(()=>{if(!this.canvasRecorder)return;const{CanvasRecorder:e}=fe,{Type:s,Quality:n,RecordFps:a,SyncFps:i}=e.Options;this.canvasRecorder.configure({type:s,quality:n,syncFps:i,recordFps:a}),this.canvasRecorder.setPanelExpanded(e.PanelExpanded);const r=document.querySelector("canvas");if(!r){console.error("Canvas not found");return}this.canvasRecorder.setCanvas(r)},"initCanvasRecorderPlugin"));u(this,"initMonitorErrorPlugin",c(()=>{var h;if(!this.monitorError)return;const{MonitorError:e,ListPlayerDevIds:s}=fe,{ApiKey:n,Service:a,Feedback:i,TrackUser:r,FilterErrors:o}=e,l=GameSDK.player.getID(),d=GameSDK.player.getName();l&&s.indexOf(l)>=0||((h=window.disableSimpleTrackErrors)==null||h.call(window),this.monitorError.configure({apiKey:n,service:a,feedback:i,trackUser:r,releaseStage:Wd,buildVersion:`${Xn}`}),this.monitorError.setUser({id:l,name:d}),this.monitorError.addFilterErrors(o),this.monitorError.initFeedbackTrackErrors(),this.updateMonitorErrorUserAndMetadata(),this.processErrorsQueue())},"initMonitorErrorPlugin"));u(this,"updateMonitorErrorUserAndMetadata",c(()=>{this.event.catchUp(Fe.PLAYER_INFO_LOADED,this.processWhenPlayerInfoLoaded)},"updateMonitorErrorUserAndMetadata"));u(this,"processErrorsQueue",c(()=>{if(this.monitorError&&window.__errorQueue){for(const e of window.__errorQueue)if(e instanceof Error)this.monitorError.sendException(e);else{const{message:s,code:n,stack:a}=e||{message:"",code:"Unknown",stack:"Unknown stack"},i=new Error(s||n);i.stack=a,this.monitorError.sendException(i)}window.__errorQueue=null}},"processErrorsQueue"));u(this,"processWhenPlayerInfoLoaded",c(()=>{if(!this.monitorError)return;const{playerId:e,name:s}=this.player.getPlayer();this.monitorError.setUser({id:e,name:s}),this.monitorError.addMetadata({isFirstLogin:this.player.isFirstLogin()})},"processWhenPlayerInfoLoaded"));u(this,"handleSaveRemoteConfig",c(e=>{try{const s={[e.type]:e};this.player.setPlayerDataByName("remoteConfig",s)}catch(s){console.warn("handleSaveGameCoreConfig",s)}},"handleSaveRemoteConfig"));u(this,"handleUpdateGameCoreConfig",c(e=>{try{const{id:s,type:n}=e;if(n!=="GameCore")return;p.Configs=Bo.merge(p.Configs,e.config);const{Ads:a}=p.Configs;this.ads.configure(a),this.event.emit(ce.REMOTE_CONFIG_UPDATED,{id:s,type:n})}catch(s){console.warn("handleUpdateGameCoreConfig",s)}},"handleUpdateGameCoreConfig"));u(this,"handleStorageCurrentRemoteConfig",c(()=>{const e=this.player.getPlayerDataByKey("remoteConfig");if(console.debug("playerRemoteConfig",lt.clone(e)),!!e){for(const s in e)if(Bo.hasOwn(e,s)){const n=e[s],a=lt.clone(n);console.log("newRemoteConfig",a);const i=new Kd.RemoteConfig.Data(a).toObject();console.debug("remoteConfigValid",i),this.remoteConfig.setRemoteConfig(i),this.remoteConfig.processUpdateConfig(i.id,i.type)}}},"handleStorageCurrentRemoteConfig"));u(this,"initAdaptivePerformancePlugin",c(()=>{if(!this.adaptivePerformance)return;const e=lt.clone(ko);this.adaptivePerformance.configure(e)},"initAdaptivePerformancePlugin"));u(this,"processAfterSyncProfile",c(()=>{qd.Enabled&&this.updatePlayerProfileToNotificationService()},"processAfterSyncProfile"))}getBuildVersion(){return parseInt(`${Xn}`)||0}async boot(){console.groupEnd(),console.groupCollapsed("ðŸ§¬ GameCore Boot"),super.boot(),this.addPlugins(),this.initEventPlugin(),this.event.emit(Fe.CORE_BOOTING),this.initFirebasePlugin(),this.initMarkCoreInitialize(),C.putAttr(this.markName,"Step","Init Analytics"),this.initGoogleAnalytics(),this.initClarityAnalytics(),this.initFirebaseAnalytics(),this.initYandexAnalytics(),this.initFacebookAnalytics(),C.putAttr(this.markName,"Step","Init Plugins"),this.initAds(),this.initMatchPlugin(),this.initRemoteConfig(),C.putAttr(this.markName,"Step","Load Lazy Plugins"),Yd.isDebugger()||this.event.on(Fe.MODULE_PLUGIN_READY,this.handleProtectGameInstance),this.addMonitorPlugin().then(this.initMonitorErrorPlugin),this.addCanvasRecorderPlugin().then(this.initCanvasRecorderPlugin),this.addAdaptivePerformancePlugin().then(this.initAdaptivePerformancePlugin),C.putAttr(this.markName,"Step","Load Dev Plugins"),this.event.catchUp(Fe.GAME_SDK_READY,this.addDevPlugins)}async start(){console.groupEnd(),console.groupCollapsed("ðŸ§¬ GameCore Start"),super.start(),C.putAttr(this.markName,"Step","Core Start"),this.event.emit(Fe.CORE_STARTING),C.putAttr(this.markName,"Step","Request Token"),await this.auth.requestToken(),C.putAttr(this.markName,"Step","Init States"),await this.initState(),C.putAttr(this.markName,"Step","Process Player Profile"),this.processPlayerProfile(),C.putAttr(this.markName,"Step","Process Context Payload"),await this.context.detectContextSessionType(),this.context.detectContextGameMode();const e=this.storage.getStorageData("context","sessionContextType")||"unknown";C.putAttr(this.markName,"Context Mode",e),C.putAttr(this.markName,"Step","Core Ready"),C.putAttr(this.markName,"Success","true"),C.stop(this.markName),this.event.emit(Fe.CORE_READY)}addPlugins(){this.installPlugin("Storage",kn),this.installPlugin("Event",As),this.installPlugin("Ads",as),this.installPlugin("Auth",ds),this.installPlugin("Audio",ft),this.installPlugin("Match",Mn),this.installPlugin("Player",$n),this.installPlugin("Profile",Fn),this.installPlugin("Context",ps),this.installPlugin("Language",Ns),this.installPlugin("Analytics",cs),this.installPlugin("Visibility",Vn),this.installPlugin("Leaderboard",Os),this.installPlugin("DailyRewards",ms),this.installPlugin("FrameCapture",bs),this.installPlugin("RemoteConfig",Qt),"Proxy"in window&&this.installPlugin("Firebase",Qt)}installPlugin(e,s,n=!1){const a=jo.toCamelCase(jo.capitalize(e));this.plugins.install(e,s,!0,a),e!=="Storage"&&(n?this.emitModulePluginReady(e):this.emitCorePluginReady(e))}async addMonitorPlugin(){try{const{MonitorError:e}=fe;if(!e.Enabled)return;this.modulePlugins.push("MonitorError");const s=(await oe(async()=>{const{default:n}=await v.import("./bundle/monitor-error.js");return{default:n}},void 0,v.meta.url)).default;if(typeof s!="function")return;this.installPlugin("MonitorError",s,!0)}catch(e){console.error("Error importing Monitor Error plugin:",e)}}async addCanvasRecorderPlugin(){try{const{CanvasRecorder:e}=fe;if(!e.Enabled)return;this.modulePlugins.push("CanvasRecorder");const s=(await oe(async()=>{const{default:n}=await v.import("./bundle/canvas-recorder.js").then(a=>a.i);return{default:n}},void 0,v.meta.url)).default;if(typeof s!="function")throw new Error("CanvasRecorderPlugin is not a function");this.installPlugin("CanvasRecorder",s,!0)}catch(e){console.error("Error importing Canvas Recorder plugin:",e)}}async addAdaptivePerformancePlugin(){try{if(!ko.Enabled)return;this.modulePlugins.push("AdaptivePerformance");const e=(await oe(async()=>{const{default:s}=await v.import("./bundle/index.js");return{default:s}},void 0,v.meta.url)).default;if(typeof e!="function")return;this.installPlugin("AdaptivePerformance",e,!0)}catch(e){console.error("Error importing Adaptive Performance plugin:",e)}}async addConsolePlugin(){try{const{Console:e}=fe;if(!e.Enabled)return;this.modulePlugins.push("Console");const s=(await oe(async()=>{const{default:n}=await v.import("./bundle/canvas-recorder.js").then(a=>a.e);return{default:n}},void 0,v.meta.url)).default;if(typeof s!="function")throw new Error("ConsolePlugin is not a function");this.installPlugin("Console",s,!0),this.initConsolePlugin()}catch(e){console.error("Error importing Console plugin:",e)}}async addProfilerPlugin(){try{const{Profiler:e}=fe;if(!e.Enabled)return;this.modulePlugins.push("Profiler");const s=(await oe(async()=>{const{default:n}=await v.import("./bundle/canvas-recorder.js").then(a=>a.e);return{default:n}},void 0,v.meta.url)).default;if(typeof s!="function")throw new Error("ProfilerPlugin is not a function");this.installPlugin("Profiler",s,!0),this.initProfilerPlugin()}catch(e){console.error("Error importing Profiler plugin:",e)}}emitCorePluginReady(e){this.event.emit(ce.CORE_PLUGIN_READY,{name:e})}emitModulePluginReady(e){this.event.emit(ce.MODULE_PLUGIN_READY,{name:e})}initEventPlugin(){const{EventLogging:e}=fe;e.Enabled&&this.event.enableLogEvent()}initMatchPlugin(){this.match.setUseCPUProfile(!1)}initAds(){this.ads.configure(ie),this.initGoogleAds(),this.initAdInstance(),ie.Enabled&&this.analytics.initAdEvent({adService:"platform",state:"loaded"})}async initGoogleAds(){try{if(!ie.Enabled)return;const{Enabled:e,UsePreload:s,DataAdBreakTest:n,DataAdClient:a,DataAdChannel:i,DataAdFrequencyHint:r,DataAdHost:o}=ie.AdServiceConfigs.AdSense;if(!e)return;ye.setGame(this),await ye.initAsync({usePreload:s,dataAdHost:o,dataAdClient:a,dataAdChannel:i,dataAdBreakTest:n,dataAdFrequencyHint:r})}catch(e){console.warn("initGoogleAds",e)}}getAdInstanceByService(e,s=!1){const{AdSense:n,AppLovin:a}=ie.AdServiceConfigs;switch(e){case"adsense":if(n.Enabled)return Bn;break;case"applovin":a.Enabled;break;default:return s?Wn:Kt}return null}initAdInstance(){for(const s of ie.InterstitialAdOptions){const n=this.getAdInstanceByService(s.AdService);n&&this.ads.setAdInstance(zt.INTERSTITIAL,s.PlacementId,n)}for(const s of ie.RewardedVideoAdOptions){const n=this.getAdInstanceByService(s.AdService);n&&this.ads.setAdInstance(zt.REWARDED_VIDEO,s.PlacementId,n)}for(const s of ie.RewardedInterstitialAdOptions){const n=this.getAdInstanceByService(s.AdService);n&&this.ads.setAdInstance(zt.REWARDED_INTERSTITIAL,s.PlacementId,n)}const e=!0;for(const s of ie.BannerDisplayAdOptions){const n=this.getAdInstanceByService(s.AdService,e);n&&this.ads.setAdInstance(zt.BANNER,s.PlacementId,n)}}async initState(){try{const e=new es(this);e.initContext(),await e.initPlayer()}catch(e){console.error("StateInitiator",e)}}initConsolePlugin(){this.console&&this.console.configure()}initProfilerPlugin(){this.profiler&&this.profiler.configure()}initRemoteConfig(){if(!Uo.Enabled)return;const e=lt.clone(Uo);this.remoteConfig.configure(e),this.event.on(ce.REQUEST_SAVE_CONFIG,this.handleSaveRemoteConfig),this.event.on(ce.REQUEST_UPDATE_CONFIG,this.handleUpdateGameCoreConfig),this.event.catchUp(ce.PLAYER_INFO_LOADED,this.handleStorageCurrentRemoteConfig)}initFirebasePlugin(){if(!Vo.Enabled||!this.firebase)return;const e=lt.clone(Vo);this.firebase.configure(e),C.setService(this.firebase.services.performance)}initMarkCoreInitialize(){zd.CoreFlows&&(C.measure(this.markName),C.putAttr(this.markName,"Build",`${Xn}`),C.putAttr(this.markName,"GameSDK",GameSDK.getSDKName()),C.putAttr(this.markName,"Platform",GameSDK.getPlatform()),C.putAttr(this.markName,"Success","false"),C.start(this.markName))}async processPlayerProfile(){try{await this.player.syncProfileToServer(),this.processAfterSyncProfile()}catch(e){console.warn("processPlayerProfile fail",e)}}async updatePlayerProfileToNotificationService(){try{const e=this.player.getPlayer(),{ASID:s,playerId:n,name:a,photo:i,locale:r}=e;await ic({appId:Hd,ASID:s,playerId:n,name:a,photo:i,locale:r})}catch(e){console.warn("updatePlayerProfileToNotificationService",e)}}initGoogleAnalytics(){const{Enabled:e,ConsoleLog:s}=qt.GoogleAnalytics??{};e&&this.analytics.add(new Yn(this.game,{log:!!s}))}initClarityAnalytics(){const{Enabled:e,ConsoleLog:s}=qt.ClarityAnalytics??{};if(!e)return;const n=new $e(this.game,{log:!!s}),a=this.player.getPlayer(),{playerId:i}=a;n.setUser(i),this.analytics.add(n)}initFirebaseAnalytics(){const{Enabled:e,ConsoleLog:s}=qt.FirebaseAnalytics??{};if(!e)return;const n=new zn(this.game,{log:!!s});this.analytics.add(n);let a="no_entry";GameSDK.getEntryPointAsync().then(i=>{a=i}).catch(i=>{console.warn(i)}).finally(()=>{const i=this.player.getPlayer(),{playerId:r,locale:o}=i,{fbig_ad_id:l,fbig_adset_id:d,fbig_campaign_id:h}=GameSDK.getEntryPointData()||{};n.setUser(r,{locale:o,ad_id:l,adset_id:d,campaign_id:h,traffic_source:a})})}initYandexAnalytics(){GameSDK.getSDKName()==="Yandex"&&this.analytics.add(new Qn(this.game))}initFacebookAnalytics(){const e=GameSDK.getSDKName(),{Enabled:s,Prefix:n,ConsoleLog:a}=qt.FacebookAnalytics??{};if(!(!s||e!=="FacebookInstant")){if(typeof n!="string"){console.warn("Facebook Analytics is not configured");return}this.analytics.add(new qn(this.game,{prefix:n,log:!!a}))}}};c(Fr,"MagicGame");let Jn=Fr;const{Configs:{GameEngine:{ForceDesktopDPR:Yt}},Utils:{Device:Qd},Events:Zn}=p,Xd=c(async()=>{const f=new Jn;window.game=f;const t=20;window.__sdkLoadingCount<t&&(window.__sdkLoadingCount=t),window.__gameCoreStart=!0,await f.boot(),f.event.catchUp(Zn.REQUEST_CORE_START,Wo),Jd(f)},"initGame"),Wo=c(()=>{if(!window.__sdkInitiated){game.event.catchUp(Zn.GAME_SDK_READY,Wo);return}window.game.start(),console.warn("Game started");const f=25;window.__sdkLoadingCount<f&&(window.__sdkLoadingCount=f)},"startGame"),Jd=c(f=>{const e=setInterval(()=>{if(!window.__sdkInitiated)return;clearInterval(e);const s=10;window.__sdkLoadingCount<s&&(window.__sdkLoadingCount=s),f.event.emit(Zn.GAME_SDK_READY)},5)},"waitGameSDK");Yt!==!1&&Qd.isDesktop()&&typeof Yt=="number"&&Yt>0&&(window.devicePixelRatio=Yt),window.originalRequestAnimationFrame=window.requestAnimationFrame,window.requestAnimationFrame=f=>(setTimeout(f,1e3/60),0),Xd()},"execute")}});
