var wc=Object.defineProperty;var Dc=(pe,I,p)=>I in pe?wc(pe,I,{enumerable:!0,configurable:!0,writable:!0,value:p}):pe[I]=p;var h=(pe,I,p)=>Dc(pe,typeof I!="symbol"?I+"":I,p);System.register(["./bundle/core.js","./bundle/monitor-error.js","./bundle/canvas-recorder.js"],function(pe,I){"use strict";var p,N,Yt,ie,B,re,Jt,Qt,ht;return{setters:[C=>{p=C.G,N=C.P,Yt=C.M,ie=C._,B=C.a,re=C.C,Jt=C.w},C=>{Qt=C.g},C=>{ht=C.d}],execute:function(){const{Valid:C,Object:ye,String:ut,Json:Xt}=p.Utils,Ee="is invalid",ne=class ne{static addDefaultData(t){C.isObject(t)||this.prototype.exception("default data",Ee),t=Xt.clone(t);const{name:e}=this;C.isObject(ne.data[e])||(ne.data[e]={}),ne.data[e]=ye.merge(ne.data[e],t)}static getDefaultData(){const{name:t}=this;return Xt.clone(ne.data[t])}static addValidateFunction(t,e){C.isString(t)||this.prototype.exception("validate key",Ee),typeof e!="function"&&this.prototype.exception("validate function",Ee);const s=`validate${ut.capitalize(t)}`;ye.assign(this.prototype,{[s]:e})}constructor(t){this.defaultData(),this.processData(t)}processData(t){this.validateStructure(t),this.validateData(t),this.setupData(t)}defaultData(){const{name:t}=this.constructor;this.lazyDefaultData(ne.data[t])}lazyDefaultData(t){C.isObject(t)||this.exception("data",Ee);for(const e in t)if(ye.hasOwn(t,e)){const s=t[e];ye.assign(this,{[e]:s})}}lazyValidateStructure(t){C.isObject(t)||this.exception("structure","is not object");const e=this.getKeys();for(const s of e){const a=this[s];a===void 0&&this.exception("structure",`has no key ${s}`),!ye.hasOwn(t,s)&&a!==void 0&&this.setDefaultData(s,t)}}setDefaultData(t,e){C.isObject(e)||this.exception("data",Ee);const s=this[t];s===void 0&&this.exception("default",`has no key ${t}`),ye.assign(e,{[t]:s})}lazyValidateData(t){const e=this.getKeys();for(const s of e){const a=t[s],n=ut.removeDiacritics(s).replace(/[^a-zA-Z0-9]/g,""),i=`validate${ut.capitalize(n)}`,r=this[i];if(typeof r=="function")try{r.call(this,a)}catch{this.setDefaultData(s,t)}else this.exception("validate",`has no function ${i}`)}}lazySetupData(t){const e=this.getKeys();for(const s of e){const a=t[s];ye.assign(this,{[s]:a})}}validate(){this.validateData(this.toObject())}exception(t,e){throw new Error(`${this.constructor.name}: ${t} ${e}`)}toObject(){return Object.fromEntries(Object.entries(this).filter(([t])=>t!=="toObject"))}getKeys(){return Object.keys(this).filter(t=>t!=="toObject")}};h(ne,"data",{});let k=ne;p.Dtos={Base:k};const Pa={score:"score",endlessScore:"endlessScore",settings:"settings",gameData:"gameData",remoteConfig:"remoteConfig",isFirstLogin:"isFirstLogin",dailyRewarded:"dailyRewarded",notificationData:"notificationData",lastCallSwitchGame:"lastCallSwitchGame"},oe={ASID:null,playerId:"0000",name:"Guest",photo:"",locale:"en_US",connectedPlayers:{},data:{dailyRewarded:{logDays:[],firstReward:0},score:0,endlessScore:0,settings:{sound:!0,music:!0,vibrate:!0,language:"en"},gameData:{coins:0,level:1},isFirstLogin:!0,notificationData:{D1:{arrivalDate:0},D2:{arrivalDate:0},D3:{arrivalDate:0},D4:{arrivalDate:0},D5:{arrivalDate:0},D6:{arrivalDate:0},D7:{arrivalDate:0}},lastCallSwitchGame:0}},{Valid:xe}=p.Utils,{playerId:va,name:Sa,photo:Ea,locale:xa}=oe,Ce="is invalid";class ke extends k{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateId(t){(!xe.isString(t)||!t)&&this.exception("_id",Ce)}validatePlayerId(t){(!xe.isString(t)||!t)&&this.exception("playerId",Ce)}validateName(t){(!xe.isString(t)||!t)&&this.exception("name",Ce)}validatePhoto(t){xe.isString(t)||this.exception("photo",Ce)}validateLocale(t){(!xe.isString(t)||!t)&&this.exception("locale",Ce)}toObject(){return super.toObject()}}ke.addDefaultData({playerId:va,name:Sa,photo:Ea,locale:xa});const Q=new ke({playerId:"10",name:"Your Friend"}).toObject();class X extends Error{constructor(e){super(e);h(this,"code");this.code="CREATE_MATCH_FAILED"}}class P extends X{constructor(t){super(t),this.name="PlayerIdNotValid",this.message=t??"Player id is not valid"}}const{Dtos:pt,Utils:{Array:Ca,Object:ba,Json:Ic,Valid:yt},Events:_a}=p;class Na{constructor(t){h(this,"game");h(this,"initContext",()=>{const t={contextId:GameSDK.context.getID()??"",contextType:GameSDK.context.getType(),entryPointData:GameSDK.getEntryPointData()},e=new pt.Context.Info(t),{contextId:s,contextType:a,entryPointData:n}=e.toObject();this.game.context.receiveContext(s,a,n)});h(this,"initPlayer",async()=>{try{const{player:t}=this.game,e=this.getPlayerInfo(),s=Ca.unique(ba.vals(Pa)),a=await GameSDK.player.getDataAsync(s),n=new pt.Player.Data(a).toObject();t.receiveData(e,n)}catch{}finally{this.game.event.emit(_a.PLAYER_INFO_LOADED)}});h(this,"getPlayerInfo",()=>{try{const t=GameSDK.player.getID();let e=GameSDK.player.getName();const s=GameSDK.player.getPhoto();let a=GameSDK.getLocale();if(!yt.isString(t))throw new P;return yt.isString(e)||(e="You"),(!yt.isString(a)||!a)&&(a="en"),new pt.Player.Info({playerId:t,name:e,photo:s,locale:a}).toObject()}catch{return Q}});this.game=t}}class ft extends Error{constructor(e,s){super(e);h(this,"payload");this.name="BadRequest",this.message=e??"This request is bad",this.payload=s}}class gt extends Error{constructor(e,s){super(e);h(this,"payload");this.name="RequestTimeout",this.message=e??"This request is timeout",this.payload=s}}const{Utils:La,Configs:Ta}=p,{AppId:Zt,Network:mt}=Ta,Oa=c=>{if(!c.ok)throw new ft(void 0,{response:c})},es=()=>{const c=window.game.auth.getToken();return{token:c,timeout:mt.Timeout,headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"}}},ts=(c,t,e,s)=>async()=>{try{if(!Zt)throw new ft("AppId is not defined");const a=`${c}/apps/${Zt}/${t}`,n=new AbortController;e.signal=n.signal;const i=setTimeout(()=>{n.abort()},e.timeout);p.Utils.Valid.isObject(s)&&(e.body=JSON.stringify(s));const r=await fetch(a,e);return clearTimeout(i),Oa(r),await r.json()||{}}catch(a){if(a instanceof ft)return null;throw a instanceof Object&&"name"in a&&a.name==="AbortError"?new gt:a}},At=async(c,t)=>{try{return c()}catch(e){if(e instanceof gt&&t>0)try{return await La.Time.sleepAsync(600),await At(c,t-1)}catch{return{}}return e instanceof gt?{}:{}}},Ie=async(c,t,e,s=mt.Retries)=>{try{const a={...es(),...t,method:"GET"},n=ts(e,c,a);return await At(n,s)}catch{return{}}},z=async(c,t,e,s,a=mt.Retries)=>{try{const n={...es(),...e,method:"POST"},i=ts(s,c,n,t);return await At(i,a)}catch{return{}}},{Configs:{Notification:{ApiUrl:Ma}},Utils:{Object:Ra}}=p,Fa=async c=>{if(!Ra.hasOwn(c,"playerId"))throw new Error("Missing playerId");const{playerId:t}=c;await z(`players/${t}`,c,{},Ma,10)};var wt=(c=>(c.IDLE="idle",c.LOADING="loading",c.FILLED="filled",c.SHOWING="showing",c))(wt||{}),K=(c=>(c.BANNER="banner",c.INTERSTITIAL="interstitial",c.REWARDED_VIDEO="rewarded_video",c.REWARDED_INTERSTITIAL="rewarded_interstitial",c))(K||{});let Ve=class extends Error{constructor(e,s){super(s);h(this,"code");this.code=e,this.message=s}};class Ga{constructor(t,e){h(this,"type");h(this,"service");h(this,"placementId");h(this,"_status");this.type=t,this._status=wt.IDLE,this.placementId=e}setStatus(t){this._status!==t&&(this._status=t)}get status(){return this._status}exception(t){throw new Ve("AD_INSTANCE_ERROR",t)}}let ss=class extends Ga{loadAsync(){this.exception("This method is not implemented")}showAsync(){this.exception("This method is not implemented")}hideAsync(){this.exception("Unsupported method")}};p.Plugins.Ads={Types:K,Status:wt,AdError:Ve,AdInstance:ss};const{Array:Be,Object:as}=p.Utils;class $a extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"enabled");h(this,"config");h(this,"lastCallAdShownTime");h(this,"isAdFullSizeShowed");h(this,"ads",{});h(this,"safeAreaBottom");h(this,"degradationTracking",{failedAttempts:0,lastSuccessTime:0})}init(){this.lastCallAdShownTime={[K.BANNER]:0,[K.INTERSTITIAL]:0,[K.REWARDED_VIDEO]:0,[K.REWARDED_INTERSTITIAL]:0},this.isAdFullSizeShowed=!1,this.calculateSafeAreaBottom(),this.resetDegradationTracking()}calculateSafeAreaBottom(){try{const e=getComputedStyle(document.documentElement).getPropertyValue("--sab");this.safeAreaBottom=parseInt(e,10),isNaN(this.safeAreaBottom)&&(this.safeAreaBottom=0)}catch{this.safeAreaBottom=0}}configure(e){this.config=e,this.enabled=this.config.Enabled}checkEnabled(){if(!this.enabled)throw new Ve("ADS_NOT_ENABLED","Ads is't enabled")}isAdFullSizeShowing(){return this.isAdFullSizeShowed}setAdInstance(e,s,a){const n=`${e}-${s}`;this.ads[n]||(this.ads[n]={type:e,placementId:s,interval:null,instance:new a(e,s)})}async loadAdAsync(e,s){this.checkEnabled();try{await this.getAd(e,s).instance.loadAsync()}catch(a){throw this.degradationTracking.failedAttempts++,a}}async showAdAsync(e,s){if(this.checkEnabled(),!this.canbeShowAd(e,s))return;const{event:a}=this.game,n=this.getAd(e,s);try{a.emit(p.Events.AD_SHOWING,{type:e,placementId:s}),this.isAdFullSizeShowed=!0,await n.instance.showAsync(),this.resetDegradationTracking(),this.lastCallAdShownTime[e]=Date.now()/1e3}catch(i){throw this.degradationTracking.failedAttempts++,i}finally{a.emit(p.Events.AD_CLOSED,{type:e,placementId:s}),this.isAdFullSizeShowed=!1}}getAdStatus(e,s){return this.checkEnabled(),this.getAd(e,s).instance.status}getAd(e,s){let a=null;if(s?a=this.getAdByPlacementId(s,e):a=this.getPriorityAdByType(e),!a)throw new Ve("AD_INSTANCE_NOT_INITIATED","The instance ads not yet initiated");return a}getAdsByType(e){return as.vals(this.ads).filter(s=>s.type===e)}getAdByPlacementId(e,s){const a=as.vals(this.ads),n=Be.search(a,i=>i.placementId===e&&(!s||i.type===s));return n||null}getPriorityAdByType(e){const s=this.getAdsByType(e);if(!s.length)return null;const a=Be.search(s,n=>n.type===e);return a||null}canbeShowAd(e,s){return this.canbeShowAdByTime(e,s)}canbeShowAdByTime(e,s){try{const a=Date.now()/1e3;let n;if(s)n=this.getCommonAdConfig(s);else{const u=this.getPriorityAdByType(e);if(!u)return!1;n=this.getCommonAdConfig(u.placementId)}const{SecondsBetweenAds:i,SecondsFirstTime:r}=n,o=a-this.lastCallAdShownTime[e],l=o>i,d=o>r;return this.lastCallAdShownTime[e]>0?l:d}catch{return!1}}canbeShowBannerAd(e){try{const s=this.getBannerConfig(e),{Platform:a}=s;if(a==="ALL")return!0;const n=GameSDK.getPlatform();return n?n===a:!1}catch{return!1}}async showBannerAdAsync(e,s=!0){this.checkEnabled();const a=this.getAd(K.BANNER,e);if(!this.canbeShowBannerAd(a.placementId))throw new Error("Banner ad can not be shown");this.cleanBannerReloadTimer(a),s?await this.showBannerAdWithSchedule(a):await this.showBannerAdOnce(a)}async showBannerAdOnce(e){const{event:s}=this.game;if(!this.isAdFullSizeShowing())try{await e.instance.showAsync(),s.emit(p.Events.AD_SHOWING,{type:K.BANNER,placementId:e.placementId})}catch(a){const n=a instanceof Error?a:new Error("AdsPlugin.startShowBannerAdInterval: Failed to show banner ad");try{await e.instance.hideAsync()}catch{}s.emit(p.Events.AD_FAILED,{type:K.BANNER,placementId:e.placementId,error:n})}}async showBannerAdWithSchedule(e){await this.showBannerAdOnce(e);const s=this.getBannerConfig(e.placementId),{SecondsReload:a}=s;if(a<=0)return;const n=()=>this.showBannerAdWithSchedule(e);e.interval=setTimeout(n,a*1e3)}async hideBannerAdAsync(e){this.checkEnabled();const s=this.getAd(K.BANNER,e);this.cleanBannerReloadTimer(s),await s.instance.hideAsync();const{event:a}=this.game;a.emit(p.Events.AD_CLOSED,{type:K.BANNER,placementId:e})}cleanBannerReloadTimer(e){try{const{interval:s}=e;if(!s)return;clearInterval(s)}catch{}}getCommonAdConfig(e){const s=[...this.config.InterstitialAdOptions,...this.config.RewardedVideoAdOptions,...this.config.RewardedInterstitialAdOptions],a=Be.search(s,n=>n.PlacementId===e);if(!a)throw new Error(`Ad config with placementId ${e} not found`);return a}getBannerConfig(e){const s=Be.search(this.config.BannerDisplayAdOptions,a=>a.PlacementId===e);if(!s)throw new Error(`Banner config with placementId ${e} not found`);return s}getBannerHeight(e,s,a=!0){this.checkEnabled();const n=this.getBannerConfig(e),i=GameSDK.getBannerHeight(n);return a?(this.safeAreaBottom<=0&&this.calculateSafeAreaBottom(),(i+this.safeAreaBottom)*s):i*s}getSafeAreaBottom(e){return this.safeAreaBottom<=0&&this.calculateSafeAreaBottom(),this.safeAreaBottom*e}resetDegradationTracking(){this.degradationTracking={failedAttempts:0,lastSuccessTime:Date.now()}}isServiceDegraded(){const e=Date.now(),{MaxFailedAttempts:s,ResetTimeMinutes:a}=this.config.DegradationTracking,{lastSuccessTime:n,failedAttempts:i}=this.degradationTracking;return e-n>a*60*1e3&&this.resetDegradationTracking(),i>=s}}const g={APP_LAUNCH:"app_launch",APP_INITIALIZED:"app_initialized",ENGINE_READY:"engine_ready",LOAD_START:"load_start",LOAD_COMPLETE:"load_complete",APP_READY:"app_ready",PAGE_VIEW:"page_view",SCREEN_OPEN:"screen_open",BUTTON_CLICK:"button_click",TUTORIAL_BEGIN:"tutorial_begin",TUTORIAL_STEP:"tutorial_step",TUTORIAL_COMPLETE:"tutorial_complete",MATCH_START:"match_start",MATCH_RESCUE:"match_rescue",MATCH_END:"match_end",LEVEL_START:"level_start",LEVEL_RESCUE:"level_rescue",LEVEL_END:"level_end",USE_ITEM:"use_item",EARN_ITEM:"earn_item",GET_FREE_ITEM:"get_free_item",SHARE:"share",INVITE:"invite",MESSAGE:"message",SHORTCUT_CREATE:"shortcut_create",SHORTCUT_CREATE_POPUP:"shortcut_create_popup",BOT_SUBSCRIBE:"bot_subscribe",BOT_SUBSCRIBE_POPUP:"bot_subscribe_popup",AD_INIT:"ad_init",AD_LOAD:"ad_load",AD_LOAD_FAILED:"ad_load_failed",AD_SHOWING:"ad_showing",AD_SHOW:"ad_show",AD_SHOW_FAILED:"ad_show_failed",AD_REWARD:"ad_reward",NEW_USER:"new_user",RETURNING_USER:"returning_user",JOIN_GROUP:"join_group",TOURNAMENT_START:"tournament_start",TOURNAMENT_SHARE:"tournament_share",TOURNAMENT_CREATE:"tournament_create",TOURNAMENT_POST_SCORE:"tournament_post_score",SWITCH_GAME_POPUP:"switch_game_popup",SWITCH_GAME:"switch_game"};class Ue{constructor(){h(this,"history",[]);h(this,"missing",[]);h(this,"outOfOrder",[]);h(this,"completed",!1);h(this,"failed",!1);h(this,"warned",[]);h(this,"debug",!1)}addEvent(t,e){if(this.completed||this.failed){this.debugLog("Skip event:",t);return}this.history.push(t),this.validateAndUpdate(t)}validateAndUpdate(t){const e=this.validateFunnelState();if(e.hasFailed){this.failed=!0,this.logValidationError();return}e.hasWarnings&&this.handleWarnings(e.warnings),this.checkFunnelCompletion(t)}validateFunnelState(){const t={hasFailed:!1,hasWarnings:!1,warnings:[]},s=this.getCurrentSteps().filter(n=>n.required);for(let n=0;n<s.length;n++){const i=s[n],r=this.history.indexOf(i.name);if(r===-1)return this.missing=[i.name],t.hasFailed=!0,t;if(n>0){const o=s[n-1];if(this.history.indexOf(o.name)>r)return this.missing=[o.name],t.hasFailed=!0,t}}const a=this.validateDependencies();return a.length>0&&(t.hasWarnings=!0,t.warnings=a,this.outOfOrder=a),t}getCurrentSteps(){const t=this.history[this.history.length-1],e=this.funnelSteps.findIndex(s=>s.name===t);return this.funnelSteps.slice(0,e+1)}validateDependencies(){const t=[];return this.history.forEach((e,s)=>{var i;const a=this.funnelSteps.find(r=>r.name===e);if(!((i=a==null?void 0:a.dependencies)!=null&&i.length))return;const n=a.dependencies.find(r=>!this.history.includes(r)||this.history.indexOf(r)>s);n&&!this.warned.includes(e)&&(t.push({event:e,missingDependency:n}),this.warned.push(e))}),t}checkFunnelCompletion(t){const e=this.funnelSteps[this.funnelSteps.length-1];if(t!==e.name)return;this.funnelSteps.filter(a=>a.required).every(a=>this.history.includes(a.name))&&(this.completed=!0,this.logCompletion())}handleWarnings(t){for(const e of t);}logValidationError(){}logCompletion(){}debugLog(...t){}isFunnelCompleted(){return this.completed}isFunnelFailed(){return this.failed}getEventHistory(){return[...this.history]}getMissingEvents(){return[...this.missing]}getOutOfOrderEvents(){return[...this.outOfOrder]}}class ka extends Ue{constructor(){super(...arguments);h(this,"debug",!1);h(this,"funnelSteps",[{name:g.AD_INIT,required:!0,payload:{service:"adsense"},description:"Init adsense ad"},{name:g.AD_LOAD_FAILED,required:!1,payload:{service:this.service},description:"Platform ad load failed (trigger for adsense)"},{name:g.AD_LOAD,required:!0,payload:{service:"adsense"},description:"Start loading adsense ad"},{name:g.AD_LOAD_FAILED,required:!1,dependencies:[g.AD_LOAD],payload:{service:"adsense"},description:"Adsense ad load failed"},{name:g.AD_SHOWING,required:!0,dependencies:[g.AD_LOAD],payload:{service:"adsense"},description:"Adsense ad is showing"},{name:g.AD_SHOW,required:!1,dependencies:[g.AD_SHOWING],payload:{service:"adsense"},description:"Adsense ad shown successfully"},{name:g.AD_SHOW_FAILED,required:!1,dependencies:[g.AD_SHOWING],payload:{service:"adsense"},description:"Adsense ad show failed"},{name:g.AD_LOAD,required:!1,payload:{service:"adsense"},description:"Preload adsense ad"}])}get service(){return(GameSDK==null?void 0:GameSDK.getSDKName())??"GameCore"}addEvent(e,s){((s==null?void 0:s.service)==="adsense"||e===g.AD_LOAD_FAILED&&(s==null?void 0:s.service)==="platform")&&super.addEvent(e,s)}}class Va extends Ue{constructor(){super(...arguments);h(this,"debug",!1);h(this,"funnelSteps",[{name:g.APP_LAUNCH,required:!0,description:"Application launched"},{name:g.APP_INITIALIZED,required:!0,dependencies:[g.APP_LAUNCH],description:"Application initialized"},{name:g.ENGINE_READY,required:!0,dependencies:[g.APP_INITIALIZED],description:"Game engine initialized"},{name:g.LOAD_START,required:!0,dependencies:[g.ENGINE_READY],description:"Start loading game assets"},{name:g.LOAD_COMPLETE,required:!0,dependencies:[g.LOAD_START],description:"Game assets loaded completely"},{name:g.APP_READY,required:!0,dependencies:[g.LOAD_COMPLETE],description:"Game is ready to play"}])}}class Ba extends Ue{constructor(){super(...arguments);h(this,"debug",!1);h(this,"funnelSteps",[{name:g.AD_INIT,required:!0,payload:{service:this.service},description:"Init platform ad"},{name:g.AD_LOAD,required:!0,payload:{service:this.service},description:"Start loading platform ad"},{name:g.AD_LOAD_FAILED,required:!1,dependencies:[g.AD_LOAD],payload:{service:this.service},description:"Platform ad load failed"},{name:g.AD_SHOWING,required:!0,dependencies:[g.AD_LOAD],payload:{service:this.service},description:"Platform ad is showing"},{name:g.AD_SHOW,required:!1,dependencies:[g.AD_SHOWING],payload:{service:this.service},description:"Platform ad shown successfully"},{name:g.AD_SHOW_FAILED,required:!1,dependencies:[g.AD_SHOWING],payload:{service:this.service},description:"Platform ad show failed"},{name:g.AD_LOAD,required:!1,payload:{service:this.service},description:"Preload platform ad"}])}get service(){return(GameSDK==null?void 0:GameSDK.getSDKName())??"GameCore"}addEvent(e,s){(s==null?void 0:s.service)===this.service&&super.addEvent(e,s)}}const{Utils:{String:fe,Valid:Ua}}=p;let Ha=class{constructor(t,e,s){h(this,"game");h(this,"name");h(this,"color");h(this,"options");h(this,"selfLog");h(this,"currentPath");this.game=t,this.name=e,this.options=s,this.color=s.color||"#FFF",this.selfLog=s.log,this.currentPath="/"}event(t,e){this.logInfo("event",{name:t,payload:e});const s=this.formatEventName(t);this.processEvent(s,e)}logInfo(t,e){this.selfLog}pageview(t){let e=this.getPageTitle(t);e=this.addGameModeToPageTitle(e),document.title=e,this.event(g.PAGE_VIEW,{path_path:t,page_title:e})}levelStart(t,e,s){this.event(g.LEVEL_START,{level:t,score:e,level_name:this.getLevelName(t),game_mode:s?fe.toUpperCamelCase(s):void 0})}levelFail(t,e,s){this.event(g.LEVEL_END,{level:t,score:e,success:!1,level_name:this.getLevelName(t),game_mode:s?fe.toUpperCamelCase(s):void 0})}levelRescue(t,e,s){this.event(g.LEVEL_RESCUE,{level:t,score:e,level_name:this.getLevelName(t),game_mode:s?fe.toUpperCamelCase(s):void 0})}levelComplete(t,e,s){this.event(g.LEVEL_END,{level:t,score:e,success:!0,level_name:this.getLevelName(t),game_mode:s?fe.toUpperCamelCase(s):void 0})}initAdEvent(t){const{adService:e,state:s}=t;this.event(g.AD_INIT,{ad_service:e,state:s})}loadAdEvent(t){const{type:e,placement:s,service:a}=t;this.event(g.AD_LOAD,{ad_type:e,screen_name:s,ad_service:a})}showAdEvent(t){const{type:e,placement:s,service:a}=t;this.event(g.AD_SHOW,{ad_type:e,screen_name:s,ad_service:a})}loadInterstitialAd(t){const{placement:e,service:s}=t;this.loadAdEvent({type:"interstitial",placement:e,service:s})}showInterstitialAd(t){const{placement:e,service:s}=t;this.showAdEvent({type:"interstitial",placement:e,service:s})}loadRewardedVideoAd(t){const{placement:e,service:s}=t;this.loadAdEvent({type:"rewarded_video",placement:e,service:s})}showRewardedVideoAd(t){const{placement:e,service:s}=t;this.showAdEvent({type:"rewarded_video",placement:e,service:s})}receiveVideoReward(t){const{placement:e,service:s}=t;this.event(g.AD_REWARD,{screen_name:e,ad_service:s})}loadRewardedInterstitialAd(t){const{placement:e,service:s}=t;this.loadAdEvent({type:"rewarded_interstitial",placement:e,service:s})}showRewardedInterstitialAd(t){const{placement:e,service:s}=t;this.showAdEvent({type:"rewarded_interstitial",placement:e,service:s})}receiveInterstitialReward(t){const{placement:e,service:s}=t;this.event(g.AD_REWARD,{screen_name:e,ad_service:s})}loadAdFail(t){const{type:e,placement:s,service:a}=t;this.event(g.AD_LOAD_FAILED,{ad_type:e,screen_name:s,ad_service:a})}showAdFail(t){const{type:e,placement:s,service:a}=t;this.event(g.AD_SHOW_FAILED,{ad_type:e,screen_name:s,ad_service:a})}showingAd(t){const{type:e,placement:s,service:a}=t;this.event(g.AD_SHOWING,{ad_type:e,screen_name:s,ad_service:a})}formatEventName(t){return t.toLowerCase().replace(/:/g,"_")}getLevelName(t){return`Level ${fe.padStart(t.toString(),5,"0")}`}getPageTitle(t){const e=t.split("/").pop();if(!Ua.isString(e))return t;const s=e.replace(/([-_\s.])/g," $1");return fe.toUpperCamelCase(s)}addGameModeToPageTitle(t){const{match:e}=this.game,s=e.getMatchState();let{mode:a}=s;return a||(a="Normal"),`${fe.toUpperCamelCase(a)}::${t}`}};p.Plugins.Analytics={Events:g,BaseFunnel:Ue,BaseAnalytics:Ha};class ja extends N.Plugins.BasePlugin{constructor(e){super(e);h(this,"analytics",[]);h(this,"placement","unknown");h(this,"funnels",[]);h(this,"pageview",e=>{if(!this.isActive())return;this.placement=e;const s=this.getPageByKey(e);for(const a of this.analytics)a.pageview(s);this.logFunnelEvent(g.PAGE_VIEW)});this.initFunnels()}add(e){const s=this.analytics.findIndex(a=>a.name===e.name);s!==-1?this.analytics[s]=e:this.analytics.push(e)}isActive(){return this.analytics.length>=1}initFunnels(){this.addFunnel(new Va),this.addFunnel(new ka),this.addFunnel(new Ba)}addFunnel(e){this.funnels.push(e)}logFunnelEvent(e,s){for(const a of this.funnels)a.addEvent(e,s)}event(e,s){if(this.isActive()){for(const a of this.analytics)a.event(e,s);this.logFunnelEvent(e,s)}}levelStart(e,s,a){if(this.isActive()){for(const n of this.analytics)n.levelStart(e,s,a);this.logFunnelEvent(g.LEVEL_START,{score:s,mode:a})}}levelRescue(e,s,a){if(this.isActive()){for(const n of this.analytics)n.levelRescue(e,s,a);this.logFunnelEvent(g.LEVEL_RESCUE,{score:s,mode:a})}}levelFail(e,s,a){if(this.isActive()){for(const n of this.analytics)n.levelFail(e,s,a);this.logFunnelEvent(g.LEVEL_END,{score:s,mode:a})}}levelComplete(e,s,a){if(this.isActive()){for(const n of this.analytics)n.levelComplete(e,s,a);this.logFunnelEvent(g.LEVEL_END,{score:s,mode:a})}}initAdEvent(e){if(this.isActive())for(const s of this.analytics)s.initAdEvent(e)}loadInterstitialAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.loadInterstitialAd(s);this.logFunnelEvent(g.AD_LOAD,s)}showInterstitialAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.showInterstitialAd(s);this.logFunnelEvent(g.AD_SHOW,s)}loadRewardedVideoAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.loadRewardedVideoAd(s);this.logFunnelEvent(g.AD_LOAD,s)}showRewardedVideoAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.showRewardedVideoAd(s);this.logFunnelEvent(g.AD_SHOW,s)}receiveVideoReward(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.receiveVideoReward(s);this.logFunnelEvent(g.AD_REWARD,s)}loadRewardedInterstitialAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.loadRewardedInterstitialAd(s);this.logFunnelEvent(g.AD_LOAD,s)}showRewardedInterstitialAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.showRewardedInterstitialAd(s);this.logFunnelEvent(g.AD_SHOW,s)}receiveInterstitialReward(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.receiveInterstitialReward(s);this.logFunnelEvent(g.AD_REWARD,s)}loadAdFail(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.loadAdFail(s);this.logFunnelEvent(g.AD_LOAD_FAILED,s)}showAdFail(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.showAdFail(s);this.logFunnelEvent(g.AD_SHOW_FAILED,s)}showingAd(e){if(!this.isActive())return;const s={...e,placement:this.placement};for(const a of this.analytics)a.showingAd(s);this.logFunnelEvent(g.AD_SHOWING,s)}getPageByKey(e){let s=e;if(s.indexOf("_")>-1){let i=s.replace(/_/g,"-");return i=i.toLowerCase(),i}let a=s.length-1,n="";for(;a>0;){n=s.charAt(a);const i=isNaN(parseInt(n,10)),r=n===n.toUpperCase();i&&r&&(s=`${s.slice(0,a)}-${s.slice(a)}`),a--}return s.toLowerCase()}}class Wa{constructor(t){h(this,"key");this.key=t}getKey(){return this.key}}var Ka=Object.defineProperty,qa=Object.getOwnPropertyDescriptor,za=(c,t,e,s)=>{for(var a=qa(t,e),n=c.length-1,i;n>=0;n--)(i=c[n])&&(a=i(t,e,a)||a);return a&&Ka(t,e,a),a};const{Decorator:ns}=p.Utils;class is{constructor(t){h(this,"id");h(this,"isMuteAll");h(this,"masterVolume");h(this,"audioClips");this.id=t,this.masterVolume=1,this.isMuteAll=!1,this.audioClips={}}getId(){return this.id}getAudioClip(t){return this.audioClips[t]?this.audioClips[t]:null}setAudioClip(t,e){this.audioClips[t]={...this.audioClips[t],...e}}async play(t,e){const s=this.getAudioClip(t);if(s){const{audioPlayer:a}=s;this.playWithRealConfig(a,e)}else await this.loadAndPlay(t,e)}async loadAndPlay(t,e){const s=await this.onLoadAudio(t,e);if(!s)return;const{volume:a=1}=e||{};this.setAudioClip(t,{volume:a,audioPlayer:s}),this.playWithRealConfig(s,e)}playWithRealConfig(t,e){if(e){const{volume:s=1}=e;e.volume=this.masterVolume*s}t.play(e)}pause(t){const e=this.getAudioClip(t);if(!e)return!1;const{audioPlayer:s}=e;return s.pause(),!0}resume(t){const e=this.getAudioClip(t);if(!e)return!1;const{audioPlayer:s}=e;return s.resume(),!0}stop(t){const e=this.getAudioClip(t);if(!e)return!1;const{audioPlayer:s}=e;return s.stop(),!0}stopAll(){this.callAudioPlayers("stop")}muteAll(){this.isMuteAll||(this.isMuteAll=!0,this.callAudioPlayers("mute"))}unmuteAll(){this.isMuteAll&&(this.isMuteAll=!1,this.callAudioPlayers("unmute"))}setVolume(t){this.masterVolume=t,this.callAudioPlayers("setVolume")}getVolume(){return this.masterVolume}queueAudioPlayer(t,e){try{const{audioPlayer:s,volume:a=1}=t;switch(e){case"play":s.play();break;case"pause":s.pause();break;case"resume":s.resume();break;case"stop":s.stop();break;case"mute":s.setVolume(0);break;case"unmute":case"setVolume":s.setVolume(this.masterVolume*a);break;default:throw new Error(`Unsupported function: ${e}`)}}catch{}}callAudioPlayers(t){const{Object:e}=p.Utils,s=e.vals(this.audioClips);for(const a of s)this.queueAudioPlayer(a,t)}}za([ns.tryCatch(),ns.validateParams("string")],is.prototype,"loadAndPlay");var Ya=Object.defineProperty,Ja=Object.getOwnPropertyDescriptor,Qa=(c,t,e,s)=>{for(var a=Ja(t,e),n=c.length-1,i;n>=0;n--)(i=c[n])&&(a=i(t,e,a)||a);return a&&Ya(t,e,a),a};p.Plugins.Audio={BaseAudioPlayer:Wa,BaseChannelManager:is};const{Decorator:rs}=p.Utils;class os extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"firstChannelId");h(this,"channels",{})}addChannel(e){const s=e.getId();this.channels[s]=e,this.firstChannelId||(this.firstChannelId=s)}getChannel(e){if(e===void 0)return this.channels[this.firstChannelId];const s=this.channels[e];if(!s)throw new Error(`Channel ${e} not found`);return s}async play(e,s,a){await this.getChannel(a).play(e,s)}pause(e,s){try{this.getChannel(s).pause(e)}catch{}}resume(e,s){try{this.getChannel(s).resume(e)}catch{}}stop(e,s){try{this.getChannel(s).stop(e)}catch{}}stopAll(e){try{this.getChannel(e).stopAll()}catch{}}mute(e){try{this.getChannel(e).muteAll()}catch{}}unmute(e){try{this.getChannel(e).unmuteAll()}catch{}}setVolume(e,s){try{this.getChannel(s).setVolume(e)}catch{}}getVolume(e){try{return this.getChannel(e).getVolume()}catch{return-1}}}Qa([rs.tryCatch(),rs.validateParams("string")],os.prototype,"play");const Xa={token:"",isRequesting:!1},{Utils:{Object:Za}}=p;class en extends N.Plugins.BasePlugin{init(){const{storage:t}=this.game;t.addStorage("auth",Xa)}async requestToken(){const{storage:t}=this.game;try{if(t.getStorageData("auth","isRequesting")||t.getStorageData("auth","token")!=="")return;t.setStorageData("auth","isRequesting",!0);const n=(await GameSDK.player.getSignedPlayerInfoAsync()).getSignature();t.setStorageData("auth","token",n)}catch(e){if(Za.hasOwn(e,"code")&&e.code==="PENDING_REQUEST")return;t.setStorageData("auth","token","")}finally{t.setStorageData("auth","isRequesting",!1)}}getToken(){const{storage:t}=this.game;return t.getStorageData("auth","token")??""}}var ce=(c=>(c.SOLO="solo",c.TOURNAMENT="tournament",c.SHARE_INVITE="share_invite",c.MATCHING_GROUP="matching_group_match",c.CHALLENGE_FRIEND="challenge_friend_match",c))(ce||{});const ge=Yt,{Configs:tn,Utils:{Array:sn,Valid:an,Browser:nn}}=p;class rn{constructor(t){h(this,"game");this.game=t}isValidContextType(t){return["THREAD","POST","SOLO","GROUP"].indexOf(t)>=0}isValidEntryPointData(t){return an.isObject(t)}isTournamentEntryPoint(t){return sn.has(["facebook~game_list~tournaments","fb_feed_tournament_unit","messenger~bot_thread~tournaments"],t)}receiveContext(t,e,s){const{storage:a}=this.game;a.setStorageData("context","contextId",t),this.isValidEntryPointData(s)&&a.setStorageData("context","entryPointData",s),this.isValidContextType(e)&&a.setStorageData("context","contextType",e)}async detectContextSessionType(){const{storage:t}=this.game,e=t.getStorageData("context","entryPointData"),{type:s}=e??{},{SOLO:a,TOURNAMENT:n,MATCHING_GROUP:i,SHARE_INVITE:r,CHALLENGE_FRIEND:o}=ce;let l=a;s===n&&(l=n),s===i&&(l=i),(s===o||s===r)&&(l=o),l===a&&(tn.Core.FastCheckTournamentContext?l=this.fastCheckTournamentContext()||l:l=await this.outdatedCheckTournamentContext()||l),t.setStorageData("context","sessionContextType",l)}fastCheckTournamentContext(){const e=nn.getQueryParams().entry_point;return typeof e!="string"||!this.isTournamentEntryPoint(e)?!1:ce.TOURNAMENT}async outdatedCheckTournamentContext(){const{storage:t}=this.game;if(!("getTournamentAsync"in GameSDK))return!1;try{const e=await GameSDK.getTournamentAsync();return t.setStorageData("context","contextId",e.getContextID()),e.getEndTime()>Date.now()/1e3?ce.TOURNAMENT:!1}catch{return!1}}detectContextGameMode(){const{player:t,storage:e}=this.game,s=e.getStorageData("context","entryPointData"),a=e.getStorageData("context","sessionContextType"),n=t.getPlayerId(),{matchId:i,playerId:r,opponentId:o=Q.playerId}=s??{},l=n===r,u=o===Q.playerId||[o,r].indexOf(n)>=0,{TOURNAMENT:y,MATCHING_GROUP:m,SHARE_INVITE:f,CHALLENGE_FRIEND:D}=ce;let A=ge.SINGLE;a===y&&(A=ge.TOURNAMENT),a===f&&!l&&(A=ge.CHALLENGE_FRIEND),a===D&&i&&u&&(A=ge.CHALLENGE_FRIEND),a===m&&(A=ge.MATCHING_GROUP),e.setStorageData("context","contextGameMode",A)}}class cs extends Error{constructor(t){super(t),this.name="PlayerHasFinishedMatch",this.message=t??"Player has finished match"}}class Dt extends Error{constructor(t){super(t),this.name="PlayerNotJoinInMatch",this.message=t||"Player is not join in match"}}const{Events:He,Plugins:{Analytics:ls},Utils:{Valid:on}}=p;class cn{constructor(t){h(this,"game");this.game=t}async processContextData(){const{player:t,storage:e,monitorError:s}=this.game,a=e.getStorageData("context","contextId")??"",n=e.getStorageData("context","entryPointData")??{},i=e.getStorageData("context","sessionContextType")??"",{type:r,matchId:o,playerId:l,opponentId:d,playerScore:u,action:y}=n;y&&await this.processEntryPointAction(y);const m=t.isFirstLogin();setTimeout(()=>{this.logUserAnalytics(m)},1e3);const{TOURNAMENT:f,SHARE_INVITE:D,MATCHING_GROUP:A,CHALLENGE_FRIEND:T}=ce;if(i===f)try{await this.processTournamentModeAsync(a);return}catch{s==null||s.sendException(new Error("Process Tournament Fail"),{contextId:a,isFirstLogin:m,entryPointData:n,playerData:t.getPlayerData()})}if(i===T){if(r===D&&typeof l=="string"){await this.processChallengeFromPostAsync(l);return}if(r===T&&typeof o=="string"&&typeof l=="string"&&typeof d=="string"){await this.processChallengeFromMessageAsync({contextId:a,matchId:o,playerId:l,opponentId:d});return}}if(i===A&&typeof l=="string"&&typeof u=="number"){await this.processMatchingGroupModeAsync(l,u);return}if(m){await this.processSingleModeAsync(!0),t.loggedIn();return}this.switchToDashboardScene()}logUserAnalytics(t){try{const{player:e,analytics:s}=this.game;if(t)s.event(ls.Events.NEW_USER);else{const{coins:a}=e.getPlayerData().gameData;s.event(ls.Events.RETURNING_USER,{coins:a})}}catch{}}async processEntryPointAction(t){try{const{player:e}=this.game;switch(t){case"reset_data":e.setPlayerDataByName("score",0),e.setPlayerDataByName("endlessScore",0),e.setGameData({coins:0,level:1}),await e.syncProfileToServer();break;case"enable_debug":e.setPlayerDataByName("debug",!0);break;case"set_locale_en":this.requestSetLocale("en");break;case"set_locale_ru":this.requestSetLocale("ru");break}}catch{}}requestSetLocale(t){const{event:e}=this.game;e.emit(He.REQUEST_LANGUAGE,{locale:t})}async processTournamentModeAsync(t){const{match:e,player:s}=this.game,a=s.getPlayerId();if(on.isEmpty(t))throw new Error("Cannot get contextId");await e.tournament.continue.processAsync({playerId:a,contextId:t}),this.switchToGameScene()}async processChallengeFromPostAsync(t){const{match:e,player:s}=this.game,a=s.getPlayerId();if(a===t)await e.single.start.processAsync({playerId:a});else try{await e.challenge.friend.processAsync({playerId:a,opponentId:t})}catch{await e.single.start.processAsync({playerId:a})}this.switchToGameScene()}async processChallengeFromMessageAsync(t){try{await this.processContinueChallengeFromMessageAsync(t)}catch(e){if(e instanceof cs){await this.processAwaitChallengeFromMessageAsync(t);return}if(e instanceof Dt){await this.processJoinChallengeFromMessageAsync(t);return}this.switchToDashboardScene()}}async processContinueChallengeFromMessageAsync(t){const{contextId:e,matchId:s,playerId:a,opponentId:n}=t,{match:i,player:r}=this.game,o=r.getPlayerId();if(a===o)await i.challenge.continue.processAsync({contextId:e,matchId:s,playerId:o,opponentId:n});else{const d=n===Q.playerId;await i.challenge.continue.processAsync({contextId:e,matchId:s,playerId:o,opponentId:d?n:a})}this.switchToGameScene()}async processJoinChallengeFromMessageAsync(t){const{contextId:e,matchId:s,playerId:a}=t,{match:n,player:i}=this.game,r=i.getPlayerId();await n.challenge.join.processAsync({contextId:e,matchId:s,playerId:r,opponentId:a}),this.switchToGameScene()}async processAwaitChallengeFromMessageAsync(t){const{contextId:e,matchId:s,playerId:a}=t,{match:n,player:i}=this.game,r=i.getPlayerId();try{await n.challenge.await.processAsync({contextId:e,matchId:s,playerId:r,opponentId:a}),this.switchToChallengeResultScene()}catch{await this.processResultChallengeFromMessageAsync(t)}}async processResultChallengeFromMessageAsync(t){const{contextId:e,matchId:s,playerId:a}=t,{match:n,player:i}=this.game,r=i.getPlayerId();try{await n.challenge.result.processAsync({contextId:e,matchId:s,playerId:r,opponentId:a}),this.switchToChallengeResultScene()}catch{this.switchToDashboardScene()}}async processMatchingGroupModeAsync(t,e){const{match:s,player:a}=this.game;await s.group.join.processAsync({playerId:a.getPlayerId(),opponentId:t,opponentScore:e}),this.switchToGameScene()}async processSingleModeAsync(t){const{match:e,player:s}=this.game,a=s.getPlayerId();t&&await e.handler.setMatchCustomData({level:0}),await e.single.start.processAsync({playerId:a}),this.switchToGameScene()}switchToDashboardScene(){const{event:t}=this.game;t.emit(He.SWITCH_SCENE,{sceneName:"DashboardScene",sceneData:{isFromLoader:!0}})}switchToGameScene(){const{event:t}=this.game;t.emit(He.SWITCH_SCENE,{sceneName:"GameScene",sceneData:{isFromLoader:!0}})}switchToChallengeResultScene(){const{event:t}=this.game;t.emit(He.SWITCH_SCENE,{sceneName:"ChallengeResultScene",sceneData:{isFromLoader:!0}})}}const ds={processed:!1,contextId:"",contextType:"SOLO",entryPointData:{},contextGameMode:"",sessionContextType:""},{Events:be}=p;class ln extends N.Plugins.BasePlugin{constructor(e){super(e);h(this,"context");h(this,"loader");this.loader=new cn(e),this.context=new rn(e)}init(){const{storage:e}=this.game;e.addStorage("context",ds)}getSessionContextTypes(){return ce}async processContextData(){const{event:e,monitorError:s}=this.game;try{e.getEventEmitCount(be.CONTEXT_SESSION_TYPE_DETECTED)>0||await e.waitTo(be.CONTEXT_SESSION_TYPE_DETECTED,3e3),await this.loader.processContextData(),e.emit(be.CONTEXT_DATA_PROCESSED)}catch(a){if(this.switchToDashboardScene(),s){const n=a instanceof Error?a:new Error(JSON.stringify(a));s.sendException(n)}}}async detectContextSessionType(){const{event:e,monitorError:s}=this.game;try{await this.context.detectContextSessionType(),e.emit(be.CONTEXT_SESSION_TYPE_DETECTED)}catch(a){if(s){const n=a instanceof Error?a:new Error(JSON.stringify(a));s.sendException(n)}}}detectContextGameMode(){this.context.detectContextGameMode()}receiveContext(e,s,a){this.context.receiveContext(e,s,a)}switchToDashboardScene(){const{event:e}=this.game;e.emit(be.SWITCH_SCENE,{sceneName:"DashboardScene"})}}const{Valid:It}=p.Utils,{contextId:dn,contextType:hn,entryPointData:un}=ds,Pt="is invalid";class hs extends k{constructor(){super(...arguments);h(this,"data")}setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateContextId(e){It.isString(e)||this.exception("contextId",Pt)}validateContextType(e){(!It.isString(e)||!e)&&this.exception("contextType",Pt)}validateEntryPointData(e){It.isObject(e)||this.exception("entryPointData",Pt)}toObject(){return super.toObject()}}hs.addDefaultData({contextId:dn,contextType:hn,entryPointData:un}),p.Dtos.Context={Info:hs};const pn={0:{id:1,type:"coin",value:300},1:{id:2,type:"coin",value:500},2:{id:3,type:"coin",value:1e3},3:{id:4,type:"coin",value:2e3},4:{id:5,type:"coin",value:3e3},5:{id:6,type:"coin",value:5e3},6:{id:7,type:"coin",value:1e3}},{Object:yn}=p.Utils;class fn{async getDailyRewardsAsync(){return yn.vals(pn)}}const V={REWARDED:"rewarded",SKIPPED:"skipped",READY:"ready",WAITING:"waiting"},gn={dailyRewards:{}},{Configs:{DailyRewards:{CheckInterrupt:us,MaxDays:ps,MockTime:ys}},Utils:{Array:vt,Valid:je}}=p,We=ys>0?ys:864e5;class mn extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"dailyRewardsApi",new fn)}init(){const{storage:e}=this.game;e.addStorage("dailyRewards",gn)}async requestDailyRewardsAsync(){const e=await this.dailyRewardsApi.getDailyRewardsAsync(),{logs:s,rewards:a}=this.parseDailyRewards(e);this.setRewardsLog(s),this.setDailyRewards(a)}getDailyRewards(){const{storage:e}=this.game,s=e.getStorageData("dailyRewards","dailyRewards");return s||null}logLoginReward(){us?this.logFromFirstReward():this.logFromLastReward()}logFromFirstReward(){const{player:e}=this.game,{logDays:s,firstReward:a}=e.getPlayerData().dailyRewarded,n=new Date,i=[...s];if(a===0){i[0]=!0,je.isDebugger()||n.setHours(0,0,0,0),this.setRewardsLog({logDays:i,firstReward:n.valueOf(),lastReward:n.valueOf()});return}const r=n.valueOf()-a,o=Math.floor(r/We);o>=ps||o>=s.length||(i[o]=!0,je.isDebugger()||n.setHours(0,0,0,0),this.setRewardsLog({logDays:i,lastReward:n.valueOf()}))}logFromLastReward(){const{player:e}=this.game,{logDays:s,lastReward:a}=e.getPlayerData().dailyRewarded,n=new Date,i=[...s];if(a===0){i[0]=!0,je.isDebugger()||n.setHours(0,0,0,0),this.setRewardsLog({logDays:i,firstReward:n.valueOf(),lastReward:n.valueOf()});return}const r=n.valueOf()-a;if(Math.floor(r/We)<1)return;const l=vt.searchIndex(i,d=>d===!1);l!==void 0&&(i[l]=!0,je.isDebugger()||n.setHours(0,0,0,0),this.setRewardsLog({logDays:i,lastReward:n.valueOf()}))}setRewardsLog(e){const{logDays:s,firstReward:a,lastReward:n}=e,{player:i}=this.game,r=i.getPlayerData().dailyRewarded;i.setPlayerDataByName("dailyRewarded",{logDays:s!==void 0?[...s]:[...r.logDays],firstReward:a??r.firstReward,lastReward:n??r.lastReward})}parseDailyRewards(e){const{player:s}=this.game,{logDays:a,firstReward:n,lastReward:i}=s.getPlayerData().dailyRewarded;if(a===void 0||n===void 0||n===0||i===void 0||i===0||a.length!==e.length){const r=this.getDefaultDailyRewards(e);return{logs:{logDays:r.logDays,firstReward:0,lastReward:0},rewards:r.rewards}}return us?this.parseFromFirstReward(e,a,n,i):this.parseFromLastReward(e,a,n,i)}parseFromFirstReward(e,s,a,n){const r=Date.now()-a;if(r<0){const f=this.getDefaultDailyRewards(e);return{logs:{logDays:f.logDays,firstReward:0,lastReward:0},rewards:f.rewards}}const o=Math.floor(r/We),l=o>=ps||o>=s.length,d=vt.search(s.slice(0,o),f=>f===!1)!==void 0;if(l||d){const f=this.getDefaultDailyRewards(e);return{logs:{logDays:f.logDays,firstReward:0,lastReward:n},rewards:f.rewards}}const y=[],m={};for(let f=0;f<e.length;f++){const D=e[f],A=y.length>o,T=y.length===o,M=s[f];if(A){y.push(!1),m[D.id]={...D,status:V.WAITING};continue}if(y.push(M),T){m[D.id]={...D,status:M?V.REWARDED:V.READY};continue}m[D.id]={...D,status:M?V.REWARDED:V.SKIPPED}}return{logs:{logDays:y,firstReward:a,lastReward:n},rewards:m}}parseFromLastReward(e,s,a,n){const r=Date.now()-n;if(r<0){const f=this.getDefaultDailyRewards(e);return{logs:{logDays:f.logDays,firstReward:0,lastReward:0},rewards:f.rewards}}const l=Math.floor(r/We)>=1,d=vt.searchIndex(s,f=>f===!1);if(d===-1&&l){const f=this.getDefaultDailyRewards(e);return f.rewards[e[0].id].status=l?V.READY:V.WAITING,{logs:{logDays:f.logDays,firstReward:0,lastReward:n},rewards:f.rewards}}const y=[],m={};for(let f=0,D=e.length;f<D;f++){const A=e[f],T=d!==-1&&f>d,M=f===d;if(T){y.push(!1),m[A.id]={...A,status:V.WAITING};continue}if(M){y.push(!1),m[A.id]={...A,status:l?V.READY:V.WAITING};continue}y.push(!0),m[A.id]={...A,status:V.REWARDED}}return{logs:{logDays:y,firstReward:a,lastReward:n},rewards:m}}getDefaultDailyRewards(e){const s=[],a={};for(const n of e)s.push(!1),a[n.id]={...n,status:V.WAITING};return a[e[0].id].status=V.READY,{logDays:s,rewards:a}}setDailyRewards(e){const{storage:s}=this.game;s.setStorageData("dailyRewards","dailyRewards",e)}}var fs={exports:{}};(function(c){var t=Object.prototype.hasOwnProperty,e="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(e=!1));function a(o,l,d){this.fn=o,this.context=l,this.once=d||!1}function n(o,l,d,u,y){if(typeof d!="function")throw new TypeError("The listener must be a function");var m=new a(d,u||o,y),f=e?e+l:l;return o._events[f]?o._events[f].fn?o._events[f]=[o._events[f],m]:o._events[f].push(m):(o._events[f]=m,o._eventsCount++),o}function i(o,l){--o._eventsCount===0?o._events=new s:delete o._events[l]}function r(){this._events=new s,this._eventsCount=0}r.prototype.eventNames=function(){var l=[],d,u;if(this._eventsCount===0)return l;for(u in d=this._events)t.call(d,u)&&l.push(e?u.slice(1):u);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(d)):l},r.prototype.listeners=function(l){var d=e?e+l:l,u=this._events[d];if(!u)return[];if(u.fn)return[u.fn];for(var y=0,m=u.length,f=new Array(m);y<m;y++)f[y]=u[y].fn;return f},r.prototype.listenerCount=function(l){var d=e?e+l:l,u=this._events[d];return u?u.fn?1:u.length:0},r.prototype.emit=function(l,d,u,y,m,f){var D=e?e+l:l;if(!this._events[D])return!1;var A=this._events[D],T=arguments.length,M,x;if(A.fn){switch(A.once&&this.removeListener(l,A.fn,void 0,!0),T){case 1:return A.fn.call(A.context),!0;case 2:return A.fn.call(A.context,d),!0;case 3:return A.fn.call(A.context,d,u),!0;case 4:return A.fn.call(A.context,d,u,y),!0;case 5:return A.fn.call(A.context,d,u,y,m),!0;case 6:return A.fn.call(A.context,d,u,y,m,f),!0}for(x=1,M=new Array(T-1);x<T;x++)M[x-1]=arguments[x];A.fn.apply(A.context,M)}else{var Ac=A.length,$e;for(x=0;x<Ac;x++)switch(A[x].once&&this.removeListener(l,A[x].fn,void 0,!0),T){case 1:A[x].fn.call(A[x].context);break;case 2:A[x].fn.call(A[x].context,d);break;case 3:A[x].fn.call(A[x].context,d,u);break;case 4:A[x].fn.call(A[x].context,d,u,y);break;default:if(!M)for($e=1,M=new Array(T-1);$e<T;$e++)M[$e-1]=arguments[$e];A[x].fn.apply(A[x].context,M)}}return!0},r.prototype.on=function(l,d,u){return n(this,l,d,u,!1)},r.prototype.once=function(l,d,u){return n(this,l,d,u,!0)},r.prototype.removeListener=function(l,d,u,y){var m=e?e+l:l;if(!this._events[m])return this;if(!d)return i(this,m),this;var f=this._events[m];if(f.fn)f.fn===d&&(!y||f.once)&&(!u||f.context===u)&&i(this,m);else{for(var D=0,A=[],T=f.length;D<T;D++)(f[D].fn!==d||y&&!f[D].once||u&&f[D].context!==u)&&A.push(f[D]);A.length?this._events[m]=A.length===1?A[0]:A:i(this,m)}return this},r.prototype.removeAllListeners=function(l){var d;return l?(d=e?e+l:l,this._events[d]&&i(this,d)):(this._events=new s,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=e,r.EventEmitter=r,c.exports=r})(fs);var An=fs.exports;const wn=Qt(An),le=new wn,Dn={names:[],history:[]};class In extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"enableLog",!1);h(this,"muteEvents",[])}init(){const{storage:e}=this.game;e.addStorage("event",Dn)}enableLogEvent(){this.enableLog=!0}on(e,s){this.validateCallback(s),this.addEventName(e),this.addHistory(e,"on","listening"),le.on(e,s)}once(e,s){this.validateCallback(s),this.addEventName(e),this.addHistory(e,"once","listening"),le.once(e,s)}waitTo(e,s){return new Promise((a,n)=>{let i;const r=o=>{clearTimeout(i),a(o)};this.once(e,r),s&&s>0&&(i=setTimeout(()=>{this.off(e,r),n(new Error(`Event ${e} timeout`))},s))})}catchUp(e,s){if(this.validateCallback(s),this.once(e,s),!(this.getEventEmitCount(e)>0))return;const{payload:n}=this.getLastEventInfo(e)??{};this.emit(e,n)}off(e,s){this.validateCallback(s),le.off(e,s),this.addHistory(e,"action","removed")}mute(e){this.muteEvents.indexOf(e)>-1||this.muteEvents.push(e)}clear(e){le.removeAllListeners(e),this.addHistory(e,"action","removed")}emit(e,s){if(this.muteEvents.indexOf(e)>-1)return;let a=[];s&&(a=[s]),this.addHistory(e,"action","called",s),le.emit(e,...a)}validateCallback(e){if(typeof e!="function")throw new Error("Callback must be a function")}addEventName(e){const{storage:s}=this.game,a=s.getStorageData("event","names");a&&a.indexOf(e)<0&&a.push(e)}limitHistory(e){if(e.length<=1e4)return e;const{Utils:{Array:a}}=p;return a.limit(e,1e4)}getEventListeners(){const e=le.eventNames();return Object.keys(e)}getHistory(){const{storage:e}=this.game,s=e.getStorageData("event","history")??[];return this.limitHistory(s)}getEventEmitCount(e){return this.getHistory().filter(a=>a.name===e&&a.status==="called").length}getLastEventInfo(e){const s=this.getHistory();let a=null;for(let n=s.length-1;n>=0;n--)if(s[n].name===e){a=s[n];break}return a}getTypeFromHistory(e){const s=this.getLastEventInfo(e);return(s==null?void 0:s.type)??null}getCallsFromHistory(e){const s=this.getLastEventInfo(e);return(s==null?void 0:s.called)??0}addHistory(e,s,a,n){const r=this.getTypeFromHistory(e)??s,o=this.getCallsFromHistory(e),l=a==="called"?o+1:o;this.getHistory().push({type:r,status:a,name:e,called:l,payload:n??{}}),this.logEventInfo(e,r,a,l)}logEventInfo(e,s,a,n){this.enableLog&&(a==="listening"&&le.listenerCount(e),a==="called"&&le.listenerCount(e))}}const Pn='nunito,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif',{Configs:vn,Utils:Sn}=p,{Object:St}=Sn,{Enabled:En,WideframeConfigs:Et}=vn.FrameCapture,xn=async c=>{if(!En)return null;const t=bn(c);if(!t)return null;Cn(t,Et.ResultChallenge);const{frameCapture:e}=window.game,{Width:s,Height:a}=Et.ResultChallenge;return e.captureAsync({name:"ResultChallenge",width:s,height:a,renderOptions:t})},Cn=(c,t)=>{const{Width:e,Height:s,Wideframe:a}=t;c.wideframe={name:"result-challenge",type:"image",depth:0,image:a,size:[e,s],position:[0,0]}},bn=c=>{try{const{playerId:t="10",playerPhoto:e="",playerScore:s=0,opponentId:a="20",opponentPhoto:n="",opponentScore:i=0,isPlayerFinished:r,isOpponentFinished:o}=c,{RenderOptions:l}=Et.ResultChallenge,d=St.clone(l);if(!d)return null;const u=St.clear(d),y=St.camelCaseKeys(u),{playerPhoto:m,opponentPhoto:f}=y,D=s===i,A=s>i,T=r??o,M=r&&o;return m.type==="image"&&(m.name=`${t}`,m.image=e),f.type==="image"&&(f.name=`${a}`,f.image=n),T?_n(y,{playerScore:s,opponentScore:i,isPlayerFinished:r,isOpponentFinished:o}):(delete y.leftScore,delete y.rightScore),!M||D?(delete y.leftCrown,delete y.rightCrown,y):(A?delete y.rightCrown:delete y.leftCrown,y)}catch{return null}},_n=(c,t)=>{const{leftScore:e,rightScore:s}=c,{playerScore:a=0,opponentScore:n=0,isPlayerFinished:i,isOpponentFinished:r}=t;(e==null?void 0:e.type)==="text"&&(e.text=i?`${a}`:"???"),(s==null?void 0:s.type)==="text"&&(s.text=r?`${n}`:"???")},{Configs:Nn,Utils:Ln}=p,{Object:xt}=Ln,{Enabled:Tn,WideframeConfigs:Ct}=Nn.FrameCapture,On=async c=>{if(!Tn)return null;const t=Rn(c);if(!t)return null;Mn(t,Ct.ShareLeaderboard);const{frameCapture:e}=window.game,{Width:s,Height:a}=Ct.ShareLeaderboard;return e.captureAsync({name:"ShareLeaderboard",width:s,height:a,renderOptions:t})},Mn=(c,t)=>{const{Width:e,Height:s,Wideframe:a}=t;c.wideframe={name:"share-leaderboard",type:"image",depth:0,image:a,size:[e,s],position:[0,0]}},Rn=c=>{try{const{playerId:t,playerPhoto:e,leaders:s}=c,{RenderOptions:a}=Ct.ShareLeaderboard,n=xt.clone(a);if(!n)return null;const i=xt.clear(n),r=xt.camelCaseKeys(i),{avatar:o}=r;return o.type==="image"&&(o.name=`${t}`,o.image=e),Fn(r,s),r}catch{return null}},Fn=(c,t)=>{const e="600 48px";t.forEach((s,a)=>{const{id:n,name:i,photo:r,score:o}=s;let l=1294+180*a;c[`photo_${n}`]={depth:-1,name:n,type:"image",image:r,size:[96,96],position:[436,l]},l=1360+180*a,c[`name_${n}`]={font:e,depth:1,name:n,type:"text",text:i,position:[600,l]},c[`score_${n}`]={font:e,depth:1,name:n,type:"text",text:`${o}`,position:[100,l]}})},{Configs:Gn,Utils:$n}=p,{Object:bt}=$n,{Enabled:kn,WideframeConfigs:_t}=Gn.FrameCapture,Vn=async c=>{if(!kn)return null;const t=Un(c);if(!t)return null;Bn(t,_t.ShareScore);const{frameCapture:e}=window.game,{Width:s,Height:a}=_t.ShareScore;return e.captureAsync({name:"ShareScore",width:s,height:a,renderOptions:t})},Bn=(c,t)=>{const{Width:e,Height:s,Wideframe:a}=t;c.wideframe={name:"share-score",type:"image",depth:0,image:a,size:[e,s],position:[0,0]}},Un=c=>{try{const{playerId:t,playerPhoto:e,playerScore:s}=c,{RenderOptions:a}=_t.ShareScore,n=bt.clone(a);if(!n)return null;const i=bt.clear(n),r=bt.camelCaseKeys(i),{avatar:o,playerScore:l}=r;return o.type==="image"&&(o.name=`${t}`,o.image=e),l.type==="text"&&(l.text=`${s}`),r}catch{return null}},{Configs:{FrameCapture:{Options:Nt}},Utils:{Browser:Hn,Image:Ke,Object:_e,Valid:qe}}=p;class jn extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"width");h(this,"height");h(this,"canvas",null);h(this,"context",null);h(this,"testRenderOptions",null);h(this,"caches",{});h(this,"wideframe",{})}init(){this.addWideframeRender("renderShareScore",Vn),this.addWideframeRender("renderResultChallenge",xn),this.addWideframeRender("renderShareLeaderboard",On)}async preloadAsync(e){const{renderOptions:s}=e;await this.loadImages(s)}async captureAsync(e){const{width:s,height:a,renderOptions:n}=e;return await this.loadImages(n),this.width=s,this.height=a,this.createCanvas(),this.drawObjects(n),this.snapshotFrameAsync()}addWideframeRender(e,s){this.wideframe[e]=s}setTestRenderOptions(e){if(!e){this.testRenderOptions=null;return}const s=_e.camelCaseKeys(e);this.testRenderOptions=_e.merge(this.testRenderOptions,s)}createCanvas(){if(!this.canvas){const e=Hn.createCanvas({type:"canvas",contextAttributes:{alpha:!1,desynchronized:!0,willReadFrequently:!0},contextType:"2d"});this.canvas=e==null?void 0:e.canvas,this.context=e==null?void 0:e.context}if(!this.canvas)throw new Error("Failed to create canvas");this.context&&this.context.clearRect(0,0,this.width,this.height),this.canvas.width=this.width,this.canvas.height=this.height}async loadImages(e){const s=_e.vals(e).filter(r=>r.type==="image"),a=this.prepareLoadImages(s),n=_e.vals(a);if(n.length<1)return;const i=await Promise.all(n);this.cacheImages(a,i)}prepareLoadImages(e){const s={};for(const a of e){const{name:n,image:i,fallbackImage:r}=a,o=this.caches[n];!qe.isString(i)||o||(i===""&&qe.isString(r)&&(a.image=r),s[n]=new Promise(l=>{Ke.loadImage(i).then(u=>{l(u)}).catch(()=>{qe.isString(r)?(a.image=r,Ke.loadImage(a.image).then(u=>{l(u)}).catch(()=>{l(null)})):l(null)})}))}return s}cacheImages(e,s){for(const a in e){const n=s.shift();n&&(this.caches[a]=n)}}drawObjects(e){const s=_e.vals(e).sort((a,n)=>a.depth-n.depth);for(const a of s)switch(a.type){case"text":this.drawText(a);break;case"image":this.drawImage(a);break}}drawText(e){if(!this.canvas||!this.context)return;const{position:s,font:a,text:n,color:i,lineWidth:r,textAlign:o}=e;this.context.font=`${a} ${Pn}`,this.context.fillStyle=i??"#ffffff",r&&(this.context.lineWidth=r),o&&(this.context.textAlign=o);const[l,d]=s;this.context.fillText(n,l,d)}drawImage(e){if(!this.canvas||!this.context)return;const{name:s,size:a,position:n,fallbackImage:i}=e;let r=this.caches[s];if(!r&&i&&(r=this.caches[i]),!r)throw new Error(`Image ${s} not found`);const[o,l]=n,[d,u]=a;this.context.drawImage(r,o,l,d,u)}async snapshotFrameAsync(){if(!this.canvas)return null;let e=null;if(Nt.UseBlobIfPossible&&"toBlob"in this.canvas?e=await this.createAsBlob():e=this.createAsDataImage(),!e)throw new Error("Image data is null");return qe.isDebugger()&&Ke.logImage(e),e}createAsDataImage(){if(!this.canvas||!this.context)return null;const{Quality:e,RenderType:s}=Nt;return this.context.canvas.toDataURL(`image/${s}`,e)}createAsBlob(){return new Promise(e=>{if(!this.canvas){e(null);return}const{Quality:s,RenderType:a}=Nt;this.canvas.toBlob(n=>{if(!n){e(null);return}Ke.blobToDataImage(n).then(i=>{e(i)})},`image/${a}`,s)})}}class gs extends Error{constructor(e,s){const a=String(e);super(`Text with key "${a}" not found in locale "${s}"`);h(this,"key");h(this,"locale");this.name="MissingKeyInLocaleError",this.key=a,this.locale=s}}class Wn extends Error{constructor(e){super(`Locale "${e}" not found`);h(this,"locale");this.name="LocaleNotFoundError",this.locale=e}}const{Utils:{Object:Lt,Function:ms,Browser:Kn},Configs:{Languages:{DetectPlayerLocale:qn}}}=p;class zn extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"locale");h(this,"fallbackLocale");h(this,"data",{})}setFallbackLocale(e){this.fallbackLocale=e}hasTextKey(e,s){const a=s??this.getCurrentLocale(),{text:n}=this.getLocaleData(a);return Lt.hasOwn(n,e)}hasTextureKey(e,s){const a=s??this.getCurrentLocale(),{texture:n}=this.getLocaleData(a);return Lt.hasOwn(n,e)}add(e,s,a=!1){this.data[e]=s,a&&this.setFallbackLocale(e)}choose(e){this.locale=e;const{event:s}=this.game;s.emit(p.Events.LANGUAGE_CHANGED,{locale:e})}getText(e,s,a,n=!1){try{return this.uncaughtGetText(e,s,a,!n)}catch{return String(e)}}getTexture(e,s,a=!1){return this.uncaughtGetTexture(e,s,!a)}uncaughtGetText(e,s=[],a,n=!0){if(!n||this.fallbackLocale===void 0){const o=this.getRawText(e,a??this.getCurrentLocale());return this.replaceVariables(o,s)}const i=this.fallbackLocale,r=ms.retry(()=>this.getRawText(e,a??this.getCurrentLocale()),()=>this.getRawText(e,i));return this.replaceVariables(r,s)}getRawText(e,s){if(!this.hasTextKey(e,s))throw new gs(e,s);const{text:a}=this.getLocaleData(s);return a[e]}uncaughtGetTexture(e,s,a=!0){if(!a||this.fallbackLocale===void 0)return this.getRawTexture(e,s??this.getCurrentLocale());const n=this.fallbackLocale;return ms.retry(()=>this.getRawTexture(e,s??this.getCurrentLocale()),()=>this.getRawTexture(e,n))}getRawTexture(e,s){if(!this.hasTextureKey(e,s))throw new gs(e,s);const{texture:a}=this.getLocaleData(s);return a[e]}getCurrentLocale(){return this.locale??"en"}getLocaleData(e){const s=e??this.getCurrentLocale();if(!Lt.hasOwn(this.data,s))throw new Wn(s);return this.data[s]}replaceVariables(e,s){const a=s.length;if(a===0)return e;let n=e;for(let i=0;i<a;i++){const r=s[i],o=`%{${i}}`;n=n.replace(o,r)}return n}getPlayerLanguage(){const{player:e}=globalThis.game,s=GameSDK.getLocale(),a=s==null?void 0:s.trim().split(/[-_]/)[0],n=this.getBrowserLanguage();return a!==n?a??n:e.getPlayerDataByKey("isFirstLogin")?n:e.getPlayerSetting("language")??n}getBrowserLanguage(){var a;if(qn===!1)return"en";const e=Kn.getLocale();return(a=e==null?void 0:e.trim())==null?void 0:a.split(/[-_]/)[0]}}const Yn=pe("D",{_id:"",name:"",createdBy:"",description:"",expireTime:7*24*60*60*1e3,type:"app_leaderboard",timezone:"utc+0",createdAt:"2024-01-01T09:00:00.000Z",sortOrder:"desc",statistics:"max",resettable:"manually",resetScore:0,numberOfLeaders:15,amountPlayer:15}),{Configs:Jn,Utils:Qn}=p,{Object:Ne,String:As,Valid:ws}=Qn,{OtherHost:Le,Mockup:Te,AppId:Xn}=Jn;class Zn{constructor(){h(this,"mockAPI")}async initMockAPI(){if(this.mockAPI)return;const t=(await ie(async()=>{const{default:e}=await I.import("./bundle/LeaderboardAPIMock.js");return{default:e}},void 0,I.meta.url)).default;if(typeof t!="function")throw new Error("Cannot load LeaderboardAPIMock");this.mockAPI=new t}async getLeadersAsync(t,e,s){const a=As.params(s);let n;return Te.Leaderboards.Enabled?(await this.initMockAPI(),"playerIds"in s?n=await this.mockAPI.getPlayers(t,s):n=await this.mockAPI.getLeaders(t,s)):n=await Ie(`${e}?${a}`,{},Le),!Ne.hasOwn(n,"data")||!Array.isArray(n.data)?[]:n.data}async getLeaderboardAsync(t){let e;const s=`leaderboards/${t}`;return Te.Leaderboards.Enabled?(await this.initMockAPI(),e=await this.mockAPI.getLeaderboardAsync(t)):(e=await Ie(s,{},Le),Ne.hasOwn(e,"data")&&ws.isObject(e.data)&&(e=e.data)),e}async getLeaderboardsAsync(t){let e;const s=p.Utils.String.params(t);return Te.Leaderboards.Enabled?(await this.initMockAPI(),e=await this.mockAPI.getLeaderboardsAsync(t)):(e=await Ie(`leaderboards?${s}`,{},Le),Ne.hasOwn(e,"data")&&Array.isArray(e.data)?e=e.data:e=[]),e}async setLeaderboardScoreAsync(t){const{leaderboardId:e,playerId:s,score:a}=t;Te.Leaderboards.Enabled?(await this.initMockAPI(),await this.mockAPI.setScoreAsync(e,s,a)):await z(`leaderboards/${e}/players/${s}`,{score:a},{},Le)}async createLeaderboardAsync(t){const e=t._id??As.generateObjectId(),s=t.numberOfLeaders,a={...Yn,...t,_id:e,appId:Xn,numberOfLeaders:s},n="leaderboards";let i;if(Te.Leaderboards.Enabled?(await this.initMockAPI(),i=await this.mockAPI.createLeaderboard(a)):(i=await z(n,a,{},Le),Ne.hasOwn(i,"data")&&ws.isObject(i.data)&&(i=i.data)),!Ne.hasOwn(i,"_id")||i._id!==e)throw new Error("Create leaderboard failed");return e}}const Ds={limit:0,offset:0,leaders:{},isRequesting:!1,amountPlayer:0},ei={leaderboards:{}},{Utils:{Array:ti,Valid:si,Json:Is,Object:ze}}=p;class ai extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"lbAPI",new Zn);h(this,"configs")}init(){const{storage:e}=this.game;e.addStorage("leaderboard",ei),this.configs={}}addLeaderboard(e){const{name:s,type:a,leaderboardId:n,autoSortRank:i}=e;if(this.getLeaderboard(s))return;let o=`leaderboards/${n}/`;(a==="global"||a==="tournament")&&(o+="leaders"),a==="friends"&&(o+="players"),this.configs[s]={id:n,name:s,type:a,host:o,autoSortRank:i};const l=Is.clone(Ds);this.setLeaderboard(s,{...l})}async requestLeaderboardsAsync(e){try{return await this.lbAPI.getLeaderboardsAsync(e)}catch{return[]}}async requestLeaderboardAsync(e,s){try{this.validateLeaderboard(e),this.clearLeaderboard(e),this.setLeaderboard(e,{isRequesting:!0});const{id:a,type:n,host:i}=this.configs[e];let r=[];if(n==="friends"){const{player:o}=this.game,l=o.getPlayerId(),d=o.getConnectedPlayerIds(s,0),u=[l,...d];this.configs[e].playerIds=[...u],r=await this.lbAPI.getLeadersAsync(a,i,{playerIds:u})}else r=await this.lbAPI.getLeadersAsync(a,i,{limit:s,offset:0});if(r.length===0)return;await this.receiveLeaderboardAsync(e,r),this.setLeaderboard(e,{limit:s,offset:0})}finally{const a=await this.lbAPI.getLeaderboardAsync(this.configs[e].id),n=a?a.resettable:"",i=a?a.amountPlayer:0;this.setLeaderboard(e,{isRequesting:!1,resettable:n,amountPlayer:i})}}async loadMoreLeaderboardAsync(e,s){const a=this.getLeaderboard(e);if(a&&this.configs[e].type!=="friends")try{this.setLeaderboard(e,{isRequesting:!0});const{id:n,host:i}=this.configs[e],{offset:r,limit:o}=a,l=r+o,d=await this.lbAPI.getLeadersAsync(n,i,{limit:s,offset:l});if(d.length===0)return;this.receiveLeaderboardAsync(e,d),this.setLeaderboard(e,{limit:s,offset:l})}finally{this.setLeaderboard(e,{isRequesting:!1})}}getLeaderboard(e){const{storage:s}=this.game,a=s.getStorageData("leaderboard","leaderboards");return!a||!a[e]?null:a[e]}async getLeadersByPlayerIdsAsync(e,s){try{this.validateLeaderboard(e);const{id:a}=this.configs[e],n=`leaderboards/${a}/players`,i=await this.lbAPI.getLeadersAsync(a,n,{playerIds:s});return i.length===0?[]:this.toLeaders(i)}catch{return[]}}async getLeaderboardResponseAsync(e){return await this.lbAPI.getLeaderboardAsync(e)}clearLeaderboard(e){try{this.validateLeaderboard(e);const s=Is.clone(Ds);this.setLeaderboard(e,null),this.setLeaderboard(e,{...s})}catch{}}isLeaderboardEmpty(e){const s=this.getLeaderboard(e);if(!s)return!0;const{leaders:a}=s;return Object.keys(a).length===0}isExistLeaderboardId(e){const{configs:s}=this;return ze.vals(s).some(a=>a.id===e)}getLeaderboardName(e){const{configs:s}=this,a=ti.search(ze.vals(s),n=>n.id===e);return a?a.name:null}async setLeaderboardScoreAsync(e,s,a){try{if(GameSDK.extra.isGuest)return;this.validateLeaderboard(e);const{id:n}=this.configs[e],i=await this.getLastScoreOnLeaderboard(e,s);if(i&&a<=i)return;await this.lbAPI.setLeaderboardScoreAsync({leaderboardId:n,playerId:s,score:a})}catch{}}async getLastScoreOnLeaderboard(e,s){const a=await this.getLeadersByPlayerIdsAsync(e,[s]);return a.length===0?null:a[0].score}async createLeaderboardAsync(e){return this.lbAPI.createLeaderboardAsync(e)}validateLeaderboard(e){const s=this.getLeaderboard(e);if(!si.isObject(s))throw new Error(`Leaderboard with name ${e} not found`)}setLeaderboard(e,s){if(!s)return;const{storage:a}=this.game;a.setStorageData("leaderboard","leaderboards",{[e]:s})}async receiveLeaderboardAsync(e,s){this.validateLeaderboard(e);const n=(await this.toLeaders(s)).filter(u=>u.name&&u.photo),{leaders:i={}}=this.getLeaderboard(e)??{},r=n.filter(u=>i[u.playerId]?(i[u.playerId]=u,!1):!0),o=ze.vals(i);r.length>0&&o.unshift(...r);let l=o.sort((u,y)=>y.score-u.score);this.configs[e].autoSortRank&&(l=l.map((u,y)=>({...u,rank:y+1})));const d=ze.keyBy(l,"playerId");this.setLeaderboard(e,{leaders:d})}async toLeaders(e){const{profile:s}=this.game,a=e.map(o=>o.playerId);await s.requestProfiles(a);const n=s.getProfiles();return e.map(o=>{const{playerId:l}=o,d=n[l];return d?{...o,name:d.name,photo:d.photo}:{...o,name:"Nameless",photo:"default"}}).map(o=>({...o,score:parseInt(o.score,10)}))}}class ni{constructor(){h(this,"APIHost")}setAPIHost(t){this.APIHost=t}getAPIHost(){return this.APIHost}}const{Utils:Ps}=p;class ii extends ni{async createSingleMatchAsync(t){const s=await z("single-matches",t,{},this.getAPIHost());return this.returnValidMatchData(s)}async getSingleMatchDetailAsync(){const e=await Ie("single-matches/active",{},this.getAPIHost());return this.returnValidMatchData(e)}async updateSingleMatchMoveAsync(t,e){const s=`single-matches/${t}/move`,a=await z(s,e,{},this.getAPIHost());return this.returnValidMatchData(a)}async finishSingleMatchAsync(t){const e=`single-matches/${t}/finish`,s=await z(e,{},{},this.getAPIHost());return this.returnValidMatchData(s)}async createMatchAsync(t){const s=await z("matches",t,{},this.getAPIHost());return this.returnValidMatchData(s)}async joinMatchAsync(t){const e=`matches/${t}/join`,s=await z(e,{},{},this.getAPIHost());return this.returnValidMatchData(s)}async getMatchDetailByIdAsync(t){const e=`matches/${t}`,s=await Ie(e,{},this.getAPIHost());return this.returnValidMatchData(s)}async finishMatchAsync(t){const{matchId:e="",score:s=0,level:a=0,extraData:n={}}=t,i=`matches/${e}/finish`,r=await z(i,{matchId:e,score:s,level:a,extraData:n},{},this.getAPIHost());return this.returnValidMatchData(r)}returnValidMatchData(t){return Ps.Valid.isObject(t)?Ps.Object.hasOwn(t,"data")?t.data??{}:{}:{}}}class ri{constructor(t){h(this,"matchAPI");this.createAPI(),this.setAPIConfig(t)}createAPI(){this.matchAPI=new ii}setAPIConfig(t){t.matchAPIHost&&this.matchAPI.setAPIHost(t.matchAPIHost)}setMatchAPIInstance(t){this.matchAPI=t}getMatchAPI(){return this.matchAPI}}class v{constructor(t,e){h(this,"game");h(this,"match");this.game=t,this.match=e}startLog(t){}endLog(){}async processAsync(t){throw new Error("Not implemented")}}class vs extends X{constructor(t){super(t),this.name="LevelNotDefined",this.message=t??"Level is not defined"}}class Tt extends X{constructor(t){super(t),this.name="MatchModeNotDefined",this.message=t??"Match id is not defined"}}const{Object:Pc,Valid:oi}=p.Utils;class w{constructor(t){h(this,"game");h(this,"match");h(this,"nextHandler");this.game=t.game,this.match=t.match,this.nextHandler=null}setNext(t){return this.nextHandler=t,t}async processAsync(t){this.logData("Before",t)}async nextAsync(t){this.logData("After",t),this.nextHandler&&await this.nextHandler.processAsync(t)}logData(t,e){oi.isDebugger()}}const{Plugins:ci,Utils:li}=p,{Analytics:di}=ci,{String:Ss,Valid:Es}=li;class q extends w{async processAsync(t){super.processAsync(t);const{mode:e,customData:s}=t,{level:a}=s;this.validateMode(e),this.validateLevel(a);const{analytics:n}=this.game;n.event(di.Events.MATCH_START,{level:a,game_mode:Ss.toUpperCamelCase(e),level_name:this.getLevelName(a)}),await this.nextAsync(t)}validateMode(t){if(!Es.isString(t))throw new Tt}validateLevel(t){if(!Es.isNumber(t))throw new vs}getLevelName(t){return`Level ${Ss.padStart(t.toString(),5,"0")}`}}const F={OPEN:"open",ACTIVE:"active",FINISHED:"finished"};class L extends w{async processAsync(t){super.processAsync(t);const{mode:e,status:s}=t;let a=e??ge.SINGLE;s===F.FINISHED&&(a=ge.SINGLE),this.contextGameModeDetected(a),await this.nextAsync(t)}contextGameModeDetected(t){const{storage:e}=this.game;e.setStorageData("context","contextGameMode",t)}}class Ot extends Error{constructor(t){super(t),this.name="GetMatchDetailFailed",this.message=t??"Get match detail failed"}}class xs extends Error{constructor(t){super(t),this.name="MatchAreNotActive",this.message=t??"Match are not active"}}class Z extends X{constructor(t){super(t),this.name="MatchIdNotValid",this.message=t??"Match id is not valid"}}class hi extends Error{constructor(t){super(t),this.name="OpponentHasFinishedMatch",this.message=t||"Opponent has finished match"}}class U extends X{constructor(t){super(t),this.name="OpponentIdNotValid",this.message=t??"Opponent id is not valid"}}class Mt extends Error{constructor(t){super(t),this.name="PlayerNotCurrentInMatch",this.message=t??"The player is not currently in this match"}}class Cs extends Error{constructor(t){super(t),this.name="PlayerNotFinishedMatch",this.message=t||"Player not finished match"}}const{Dtos:ui,Utils:{Object:pi}}=p;class yi extends w{async processAsync(t){super.processAsync(t),this.validateMatchData(t);const e=await this.getMatchAsync(t),s=new ui.Match.Data(e).toObject();this.validateAwaitMatchData(t,s),this.updateMatchData(t,s),this.validateMatchStatus(t),this.validatePlayerTurn(t),this.validateOpponentTurn(t),await this.nextAsync(t)}validateMatchData(t){const{id:e}=t;if(typeof e!="string")throw new Z}validateMatchStatus(t){const{status:e}=t;if(e!==F.ACTIVE)throw new xs}validateAwaitMatchData(t,e){const{id:s,customData:a}=t,{_id:n,whitePlayerId:i,blackPlayerId:r}=e;if(typeof n!="string"||n!==s)throw new Ot;const{playerId:o}=a,l=i===o,d=r===o;if(!l&&r===Q.playerId)throw new Dt;if(!l&&!d)throw new Mt}validatePlayerTurn(t){const{profiles:e,customData:s}=t,{playerId:a}=s;if(typeof a!="string")throw new P;const{finished:n}=e[a];if(!n)throw new Cs}validateOpponentTurn(t){const{profiles:e,customData:s}=t,{opponentId:a}=s;if(typeof a!="string")throw new U;const{finished:n}=e[a];if(n)throw new hi}async getMatchAsync(t){const{id:e}=t;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):{}}updateMatchData(t,e){this.updateMatchGeneral(t,e),this.updatePlayerIds(t,e),this.initializeProfiles(t),this.updateScoresAndStatus(t,e)}updateMatchGeneral(t,e){const{status:s,extraData:a}=e;t.status=s,t.customData=pi.merge(t.customData,a)}updatePlayerIds(t,e){const{whitePlayerId:s,blackPlayerId:a}=e,n=s===t.customData.playerId;t.customData.playerId=n?s:a,t.customData.opponentId=n?a:s}initializeProfiles(t){const{playerId:e,opponentId:s}=t.customData;if(!e||!s)return;const a={name:"",photo:"",finished:!1};t.profiles[e]||(t.profiles[e]={id:e,...a}),t.profiles[s]||(t.profiles[s]={id:s,...a})}updateScoresAndStatus(t,e){const{playerId:s,opponentId:a}=t.customData;if(!s||!a)return;const{whitePlayerId:n,whitePlayerScore:i,whitePlayerFinish:r,blackPlayerScore:o,blackPlayerFinish:l}=e,d=n===s;t.profiles[s].score=d?i:o,t.profiles[a].score=d?o:i,t.profiles[s].finished=d?r:l,t.profiles[a].finished=d?l:r}}const Rt={level:1,rescued:0,contextId:null,playerId:null,opponentId:null,tournamentId:null,leaderboardId:null};class H extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.initializeMatch(e),await this.nextAsync(e)}initializeMatch(e){const{id:s,mode:a,customData:n}=this.payload;e.id=s??null,e.mode=a||null,e.status=F.OPEN,e.startAt=0,e.finishAt=0,e.profiles={},e.customData={...Rt,...e.customData,...n}}}const me=ce;class S extends Error{constructor(t){super(t),this.name="UnavailableFeature",this.message=`Unavailable feature: ${t}`}}class Y extends X{constructor(t){super(t),this.name="ContextIdNotValid",this.message=t??"Context id is not valid"}}class b extends X{constructor(t){super(t),this.name="ProfileNotFound",this.message=t??"Profile not found"}}class fi extends w{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesAwaitingAsync(t);e&&this.sendMessageAsync(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:a,opponentId:n}=s;if(!e||typeof e!="string")throw new Z;if(!a||typeof a!="string")throw new Y;if(!n||typeof n!="string")throw new U}async createWideframesAwaitingAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:a}=t,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=s[n],o=s[i];if(!r||!o)return null;const{photo:l,score:d=0,finished:u}=r;if(!u)return null;const{photo:y,score:m=0,finished:f}=o;return f?null:await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:m,isPlayerFinished:!0,isOpponentFinished:!1})}catch{return null}}async sendMessageAsync(t,e){const{id:s,profiles:a,customData:n}=t,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const o=a[i];if(!o)throw new b;const{name:l}=o,d={data:{type:me.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${l} is waiting for you to finish this game. Play now!`,localizations:{vi_VN:`${l} đang chờ bạn kết thúc trận đấu. Chơi ngay!`}},image:e,strategy:"LAST",notification:"PUSH"};await GameSDK.extra.updateAsync(d)}}class _ extends w{async processAsync(t){await this.nextAsync(t)}async nextAsync(t){this.nextHandler&&await this.nextHandler.processAsync(t)}}const{Dtos:gi}=p;class de extends w{async processAsync(t){super.processAsync(t),this.validateData(t);const{customData:e}=t,{playerId:s,opponentId:a}=e;let n=s;const i=await this.getProfile(n);if(!i)throw new b;if(this.updateMatchProfile(t,n,i),n=a,n!==Q.playerId){const r=await this.getProfile(n);if(!r)throw new b;this.updateMatchProfile(t,n,r)}else this.updateMatchProfile(t,n);await this.nextAsync(t)}validateData(t){const{customData:e}=t,{playerId:s,opponentId:a}=e;if(!s||typeof s!="string")throw new P;if(!a||typeof a!="string")throw new U}async getProfile(t){const{profile:e}=this.game;return await e.requestProfiles([t]),e.getProfiles()[t]}updateMatchProfile(t,e,s){const{name:a,photo:n}=s??Q,i=new gi.Match.Profile({id:e,name:a,photo:n}).toObject();t.profiles[e]?(t.profiles[e].name=i.name,t.profiles[e].photo=i.photo):t.profiles[e]=i}}class mi extends v{async processAsync(t){try{this.startLog(t);const{matchId:e,playerId:s,opponentId:a}=t,n=new _(this),i=new H(this,{id:e,mode:B.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:a}});n.setNext(i);const r=new yi(this);i.setNext(r);const o=new de(this);r.setNext(o);const l=new fi(this);o.setNext(l);const d=new q(this);l.setNext(d);const u=new L(this);d.setNext(u);const y=this.match.getMatchState();await n.processAsync(y)}finally{this.endLog()}}}class Ft extends X{constructor(t){super(t),this.name="CreateContextFailed",this.message=t??"Create context failed"}}const{Valid:bs,Object:_s}=p.Utils;class Ai extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{opponentId:s}=this.payload,a=await this.createAsync(s);e.customData.contextId=a,await this.nextAsync(e)}async createAsync(e){try{await GameSDK.context.createAsync(e)}catch(a){this.validateError(a)}const s=GameSDK.context.getID();if(!bs.isString(s))throw new Ft;return s}validateError(e){if(!_s.hasOwn(e,"code"))throw e;if(e.code!=="SAME_CONTEXT"){if(e.code==="INVALID_PARAM"){if(!this.isNotConnectedPlayerError(e))throw e;return}throw e}}validateErrorMessage(e){if(!_s.hasOwn(e,"message")||!bs.isString(e.message))throw e}isNotConnectedPlayerError(e){return this.validateErrorMessage(e),e.message.indexOf("is not a connected player of the current player")>-1}}class Ye extends X{constructor(t){super(t),this.name="MatchAreNotOpen",this.message=t??"Match are not open"}}const{Dtos:wi,Utils:{Object:Di}}=p;class Ns extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.validateData(e);const s=await this.createMatchAsync(e),a=new wi.Match.Data(s).toObject();this.updateMatchState(e,a),await this.nextAsync(e)}validateData(e){const{status:s,customData:a}=e,{opponentId:n}=a;if(typeof n!="string")throw new U;if(s!==F.OPEN)throw new Ye}async createMatchAsync(e){const{opponentId:s}=e.customData,{extraData:a}=this.payload;if(!s)return{};const n={opponentPlayerId:s,extraData:a};return this.match.api.getMatchAPI().createMatchAsync(n)}updateMatchState(e,s){this.updateMatchGeneral(e,s),this.updatePlayerIds(e,s),this.initializeProfiles(e),this.updateFinishStatus(e,s)}updateMatchGeneral(e,s){const{_id:a,extraData:n}=s;e.id=a||null,e.customData=Di.merge(e.customData,n)}updatePlayerIds(e,s){const{whitePlayerId:a,blackPlayerId:n}=s,{customData:i}=e,r=a===i.opponentId,o=r?n:a,l=r?a:n;e.customData.playerId=o,e.customData.opponentId=l}initializeProfiles(e){const{playerId:s,opponentId:a}=e.customData;if(!s||!a)return;const n={name:"",photo:"",finished:!1};e.profiles[s]||(e.profiles[s]={id:s,...n}),e.profiles[a]||(e.profiles[a]={id:a,...n})}updateFinishStatus(e,s){const{playerId:a,opponentId:n}=e.customData;if(!a||!n)return;const{whitePlayerId:i,whitePlayerFinish:r,blackPlayerFinish:o}=s,l=i===e.customData.opponentId,d=l?o:r,u=l?r:o;e.profiles[a].finished=d,e.profiles[n].finished=u}}class J extends w{async processAsync(t){if(super.processAsync(t),t.status!==F.OPEN)throw new Ye;this.startMatch(t),await this.nextAsync(t)}startMatch(t){t.status=F.ACTIVE,t.startAt=Date.now()}}class Ls extends w{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesChallengeAsync(t);e&&this.sendMessageAsync(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:a,opponentId:n}=s;if(!e||typeof e!="string")throw new Z;if(!a||typeof a!="string")throw new Y;if(!n||typeof n!="string")throw new U}async createWideframesChallengeAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:a}=t,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=s[n],o=s[i];if(!r||!o)return null;const{photo:l,score:d=0}=r,{photo:u,score:y=0}=o;return await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:u,opponentScore:y,isPlayerFinished:!1,isOpponentFinished:!1})}catch{return null}}async sendMessageAsync(t,e){const{id:s,profiles:a,customData:n}=t,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const{name:o}=a[i],l={data:{type:me.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${o} challenges you`,localizations:{vi_VN:`${o} thử thách bạn trong trận đấu này. Chơi ngay!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};await GameSDK.extra.updateAsync(l)}}class Ii extends v{async processAsync(t){try{this.startLog(t);const{playerId:e,opponentId:s,extraData:a}=t,n=new _(this),i=new Ai(this,{opponentId:s});n.setNext(i);const r=new H(this,{mode:B.CHALLENGE_FRIEND,customData:{playerId:e,opponentId:s}});i.setNext(r);const o=new Ns(this,{extraData:a});r.setNext(o);const l=new de(this);o.setNext(l);const d=new J(this);l.setNext(d);const u=new q(this);d.setNext(u);const y=new Ls(this);u.setNext(y);const m=new L(this);y.setNext(m);const f=this.match.getMatchState();await n.processAsync(f)}finally{this.endLog()}}}class Gt extends Error{constructor(t){super(t),this.name="SameContext",this.message=t??"Same context"}}const{Utils:Ts}=p;class Je extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{contextId:s}=this.payload;await this.switchAsync(s),e.customData.contextId=s,await this.nextAsync(e)}checkSameContext(e){const s=e==="SOLO",a=GameSDK.context.getID();if(a===e)throw new Gt;if(s&&a===null)throw new Gt}async switchAsync(e){const s=e==="SOLO";try{this.checkSameContext(e),await GameSDK.context.switchAsync(e,s)}catch(a){if(a instanceof Gt)return;if(!Ts.Object.hasOwn(a,"code"))throw a;if(Ts.Device.isAndroid()&&s&&a.code==="INVALID_PARAM")return;if(a.code!=="SAME_CONTEXT")throw a}}}const{Dtos:Pi,Utils:{Object:vi}}=p;class Si extends w{async processAsync(t){super.processAsync(t),this.validateMatchData(t);const e=await this.getMatchAsync(t),s=new Pi.Match.Data(e).toObject();this.validateContinueMatchData(t,s),this.updateMatchData(t,s),this.validatePlayerTurn(t),await this.nextAsync(t)}validateMatchData(t){const{id:e,status:s}=t;if(typeof e!="string")throw new Z;if(s!==F.OPEN)throw new Ye}validateContinueMatchData(t,e){const{id:s,customData:a}=t,{_id:n,whitePlayerId:i,blackPlayerId:r}=e;if(typeof n!="string"||n!==s)throw new Ot;const{playerId:o}=a,l=i===o,d=r===o;if(!l&&r===Q.playerId)throw new Dt;if(!l&&!d)throw new Mt}validatePlayerTurn(t){const{profiles:e,customData:s}=t,{playerId:a}=s;if(typeof a!="string")throw new P;const{finished:n}=e[a];if(n)throw new cs}async getMatchAsync(t){const{id:e}=t;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):{}}updateMatchData(t,e){this.updateMatchGeneral(t,e),this.updatePlayerIds(t,e),this.initializeProfiles(t),this.updateScoresAndStatus(t,e)}updateMatchGeneral(t,e){const{extraData:s}=e;t.customData=vi.merge(t.customData,s)}updatePlayerIds(t,e){const{whitePlayerId:s,blackPlayerId:a}=e,n=s===t.customData.playerId;t.customData.playerId=n?s:a,t.customData.opponentId=n?a:s}initializeProfiles(t){const{playerId:e,opponentId:s}=t.customData;if(!e||!s)return;const a={name:"",photo:"",finished:!1};t.profiles[e]||(t.profiles[e]={id:e,...a}),t.profiles[s]||(t.profiles[s]={id:s,...a})}updateScoresAndStatus(t,e){const{playerId:s,opponentId:a}=t.customData;if(!s||!a)return;const{whitePlayerId:n,whitePlayerScore:i,whitePlayerFinish:r,blackPlayerScore:o,blackPlayerFinish:l}=e,d=n===s;t.profiles[s].score=d?i:o,t.profiles[a].score=d?o:i,t.profiles[s].finished=d?r:l,t.profiles[a].finished=d?l:r}}class Ei extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){if(super.processAsync(e),this.payload.ignore){await this.nextAsync(e);return}this.validateData(e);const s=await this.createWideframesCurrentScoreAsync();s&&this.sendMessageAsync(e,s),await this.nextAsync(e)}validateData(e){const{id:s,customData:a}=e,{contextId:n,opponentId:i}=a;if(!s||typeof s!="string")throw new Z;if(!n||typeof n!="string")throw new Y;if(!i||typeof i!="string")throw new U}async createWideframesCurrentScoreAsync(){try{const{player:e,frameCapture:s}=this.game,{playerId:a,photo:n}=e.getPlayer(),{profiles:i}=this.match.getMatchState(),{score:r=0}=i[a]||{};return await s.wideframe.renderShareScore({playerId:a,playerPhoto:n,playerScore:r})}catch{return null}}async sendMessageAsync(e,s){const{id:a,profiles:n,customData:i}=e,{playerId:r,opponentId:o}=i;if(!r||typeof r!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const l=n[r];if(!l)throw new b;const{name:d}=l,u={data:{type:me.CHALLENGE_FRIEND,matchId:a,playerId:r,opponentId:o},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${d} made an update.`,localizations:{vi_VN:`${d} đã cập nhật trận đấu. Chơi ngay!`}},image:s,strategy:"LAST",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(u)}}class xi extends v{async processAsync(t){try{this.startLog(t);const{contextId:e,matchId:s,playerId:a,opponentId:n,sendUpdateMessage:i=!0}=t,r=new _(this),o=new Je(this,{contextId:e});r.setNext(o);const l=new H(this,{id:s,mode:B.CHALLENGE_FRIEND,customData:{playerId:a,opponentId:n}});o.setNext(l);const d=new Si(this);l.setNext(d);const u=new de(this);d.setNext(u);const y=new J(this);u.setNext(y);const m=new Ei(this,{ignore:!i});y.setNext(m);const f=new q(this);m.setNext(f);const D=new L(this);f.setNext(D);const A=this.match.getMatchState();await r.processAsync(A)}finally{this.endLog()}}}const{Plugins:Ci,Utils:bi}=p,{Analytics:_i}=Ci,{String:Os,Valid:Ms}=bi;class Oe extends w{async processAsync(t){super.processAsync(t);const{customData:e,mode:s,startAt:a,finishAt:n}=t,{level:i}=e;this.validateMode(s),this.validateLevel(i);const{analytics:r}=this.game,o=Math.floor((n-a)/1e3);r.event(_i.Events.MATCH_END,{level:i,game_mode:Os.toUpperCamelCase(s),level_name:this.getLevelName(i),time_played:o}),await this.nextAsync(t)}validateMode(t){if(!Ms.isString(t))throw new Tt}validateLevel(t){if(!Ms.isNumber(t))throw new vs}getLevelName(t){return`Level ${Os.padStart(t.toString(),5,"0")}`}}class Rs extends Error{constructor(t){super(t),this.name="LeaderboardNotExist",this.message=t??"Leaderboard not exist in game"}}class $t extends Error{constructor(t){super(t),this.name="ScoreNotValid",this.message=t??"Score is not valid"}}const{Utils:{Valid:Ni},Configs:{Leaderboards:{LeaderboardList:Li}}}=p;class Qe extends w{constructor(e,s){super(e);h(this,"payload");h(this,"skipPostScore");this.payload={score:0,playerId:""},this.skipPostScore=!!(s!=null&&s.ignore)}async processAsync(e){if(super.processAsync(e),this.skipPostScore){await this.nextAsync(e);return}this.setupSetScorePayload(e),"submitGameResultsAsync"in GameSDK.extra&&await GameSDK.extra.submitGameResultsAsync(this.payload.score);for(const s of Li){const{Id:a,Mode:n}=s;!e.mode||!this.isValidMode(n,e.mode)||this.setLeaderboardScoreAsync({leaderboardId:a,...this.payload})}await this.nextAsync(e)}isValidMode(e,s){return e===s}async setupSetScorePayload(e){const{profiles:s,customData:a}=e,{playerId:n}=a;if(!n||!s[n])throw new b;const{score:i}=s[n];if(!Ni.isNumber(i))throw new $t;this.payload={score:i,playerId:n}}async setLeaderboardScoreAsync(e){try{const{playerId:s,score:a,leaderboardId:n}=e,i=this.game.leaderboard.getLeaderboardName(n);if(!i)throw new Rs;await this.game.leaderboard.setLeaderboardScoreAsync(i,s,a)}catch{}}}const{Dtos:Ti,Utils:Oi}=p,{Valid:Xe,Object:Mi}=Oi;class Me extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.validateMatchData(e);const{useAPI:s}=this.payload;if(s){const a=await this.finishMatchAsync(e),n=new Ti.Match.Data(a).toObject();this.updateMatchFromAPI(e,n)}else this.updateMatchData(e);this.updateMatchState(e),await this.nextAsync(e)}validateMatchData(e){const{status:s,profiles:a,customData:n}=e;if(s!==F.ACTIVE)throw new xs;const{playerId:i}=n;if(!i||!Mi.hasOwn(a,i))throw new Mt}updateMatchData(e){const{playerId:s}=e.customData;if(!Xe.isString(s))throw new P;e.profiles[s].finished=!0}updateMatchState(e){e.status=F.FINISHED,e.finishAt=Date.now()}async finishMatchAsync(e){const{id:s,profiles:a,customData:n}=e,{level:i,playerId:r}=n;if(!Xe.isString(r))throw new P;const{score:o}=a[r],{extraData:l}=this.payload,d={matchId:s??"",score:o,level:i,extraData:l};return this.match.api.getMatchAPI().finishMatchAsync(d)}updateMatchFromAPI(e,s){const{playerId:a,opponentId:n}=e.customData;if(!Xe.isString(a))throw new P;if(!Xe.isString(n))throw new U;const{whitePlayerId:i,whitePlayerScore:r,blackPlayerScore:o,whitePlayerFinish:l,blackPlayerFinish:d}=s,u=a===i,y=u?r:o,m=u?o:r,f=u?l:d,D=u?d:l;e.profiles[a].score=y,e.profiles[n].score=m,e.profiles[a].finished=f,e.profiles[n].finished=D}}class Ri extends w{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesResultAsync(t);e&&this.progressSendFinishedMessage(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:a,opponentId:n}=s;if(!e||typeof e!="string")throw new Z;if(!a||typeof a!="string")throw new Y;if(!n||typeof n!="string")throw new U}async createWideframesResultAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:a}=t,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=s[n],o=s[i];if(!r||!o)return null;const{photo:l,score:d=0,finished:u}=r,{photo:y,score:m=0,finished:f}=o;return await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:m,isPlayerFinished:!!u,isOpponentFinished:!!f})}catch{return null}}progressSendFinishedMessage(t,e){const{profiles:s,customData:a}=t,{playerId:n,opponentId:i}=a;if(!n||typeof n!="string")throw new P;if(!i||typeof i!="string")throw new U;if(!s[n]||!s[i])throw new b;const{score:r=0,finished:o}=s[n],{score:l=0,finished:d}=s[i];o?this.sendFinishMessageAsync(t,e):d&&r>l?this.sendBestScoreMessageAsync(t,e):this.sendPlayTurnMessageAsync(t,e)}async sendFinishMessageAsync(t,e){const{id:s,profiles:a,customData:n}=t,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const o=a[i];if(!o)throw new b;const{name:l}=o,d={data:{type:me.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r,status:F.FINISHED},action:"CUSTOM",template:"finished",cta:{default:"See result",localizations:{vi_VN:"Xem kết quả"}},text:{default:`${l} just finished. Check them now.`,localizations:{vi_VN:`${l} vừa hoàn thành màn chơi. Nhấn để xem kết quả trận đấu.`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(d)}async sendPlayTurnMessageAsync(t,e){const{id:s,profiles:a,customData:n}=t,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;const o=a[i];if(!o)throw new b;const{name:l,score:d}=o,u={data:{type:me.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r,status:F.ACTIVE},action:"CUSTOM",template:"finished",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${l} got ${d} scores. So easy! Can you?`,localizations:{vi_VN:`${l} đã đạt ${d} điểm! Nhấn Chơi để so tài!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(u)}async sendBestScoreMessageAsync(t,e){const{id:s,profiles:a,customData:n}=t,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;const o=a[i];if(!o)throw new b;const{name:l,score:d}=o,u={data:{type:me.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r,status:F.FINISHED},action:"CUSTOM",template:"pass_score",cta:{default:"See result",localizations:{vi_VN:"Xem kết quả"}},text:{default:`${l} beat your high score. Their score: ${d}`,localizations:{vi_VN:`${l} đã vượt qua điểm số của bạn, với ${d} điểm!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(u)}}class Re extends w{constructor(e,s){super(e);h(this,"ignore");this.ignore=!!(s!=null&&s.ignore)}async processAsync(e){super.processAsync(e),this.setPlayerBestScore(e),await this.nextAsync(e)}setPlayerBestScore(e){if(this.ignore)return;const{profiles:s,customData:a}=e,{playerId:n}=a;if(!n||!s[n])throw new b;const{player:i}=this.game,r=i.getBestScore()||0,{score:o=0}=s[n];o<=r||(i.setBestScore(o),s[n].bestScore=o)}}class Fi extends v{async processAsync(t){try{this.startLog(t);const{extraData:e}=t??{},s=new _(this),a=new Me(this,{useAPI:!0,extraData:e});s.setNext(a);const n=new Ri(this);a.setNext(n);const i=new Oe(this);n.setNext(i);const r=new Re(this);i.setNext(r);const o=new Qe(this);r.setNext(o);const l=new L(this);o.setNext(l);const d=this.match.getMatchState();await s.processAsync(d)}finally{this.endLog()}}}class Gi extends Error{constructor(t){super(t),this.name="ContextAreSolo",this.message=t??"Context are solo"}}class $i extends Error{constructor(t){super(t),this.name="ContextNotChallenge",this.message=t??"Context is not a challenge"}}class ki extends Error{constructor(t){super(t),this.name="NetworkFailure",this.message=t??"Network failure"}}const{Utils:Vi,Dtos:Bi}=p,{Array:Ui,Object:Hi}=Vi;class Fs extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.checkCurrentContext();const s=await this.getOpponentIdFromContextAsync();e.customData.opponentId=s,await this.nextAsync(e)}checkCurrentContext(){const e=GameSDK.context.getID();if(typeof e!="string")throw new Y;if(e==="SOLO")throw new Gi}async getOpponentIdFromContextAsync(){const{ignoreId:e}=this.payload,s=await this.getContextPlayers([e]);if(s.length>1)throw new $i;let a=Q;return s.length===1&&(a=s[0]),a.playerId}async getContextPlayers(e){try{const s=await GameSDK.context.getPlayersAsync(),a=[];for(const n of s){const i=n.getID();if(e.indexOf(i)>-1)continue;const r=n.getName();if(!r)continue;const o=n.getPhoto();a.push(new Bi.Player.Info({playerId:i,name:r,photo:o}).toObject())}return Ui.unique(a)}catch(s){if(Hi.hasOwn(s,"code")&&s.code==="NETWORK_FAILURE")throw new ki;return[]}}}class kt extends Error{constructor(t){super(t),this.name="ContextIsTournament",this.message=t??"Context is a tournament"}}const{Object:ji}=p.Utils;class Wi extends w{async processAsync(t){super.processAsync(t);const e=await this.chooseAsync();await this.checkContextTournament(),t.customData.contextId=e,await this.nextAsync(t)}async chooseAsync(){try{await GameSDK.context.chooseAsync({filters:["INCLUDE_EXISTING_CHALLENGES"],minSize:2,maxSize:2})}catch(e){if(!ji.hasOwn(e,"code")||e.code!=="SAME_CONTEXT")throw e}const t=GameSDK.context.getID();if(typeof t!="string")throw new Ft;return t}async checkContextTournament(){try{if(!GameSDK.context.getID())return;throw"getTournamentAsync"in GameSDK?(await GameSDK.getTournamentAsync(),new kt):new S("getTournamentAsync")}catch(t){if(t instanceof kt)throw t}}}class Ki extends v{async processAsync(t){try{this.startLog(t);const{playerId:e,extraData:s}=t,a=new _(this),n=new Wi(this);a.setNext(n);const i=new H(this,{mode:B.CHALLENGE_FRIEND,customData:{playerId:e}});n.setNext(i);const r=new Fs(this,{ignoreId:e});i.setNext(r);const o=new Ns(this,{extraData:s});r.setNext(o);const l=new de(this);o.setNext(l);const d=new J(this);l.setNext(d);const u=new q(this);d.setNext(u);const y=new Ls(this);u.setNext(y);const m=new L(this);y.setNext(m);const f=this.match.getMatchState();await a.processAsync(f)}finally{this.endLog()}}}class qi extends Error{constructor(t){super(t),this.name="JoinMatchFailed",this.message=t??"Join match failed"}}class zi extends Error{constructor(t){super(t),this.name="MatchAreFinished",this.message=t??"Match are finished"}}class Yi extends Error{constructor(t){super(t),this.name="OtherPlayerHasJoinedMatch",this.message=t??"Other player has joined match"}}const{Dtos:Ji,Utils:{Object:Qi}}=p;class Xi extends w{async processAsync(t){super.processAsync(t),this.validateMatchData(t);const e=await this.joinMatchAsync(t),s=new Ji.Match.Data(e).toObject();this.validateJoinMatchData(t,s),this.updateMatchData(t,s),await this.nextAsync(t)}validateMatchData(t){const{status:e}=t;if(e!==F.OPEN)throw new Ye}validateJoinMatchData(t,e){const{id:s,customData:a}=t,{_id:n,blackPlayerId:i,whitePlayerId:r,whitePlayerFinish:o,blackPlayerFinish:l}=e,d=i===a.playerId,u=r===a.opponentId;if(typeof n!="string"||n!==s||!u)throw new qi;if(o&&l)throw new zi;if(!d)throw new Yi}async joinMatchAsync(t){const{id:e}=t;return e?this.match.api.getMatchAPI().joinMatchAsync(e):{}}updateMatchData(t,e){this.updateMatchGeneral(t,e),this.updatePlayerIds(t,e),this.initializeProfiles(t),this.updateScoresAndStatus(t,e)}updateMatchGeneral(t,e){const{extraData:s}=e;t.customData=Qi.merge(t.customData,s)}updatePlayerIds(t,e){const{whitePlayerId:s,blackPlayerId:a}=e,{customData:n}=t,i=s===n.playerId,r=i?s:a,o=i?a:s;t.customData.playerId=r,t.customData.opponentId=o}initializeProfiles(t){const{playerId:e,opponentId:s}=t.customData;if(!e||!s)return;const a={name:"",photo:"",finished:!1};t.profiles[e]||(t.profiles[e]={id:e,...a}),t.profiles[s]||(t.profiles[s]={id:s,...a})}updateScoresAndStatus(t,e){const{playerId:s,opponentId:a}=t.customData;if(!s||!a)return;const{whitePlayerId:n,whitePlayerScore:i,whitePlayerFinish:r,blackPlayerScore:o,blackPlayerFinish:l}=e,d=n===t.customData.playerId;t.profiles[s].score=d?i:o,t.profiles[a].score=d?o:i,t.profiles[s].finished=d?r:l,t.profiles[a].finished=d?l:r}}class Zi extends w{async processAsync(t){super.processAsync(t),this.validateData(t);const e=await this.createWideframesAcceptedAsync(t);e&&this.sendMessageAsync(t,e),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:a,opponentId:n}=s;if(!e||typeof e!="string")throw new Z;if(!a||typeof a!="string")throw new Y;if(!n||typeof n!="string")throw new U}async createWideframesAcceptedAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:a}=t,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=s[n],o=s[i];if(!r||!o)return null;const{photo:l,score:d=0,finished:u}=r;if(u)return null;const{photo:y,score:m=0,finished:f}=o;return f?await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:m,isPlayerFinished:!1,isOpponentFinished:!0}):null}catch{return null}}async sendMessageAsync(t,e){const{id:s,profiles:a,customData:n}=t,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const o=a[i];if(!o)throw new b;const{name:l}=o,d={data:{type:me.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${l} accepted the challenge.`,localizations:{vi_VN:`${l} đã chấp nhận tham gia trận đấu.`}},image:e,strategy:"LAST",notification:"PUSH"};await GameSDK.extra.updateAsync(d)}}class er extends v{async processAsync(t){try{this.startLog(t);const{matchId:e,playerId:s,opponentId:a}=t,n=new _(this),i=new H(this,{id:e,mode:B.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:a}});n.setNext(i);const r=new Xi(this);i.setNext(r);const o=new de(this);r.setNext(o);const l=new J(this);o.setNext(l);const d=new Zi(this);l.setNext(d);const u=new q(this);d.setNext(u);const y=new L(this);u.setNext(y);const m=this.match.getMatchState();await n.processAsync(m)}finally{this.endLog()}}}const Gs={_id:"",status:"",appId:"",createdAt:"",startedAt:null,finishedAt:null,winnerId:"",whitePlayerId:"",blackPlayerId:"",whitePlayerScore:0,blackPlayerScore:0,whitePlayerFinish:!1,blackPlayerFinish:!1,extraData:{}},{Configs:{AppId:tr},Utils:{Valid:G}}=p,$="is invalid";class Vt extends k{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateId(t){(!G.isString(t)||!t)&&this.exception("_id",$)}validateStatus(t){(!G.isString(t)||!t)&&this.exception("status",$)}validateAppId(t){(!G.isString(t)||t!==tr)&&this.exception("appId",$)}validateCreatedAt(t){G.isString(t)||this.exception("createdAt",$)}validateStartedAt(t){t!==null&&(G.isString(t)||this.exception("startedAt",$))}validateFinishedAt(t){t!==null&&(G.isString(t)||this.exception("finishedAt",$))}validateExtraData(t){t!==null&&(G.isObject(t)||this.exception("extraData",$))}validateWinnerId(t){t!==null&&(!G.isString(t)||!t)&&this.exception("winnerId",$)}validateWhitePlayerId(t){(!G.isString(t)||!t)&&this.exception("whitePlayerId",$)}validateBlackPlayerId(t){(!G.isString(t)||!t)&&this.exception("blackPlayerId",$)}validateWhitePlayerScore(t){G.isNumber(t)||this.exception("whitePlayerScore",$)}validateBlackPlayerScore(t){G.isNumber(t)||this.exception("blackPlayerScore",$)}validateWhitePlayerFinish(t){G.isBoolean(t)||this.exception("whitePlayerFinish",$)}validateBlackPlayerFinish(t){G.isBoolean(t)||this.exception("blackPlayerFinish",$)}toObject(){return super.toObject()}static getDefaultData(){return Gs}}Vt.addDefaultData(Gs);class sr extends Error{constructor(t){super(t),this.name="MatchAreNotFinished",this.message=t||"Match are not finished"}}class ar extends Error{constructor(t){super(t),this.name="OpponentNotFinishedMatch",this.message=t||"Opponent not finished match"}}const{Utils:{Object:nr}}=p;class ir extends w{async processAsync(t){super.processAsync(t),this.validateMatchData(t);const e=await this.getMatchAsync(t),s=new Vt(e).toObject();this.validateResultMatchData(t,s),this.updateMatchData(t,s),this.validatePlayerTurn(t),this.validateOpponentTurn(t),await this.nextAsync(t)}validateMatchData(t){const{id:e}=t;if(typeof e!="string")throw new Z}validateResultMatchData(t,e){const{id:s}=t,{_id:a,whitePlayerFinish:n,blackPlayerFinish:i}=e;if(typeof a!="string"||a!==s)throw new Ot;if(!n&&!i)throw new sr}validatePlayerTurn(t){const{profiles:e,customData:s}=t,{playerId:a}=s;if(typeof a!="string")throw new P;const{finished:n}=e[a];if(!n)throw new Cs}validateOpponentTurn(t){const{profiles:e,customData:s}=t,{opponentId:a}=s;if(typeof a!="string")throw new U;const{finished:n}=e[a];if(!n)throw new ar}async getMatchAsync(t){const{id:e}=t;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):null}updateMatchData(t,e){this.updateMatchGeneral(t,e),this.updatePlayerIds(t,e),this.initializeProfiles(t),this.updateScoresAndStatus(t,e)}updateMatchGeneral(t,e){const{extraData:s}=e;t.status=F.FINISHED,t.customData=nr.merge(t.customData,s)}updatePlayerIds(t,e){const{whitePlayerId:s,blackPlayerId:a}=e,{customData:n}=t,i=s===n.playerId,r=i?s:a,o=i?a:s;t.customData.playerId=r,t.customData.opponentId=o}initializeProfiles(t){const{playerId:e,opponentId:s}=t.customData;if(!e||!s)return;const a={name:"",photo:"",finished:!0};t.profiles[e]||(t.profiles[e]={id:e,...a}),t.profiles[s]||(t.profiles[s]={id:s,...a})}updateScoresAndStatus(t,e){const{playerId:s,opponentId:a}=t.customData;if(!s||!a)return;const{whitePlayerId:n,whitePlayerScore:i,whitePlayerFinish:r,blackPlayerScore:o,blackPlayerFinish:l}=e,d=n===t.customData.playerId;t.profiles[s].score=d?i:o,t.profiles[a].score=d?o:i,t.profiles[s].finished=d?r:l,t.profiles[a].finished=d?l:r}}class rr extends v{async processAsync(t){try{this.startLog(t);const{matchId:e,playerId:s,opponentId:a}=t,n=new _(this),i=new H(this,{id:e,mode:B.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:a}});n.setNext(i);const r=new ir(this);i.setNext(r);const o=new de(this);r.setNext(o);const l=new L(this);o.setNext(l);const d=this.match.getMatchState();await n.processAsync(d)}finally{this.endLog()}}}class or extends v{constructor(){super(...arguments);h(this,"fallbackSingleMode");h(this,"startFLowChallengeFriend",async e=>{try{return await this.match.challenge.invite.processAsync(e),!0}catch(s){return s}});h(this,"startFlowTournament",async e=>{try{const s=GameSDK.context.getID();if(typeof s!="string")throw new Y;await this.match.tournament.continue.processAsync({playerId:e,contextId:s})}catch{await this.startFlowSingle(e)}});h(this,"startFlowSingle",async e=>this.match.single.start.processAsync({playerId:e}))}async processAsync(e){try{this.startLog(e);const{playerId:s,extraData:a,fallbackSingleMode:n}=e;this.fallbackSingleMode=n;const i=await this.startFLowChallengeFriend({playerId:s,extraData:a});if(i===!0)return;if(i instanceof kt)await this.startFlowTournament(s);else if(this.fallbackSingleMode)await this.startFlowSingle(s);else throw i}finally{this.endLog()}}}class Fe extends Error{constructor(t){super(t),this.name="LeaderboardIdNotValid",this.message=t??"Leaderboard id is not valid"}}const{Valid:$s}=p.Utils;class ks extends w{constructor(e,s){super(e);h(this,"payload");h(this,"leaderboardPayload");this.payload=s}async processAsync(e){super.processAsync(e),this.setupSetScorePayload(e),"submitGameResultsAsync"in GameSDK.extra&&await GameSDK.extra.submitGameResultsAsync(this.payload.score),this.setLeaderboardScoreAsync(),await this.nextAsync(e)}async setupSetScorePayload(e){const{profiles:s,customData:a}=e,{playerId:n}=a;if(!n||!s[n])throw new b;const{score:i,leaderboardId:r}=this.payload;if(!$s.isNumber(i))throw new $t;if(!$s.isString(r))throw new Fe;this.leaderboardPayload={score:i,playerId:n,leaderboardId:r}}async setLeaderboardScoreAsync(){try{const{playerId:e,score:s,leaderboardId:a}=this.leaderboardPayload,n=this.game.leaderboard.getLeaderboardName(a);if(!n)throw new Rs;await this.game.leaderboard.setLeaderboardScoreAsync(n,e,s)}catch{}}}const{Utils:{Valid:cr}}=p;class Bt extends ks{constructor(t){super(t,{score:0,leaderboardId:""})}async setupSetScorePayload(t){const{profiles:e,customData:s}=t,{playerId:a,leaderboardId:n}=s;if(!n)throw new Fe;if(!a||!e[a])throw new b;const{score:i}=e[a];if(!cr.isNumber(i))throw new $t;this.payload.score=i,this.payload.leaderboardId=n,super.setupSetScorePayload(t)}}class lr extends w{async processAsync(t){super.processAsync(t),this.validateData(t),this.progressSendGroupMessage(t),await this.nextAsync(t)}validateData(t){const{id:e,customData:s}=t,{contextId:a,opponentId:n}=s;if(!e||typeof e!="string")throw new Z;if(!a||typeof a!="string")throw new Y;if(!n||typeof n!="string")throw new U}async createWideframesResultGroupAsync(t){try{const{frameCapture:e}=this.game,{profiles:s,customData:a}=t,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=s[n],o=s[i];if(!r||!o)return null;const{photo:l,score:d=0}=r,{photo:u,score:y=0}=o;return await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:u,opponentScore:y,isPlayerFinished:!0,isOpponentFinished:!0})}catch{return null}}async createWideframesBestScoreAsync(t){try{const{player:e,frameCapture:s}=this.game,{playerId:a}=t.customData,{playerId:n,photo:i,data:r}=e.getPlayer();if(a!==n)return null;const{score:o}=r||{};return await s.wideframe.renderShareScore({playerId:n,playerPhoto:i,playerScore:o})}catch{return null}}async progressSendGroupMessage(t){const{profiles:e,customData:s}=t,{playerId:a,opponentId:n}=s;if(n&&typeof n=="string"){if(!a||typeof a!="string")throw new P;const r=e[a],o=e[n];if(!r||!o)return;const{score:l=0}=r,{score:d=0}=o;if(l>d){const u=await this.createWideframesResultGroupAsync(t);if(!u)return;this.sendBestScoreMessageAsync(t,u);return}}const i=await this.createWideframesBestScoreAsync(t);i&&this.sendChallengeMessageAsync(t,i)}async sendBestScoreMessageAsync(t,e){const{profiles:s,customData:a}=t,{playerId:n}=a;if(!n||typeof n!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const i=s[n];if(!i)throw new b;const{name:r,score:o}=i,d={data:{type:this.game.context.getSessionContextTypes().MATCHING_GROUP,playerId:n,playerName:r,playerScore:o},action:"CUSTOM",template:"play_turn",cta:{default:"Play",localizations:{vi_VN:"Chơi"}},text:{default:`${r} beats your high score. Their score: ${o}.`,localizations:{vi_VN:`${r} vừa vượt điểm số cao nhất của bạn! Chơi lần nữa chứ?`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(d)}async sendChallengeMessageAsync(t,e){const{profiles:s,customData:a}=t,{playerId:n}=a;if(!n||typeof n!="string")throw new P;const i=s[n];if(!i)throw new b;const{name:r,score:o}=i,d={data:{type:this.game.context.getSessionContextTypes().MATCHING_GROUP,playerId:n,playerName:r,playerScore:o},action:"CUSTOM",template:"play_turn",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${r} got ${o} scores. So easy! Can you?`,localizations:{vi_VN:`${r} đã đạt ${o} điểm! Quá dễ luôn. Chơi lại nào!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(d)}}class dr extends v{async processAsync(){try{this.startLog();const t=new _(this),e=new Me(this,{useAPI:!1});t.setNext(e);const s=new lr(this);e.setNext(s);const a=new Oe(this);s.setNext(a);const n=new Re(this);a.setNext(n);const i=new Bt(this);n.setNext(i);const r=new L(this);i.setNext(r);const o=this.match.getMatchState();await t.processAsync(o)}finally{this.endLog()}}}const{Dtos:hr}=p;class Ze extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.updateProfileMatchData(e),await this.nextAsync(e)}updateProfileMatchData(e){const{id:s}=this.payload,{profiles:a}=e;if(!a[s])throw new b;const n={...a[s],...this.payload},i=new hr.Match.Profile(n).toObject();a[i.id]=i}}class ur extends v{async processAsync(t){try{this.startLog(t);const{playerId:e,opponentId:s,opponentScore:a}=t,n=new _(this),i=new H(this,{id:"7749",mode:B.MATCHING_GROUP,customData:{playerId:e,opponentId:s}});n.setNext(i);const r=new de(this);i.setNext(r);const o=new Ze(this,{id:e,score:a});r.setNext(o);const l=new J(this);o.setNext(l);const d=new q(this);l.setNext(d);const u=new L(this);d.setNext(u);const y=this.match.getMatchState();await n.processAsync(y)}finally{this.endLog()}}}class Vs extends Error{constructor(t){super(t),this.name="MatchGroupNotSupported",this.message=t??"Match group is not supported"}}class pr extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),await this.checkMatchGroupSupported();const s=await this.matchingGroup();e.customData.contextId=s,await this.nextAsync(e)}async checkMatchGroupSupported(){if(!("getSupportedAPIs"in GameSDK))throw new S("getSupportedAPIs");if(!("checkCanPlayerMatchAsync"in GameSDK.extra))throw new S("checkCanPlayerMatchAsync");if(!(GameSDK.getSupportedAPIs().indexOf("checkCanPlayerMatchAsync")>-1))throw new Vs;if(!await GameSDK.extra.checkCanPlayerMatchAsync())throw new Vs}async matchingGroup(){if(!("matchPlayerAsync"in GameSDK.extra))throw new S("matchPlayerAsync");const{matchTag:e,autoSwitch:s=!1,onlyExisting:a=!1}=this.payload;await GameSDK.extra.matchPlayerAsync(e,s,a);const n=GameSDK.context.getID();if(typeof n!="string")throw new Ft;return n}}class yr extends v{async processAsync(t){try{this.startLog(t);const{matchTag:e,playerId:s,options:a}=t,n=new _(this),i=new pr(this,{matchTag:e,...a});n.setNext(i);const r=new H(this,{id:"7749",mode:B.MATCHING_GROUP,customData:{playerId:s}});i.setNext(r);const o=new Fs(this,{ignoreId:s});r.setNext(o);const l=new J(this);o.setNext(l);const d=new de(this);l.setNext(d);const u=new q(this);d.setNext(u);const y=new L(this);u.setNext(y);const m=this.match.getMatchState();await n.processAsync(m)}finally{this.endLog()}}}class fr extends v{async processAsync(){try{this.startLog();const t=new _(this),e=new Me(this,{useAPI:!1});t.setNext(e);const s=new Oe(this);e.setNext(s);const a=new Re(this);s.setNext(a);const n=new Qe(this);a.setNext(n);const i=new L(this);n.setNext(i);const r=this.match.getMatchState();await t.processAsync(r)}finally{this.endLog()}}}class gr extends Error{constructor(t){super(t),this.name="ProfileIdNotDefined",this.message=t??"Profile id is not defined"}}const{Dtos:mr}=p;class Ge extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{profileId:s}=this.payload;if(!s)throw new gr;const{player:a}=this.game,n=a.getPlayerId();let i;if(s===n)i=this.getPlayerProfile();else if(i=await this.getProfileAsync(s),!i)throw new b;this.updateMatchData(i,e),await this.nextAsync(e)}getPlayerProfile(){const{player:e}=this.game,{playerId:s,name:a,photo:n,locale:i}=e.getPlayer();return{playerId:s,name:a,photo:n,locale:i}}async getProfileAsync(e){const{profile:s}=this.game;return await s.requestProfiles([e]),s.getProfiles()[e]}updateMatchData(e,s){const{playerId:a,name:n,photo:i}=e,r=new mr.Match.Profile({id:a,name:n,photo:i}).toObject();s.profiles[a]=r}}class Ar extends v{async processAsync(t){try{this.startLog(t);const{playerId:e}=t,s=new _(this),a=new Je(this,{contextId:"SOLO"});s.setNext(a);const n=new H(this,{id:"123456",mode:B.SINGLE,customData:{playerId:e}});a.setNext(n);const i=new J(this);n.setNext(i);const r=new Ge(this,{profileId:e});i.setNext(r);const o=new q(this);r.setNext(o);const l=new L(this);o.setNext(l);const d=this.match.getMatchState();await s.processAsync(d)}finally{this.endLog()}}}class wr extends v{async processAsync(t){try{this.startLog(t);const{setPlayerBestScore:e=!1,postGlobalLeaderboard:s=!1}=t??{},a=new _(this),n=new Me(this,{useAPI:!1});a.setNext(n);const i=new Oe(this);n.setNext(i);const r=new Re(this,{ignore:!e});i.setNext(r);const o=new Qe(this,{ignore:!s});r.setNext(o);const l=new L(this);o.setNext(l);const d=this.match.getMatchState();await a.processAsync(d)}finally{this.endLog()}}}class Dr extends v{async processAsync(t){try{this.startLog(t);const{matchId:e,playerId:s,gameMode:a,extraData:n={}}=t,i=new _(this),r=new Je(this,{contextId:"SOLO"});i.setNext(r);const o=new H(this,{id:e,mode:a,customData:{playerId:s,...n}});r.setNext(o);const l=new J(this);o.setNext(l);const d=new Ge(this,{profileId:s});l.setNext(d);const u=new q(this);d.setNext(u);const y=new L(this);u.setNext(y);const m=this.match.getMatchState();await i.processAsync(m)}finally{this.endLog()}}}const{Plugins:Ir,Utils:Pr}=p,{Analytics:vr}=Ir,{String:Sr,Valid:Er}=Pr;class Bs extends w{async processAsync(t){super.processAsync(t);const{mode:e,customData:s}=t;this.validateMode(e);const{analytics:a}=this.game,{tournamentId:n,leaderboardId:i}=s;a.event(vr.Events.TOURNAMENT_START,{success:!0,game_mode:Sr.toUpperCamelCase(e),tournament_id:n,leaderboard_id:i}),await this.nextAsync(t)}validateMode(t){if(!Er.isString(t))throw new Tt}}class Us extends Error{constructor(t){super(t),this.name="TournamentIdNotValid",this.message=t??"Tournament id is not valid"}}const{Valid:Ut}=p.Utils;class xr extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{contextId:s}=this.payload;this.validateContextId(s);const a=await GameSDK.getTournamentAsync(),n=a.getID().toString();this.validateTournamentId(n);const i=JSON.parse(a.getPayload()||"{}"),{leaderboardId:r}=i;this.validateLeaderboardId(r),e.customData.contextId=s,e.customData.tournamentId=n,e.customData.leaderboardId=r,await this.nextAsync(e)}validateContextId(e){if(!Ut.isString(e))throw new Y}validateTournamentId(e){if(!Ut.isString(e))throw new Us}validateLeaderboardId(e){if(!Ut.isString(e)||e==="")throw new Fe}}class Cr extends v{async processAsync(t){try{this.startLog(t);const{playerId:e,contextId:s}=t,a=new _(this),n=new xr(this,{contextId:s});a.setNext(n);const i=new H(this,{id:"1997",mode:B.TOURNAMENT,customData:{playerId:e}});n.setNext(i);const r=new J(this);i.setNext(r);const o=new Ge(this,{profileId:e});r.setNext(o);const l=new q(this);o.setNext(l);const d=new Bs(this);l.setNext(d);const u=new L(this);l.setNext(u);const y=this.match.getMatchState();await a.processAsync(y)}finally{this.endLog()}}}const{Plugins:br}=p,{Analytics:_r}=br;class Nr extends w{async processAsync(t){super.processAsync(t);const{customData:e}=t,{analytics:s}=this.game,{tournamentId:a,leaderboardId:n}=e;s.event(_r.Events.TOURNAMENT_CREATE,{success:!0,tournament_id:a,leaderboard_id:n}),await this.nextAsync(t)}}class Lr extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),await this.createTournamentAsync(),await this.updateMatchStateAsync(e),await this.nextAsync(e)}async createTournamentAsync(){const{name:e,score:s,customData:a}=this.payload;await GameSDK.tournament.createAsync({initialScore:s,config:{title:e,tournamentTitle:e},data:a})}async updateMatchStateAsync(e){try{if(!("getTournamentAsync"in GameSDK))throw new S("getTournamentAsync");const s=await GameSDK.getTournamentAsync(),a=s.getContextID(),n=s.getID().toString(),{playerId:i}=this.payload;e.customData.playerId=i,e.customData.contextId=a,e.customData.tournamentId=n}catch(s){if(s instanceof S)return}}}const{Valid:Hs}=p.Utils;class Tr extends w{constructor(e,s){super(e);h(this,"payload");h(this,"leaderboardPayload");this.payload=s}async processAsync(e){super.processAsync(e),this.validatePayload(),await this.setupCreatePayload(e),await this.createLeaderboardAsync(e),await this.nextAsync(e)}validatePayload(){const{leaderboardId:e}=this.payload;if(!Hs.isString(e))throw new Fe}validatePlayerId(e){if(!Hs.isString(e))throw new P}async setupCreatePayload(e){const{playerId:s}=e.customData;this.validatePlayerId(s);const{name:a,leaderboardId:n,customData:i}=this.payload;this.leaderboardPayload={_id:n,name:a??"",createdBy:s,description:JSON.stringify(i)}}async createLeaderboardAsync(e){const s=await this.game.leaderboard.createLeaderboardAsync(this.leaderboardPayload);e.customData.leaderboardId=s}}class Or extends v{async processAsync(t){try{this.startLog(t);const{playerId:e,name:s,score:a,leaderboardId:n,payload:i}=t,r=new _(this),o=new Je(this,{contextId:"SOLO"});r.setNext(o);const l=new Lr(this,{name:s,score:a,playerId:e,customData:i});o.setNext(l);const d=new Ge(this,{profileId:e});l.setNext(d);const u=new Ze(this,{id:e,score:a});d.setNext(u);const y=new Tr(this,{name:s,customData:i,leaderboardId:n});u.setNext(y);const m=new Bt(this);y.setNext(m);const f=new Nr(this);m.setNext(f);const D=this.match.getMatchState();await r.processAsync(D)}finally{this.endLog()}}}const{Analytics:js}=p.Plugins,{Valid:Mr}=p.Utils;class Rr extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.validateData(e),await this.postScoreTournamentAsync(e),await this.nextAsync(e)}validateData(e){const{profiles:s,customData:a}=e,{playerId:n}=a;if(this.validatePlayerId(n),!s[n])throw new b}validatePlayerId(e){if(!Mr.isString(e))throw new P}getPlayerProfile(e){const{profiles:s,customData:a}=e,{playerId:n}=a;return this.validatePlayerId(n),s[n]}isNewBestScore(e){const s=this.getPlayerProfile(e),{score:a=0,bestScore:n=0}=s;return a>n}async postScoreTournamentAsync(e){const{analytics:s}=window.game,a=this.getPlayerProfile(e),{score:n=0}=a;let i=null,r=!1;const{checkBestScore:o}=this.payload,l=this.isNewBestScore(e);try{if(!("getTournamentAsync"in GameSDK))throw new S("getTournamentAsync");await GameSDK.getTournamentAsync(),!o||l?(i=js.Events.TOURNAMENT_SHARE,await GameSDK.tournament.shareAsync({score:n})):(i=js.Events.TOURNAMENT_POST_SCORE,await GameSDK.tournament.postScoreAsync(n)),r=!0}catch{}finally{i&&s.event(i,{success:r})}}}class Fr extends v{async processAsync(t){try{this.startLog(t);const{playerId:e,bestScore:s,checkBestScore:a=!1}=t,n=new _(this),i=new Me(this,{useAPI:!1});n.setNext(i);const r=new Ze(this,{id:e,bestScore:s});i.setNext(r);const o=new Rr(this,{checkBestScore:a});r.setNext(o);const l=new Oe(this);o.setNext(l);const d=new Re(this);l.setNext(d);const u=new Bt(this);d.setNext(u);const y=new Qe(this);u.setNext(y);const m=new L(this);y.setNext(m);const f=this.match.getMatchState();await n.processAsync(f)}finally{this.endLog()}}}const{Valid:Ht,Object:Gr}=p.Utils;class $r extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e);const{tournamentId:s}=this.payload;this.validateTournamentId(s),await this.joinTournamentAsync(s);const a=await GameSDK.getTournamentAsync(),n=a.getContextID();this.validateContextId(n);const i=JSON.parse(a.getPayload()||"{}"),{leaderboardId:r}=i;this.validateLeaderboardId(r),e.customData.contextId=n,e.customData.tournamentId=s,e.customData.leaderboardId=r,await this.nextAsync(e)}validateTournamentId(e){if(!Ht.isString(e))throw new Us}validateContextId(e){if(!Ht.isString(e))throw new Y}validateLeaderboardId(e){if(!Ht.isString(e)||e==="")throw new Fe}async joinTournamentAsync(e){if(!("tournament"in GameSDK))throw new S("tournament");try{await GameSDK.tournament.joinAsync(e)}catch(s){if(!Gr.hasOwn(s,"code")||s.code!=="SAME_CONTEXT")throw s}}}class kr extends v{async processAsync(t){try{this.startLog(t);const{playerId:e,tournamentId:s}=t,a=new _(this),n=new $r(this,{tournamentId:s});a.setNext(n);const i=new H(this,{id:"1997",mode:B.TOURNAMENT,customData:{playerId:e}});n.setNext(i);const r=new J(this);i.setNext(r);const o=new Ge(this,{profileId:e});r.setNext(o);const l=new q(this);o.setNext(l);const d=new Bs(this);l.setNext(d);const u=new L(this);d.setNext(u);const y=this.match.getMatchState();await a.processAsync(y)}finally{this.endLog()}}}const{Dtos:Vr,Utils:Br}=p,{Object:Ur}=Br;class Hr extends w{async processAsync(t){super.processAsync(t);const e=await this.getMatchCustomData(t);this.updateMatchCustomData(t,e),await this.nextAsync(t)}async getMatchCustomData(t){const{id:e}=t;if(!e)return{};const a=await this.match.api.getMatchAPI().getMatchDetailByIdAsync(e);return(a==null?void 0:a.extraData)??{}}updateMatchCustomData(t,e){const s=Ur.merge(t.customData,e),a=new Vr.Match.CustomData(s).toObject();t.customData=a}}const{Dtos:jr,Utils:Wr}=p,{Object:Kr}=Wr;class qr extends w{constructor(e,s){super(e);h(this,"payload");this.payload=s}async processAsync(e){super.processAsync(e),this.updateMatchCustomData(e),await this.nextAsync(e)}updateMatchCustomData(e){const s=Kr.merge(e.customData,this.payload),a=new jr.Match.CustomData(s).toObject();e.customData=a}}const zr={id:null,mode:null,status:null,startAt:0,finishAt:0,profiles:{},customData:{...Rt}},{Configs:Ws}=p;class Yr extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"base");h(this,"group");h(this,"single");h(this,"context");h(this,"strategy");h(this,"challenge");h(this,"tournament");h(this,"api");h(this,"handler");h(this,"useCPUProfile")}init(){this.createMatchData(),this.createAPIHandler(),this.createBaseConcrete(),this.createConcreteFlows(),this.createConcreteHandlers()}setUseCPUProfile(e){this.useCPUProfile=e}createMatchData(){const{storage:e}=this.game;e.addStorage("match",zr)}getMatchState(){const{storage:e}=this.game;return e.getStorage("match")}createBaseConcrete(){this.base=new v(this.game,this)}createConcreteFlows(){this.createGroupFlows(),this.createSingleFlows(),this.createContextFlows(),this.createStrategyFlows(),this.createChallengeFlows(),this.createTournamentFlows()}createConcreteHandlers(){this.handler={setProfileData:async e=>{const s=new Ze(this.base,e);await this.processHandlerAsync(s)},setMatchCustomData:async e=>{const s=new qr(this.base,e);await this.processHandlerAsync(s)},getMatchCustomData:async()=>{const e=new Hr(this.base);await this.processHandlerAsync(e)},setLeaderboardScore:async e=>{const s=new ks(this.base,e);await this.processHandlerAsync(s)}}}createAPIHandler(){const e={appId:Ws.AppId,matchAPIHost:Ws.ApiHost};this.api=new ri(e)}createGroupFlows(){this.group={join:new ur(this.game,this),start:new yr(this.game,this),finish:new dr(this.game,this)}}createSingleFlows(){this.single={start:new Ar(this.game,this),finish:new fr(this.game,this)}}createStrategyFlows(){this.strategy={start:new Dr(this.game,this),finish:new wr(this.game,this)}}createContextFlows(){this.context={choose:new or(this.game,this)}}createChallengeFlows(){this.challenge={invite:new Ki(this.game,this),friend:new Ii(this.game,this),join:new er(this.game,this),await:new mi(this.game,this),result:new rr(this.game,this),finish:new Fi(this.game,this),continue:new xi(this.game,this)}}createTournamentFlows(){this.tournament={join:new kr(this.game,this),create:new Or(this.game,this),finish:new Fr(this.game,this),continue:new Cr(this.game,this)}}processHandlerAsync(e){const s=this.getMatchState();return e.processAsync(s)}}const{Valid:Ae}=p.Utils,we="is invalid";class Ks extends k{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateLevel(t){(!Ae.isNumber(t)||t<0)&&this.exception("level",we)}validateRescued(t){(!Ae.isNumber(t)||t<0)&&this.exception("rescued",we)}validateContextId(t){Ae.isString(t)||this.exception("contextId",we)}validatePlayerId(t){Ae.isString(t)||this.exception("playerId",we)}validateOpponentId(t){!Ae.isString(t)&&t!==null&&this.exception("opponentId",we)}validateTournamentId(t){!Ae.isString(t)&&t!==null&&this.exception("tournamentId",we)}validateLeaderboardId(t){!Ae.isString(t)&&t!==null&&this.exception("leaderboardId",we)}toObject(){return super.toObject()}static getDefaultData(){return k.getDefaultData()}}Ks.addDefaultData(Rt);const{Valid:Pe}=p.Utils,ve="is invalid";class qs extends k{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateId(t){(!Pe.isString(t)||!t)&&this.exception("id",ve)}validateName(t){(!Pe.isString(t)||!t)&&this.exception("name",ve)}validatePhoto(t){Pe.isString(t)||this.exception("photo",ve)}validateScore(t){(!Pe.isNumber(t)||t<0)&&this.exception("score",ve)}validateBestScore(t){(!Pe.isNumber(t)||t<0)&&this.exception("bestScore",ve)}validateFinished(t){Pe.isBoolean(t)||this.exception("finished",ve)}toObject(){return super.toObject()}static getDefaultData(){return k.getDefaultData()}}qs.addDefaultData({id:"",name:"Your Friend",photo:"./assets/images/others/avatar.png",score:0,bestScore:0,finished:!1}),p.Dtos.Match={Data:Vt,Profile:qs,CustomData:Ks};const{Utils:{Object:Jr},Configs:{ApiHost:Qr}}=p,Xr=async c=>{let t="players";GameSDK.getSDKName()==="MsGames"&&(t="players?platform=ms-games");const e=await z(t,c,{},Qr,10);return Jr.hasOwn(e,"data")?e.data||{}:{}},{Utils:{Array:Zr,Object:et,Valid:eo},Configs:{AppId:to}}=p;class so extends N.Plugins.BasePlugin{init(){const{storage:t}=this.game;t.addStorage("player",oe)}async saveToCloud(){try{const t=this.getPlayerData();await GameSDK.player.setDataAsync(t)}catch{}}receiveData(t,e){const{storage:s}=this.game,{playerId:a,name:n,photo:i,locale:r}=t;s.setStorageData("player","playerId",a),s.setStorageData("player","name",n),s.setStorageData("player","photo",i),s.setStorageData("player","locale",r),e&&this.setPlayerData(e)}async syncProfileToServer(){if(GameSDK.extra.isGuest)throw new Error("Guest player cannot sync profile to server");const{storage:t}=this.game,e=this.getPlayer(),{playerId:s,name:a,photo:n,locale:i}=e;let r=this.getPlayerASID();!eo.isString(r)&&"getASIDAsync"in GameSDK.player&&(r=await GameSDK.player.getASIDAsync()??r,t.setStorageData("player","ASID",`${r}`)),await Xr({appId:to,ASID:r,playerId:s,name:a,photo:n,locale:i})}setPlayerDataByName(t,e){this.setPlayerData({[t]:e})}setPlayerData(t){const{storage:e}=this.game;e.setStorageData("player","data",t),this.saveToCloud()}setBestScore(t){this.setPlayerDataByName("score",t)}setBestEndlessScore(t){this.setPlayerDataByName("endlessScore",t)}setSetting(t,e){this.setPlayerDataByName("settings",{[t]:e})}setGameData(t){const e=this.getGameData()??{},s=et.merge(e,t);this.setPlayerDataByName("gameData",s)}async requestConnectedPlayers(){const{storage:t}=this.game,s=(await GameSDK.player.getConnectedPlayersAsync()).map(i=>{const r=i.getID(),o=i.getName(),l=i.getPhoto();return!r||!o||!l?null:new ke({playerId:r,name:o,photo:l}).toObject()}),a=Zr.unique(s);if(a.length<1)return;const n=et.keyBy(a,"playerId");t.setStorageData("player","connectedPlayers",n)}getPlayer(){const{storage:t}=this.game;return t.getStorage("player")}getPlayerId(){const{storage:t}=this.game;return t.getStorageData("player","playerId")??""}getPlayerASID(){const{storage:t}=this.game;return t.getStorageData("player","ASID")??null}getPlayerLocale(){const{storage:t}=this.game;return t.getStorageData("player","locale")??""}getPlayerData(){const{storage:t}=this.game;return t.getStorageData("player","data")??oe.data}getPlayerDataByKey(t){const e=this.getPlayerData();return et.hasOwn(e,t)?e[t]:null}getGameData(){return this.getPlayerDataByKey("gameData")}getPlayerSetting(t){const e=this.getPlayerSettings();return et.hasOwn(e,t)?e[t]:null}getPlayerSettings(){const{settings:t}=this.getPlayerData();return t}isFirstLogin(){return this.getPlayerDataByKey("isFirstLogin")??oe.data.isFirstLogin}loggedIn(){this.setPlayerDataByName("isFirstLogin",!1)}getBestScore(){const{score:t}=this.getPlayerData();return t}getBestEndlessScore(){const{endlessScore:t}=this.getPlayerData();return t}getConnectedPlayers(){const{storage:t}=this.game;return t.getStorageData("player","connectedPlayers")??{}}getConnectedPlayerIds(t,e){const s=this.getConnectedPlayers();return Object.keys(s).slice(e,e+t)}getNotificationData(){return this.getPlayerDataByKey("notificationData")??oe.data.notificationData}}const{Dtos:zs,Utils:ao}=p,{Valid:R}=ao,{score:Ys,endlessScore:no,settings:io,gameData:ro,isFirstLogin:oo,dailyRewarded:co,notificationData:lo,lastCallSwitchGame:ho}=oe.data,O="is invalid";class Js extends k{processData(t){this.validateStructure(t),t.settings=new zs.Player.Settings(t.settings).toObject(),t.gameData=new zs.Player.GameData(t.gameData).toObject(),this.validateData(t),this.setupData(t)}setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateScore(t){(!R.isNumber(t)||t<0)&&this.exception("score",O)}validateEndlessScore(t){(!R.isNumber(t)||Ys<0)&&this.exception("endlessScore",O)}validateSettings(t){R.isObject(t)||this.exception("settings",O)}validateNotificationData(t){R.isObject(t)||this.exception("notificationData",O),(!("D1"in t)||!R.isObject(t.D1))&&this.exception("notificationData.D1",O),(!("D2"in t)||!R.isObject(t.D2))&&this.exception("notificationData.D2",O),(!("D3"in t)||!R.isObject(t.D3))&&this.exception("notificationData.D3",O),(!("D4"in t)||!R.isObject(t.D4))&&this.exception("notificationData.D4",O),(!("D5"in t)||!R.isObject(t.D5))&&this.exception("notificationData.D5",O),(!("D6"in t)||!R.isObject(t.D6))&&this.exception("notificationData.D6",O),(!("D7"in t)||!R.isObject(t.D7))&&this.exception("notificationData.D7",O)}validateGameData(t){R.isObject(t)||this.exception("gameData",O)}validateIsFirstLogin(t){R.isBoolean(t)||this.exception("isFirstLogin",O)}validateDailyRewarded(t){R.isObject(t)||this.exception("dailyRewarded",O)}validateLastCallSwitchGame(t){R.isNumber(t)||this.exception("lastCallSwitchGame",O),t<0&&this.exception("lastCallSwitchGame",O)}toObject(){return super.toObject()}}Js.addDefaultData({score:Ys,endlessScore:no,settings:io,gameData:ro,isFirstLogin:oo,dailyRewarded:co,notificationData:lo,lastCallSwitchGame:ho});const{Valid:Qs}=p.Utils,{level:uo,coins:po}=oe.data.gameData;class Xs extends k{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateLevel(t){(!Qs.isNumber(t)||t<0)&&this.exception("level","is invalid")}validateCoins(t){(!Qs.isNumber(t)||t<0)&&this.exception("coins","is invalid")}toObject(){return super.toObject()}}Xs.addDefaultData({level:uo,coins:po});const{Valid:tt}=p.Utils,{sound:yo,music:fo,vibrate:go,language:mo}=oe.data.settings,st="is invalid";class Zs extends k{setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateSound(t){tt.isBoolean(t)||this.exception("sound",st)}validateMusic(t){tt.isBoolean(t)||this.exception("music",st)}validateVibrate(t){tt.isBoolean(t)||this.exception("vibrate",st)}validateLanguage(t){(!tt.isString(t)||!t)&&this.exception("language",st)}toObject(){return super.toObject()}}Zs.addDefaultData({sound:yo,music:fo,vibrate:go,language:mo}),p.Dtos.Player={Info:ke,Data:Js,Settings:Zs,GameData:Xs};const{Configs:Ao,Utils:wo}=p,{Object:Do,String:Io}=wo,{ApiHost:Po,Mockup:vo}=Ao;class So{constructor(){h(this,"mockAPI")}async initMockAPI(){if(this.mockAPI)return;const t=(await ie(async()=>{const{default:e}=await I.import("./bundle/ProfileAPIMock.js");return{default:e}},void 0,I.meta.url)).default;if(typeof t!="function")throw new Error("Cannot load ProfileAPIMock");this.mockAPI=new t}async getPlayersAsync(t){const e=Io.params(t);let s;return vo.Profile.Enabled?(await this.initMockAPI(),s=await this.mockAPI.getPlayersAsync(t)):s=await Ie(`players?${e}`,{},Po),!Do.hasOwn(s,"data")||!Array.isArray(s.data)?[]:s.data}}const ea={profiles:{},profileIds:[]},{Utils:Eo,Dtos:xo}=p,{Array:ta,Valid:Co,Object:bo,Function:_o}=Eo;class No extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"profileAPI",new So)}init(){const{storage:e}=this.game;e.addStorage("profile",ea)}async requestProfiles(e){const s=this.getProfileIds(),a=ta.difference(e,s);if(a.length<1)return;const i=ta.chunk(a,400).map(d=>this.profileAPI.getPlayersAsync({playerIds:d})),o=(await _o.allSettled(i)).reduce((d,u)=>u.status==="fulfilled"?d.concat(u.value):d,[]);if(!this.validateProfilesResponse(o))return;const l=this.convertToProfiles(o);this.setProfiles(l)}getProfile(e){return this.getProfiles()[e]??null}getProfiles(){const{storage:e}=this.game;return e.getStorageData("profile","profiles")??ea.profiles}setProfiles(e){const{storage:s}=this.game;s.setStorageData("profile","profiles",e),s.setStorageData("profile","profileIds",Object.keys(e))}getProfileIds(){const{storage:e}=this.game;return e.getStorageData("profile","profileIds")??[]}validateProfilesResponse(e){return!(!Array.isArray(e)||e.length<1)}convertToProfiles(e){const s={};for(const a of e)bo.hasOwn(a,"playerId")&&Co.isString(a.playerId)&&(s[a.playerId]=new xo.Player.Info(a).toObject());return s}}const sa="Save The Pets",{Utils:{Object:aa,Valid:na,Browser:ia}}=p;class Lo extends N.Plugins.BasePlugin{constructor(e){super(e);h(this,"storages");h(this,"storageLocalKeys",{});this.storages={}}async addStorage(e,s,a=!1){this.storages[e]=s,a&&await this.initFromWebStorage(e,s)}async initFromWebStorage(e,s){this.storageLocalKeys[e]=!0;const a=await ia.getIndexedDB(`${sa}_S_${e}`);if(!na.isObject(a))return;const n=Object.keys(s);for(const i of n)aa.hasOwn(a,i)&&typeof s[i]==typeof a[i]&&this.setStorageData(e,i,a[i])}initStorageData(e,s,a){this.storages[e][s]=a}setStorageData(e,s,a){let n;if(na.isObject(a)){const i=this.getStorageData(e,s);n=aa.merge(i,a)}else n=a;this.storages[e][s]=n}getStorageData(e,s){return this.getStorage(e)[s]}getStorage(e){return this.storages[e]}async updateToWebStorage(e){if(this.storageLocalKeys[e])return this.saveToWebStorage(e)}async saveToWebStorage(e){const s=this.getStorage(e);return ia.setIndexedDB(`${sa}_S_${e}`,s)}}class To extends N.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"isVisible",!0);h(this,"browserPrefixes",["moz","ms","o","","webkit"]);h(this,"handleVisibilityChange",e=>{if(["focus","blur"].indexOf(e)>-1)return e==="focus"?this.onVisibleEvent():this.onHiddenEvent();const a=this.getBrowserPrefix();return this.getHiddenPropertyName(a)in document?this.onHiddenEvent():this.onVisibleEvent()})}init(){const e=this.getBrowserPrefix(),a=[this.getVisibilityEvent(e),"focus","blur"];for(const n of a)window.addEventListener(n,()=>{this.handleVisibilityChange(n)},!1),document.addEventListener(n,()=>{this.handleVisibilityChange(n)},!1);GameSDK.extra&&("onPause"in GameSDK.extra&&GameSDK.extra.onPause(()=>{this.handleVisibilityChange("blur")}),"onResume"in GameSDK.extra&&GameSDK.extra.onResume(()=>{this.handleVisibilityChange("focus")}))}isGameVisible(){return this.isVisible}getHiddenPropertyName(e){return e?`${e}Hidden`:"hidden"}getVisibilityEvent(e){return`${e||""}visibilitychange`}getBrowserPrefix(){for(const e of this.browserPrefixes)if(this.getHiddenPropertyName(e)in document)return e;return""}onVisibleEvent(){this.isVisible||(this.isVisible=!0,this.game.event.emit(p.Events.VISIBILITY_VISIBLE))}onHiddenEvent(){this.isVisible&&(this.isVisible=!1,this.game.event.emit(p.Events.VISIBILITY_HIDDEN))}}const{Utils:{Array:at}}=p,ee={IDLE:"idle",LOADING:"loading",LOADED:"loaded",FAILED:"failed"},he={NOT_STARTED:"not-started",IN_PROGRESS:"in-progress",COMPLETED:"completed",FAILED:"failed"},ra=["next","preroll","browse","pause","start"],oa=["reward"];class j{static set initStatus(t){var e,s;this._initStatus!==t&&((s=(e=this.game)==null?void 0:e.analytics)==null||s.initAdEvent({adService:"adsense",state:t}),this._initStatus=t)}static get initStatus(){return this._initStatus}static async getRewardedVideoAsync(t){return await this.ensureInitialized(),this.createAdInstance(this.rewardedType,t)}static async getInterstitialAdAsync(t){return await this.ensureInitialized(),this.createAdInstance(this.interstitialType,t)}static async getRewardedInterstitialAsync(t){return await this.ensureInitialized(),this.createAdInstance(this.rewardedType,t)}static setGame(t){this.game=t}static setRewardType(t){at.has(oa,t)&&(this.rewardedType=t)}static setInterstitialType(t){at.has(ra,t)&&(this.interstitialType=t)}static async initAsync(t){try{switch(this.initStatus){case ee.LOADED:return;case ee.LOADING:return}if(!this.validateConfig(t))throw new Error("Invalid Google Ads configuration");this.initStatus=ee.LOADING,this.config=t,await this.loadScriptElementAsync()}catch(e){throw this.initStatus=ee.FAILED,e}}static validateConfig(t){if(!t)return!1;const{dataAdClient:e,dataAdHost:s}=t;if(!e&&!s)return!1;if(t.dataAdFrequencyHint){const a=Number(t.dataAdFrequencyHint);if(isNaN(a)||a<=0)return!1}return!0}static async loadScriptElementAsync(){try{await this.injectMainScript(),await this.configureGoogleAds()}catch(t){throw t}}static async injectMainScript(){return new Promise((t,e)=>{try{const s=document.createElement("script");this.configureScriptAttributes(s),s.onload=()=>{this.initStatus=ee.LOADED,t()},s.onerror=a=>{this.initStatus=ee.FAILED,e(new Error(`Failed to load Google Ads script: ${a}`))},document.head.appendChild(s)}catch(s){e(s)}})}static async configureGoogleAds(){try{window.adsbygoogle=window.adsbygoogle||[],window.adBreak=t=>adsbygoogle.push(t),window.adConfig=t=>adsbygoogle.push(t),this.config.usePreload&&await this.preloadAdConfig()}catch(t){throw t}}static configureScriptAttributes(t){const{dataAdClient:e,dataAdHost:s,dataAdChannel:a,dataAdBreakTest:n,dataAdFrequencyHint:i}=this.config;t.async=!0,t.crossOrigin="anonymous";let r="";i&&t.setAttribute("data-ad-frequency-hint",`${i}s`),e&&(t.setAttribute("data-ad-client",e),r+=`?client=${e}`),a&&t.setAttribute("data-ad-channel",a),s&&(t.setAttribute("data-ad-host",s),r+=`&host=${s}`),n&&t.setAttribute("data-adbreak-test","on"),t.src=`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js${r}`}static async ensureInitialized(){if(this.initStatus!==ee.LOADED)throw new Error("Google Ads not initialized. Call initAsync first.");await this.ensurePreloaded()}static async ensurePreloaded(){this.preloadStatus!==he.COMPLETED&&await this.preloadAdPlacement()}static createAdInstance(t,e){return{getPlacementID:()=>e,loadAsync:()=>this.preloadAdPlacement(),showAsync:()=>this.showAd(t,e),hideAsync:()=>Promise.resolve()}}static async showAd(t,e){return new Promise((s,a)=>{try{const n=this.createAdBreakConfig({type:t,placementId:e,resolve:s,reject:a});window.adBreak(n)}catch(n){a(n)}})}static createAdBreakConfig(t){const e=this.createBaseAdBreakConfig({placementId:t.placementId}),{type:s}=t;if(at.has(ra,s))return this.createInterstitialAdBreakConfig(e,t);if(at.has(oa,s))return this.createRewardAdBreakConfig(e,t);throw new Error(`Ad type: ${s} is not supported.`)}static createBaseAdBreakConfig(t){return{name:t.placementId,beforeAd:()=>{},adBreakDone:e=>{}}}static createInterstitialAdBreakConfig(t,{resolve:e,reject:s}){return{...t,type:this.interstitialType,adBreakDone:a=>{var n;(n=t.adBreakDone)==null||n.call(t,a),this.handleAdBreakDone({info:a,resolve:e,reject:s})}}}static createRewardAdBreakConfig(t,{resolve:e,reject:s}){return{...t,type:this.rewardedType,beforeReward:a=>{a()},adDismissed:()=>{s(new Error("USER_INPUT"))},adViewed:()=>{e()}}}static handleAdBreakDone(t){const{info:e,resolve:s,reject:a}=t;switch(e.breakStatus){case"viewed":s();break;case"frequencyCapped":a(new Error("AD_FREQUENCY_CAPPED"));break;default:a(new Error(e.breakStatus))}}static async preloadAdPlacement(){return this.initStatus!==ee.LOADED?Promise.reject(new Error("Google Ads not initiated.")):this.preloadAdConfig()}static getInitStatus(){return this.initStatus}static getPreloadStatus(){return this.preloadStatus}static async preloadAdConfig(){if(this.preloadStatus!==he.COMPLETED&&this.preloadStatus!==he.IN_PROGRESS)return this.preloadStatus=he.IN_PROGRESS,new Promise((t,e)=>{const s=setTimeout(()=>{this.preloadStatus===he.IN_PROGRESS&&(this.preloadStatus=he.FAILED,e(new Error("Failed to preload ad config in time.")))},5e3);window.adConfig({preloadAdBreaks:"on",onReady:()=>{clearTimeout(s),this.preloadStatus=he.COMPLETED,t()}})})}}h(j,"game"),h(j,"_initStatus",ee.IDLE),h(j,"preloadStatus",he.NOT_STARTED),h(j,"config"),h(j,"rewardedType","reward"),h(j,"interstitialType","next"),window.GoogleAds=j;const{Utils:{Object:ca},Plugins:{Ads:{Status:W,Types:te,AdError:nt,AdInstance:Oo}}}=p;class la extends Oo{constructor(e,s){super(e,s);h(this,"service");h(this,"instance");h(this,"instanceQueue",[]);this.service=GameSDK.getSDKName(),this.instance=null}async loadAsync(){if(!(this.instance&&this.status===W.FILLED)){if(this.status!==W.IDLE)throw new nt("AD_NOT_READY","Ad is not ready.");try{if(this.instance=await this.createInstanceByType(this.type),this.instance===null)throw new nt("AD_INSTANCE_NOT_INITIATED","Ad instance didn't initiated.");this.setStatus(W.LOADING),await this.instance.loadAsync(),this.setStatus(W.FILLED),this.logAdLoad()}catch(e){throw this.setStatus(W.IDLE),e instanceof Object&&"code"in e&&e.code==="INVALID_PARAM"&&(this.instance=null),this.instance&&this.pushInstanceToQueue(this.instance),self.game.analytics.loadAdFail({type:this.type,service:this.service}),e}}}async showAsync(){if(this.status!==W.FILLED)throw new nt("AD_NOT_FILLED","Ad is not filled.");if(this.instance===null)throw new nt("AD_INSTANCE_NOT_INITIATED","Ad instance didn't initiated.");let e=!1;try{this.setStatus(W.SHOWING),self.game.analytics.showingAd({type:this.type,service:this.service}),await this.instance.showAsync(),e=!0,this.setStatus(W.IDLE),this.instance=null}catch(s){throw ca.hasOwn(s,"code")&&(s.code==="AD_NOT_LOADED"&&this.setStatus(W.IDLE),["INVALID_PARAM","INVALID_OPERATION","USER_INPUT"].indexOf(`${s.code}`)>-1&&(this.setStatus(W.IDLE),this.instance=null),s.code==="USER_INPUT"&&(e=!0)),this.status===W.SHOWING&&(this.setStatus(W.IDLE),this.instance=null),s}finally{e?this.logAdShown():self.game.analytics.showAdFail({type:this.type,service:this.service})}}async createInstanceByType(e){try{return await this.getAdInstanceByType(e)}catch(s){return ca.hasOwn(s,"code")&&s.code==="ADS_TOO_MANY_INSTANCES"?this.getAdInstanceFailed():null}}async getAdInstanceByType(e){switch(e){case te.REWARDED_VIDEO:return await GameSDK.getRewardedVideoAsync(this.placementId);case te.INTERSTITIAL:return await GameSDK.getInterstitialAdAsync(this.placementId);case te.REWARDED_INTERSTITIAL:return await GameSDK.getRewardedInterstitialAsync(this.placementId);default:return null}}getAdInstanceFailed(){if("canBeLoadedAd"in GameSDK.extra){for(const e of this.instanceQueue)if(GameSDK.extra.canBeLoadedAd(e))return this.instanceQueue.splice(this.instanceQueue.indexOf(e),1),e}else return this.instanceQueue.shift()||null;return null}logAdLoad(){switch(this.type){case te.INTERSTITIAL:self.game.analytics.loadInterstitialAd({service:this.service});break;case te.REWARDED_VIDEO:self.game.analytics.loadRewardedVideoAd({service:this.service});break;case te.REWARDED_INTERSTITIAL:self.game.analytics.loadRewardedInterstitialAd({service:this.service});break}}logAdShown(){switch(this.type){case te.INTERSTITIAL:self.game.analytics.showInterstitialAd({service:this.service});break;case te.REWARDED_VIDEO:self.game.analytics.showRewardedVideoAd({service:this.service});break;case te.REWARDED_INTERSTITIAL:self.game.analytics.showRewardedInterstitialAd({service:this.service});break}}pushInstanceToQueue(e){this.instanceQueue.push(e)}}const{Plugins:{Ads:{Types:jt}}}=p;class Mo extends la{constructor(t,e){super(t,e),this.service="adsense"}async createInstanceByType(t){try{switch(t){case jt.REWARDED_VIDEO:return await j.getRewardedVideoAsync(this.placementId);case jt.INTERSTITIAL:return await j.getInterstitialAdAsync(this.placementId);case jt.REWARDED_INTERSTITIAL:return await j.getRewardedInterstitialAsync(this.placementId);default:return null}}catch{return null}}getAdInstanceFailed(){return null}}class Ro extends ss{async loadAsync(){this.exception("Unsupported method")}async showAsync(){this.exception("This method is not implemented")}async hideAsync(){this.exception("This method is not implemented")}}const{Status:da}=p.Plugins.Ads;class Fo extends Ro{async showAsync(){await GameSDK.loadBannerAdAsync(this.placementId),this.setStatus(da.SHOWING)}async hideAsync(){await GameSDK.hideBannerAdAsync(this.placementId),this.setStatus(da.IDLE)}}var Go=Object.defineProperty,$o=Object.getOwnPropertyDescriptor,Wt=(c,t,e,s)=>{for(var a=$o(t,e),n=c.length-1,i;n>=0;n--)(i=c[n])&&(a=i(t,e,a)||a);return a&&Go(t,e,a),a};const{BaseAnalytics:ko,Events:se}=p.Plugins.Analytics,{Events:{VISIBILITY_HIDDEN:Vo,VISIBILITY_VISIBLE:Bo},Utils:{Array:ha,Object:it,Image:Uo,Decorator:Kt},Configs:{Analytics:{ClarityAnalytics:ua}}}=p,pa=it.invert(se),Ho=[se.SCREEN_OPEN];class rt extends ko{constructor(e,s){super(e,"ClarityAnalytics",{...s,color:"#9692FF"});h(this,"image");h(this,"screenshotCount",4);h(this,"isCapturing",!1);h(this,"isScreenshotByEvent",!1);h(this,"handleVisibilityHidden",()=>{var e;(e=this.clarity)==null||e.call(this,"set","Visibility","hidden")});h(this,"handleVisibilityVisible",()=>{var e;(e=this.clarity)==null||e.call(this,"set","Visibility","visible")});h(this,"makeScreenshotByEvent",async(e,s=0)=>{if(!this.game.canvasRecorder||!this.isScreenshotByEvent||!it.hasOwn(pa,e))return;const n=pa[e];ha.has(ua.ScreenshotCanvas.ByEvent,n)&&(await this.setScreenshotToHtml(),s<this.screenshotCount&&setTimeout(()=>this.makeScreenshotByEvent(e,s+1),300))});h(this,"setScreenshotToHtml",async()=>{try{if(this.isCapturing||(this.isCapturing=!0,!this.image))return;const e=await this.captureScreenshot();if(!e)return;this.image.src=e}finally{this.isCapturing=!1}});this.setupScreenshots(),this.listenVisibilityEvents()}get clarity(){return it.hasOwn(window,"clarity")?window.clarity:null}setUser(e){var s;(s=this.clarity)==null||s.call(this,"identify",e)}listenVisibilityEvents(){this.game.event.on(Vo,this.handleVisibilityHidden),this.game.event.on(Bo,this.handleVisibilityVisible)}processEvent(e,s){var a;this.setTagByEvent(e,s),this.makeScreenshotByEvent(e),!ha.has(Ho,e)&&((a=this.clarity)==null||a.call(this,"event",e,s))}setTagByEvent(e,s){if(s)switch(e){case se.PAGE_VIEW:case se.SCREEN_OPEN:this.setPageTag(s);break;case se.AD_SHOWING:this.setAdTag(s);break;case se.BUTTON_CLICK:this.setButtonTag(s);break;case se.TUTORIAL_STEP:this.setTutorialTag(s);break;case se.LEVEL_START:this.setLevelTag(s);break;case se.USE_ITEM:this.setItemTag(s);break}}setPageTag(e){var a;if(!e.page_title&&!e.path_path)return;const s=e.page_title||e.path_path;s&&((a=this.clarity)==null||a.call(this,"set","Page",s))}setAdTag(e){var a;if(!e.ad_type||!e.ad_service)return;const s=`${e.ad_type}:${e.ad_service}`;(a=this.clarity)==null||a.call(this,"set","Ad",s)}setButtonTag(e){var a;if(!e.button_name||!e.screen_name)return;const s=`${e.button_name}:${e.screen_name}`;(a=this.clarity)==null||a.call(this,"set","Button",s)}setTutorialTag(e){var a;if(!e.step)return;const s=e.step.toString();(a=this.clarity)==null||a.call(this,"set","Tutorial",s)}setLevelTag(e){var a;if(!e.level_name||!e.game_mode)return;const s=`${e.game_mode}:${e.level_name}`;(a=this.clarity)==null||a.call(this,"set","Level",s)}setItemTag(e){var s;e.item_name&&((s=this.clarity)==null||s.call(this,"set","Item",e.item_name))}setupScreenshots(){if(typeof FileReader>"u")return;this.initImage();const{ByEvent:e,Interval:s}=ua.ScreenshotCanvas;if(e.length>0){this.isScreenshotByEvent=!0;return}setInterval(this.setScreenshotToHtml,s)}initImage(){if(this.image)return;const e=document.getElementById("Cocos3dGameContainer");e&&(this.image=document.createElement("img"),this.image.id="clarity-screenshot",this.image.setAttribute("data-clarity-unmask","true"),it.assign(this.image.style,{position:"absolute",display:"flex",width:"100%",top:0,left:0,pointerEvents:"none"}),e.insertBefore(this.image,e.firstChild))}async captureScreenshot(){if(!this.game.canvasRecorder)return null;const e=await this.game.canvasRecorder.snapshotFrameAsync({force:!0,type:"jpeg",quality:.1,resolution:.5});return this.game.canvasRecorder.waitNextFrame(),e?await Uo.blobToDataImage(e):null}}Wt([Kt.tryCatch()],rt.prototype,"setupScreenshots"),Wt([Kt.tryCatch()],rt.prototype,"initImage"),Wt([Kt.tryCatch()],rt.prototype,"captureScreenshot");const{BaseAnalytics:jo,Events:ya}=p.Plugins.Analytics,Wo=[ya.BUTTON_CLICK,ya.SCREEN_OPEN],{Utils:{Array:Ko}}=p;class qo extends jo{constructor(e,s){super(e,"FacebookAnalytics",{...s,color:"#0F52BA"});h(this,"prefix");this.prefix=s.prefix}processEvent(e,s){if(!("logEvent"in GameSDK.extra)||Ko.has(Wo,e))return;const a=this.addPrefixToEventName(e);GameSDK.extra.logEvent(a,1,s)}addPrefixToEventName(e){return`${this.prefix}_${e}`}}const{BaseAnalytics:zo,Events:Yo}=p.Plugins.Analytics,Jo=[Yo.SCREEN_OPEN],{Utils:{Array:Qo}}=p;class Xo extends zo{constructor(t,e){super(t,"FirebaseAnalytics",{...e,color:"#FFCA28"})}setUser(t,e){var s,a;(a=(s=this.game.firebase)==null?void 0:s.services.analytics)==null||a.setUser(t,e)}processEvent(t,e){var s,a;Qo.has(Jo,t)||(a=(s=this.game.firebase)==null?void 0:s.services.analytics)==null||a.event(t,e)}}const{BaseAnalytics:Zo,Events:Se}=p.Plugins.Analytics,ec=[Se.SCREEN_OPEN],{Utils:{Array:tc}}=p;class sc extends Zo{constructor(t,e){super(t,"GoogleAnalytics",{...e,color:"#E35335"})}processEvent(t,e){tc.has(ec,t)||(this.customEvent(t,e),gtag("event",t,e))}customEvent(t,e){switch(t){case Se.AD_SHOW:case Se.AD_SHOW_FAILED:case Se.AD_SHOWING:case Se.USE_ITEM:case Se.EARN_ITEM:this.addLevelName(e);break}}addLevelName(t){if(!t||!(game!=null&&game.match))return;const s=game.match.getMatchState().customData.level;s<0||(t.level_name=this.getLevelName(s))}}const{BaseAnalytics:ac,Events:fa}=p.Plugins.Analytics,nc=[fa.LEVEL_START,fa.LEVEL_END],{Utils:{Array:ic}}=p;class rc extends ac{constructor(t){super(t,"YandexAnalytics",{color:"#FFB02E"})}processEvent(t){"logEvent"in GameSDK.extra&&ic.has(nc,t)&&GameSDK.extra.logEvent(t)}}const oc="production",qt="23",{Dtos:cc,Events:De,Configs:{AppId:lc,Ads:ae,Analytics:ot,AdaptivePerformance:ga,Debugger:ue,Firebase:ma,Notification:dc,RemoteConfig:Aa,PerformanceMonitor:hc},Plugins:{Ads:{Types:ct}},Utils:{Device:uc,Object:wa,Json:lt,String:Da,Valid:pc,Mark:E}}=p;class yc extends N.Game{constructor(){super(...arguments);h(this,"markName","Core Initialize");h(this,"modulePlugins",[]);h(this,"processContextSession",async()=>{E.putAttr(this.markName,"Step","Process Context Payload"),await this.context.detectContextSessionType(),this.context.detectContextGameMode();const e=this.storage.getStorageData("context","sessionContextType")||"unknown";E.putAttr(this.markName,"Context Mode",e),E.stop(this.markName)});h(this,"addDevPlugins",()=>{var a;const{ListPlayerDevIds:e}=ue,s=(a=GameSDK==null?void 0:GameSDK.player)==null?void 0:a.getID();!s||e.indexOf(s)<0||(this.addConsolePlugin(),this.addProfilerPlugin())});h(this,"handleProtectGameInstance",()=>{const e=this.event.getEventEmitCount(re.MODULE_PLUGIN_READY),s=this.modulePlugins.length;e<s||(window.game=Object.freeze(window.game),Jt(window,"game"))});h(this,"initCanvasRecorderPlugin",()=>{if(!this.canvasRecorder)return;const{CanvasRecorder:e}=ue,{Type:s,Quality:a,RecordFps:n,SyncFps:i}=e.Options;this.canvasRecorder.configure({type:s,quality:a,syncFps:i,recordFps:n}),this.canvasRecorder.setPanelExpanded(e.PanelExpanded);const r=document.querySelector("canvas");r&&this.canvasRecorder.setCanvas(r)});h(this,"initMonitorErrorPlugin",()=>{var u;if(!this.monitorError)return;const{MonitorError:e,ListPlayerDevIds:s}=ue,{ApiKey:a,Service:n,Feedback:i,TrackUser:r,FilterErrors:o}=e,l=GameSDK.player.getID(),d=GameSDK.player.getName();l&&s.indexOf(l)>=0||((u=window.disableSimpleTrackErrors)==null||u.call(window),this.monitorError.configure({apiKey:a,service:n,feedback:i,trackUser:r,releaseStage:oc,buildVersion:`${qt}`}),this.monitorError.setUser({id:l,name:d}),this.monitorError.addFilterErrors(o),this.monitorError.initFeedbackTrackErrors(),this.updateMonitorErrorUserAndMetadata(),this.processErrorsQueue())});h(this,"updateMonitorErrorUserAndMetadata",()=>{this.event.catchUp(De.PLAYER_INFO_LOADED,this.processWhenPlayerInfoLoaded)});h(this,"processErrorsQueue",()=>{if(this.monitorError&&window.__errorQueue){for(const e of window.__errorQueue)if(e instanceof Error)this.monitorError.sendException(e);else{const{message:s,code:a,stack:n}=e||{message:"",code:"Unknown",stack:"Unknown stack"},i=new Error(s||a);i.stack=n,this.monitorError.sendException(i)}window.__errorQueue=null}});h(this,"processWhenPlayerInfoLoaded",()=>{if(!this.monitorError)return;const{playerId:e,name:s}=this.player.getPlayer();this.monitorError.setUser({id:e,name:s}),this.monitorError.addMetadata({isFirstLogin:this.player.isFirstLogin()})});h(this,"handleSaveRemoteConfig",e=>{try{const s={[e.type]:e};this.player.setPlayerDataByName("remoteConfig",s)}catch{}});h(this,"handleUpdateGameCoreConfig",e=>{try{const{id:s,type:a}=e;if(a!=="GameCore")return;p.Configs=wa.merge(p.Configs,e.config);const{Ads:n}=p.Configs;this.ads.configure(n),this.event.emit(re.REMOTE_CONFIG_UPDATED,{id:s,type:a})}catch{}});h(this,"handleStorageCurrentRemoteConfig",()=>{const e=this.player.getPlayerDataByKey("remoteConfig");if(e){for(const s in e)if(wa.hasOwn(e,s)){const a=e[s],n=lt.clone(a),i=new cc.RemoteConfig.Data(n).toObject();this.remoteConfig.setRemoteConfig(i),this.remoteConfig.processUpdateConfig(i.id,i.type)}}});h(this,"initAdaptivePerformancePlugin",()=>{if(!this.adaptivePerformance)return;const e=lt.clone(ga);this.adaptivePerformance.configure(e)});h(this,"processAfterSyncProfile",()=>{dc.Enabled&&this.updatePlayerProfileToNotificationService()})}getBuildVersion(){return parseInt(`${qt}`)||0}async boot(){super.boot(),this.addPlugins(),this.initEventPlugin(),this.event.emit(De.CORE_BOOTING),this.initFirebasePlugin(),this.initMarkCoreInitialize(),E.putAttr(this.markName,"Step","Init Analytics"),this.initGoogleAnalytics(),this.initClarityAnalytics(),this.initFirebaseAnalytics(),this.initYandexAnalytics(),this.initFacebookAnalytics(),E.putAttr(this.markName,"Step","Init Plugins"),this.initAds(),this.initMatchPlugin(),this.initRemoteConfig(),E.putAttr(this.markName,"Step","Load Lazy Plugins"),pc.isDebugger()||this.event.on(De.MODULE_PLUGIN_READY,this.handleProtectGameInstance),this.addMonitorPlugin().then(this.initMonitorErrorPlugin),this.addCanvasRecorderPlugin().then(this.initCanvasRecorderPlugin),this.addAdaptivePerformancePlugin().then(this.initAdaptivePerformancePlugin),E.putAttr(this.markName,"Step","Load Dev Plugins"),this.event.catchUp(De.GAME_SDK_READY,this.addDevPlugins)}async start(){super.start(),E.putAttr(this.markName,"Step","Core Start"),this.event.emit(De.CORE_STARTING),E.putAttr(this.markName,"Step","Request Token"),await this.auth.requestToken(),E.putAttr(this.markName,"Step","Init States"),await this.initState(),E.putAttr(this.markName,"Step","Process Player Profile"),this.processPlayerProfile(),GameSDK.getSDKName()==="FacebookInstant"&&uc.isIOS()?this.event.catchUp(De.GAME_SDK_STARTED,this.processContextSession):await this.processContextSession(),E.putAttr(this.markName,"Step","Core Ready"),E.putAttr(this.markName,"Success","true"),this.event.emit(De.CORE_READY)}addPlugins(){this.installPlugin("Storage",Lo),this.installPlugin("Event",In),this.installPlugin("Ads",$a),this.installPlugin("Auth",en),this.installPlugin("Audio",os),this.installPlugin("Match",Yr),this.installPlugin("Player",so),this.installPlugin("Profile",No),this.installPlugin("Context",ln),this.installPlugin("Language",zn),this.installPlugin("Analytics",ja),this.installPlugin("Visibility",To),this.installPlugin("Leaderboard",ai),this.installPlugin("DailyRewards",mn),this.installPlugin("FrameCapture",jn),this.installPlugin("RemoteConfig",ht),"Proxy"in window&&this.installPlugin("Firebase",ht)}installPlugin(e,s,a=!1){const n=Da.toCamelCase(Da.capitalize(e));this.plugins.install(e,s,!0,n),e!=="Storage"&&(a?this.emitModulePluginReady(e):this.emitCorePluginReady(e))}async addMonitorPlugin(){try{const{MonitorError:e}=ue;if(!e.Enabled)return;this.modulePlugins.push("MonitorError");const s=(await ie(async()=>{const{default:a}=await I.import("./bundle/monitor-error.js").then(n=>n.i);return{default:a}},void 0,I.meta.url)).default;if(typeof s!="function")return;this.installPlugin("MonitorError",s,!0)}catch{}}async addCanvasRecorderPlugin(){try{const{CanvasRecorder:e}=ue;if(!e.Enabled)return;this.modulePlugins.push("CanvasRecorder");const s=(await ie(async()=>{const{default:a}=await I.import("./bundle/canvas-recorder.js").then(n=>n.i);return{default:a}},void 0,I.meta.url)).default;if(typeof s!="function")throw new Error("CanvasRecorderPlugin is not a function");this.installPlugin("CanvasRecorder",s,!0)}catch{}}async addAdaptivePerformancePlugin(){try{if(!ga.Enabled)return;this.modulePlugins.push("AdaptivePerformance");const e=(await ie(async()=>{const{default:s}=await I.import("./bundle/index.js");return{default:s}},void 0,I.meta.url)).default;if(typeof e!="function")return;this.installPlugin("AdaptivePerformance",e,!0)}catch{}}async addConsolePlugin(){try{const{Console:e}=ue;if(!e.Enabled)return;this.modulePlugins.push("Console");const s=(await ie(async()=>{const{default:a}=await I.import("./bundle/canvas-recorder.js").then(n=>n.e);return{default:a}},void 0,I.meta.url)).default;if(typeof s!="function")throw new Error("ConsolePlugin is not a function");this.installPlugin("Console",s,!0),this.initConsolePlugin()}catch{}}async addProfilerPlugin(){try{const{Profiler:e}=ue;if(!e.Enabled)return;this.modulePlugins.push("Profiler");const s=(await ie(async()=>{const{default:a}=await I.import("./bundle/canvas-recorder.js").then(n=>n.e);return{default:a}},void 0,I.meta.url)).default;if(typeof s!="function")throw new Error("ProfilerPlugin is not a function");this.installPlugin("Profiler",s,!0),this.initProfilerPlugin()}catch{}}emitCorePluginReady(e){this.event.emit(re.CORE_PLUGIN_READY,{name:e})}emitModulePluginReady(e){this.event.emit(re.MODULE_PLUGIN_READY,{name:e})}initEventPlugin(){const{EventLogging:e}=ue;e.Enabled&&this.event.enableLogEvent()}initMatchPlugin(){this.match.setUseCPUProfile(!1)}initAds(){this.ads.configure(ae),this.initGoogleAds(),this.initAdInstance(),ae.Enabled&&this.analytics.initAdEvent({adService:"platform",state:"loaded"})}async initGoogleAds(){try{if(!ae.Enabled)return;const{Enabled:e,UsePreload:s,DataAdBreakTest:a,DataAdClient:n,DataAdChannel:i,DataAdFrequencyHint:r,DataAdHost:o}=ae.AdServiceConfigs.AdSense;if(!e)return;j.setGame(this),await j.initAsync({usePreload:s,dataAdHost:o,dataAdClient:n,dataAdChannel:i,dataAdBreakTest:a,dataAdFrequencyHint:r})}catch{}}getAdInstanceByService(e,s=!1){const{AdSense:a,AppLovin:n}=ae.AdServiceConfigs;switch(e){case"adsense":if(a.Enabled)return Mo;break;case"applovin":break;default:return s?Fo:la}return null}initAdInstance(){for(const s of ae.InterstitialAdOptions){const a=this.getAdInstanceByService(s.AdService);a&&this.ads.setAdInstance(ct.INTERSTITIAL,s.PlacementId,a)}for(const s of ae.RewardedVideoAdOptions){const a=this.getAdInstanceByService(s.AdService);a&&this.ads.setAdInstance(ct.REWARDED_VIDEO,s.PlacementId,a)}for(const s of ae.RewardedInterstitialAdOptions){const a=this.getAdInstanceByService(s.AdService);a&&this.ads.setAdInstance(ct.REWARDED_INTERSTITIAL,s.PlacementId,a)}const e=!0;for(const s of ae.BannerDisplayAdOptions){const a=this.getAdInstanceByService(s.AdService,e);a&&this.ads.setAdInstance(ct.BANNER,s.PlacementId,a)}}async initState(){try{const e=new Na(this);e.initContext(),await e.initPlayer()}catch{}}initConsolePlugin(){this.console&&this.console.configure()}initProfilerPlugin(){this.profiler&&this.profiler.configure()}initRemoteConfig(){if(!Aa.Enabled)return;const e=lt.clone(Aa);this.remoteConfig.configure(e),this.event.on(re.REQUEST_SAVE_CONFIG,this.handleSaveRemoteConfig),this.event.on(re.REQUEST_UPDATE_CONFIG,this.handleUpdateGameCoreConfig),this.event.catchUp(re.PLAYER_INFO_LOADED,this.handleStorageCurrentRemoteConfig)}initFirebasePlugin(){if(!ma.Enabled||!this.firebase)return;const e=lt.clone(ma);this.firebase.configure(e),E.setService(this.firebase.services.performance)}initMarkCoreInitialize(){hc.CoreFlows&&(E.measure(this.markName),E.putAttr(this.markName,"Build",`${qt}`),E.putAttr(this.markName,"GameSDK",GameSDK.getSDKName()),E.putAttr(this.markName,"Platform",GameSDK.getPlatform()),E.putAttr(this.markName,"Success","false"),E.start(this.markName))}async processPlayerProfile(){try{await this.player.syncProfileToServer(),this.processAfterSyncProfile()}catch{}}async updatePlayerProfileToNotificationService(){try{const e=this.player.getPlayer(),{ASID:s,playerId:a,name:n,photo:i,locale:r}=e;await Fa({appId:lc,ASID:s,playerId:a,name:n,photo:i,locale:r})}catch{}}initGoogleAnalytics(){const{Enabled:e,ConsoleLog:s}=ot.GoogleAnalytics??{};e&&this.analytics.add(new sc(this.game,{log:!!s}))}initClarityAnalytics(){const{Enabled:e,ConsoleLog:s}=ot.ClarityAnalytics??{};if(!e)return;const a=new rt(this.game,{log:!!s});if(!GameSDK.extra.isGuest){const n=this.player.getPlayer(),{playerId:i}=n;a.setUser(i)}this.analytics.add(a)}initFirebaseAnalytics(){const{Enabled:e,ConsoleLog:s}=ot.FirebaseAnalytics??{};if(!e)return;const a=new Xo(this.game,{log:!!s});this.analytics.add(a);let n="no_entry";GameSDK.getEntryPointAsync().then(i=>{n=i}).catch(i=>{}).finally(()=>{const i=this.player.getPlayer(),{playerId:r,locale:o}=i,{fbig_ad_id:l,fbig_adset_id:d,fbig_campaign_id:u}=GameSDK.getEntryPointData()||{};a.setUser(r,{locale:o,ad_id:l,adset_id:d,campaign_id:u,traffic_source:n})})}initYandexAnalytics(){GameSDK.getSDKName()==="Yandex"&&this.analytics.add(new rc(this.game))}initFacebookAnalytics(){const e=GameSDK.getSDKName(),{Enabled:s,Prefix:a,ConsoleLog:n}=ot.FacebookAnalytics??{};!s||e!=="FacebookInstant"||typeof a=="string"&&this.analytics.add(new qo(this.game,{prefix:a,log:!!n}))}}const{Configs:{GameEngine:{ForceDesktopDPR:dt}},Utils:{Device:fc},Events:zt}=p,gc=async()=>{const c=new yc;window.game=c;const t=20;window.__sdkLoadingCount<t&&(window.__sdkLoadingCount=t),window.__gameCoreStart=!0,await c.boot(),c.event.catchUp(zt.REQUEST_CORE_START,Ia),mc(c)},Ia=()=>{if(!window.__sdkInitiated){game.event.catchUp(zt.GAME_SDK_READY,Ia);return}window.game.start();const c=25;window.__sdkLoadingCount<c&&(window.__sdkLoadingCount=c)},mc=c=>{const e=setInterval(()=>{if(!window.__sdkInitiated)return;clearInterval(e);const s=10;window.__sdkLoadingCount<s&&(window.__sdkLoadingCount=s),c.event.emit(zt.GAME_SDK_READY)},5)};dt!==!1&&fc.isDesktop()&&typeof dt=="number"&&dt>0&&(window.devicePixelRatio=dt),window.originalRequestAnimationFrame=window.requestAnimationFrame,window.isCustomRequestAnimationFrame=!0,window.requestAnimationFrame=c=>window.isCustomRequestAnimationFrame?(setTimeout(c,1e3/60),0):window.originalRequestAnimationFrame(c),gc()}}});
