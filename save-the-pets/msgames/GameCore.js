var qo=Object.defineProperty;var Zd=(se,v,p)=>v in se?qo(se,v,{enumerable:!0,configurable:!0,writable:!0,value:p}):se[v]=p;var c=(se,v)=>qo(se,"name",{value:v,configurable:!0});var h=(se,v,p)=>Zd(se,typeof v!="symbol"?v+"":v,p);System.register(["./bundle/core.js","./bundle/__commonjsHelpers__.js","./bundle/canvas-recorder.js"],function(se,v){"use strict";var p,O,Vr,ce,K,le,Br,Zt;return{setters:[L=>{p=L.G,O=L.P,Vr=L.M,ce=L._,K=L.a,le=L.C},L=>{Br=L.g},L=>{Zt=L.d}],execute:c(function(){var ke,Ve,Be;const{Valid:L,Object:fe,String:es,Json:Ur}=p.Utils,Ue="is invalid",J=class J{static addDefaultData(s){L.isObject(s)||this.prototype.exception("default data",Ue),s=Ur.clone(s);const{name:e}=this;L.isObject(J.data[e])||(J.data[e]={}),J.data[e]=fe.merge(J.data[e],s),console.debug(`${e} default data:`,J.data[e])}static getDefaultData(){const{name:s}=this;return Ur.clone(J.data[s])}static addValidateFunction(s,e){L.isString(s)||this.prototype.exception("validate key",Ue),typeof e!="function"&&this.prototype.exception("validate function",Ue);const t=`validate${es.capitalize(s)}`;fe.assign(this.prototype,{[t]:e})}constructor(s){this.defaultData(),this.processData(s)}processData(s){this.validateStructure(s),this.validateData(s),this.setupData(s)}defaultData(){const{name:s}=this.constructor;this.lazyDefaultData(J.data[s])}lazyDefaultData(s){L.isObject(s)||this.exception("data",Ue);for(const e in s)if(fe.hasOwn(s,e)){const t=s[e];fe.assign(this,{[e]:t})}}lazyValidateStructure(s){L.isObject(s)||this.exception("structure","is not object");const e=this.getKeys();for(const t of e){const a=this[t];a===void 0&&this.exception("structure",`has no key ${t}`),!fe.hasOwn(s,t)&&a!==void 0&&this.setDefaultData(t,s)}}setDefaultData(s,e){L.isObject(e)||this.exception("data",Ue);const t=this[s];t===void 0&&this.exception("default",`has no key ${s}`),fe.assign(e,{[s]:t})}lazyValidateData(s){const e=this.getKeys();for(const t of e){const a=s[t],n=es.removeDiacritics(t).replace(/[^a-zA-Z0-9]/g,""),i=`validate${es.capitalize(n)}`,r=this[i];if(typeof r=="function")try{r.call(this,a)}catch(o){console.warn(o),this.setDefaultData(t,s)}else this.exception("validate",`has no function ${i}`)}}lazySetupData(s){const e=this.getKeys();for(const t of e){const a=s[t];fe.assign(this,{[t]:a})}}validate(){this.validateData(this.toObject())}exception(s,e){throw new Error(`${this.constructor.name}: ${s} ${e}`)}toObject(){return Object.fromEntries(Object.entries(this).filter(([s])=>s!=="toObject"))}getKeys(){return Object.keys(this).filter(s=>s!=="toObject")}};c(J,"BaseDtos"),h(J,"data",{});let U=J;p.Dtos={Base:U};const Yo={score:"score",endlessScore:"endlessScore",settings:"settings",gameData:"gameData",remoteConfig:"remoteConfig",isFirstLogin:"isFirstLogin",dailyRewarded:"dailyRewarded",notificationData:"notificationData",lastCallSwitchGame:"lastCallSwitchGame"},de={ASID:null,playerId:"0000",name:"Guest",photo:"",locale:"en_US",connectedPlayers:{},data:{dailyRewarded:{logDays:[],firstReward:0},score:0,endlessScore:0,settings:{sound:!0,music:!0,vibrate:!0,language:"en"},gameData:{coins:0,level:1},isFirstLogin:!0,notificationData:{D1:{arrivalDate:0},D2:{arrivalDate:0},D3:{arrivalDate:0},D4:{arrivalDate:0},D5:{arrivalDate:0},D6:{arrivalDate:0},D7:{arrivalDate:0}},lastCallSwitchGame:0}},{Valid:We}=p.Utils,{playerId:Qo,name:Xo,photo:Jo,locale:Zo}=de,je="is invalid",sn=class sn extends U{setupData(s){this.lazySetupData(s)}validateStructure(s){this.lazyValidateStructure(s)}validateData(s){this.lazyValidateData(s)}validateId(s){(!We.isString(s)||!s)&&this.exception("_id",je)}validatePlayerId(s){(!We.isString(s)||!s)&&this.exception("playerId",je)}validateName(s){(!We.isString(s)||!s)&&this.exception("name",je)}validatePhoto(s){We.isString(s)||this.exception("photo",je)}validateLocale(s){(!We.isString(s)||!s)&&this.exception("locale",je)}toObject(){return super.toObject()}};c(sn,"PlayerInfoDtos");let Ne=sn;Ne.addDefaultData({playerId:Qo,name:Xo,photo:Jo,locale:Zo});const ae=new Ne({playerId:"10",name:"Your Friend"}).toObject(),an=class an extends Error{constructor(e){super(e);h(this,"code");this.code="CREATE_MATCH_FAILED"}};c(an,"ACreateMatchFailed");let Y=an;const nn=class nn extends Y{constructor(s){super(s),this.name="PlayerIdNotValid",this.message=s??"Player id is not valid"}};c(nn,"PlayerIdNotValid");let P=nn;const{Dtos:ts,Utils:{Array:ec,Object:tc,Json:ss,Valid:as},Events:sc}=p,rn=class rn{constructor(s){h(this,"game");h(this,"initContext",c(()=>{const s={contextId:GameSDK.context.getID()??"",contextType:GameSDK.context.getType(),entryPointData:GameSDK.getEntryPointData()},e=new ts.Context.Info(s),{contextId:t,contextType:a,entryPointData:n}=e.toObject();this.game.context.receiveContext(t,a,n)},"initContext"));h(this,"initPlayer",c(async()=>{try{const{player:s}=this.game,e=this.getPlayerInfo();console.info("playerInfo",ss.clone(e));const t=ec.unique(tc.vals(Yo));console.debug("dataKeys",t);const a=await GameSDK.player.getDataAsync(t);console.debug("rawData",ss.clone(a));const n=new ts.Player.Data(a).toObject();console.info("playerData",ss.clone(n)),s.receiveData(e,n)}catch(s){console.warn("StateInitiator.initPlayer",s)}finally{this.game.event.emit(sc.PLAYER_INFO_LOADED)}},"initPlayer"));h(this,"getPlayerInfo",c(()=>{try{const s=GameSDK.player.getID();let e=GameSDK.player.getName();const t=GameSDK.player.getPhoto();let a=GameSDK.getLocale();if(!as.isString(s))throw new P;return as.isString(e)||(e="You"),(!as.isString(a)||!a)&&(a="en"),new ts.Player.Info({playerId:s,name:e,photo:t,locale:a}).toObject()}catch(s){return console.warn("StateInitiator.getPlayerInfo",s),ae}},"getPlayerInfo"));this.game=s}};c(rn,"StateInitiator");let ns=rn;const on=class on extends Error{constructor(e,t){super(e);h(this,"payload");this.name="BadRequest",this.message=e??"This request is bad",this.payload=t}};c(on,"BadRequest");let Ke=on;const cn=class cn extends Error{constructor(e,t){super(e);h(this,"payload");this.name="RequestTimeout",this.message=e??"This request is timeout",this.payload=t}};c(cn,"RequestTimeout");let He=cn;const{Utils:ac,Configs:nc}=p,{AppId:Wr,Network:is}=nc,ic=c(y=>{if(!y.ok)throw new Ke(void 0,{response:y})},"validateResponse"),jr=c(()=>{const y=window.game.auth.getToken();return{token:y,timeout:is.Timeout,headers:{Authorization:`Bearer ${y}`,"Content-Type":"application/json"}}},"defaultConfig"),Kr=c((y,s,e,t)=>async()=>{try{if(!Wr)throw new Ke("AppId is not defined");const a=`${y}/apps/${Wr}/${s}`,n=new AbortController;e.signal=n.signal;const i=setTimeout(()=>{n.abort()},e.timeout);p.Utils.Valid.isObject(t)&&(e.body=JSON.stringify(t));const r=await fetch(a,e);return clearTimeout(i),ic(r),await r.json()||{}}catch(a){if(a instanceof Ke)return null;throw a instanceof Object&&"name"in a&&a.name==="AbortError"?new He:a}},"requester"),rs=c(async(y,s)=>{try{return y()}catch(e){if(e instanceof He&&s>0)try{return await ac.Time.sleepAsync(600),await rs(y,s-1)}catch{return{}}return e instanceof He?{}:(console.warn("Request error",e),{})}},"handleRequest"),Oe=c(async(y,s,e,t=is.Retries)=>{try{const a={...jr(),...s,method:"GET"},n=Kr(e,y,a);return await rs(n,t)}catch(a){return console.warn("Get error",a),{}}},"get"),Z=c(async(y,s,e,t,a=is.Retries)=>{try{const n={...jr(),...e,method:"POST"},i=Kr(t,y,n,s);return await rs(i,a)}catch(n){return console.warn("Post error",n),{}}},"post"),{Configs:{Notification:{ApiUrl:rc}},Utils:{Object:oc}}=p,cc=c(async y=>{if(!oc.hasOwn(y,"playerId"))throw new Error("Missing playerId");const{playerId:s}=y;await Z(`players/${s}`,y,{},rc,10)},"updatePlayerProfileNotificationAsync");var Hr=(y=>(y.IDLE="idle",y.LOADING="loading",y.FILLED="filled",y.SHOWING="showing",y))(Hr||{});const zr=Hr;var qr=(y=>(y.BANNER="banner",y.INTERSTITIAL="interstitial",y.REWARDED_VIDEO="rewarded_video",y.REWARDED_INTERSTITIAL="rewarded_interstitial",y))(qr||{});const ee=qr;let ut=(ke=class extends Error{constructor(e,t){super(t);h(this,"code");this.code=e,this.message=t}},c(ke,"AdError"),ke);const ln=class ln{constructor(s,e){h(this,"type");h(this,"service");h(this,"placementId");h(this,"_status");this.type=s,this._status=zr.IDLE,this.placementId=e}setStatus(s){this._status!==s&&(this._status=s)}get status(){return this._status}exception(s){throw new ut("AD_INSTANCE_ERROR",s)}};c(ln,"BaseInstance");let os=ln,Yr=(Ve=class extends os{loadAsync(){this.exception("This method is not implemented")}showAsync(){this.exception("This method is not implemented")}hideAsync(){this.exception("Unsupported method")}},c(Ve,"AdInstance"),Ve);p.Plugins.Ads={Types:ee,Status:zr,AdError:ut,AdInstance:Yr};const{Array:pt,Object:Qr}=p.Utils,dn=class dn extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"enabled");h(this,"config");h(this,"lastCallAdShownTime");h(this,"isAdFullSizeShowed");h(this,"ads",{});h(this,"safeAreaBottom");h(this,"degradationTracking",{failedAttempts:0,lastSuccessTime:0})}init(){this.lastCallAdShownTime={[ee.BANNER]:0,[ee.INTERSTITIAL]:0,[ee.REWARDED_VIDEO]:0,[ee.REWARDED_INTERSTITIAL]:0},this.isAdFullSizeShowed=!1,this.calculateSafeAreaBottom(),this.resetDegradationTracking()}calculateSafeAreaBottom(){try{const e=getComputedStyle(document.documentElement).getPropertyValue("--sab");this.safeAreaBottom=parseInt(e,10),isNaN(this.safeAreaBottom)&&(this.safeAreaBottom=0)}catch{this.safeAreaBottom=0}}configure(e){this.config=e,this.enabled=this.config.Enabled}checkEnabled(){if(!this.enabled)throw new ut("ADS_NOT_ENABLED","Ads is't enabled")}isAdFullSizeShowing(){return this.isAdFullSizeShowed}setAdInstance(e,t,a){const n=`${e}-${t}`;if(this.ads[n]){console.warn(`AdsPlugin: Ad instance with placementId ${t} already exists`);return}this.ads[n]={type:e,placementId:t,interval:null,instance:new a(e,t)}}async loadAdAsync(e,t){this.checkEnabled();try{await this.getAd(e,t).instance.loadAsync()}catch(a){throw this.degradationTracking.failedAttempts++,a}}async showAdAsync(e,t){if(this.checkEnabled(),!this.canbeShowAd(e,t)){console.warn(`AdsPlugin: This ad ${e} is not ready to be shown`);return}const{event:a}=this.game,n=this.getAd(e,t);try{a.emit(p.Events.AD_SHOWING,{type:e,placementId:t}),this.isAdFullSizeShowed=!0,await n.instance.showAsync(),this.resetDegradationTracking(),this.lastCallAdShownTime[e]=Date.now()/1e3}catch(i){throw this.degradationTracking.failedAttempts++,i}finally{a.emit(p.Events.AD_CLOSED,{type:e,placementId:t}),this.isAdFullSizeShowed=!1}}getAdStatus(e,t){return this.checkEnabled(),this.getAd(e,t).instance.status}getAd(e,t){let a=null;if(t?a=this.getAdByPlacementId(t,e):a=this.getPriorityAdByType(e),!a)throw new ut("AD_INSTANCE_NOT_INITIATED","The instance ads not yet initiated");return a}getAdsByType(e){return Qr.vals(this.ads).filter(t=>t.type===e)}getAdByPlacementId(e,t){const a=Qr.vals(this.ads),n=pt.search(a,i=>i.placementId===e&&(!t||i.type===t));return n||null}getPriorityAdByType(e){const t=this.getAdsByType(e);if(!t.length)return null;const a=pt.search(t,n=>n.type===e);return a||null}canbeShowAd(e,t){return this.canbeShowAdByTime(e,t)}canbeShowAdByTime(e,t){try{const a=Date.now()/1e3;let n;if(t)n=this.getCommonAdConfig(t);else{const u=this.getPriorityAdByType(e);if(!u)return!1;n=this.getCommonAdConfig(u.placementId)}const{SecondsBetweenAds:i,SecondsFirstTime:r}=n,o=a-this.lastCallAdShownTime[e],l=o>i,d=o>r;return console.debug("[AdsPlugin] canbeShowAdByTime",{type:e,now:a,lastShownTime:this.lastCallAdShownTime[e],period:o,adConfig:n,canbeShowByTime:l,canbeShowFirstTime:d}),this.lastCallAdShownTime[e]>0?l:d}catch(a){return console.warn(`Error while checking canbe show ${e} ad by time`,a),!1}}canbeShowBannerAd(e){try{const t=this.getBannerConfig(e),{Platform:a}=t;if(a==="ALL")return!0;const n=GameSDK.getPlatform();return n?n===a:!1}catch(t){return console.warn("Error while checking canbeShowBannerAd",t),!1}}async showBannerAdAsync(e,t=!0){this.checkEnabled();const a=this.getAd(ee.BANNER,e);if(!this.canbeShowBannerAd(a.placementId))throw new Error("Banner ad can not be shown");this.cleanBannerReloadTimer(a),t?await this.showBannerAdWithSchedule(a):await this.showBannerAdOnce(a)}async showBannerAdOnce(e){const{event:t}=this.game;if(this.isAdFullSizeShowing()){console.warn("Show banner ad skipped because ad full size is showing");return}try{await e.instance.showAsync(),t.emit(p.Events.AD_SHOWING,{type:ee.BANNER,placementId:e.placementId})}catch(a){const n=a instanceof Error?a:new Error("AdsPlugin.startShowBannerAdInterval: Failed to show banner ad");try{await e.instance.hideAsync()}catch(i){console.warn("AdsPlugin.startShowBannerAdInterval: Failed to call ad.instance.hideAsync after show banner ad failed",i)}t.emit(p.Events.AD_FAILED,{type:ee.BANNER,placementId:e.placementId,error:n})}}async showBannerAdWithSchedule(e){await this.showBannerAdOnce(e);const t=this.getBannerConfig(e.placementId),{SecondsReload:a}=t;if(a<=0){console.warn("Banner ad reload time is less than 0");return}const n=c(()=>this.showBannerAdWithSchedule(e),"cb");e.interval=setTimeout(n,a*1e3)}async hideBannerAdAsync(e){this.checkEnabled();const t=this.getAd(ee.BANNER,e);this.cleanBannerReloadTimer(t),await t.instance.hideAsync();const{event:a}=this.game;a.emit(p.Events.AD_CLOSED,{type:ee.BANNER,placementId:e})}cleanBannerReloadTimer(e){try{const{interval:t}=e;if(!t)return;clearInterval(t)}catch(t){console.warn("Error while cleaning banner reload timer",t)}}getCommonAdConfig(e){const t=[...this.config.InterstitialAdOptions,...this.config.RewardedVideoAdOptions,...this.config.RewardedInterstitialAdOptions],a=pt.search(t,n=>n.PlacementId===e);if(!a)throw new Error(`Ad config with placementId ${e} not found`);return a}getBannerConfig(e){const t=pt.search(this.config.BannerDisplayAdOptions,a=>a.PlacementId===e);if(!t)throw new Error(`Banner config with placementId ${e} not found`);return t}getBannerHeight(e,t,a=!0){this.checkEnabled();const n=this.getBannerConfig(e),i=GameSDK.getBannerHeight(n);return a?(this.safeAreaBottom<=0&&this.calculateSafeAreaBottom(),(i+this.safeAreaBottom)*t):i*t}getSafeAreaBottom(e){return this.safeAreaBottom<=0&&this.calculateSafeAreaBottom(),this.safeAreaBottom*e}resetDegradationTracking(){this.degradationTracking={failedAttempts:0,lastSuccessTime:Date.now()}}isServiceDegraded(){const e=Date.now(),{MaxFailedAttempts:t,ResetTimeMinutes:a}=this.config.DegradationTracking,{lastSuccessTime:n,failedAttempts:i}=this.degradationTracking;return e-n>a*60*1e3&&this.resetDegradationTracking(),i>=t}};c(dn,"AdsPlugin");let cs=dn;const m={APP_LAUNCH:"app_launch",APP_INITIALIZED:"app_initialized",ENGINE_READY:"engine_ready",LOAD_START:"load_start",LOAD_COMPLETE:"load_complete",APP_READY:"app_ready",PAGE_VIEW:"page_view",SCREEN_OPEN:"screen_open",BUTTON_CLICK:"button_click",TUTORIAL_BEGIN:"tutorial_begin",TUTORIAL_STEP:"tutorial_step",TUTORIAL_COMPLETE:"tutorial_complete",MATCH_START:"match_start",MATCH_RESCUE:"match_rescue",MATCH_END:"match_end",LEVEL_START:"level_start",LEVEL_RESCUE:"level_rescue",LEVEL_END:"level_end",USE_ITEM:"use_item",EARN_ITEM:"earn_item",GET_FREE_ITEM:"get_free_item",SHARE:"share",INVITE:"invite",MESSAGE:"message",SHORTCUT_CREATE:"shortcut_create",SHORTCUT_CREATE_POPUP:"shortcut_create_popup",BOT_SUBSCRIBE:"bot_subscribe",BOT_SUBSCRIBE_POPUP:"bot_subscribe_popup",AD_INIT:"ad_init",AD_LOAD:"ad_load",AD_LOAD_FAILED:"ad_load_failed",AD_SHOWING:"ad_showing",AD_SHOW:"ad_show",AD_SHOW_FAILED:"ad_show_failed",AD_REWARD:"ad_reward",NEW_USER:"new_user",RETURNING_USER:"returning_user",JOIN_GROUP:"join_group",TOURNAMENT_START:"tournament_start",TOURNAMENT_SHARE:"tournament_share",TOURNAMENT_CREATE:"tournament_create",TOURNAMENT_POST_SCORE:"tournament_post_score",SWITCH_GAME_POPUP:"switch_game_popup",SWITCH_GAME:"switch_game"},hn=class hn{constructor(){h(this,"history",[]);h(this,"missing",[]);h(this,"outOfOrder",[]);h(this,"completed",!1);h(this,"failed",!1);h(this,"warned",[]);h(this,"debug",!1)}addEvent(s,e){if(this.completed||this.failed){this.debugLog("Skip event:",s);return}this.history.push(s),this.validateAndUpdate(s)}validateAndUpdate(s){const e=this.validateFunnelState();if(e.hasFailed){this.failed=!0,this.logValidationError();return}e.hasWarnings&&this.handleWarnings(e.warnings),this.checkFunnelCompletion(s)}validateFunnelState(){const s={hasFailed:!1,hasWarnings:!1,warnings:[]},t=this.getCurrentSteps().filter(n=>n.required);for(let n=0;n<t.length;n++){const i=t[n],r=this.history.indexOf(i.name);if(r===-1)return this.missing=[i.name],s.hasFailed=!0,s;if(n>0){const o=t[n-1];if(this.history.indexOf(o.name)>r)return this.missing=[o.name],s.hasFailed=!0,s}}const a=this.validateDependencies();return a.length>0&&(s.hasWarnings=!0,s.warnings=a,this.outOfOrder=a),s}getCurrentSteps(){const s=this.history[this.history.length-1],e=this.funnelSteps.findIndex(t=>t.name===s);return this.funnelSteps.slice(0,e+1)}validateDependencies(){const s=[];return this.history.forEach((e,t)=>{var i;const a=this.funnelSteps.find(r=>r.name===e);if(!((i=a==null?void 0:a.dependencies)!=null&&i.length))return;const n=a.dependencies.find(r=>!this.history.includes(r)||this.history.indexOf(r)>t);n&&!this.warned.includes(e)&&(s.push({event:e,missingDependency:n}),this.warned.push(e))}),s}checkFunnelCompletion(s){const e=this.funnelSteps[this.funnelSteps.length-1];if(s!==e.name)return;this.funnelSteps.filter(a=>a.required).every(a=>this.history.includes(a.name))&&(this.completed=!0,this.logCompletion())}handleWarnings(s){for(const e of s)console.warn(`⚠️ [${this.constructor.name}] Event ${e.event} is out of order. Missing: ${e.missingDependency}`)}logValidationError(){const s=this.constructor.name;this.missing.length&&console.error(`⚠️ [${s}] Missing required: ${this.missing.join(", ")}`),console.debug(`ℹ️ [${s}] History:`,this.history)}logCompletion(){const s=this.constructor.name;this.outOfOrder.length>0?console.warn(`⚠️ [${s}] Completed with out of order events:`,{history:this.history,outOfOrder:this.outOfOrder}):console.info(`🎯 [${s}] Completed`,{history:this.history})}debugLog(...s){this.debug&&console.debug(`🔍 [${this.constructor.name}]`,...s)}isFunnelCompleted(){return this.completed}isFunnelFailed(){return this.failed}getEventHistory(){return[...this.history]}getMissingEvents(){return[...this.missing]}getOutOfOrderEvents(){return[...this.outOfOrder]}};c(hn,"BaseFunnel");let Le=hn;const un=class un extends Le{constructor(){super(...arguments);h(this,"debug",!1);h(this,"funnelSteps",[{name:m.AD_INIT,required:!0,payload:{service:"adsense"},description:"Init adsense ad"},{name:m.AD_LOAD_FAILED,required:!1,payload:{service:this.service},description:"Platform ad load failed (trigger for adsense)"},{name:m.AD_LOAD,required:!0,payload:{service:"adsense"},description:"Start loading adsense ad"},{name:m.AD_LOAD_FAILED,required:!1,dependencies:[m.AD_LOAD],payload:{service:"adsense"},description:"Adsense ad load failed"},{name:m.AD_SHOWING,required:!0,dependencies:[m.AD_LOAD],payload:{service:"adsense"},description:"Adsense ad is showing"},{name:m.AD_SHOW,required:!1,dependencies:[m.AD_SHOWING],payload:{service:"adsense"},description:"Adsense ad shown successfully"},{name:m.AD_SHOW_FAILED,required:!1,dependencies:[m.AD_SHOWING],payload:{service:"adsense"},description:"Adsense ad show failed"},{name:m.AD_LOAD,required:!1,payload:{service:"adsense"},description:"Preload adsense ad"}])}get service(){return(GameSDK==null?void 0:GameSDK.getSDKName())??"GameCore"}addEvent(e,t){((t==null?void 0:t.service)==="adsense"||e===m.AD_LOAD_FAILED&&(t==null?void 0:t.service)==="platform")&&super.addEvent(e,t)}};c(un,"AdsenseFunnel");let ls=un;const pn=class pn extends Le{constructor(){super(...arguments);h(this,"debug",!1);h(this,"funnelSteps",[{name:m.APP_LAUNCH,required:!0,description:"Application launched"},{name:m.APP_INITIALIZED,required:!0,dependencies:[m.APP_LAUNCH],description:"Application initialized"},{name:m.ENGINE_READY,required:!0,dependencies:[m.APP_INITIALIZED],description:"Game engine initialized"},{name:m.LOAD_START,required:!0,dependencies:[m.ENGINE_READY],description:"Start loading game assets"},{name:m.LOAD_COMPLETE,required:!0,dependencies:[m.LOAD_START],description:"Game assets loaded completely"},{name:m.APP_READY,required:!0,dependencies:[m.LOAD_COMPLETE],description:"Game is ready to play"}])}};c(pn,"CorecosFunnel");let ds=pn;const yn=class yn extends Le{constructor(){super(...arguments);h(this,"debug",!1);h(this,"funnelSteps",[{name:m.AD_INIT,required:!0,payload:{service:this.service},description:"Init platform ad"},{name:m.AD_LOAD,required:!0,payload:{service:this.service},description:"Start loading platform ad"},{name:m.AD_LOAD_FAILED,required:!1,dependencies:[m.AD_LOAD],payload:{service:this.service},description:"Platform ad load failed"},{name:m.AD_SHOWING,required:!0,dependencies:[m.AD_LOAD],payload:{service:this.service},description:"Platform ad is showing"},{name:m.AD_SHOW,required:!1,dependencies:[m.AD_SHOWING],payload:{service:this.service},description:"Platform ad shown successfully"},{name:m.AD_SHOW_FAILED,required:!1,dependencies:[m.AD_SHOWING],payload:{service:this.service},description:"Platform ad show failed"},{name:m.AD_LOAD,required:!1,payload:{service:this.service},description:"Preload platform ad"}])}get service(){return(GameSDK==null?void 0:GameSDK.getSDKName())??"GameCore"}addEvent(e,t){(t==null?void 0:t.service)===this.service&&super.addEvent(e,t)}};c(yn,"PlatformAdsFunnel");let hs=yn;const{Utils:{String:ge,Valid:lc}}=p;let dc=(Be=class{constructor(s,e,t){h(this,"game");h(this,"name");h(this,"color");h(this,"options");h(this,"selfLog");h(this,"currentPath");this.game=s,this.name=e,this.options=t,this.color=t.color||"#FFF",this.selfLog=t.log,this.currentPath="/",console.info(`%c${this.name}: init`,`color: ${this.color}`,this.options)}event(s,e){this.logInfo("event",{name:s,payload:e});const t=this.formatEventName(s);this.processEvent(t,e)}logInfo(s,e){this.selfLog&&console.info(`%c${this.name}: ${s}`,`color: ${this.color}`,e)}pageview(s){let e=this.getPageTitle(s);e=this.addGameModeToPageTitle(e),document.title=e,this.event(m.PAGE_VIEW,{path_path:s,page_title:e})}levelStart(s,e,t){this.event(m.LEVEL_START,{level:s,score:e,level_name:this.getLevelName(s),game_mode:t?ge.toUpperCamelCase(t):void 0})}levelFail(s,e,t){this.event(m.LEVEL_END,{level:s,score:e,success:!1,level_name:this.getLevelName(s),game_mode:t?ge.toUpperCamelCase(t):void 0})}levelRescue(s,e,t){this.event(m.LEVEL_RESCUE,{level:s,score:e,level_name:this.getLevelName(s),game_mode:t?ge.toUpperCamelCase(t):void 0})}levelComplete(s,e,t){this.event(m.LEVEL_END,{level:s,score:e,success:!0,level_name:this.getLevelName(s),game_mode:t?ge.toUpperCamelCase(t):void 0})}initAdEvent(s){const{adService:e,state:t}=s;this.event(m.AD_INIT,{ad_service:e,state:t})}loadAdEvent(s){const{type:e,placement:t,service:a}=s;this.event(m.AD_LOAD,{ad_type:e,screen_name:t,ad_service:a})}showAdEvent(s){const{type:e,placement:t,service:a}=s;this.event(m.AD_SHOW,{ad_type:e,screen_name:t,ad_service:a})}loadInterstitialAd(s){const{placement:e,service:t}=s;this.loadAdEvent({type:"interstitial",placement:e,service:t})}showInterstitialAd(s){const{placement:e,service:t}=s;this.showAdEvent({type:"interstitial",placement:e,service:t})}loadRewardedVideoAd(s){const{placement:e,service:t}=s;this.loadAdEvent({type:"rewarded_video",placement:e,service:t})}showRewardedVideoAd(s){const{placement:e,service:t}=s;this.showAdEvent({type:"rewarded_video",placement:e,service:t})}receiveVideoReward(s){const{placement:e,service:t}=s;this.event(m.AD_REWARD,{screen_name:e,ad_service:t})}loadRewardedInterstitialAd(s){const{placement:e,service:t}=s;this.loadAdEvent({type:"rewarded_interstitial",placement:e,service:t})}showRewardedInterstitialAd(s){const{placement:e,service:t}=s;this.showAdEvent({type:"rewarded_interstitial",placement:e,service:t})}receiveInterstitialReward(s){const{placement:e,service:t}=s;this.event(m.AD_REWARD,{screen_name:e,ad_service:t})}loadAdFail(s){const{type:e,placement:t,service:a}=s;this.event(m.AD_LOAD_FAILED,{ad_type:e,screen_name:t,ad_service:a})}showAdFail(s){const{type:e,placement:t,service:a}=s;this.event(m.AD_SHOW_FAILED,{ad_type:e,screen_name:t,ad_service:a})}showingAd(s){const{type:e,placement:t,service:a}=s;this.event(m.AD_SHOWING,{ad_type:e,screen_name:t,ad_service:a})}formatEventName(s){return s.toLowerCase().replace(/:/g,"_")}getLevelName(s){return`Level ${ge.padStart(s.toString(),5,"0")}`}getPageTitle(s){const e=s.split("/").pop();if(!lc.isString(e))return s;const t=e.replace(/([-_\s.])/g," $1");return ge.toUpperCamelCase(t)}addGameModeToPageTitle(s){const{match:e}=this.game,t=e.getMatchState();let{mode:a}=t;return a||(a="Normal"),`${ge.toUpperCamelCase(a)}::${s}`}},c(Be,"BaseAnalytics"),Be);p.Plugins.Analytics={Events:m,BaseFunnel:Le,BaseAnalytics:dc};const fn=class fn extends O.Plugins.BasePlugin{constructor(e){super(e);h(this,"analytics",[]);h(this,"placement","unknown");h(this,"funnels",[]);h(this,"pageview",c(e=>{if(!this.isActive())return;this.placement=e;const t=this.getPageByKey(e);for(const a of this.analytics)a.pageview(t);this.logFunnelEvent(m.PAGE_VIEW)},"pageview"));this.initFunnels()}add(e){const t=this.analytics.findIndex(a=>a.name===e.name);t!==-1?this.analytics[t]=e:this.analytics.push(e)}isActive(){return this.analytics.length>=1}initFunnels(){this.addFunnel(new ds),this.addFunnel(new ls),this.addFunnel(new hs)}addFunnel(e){this.funnels.push(e)}logFunnelEvent(e,t){for(const a of this.funnels)a.addEvent(e,t)}event(e,t){if(this.isActive()){for(const a of this.analytics)a.event(e,t);this.logFunnelEvent(e,t)}}levelStart(e,t,a){if(this.isActive()){for(const n of this.analytics)n.levelStart(e,t,a);this.logFunnelEvent(m.LEVEL_START,{score:t,mode:a})}}levelRescue(e,t,a){if(this.isActive()){for(const n of this.analytics)n.levelRescue(e,t,a);this.logFunnelEvent(m.LEVEL_RESCUE,{score:t,mode:a})}}levelFail(e,t,a){if(this.isActive()){for(const n of this.analytics)n.levelFail(e,t,a);this.logFunnelEvent(m.LEVEL_END,{score:t,mode:a})}}levelComplete(e,t,a){if(this.isActive()){for(const n of this.analytics)n.levelComplete(e,t,a);this.logFunnelEvent(m.LEVEL_END,{score:t,mode:a})}}async initAdEvent(e){if(this.isActive()){await this.game.event.waitTo(m.APP_READY);for(const t of this.analytics)t.initAdEvent(e)}}loadInterstitialAd(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.loadInterstitialAd(t);this.logFunnelEvent(m.AD_LOAD,t)}showInterstitialAd(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.showInterstitialAd(t);this.logFunnelEvent(m.AD_SHOW,t)}loadRewardedVideoAd(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.loadRewardedVideoAd(t);this.logFunnelEvent(m.AD_LOAD,t)}showRewardedVideoAd(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.showRewardedVideoAd(t);this.logFunnelEvent(m.AD_SHOW,t)}receiveVideoReward(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.receiveVideoReward(t);this.logFunnelEvent(m.AD_REWARD,t)}loadRewardedInterstitialAd(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.loadRewardedInterstitialAd(t);this.logFunnelEvent(m.AD_LOAD,t)}showRewardedInterstitialAd(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.showRewardedInterstitialAd(t);this.logFunnelEvent(m.AD_SHOW,t)}receiveInterstitialReward(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.receiveInterstitialReward(t);this.logFunnelEvent(m.AD_REWARD,t)}loadAdFail(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.loadAdFail(t);this.logFunnelEvent(m.AD_LOAD_FAILED,t)}showAdFail(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.showAdFail(t);this.logFunnelEvent(m.AD_SHOW_FAILED,t)}showingAd(e){if(!this.isActive())return;const t={...e,placement:this.placement};for(const a of this.analytics)a.showingAd(t);this.logFunnelEvent(m.AD_SHOWING,t)}getPageByKey(e){let t=e;if(t.indexOf("_")>-1){let i=t.replace(/_/g,"-");return i=i.toLowerCase(),i}let a=t.length-1,n="";for(;a>0;){n=t.charAt(a);const i=isNaN(parseInt(n,10)),r=n===n.toUpperCase();i&&r&&(t=`${t.slice(0,a)}-${t.slice(a)}`),a--}return t.toLowerCase()}};c(fn,"AnalyticsPlugin");let us=fn;const gn=class gn{constructor(s){h(this,"key");this.key=s}getKey(){return this.key}};c(gn,"BaseAudioPlayer");let ps=gn;var hc=Object.defineProperty,uc=Object.getOwnPropertyDescriptor,pc=c((y,s,e,t)=>{for(var a=t>1?void 0:t?uc(s,e):s,n=y.length-1,i;n>=0;n--)(i=y[n])&&(a=(t?i(s,e,a):i(a))||a);return t&&a&&hc(s,e,a),a},"__decorateClass$2");const{Decorator:Xr}=p.Utils,mn=class mn{constructor(s){h(this,"id");h(this,"isMuteAll");h(this,"masterVolume");h(this,"audioClips");this.id=s,this.masterVolume=1,this.isMuteAll=!1,this.audioClips={}}getId(){return this.id}getAudioClip(s){return this.audioClips[s]?this.audioClips[s]:null}setAudioClip(s,e){this.audioClips[s]={...this.audioClips[s],...e}}async play(s,e){const t=this.getAudioClip(s);if(t){const{audioPlayer:a}=t;this.playWithRealConfig(a,e)}else await this.loadAndPlay(s,e)}async loadAndPlay(s,e){const t=await this.onLoadAudio(s,e);if(!t)return;const{volume:a=1}=e||{};this.setAudioClip(s,{volume:a,audioPlayer:t}),this.playWithRealConfig(t,e)}playWithRealConfig(s,e){if(e){const{volume:t=1}=e;e.volume=this.masterVolume*t}s.play(e)}pause(s){const e=this.getAudioClip(s);if(!e)return!1;const{audioPlayer:t}=e;return t.pause(),!0}resume(s){const e=this.getAudioClip(s);if(!e)return!1;const{audioPlayer:t}=e;return t.resume(),!0}stop(s){const e=this.getAudioClip(s);if(!e)return!1;const{audioPlayer:t}=e;return t.stop(),!0}stopAll(){this.callAudioPlayers("stop")}muteAll(){this.isMuteAll||(this.isMuteAll=!0,this.callAudioPlayers("mute"))}unmuteAll(){this.isMuteAll&&(this.isMuteAll=!1,this.callAudioPlayers("unmute"))}setVolume(s){this.masterVolume=s,this.callAudioPlayers("setVolume")}getVolume(){return this.masterVolume}queueAudioPlayer(s,e){try{const{audioPlayer:t,volume:a=1}=s;switch(e){case"play":t.play();break;case"pause":t.pause();break;case"resume":t.resume();break;case"stop":t.stop();break;case"mute":t.setVolume(0);break;case"unmute":case"setVolume":t.setVolume(this.masterVolume*a);break;default:throw new Error(`Unsupported function: ${e}`)}}catch(t){console.warn("queueAudioPlayer",t)}}callAudioPlayers(s){const{Object:e}=p.Utils,t=e.vals(this.audioClips);for(const a of t)this.queueAudioPlayer(a,s)}};c(mn,"BaseChannelManager");let yt=mn;pc([Xr.tryCatch(),Xr.validateParams("string")],yt.prototype,"loadAndPlay",1);var yc=Object.defineProperty,fc=Object.getOwnPropertyDescriptor,gc=c((y,s,e,t)=>{for(var a=t>1?void 0:t?fc(s,e):s,n=y.length-1,i;n>=0;n--)(i=y[n])&&(a=(t?i(s,e,a):i(a))||a);return t&&a&&yc(s,e,a),a},"__decorateClass$1");p.Plugins.Audio={BaseAudioPlayer:ps,BaseChannelManager:yt};const{Decorator:Jr}=p.Utils,wn=class wn extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"firstChannelId");h(this,"channels",{})}addChannel(e){const t=e.getId();this.channels[t]=e,this.firstChannelId||(this.firstChannelId=t)}getChannel(e){if(e===void 0)return this.channels[this.firstChannelId];const t=this.channels[e];if(!t)throw new Error(`Channel ${e} not found`);return t}async play(e,t,a){await this.getChannel(a).play(e,t)}pause(e,t){try{this.getChannel(t).pause(e)}catch(a){console.warn("pauseSound",a)}}resume(e,t){try{this.getChannel(t).resume(e)}catch(a){console.warn("resumeSound",a)}}stop(e,t){try{this.getChannel(t).stop(e)}catch(a){console.warn("stopSound",a)}}stopAll(e){try{this.getChannel(e).stopAll()}catch(t){console.warn("stopAllSounds",t)}}mute(e){try{this.getChannel(e).muteAll()}catch(t){console.warn("mute",t)}}unmute(e){try{this.getChannel(e).unmuteAll()}catch(t){console.warn("unmute",t)}}setVolume(e,t){try{this.getChannel(t).setVolume(e)}catch(a){console.warn("setSoundVolume",a)}}getVolume(e){try{return this.getChannel(e).getVolume()}catch(t){return console.warn("getSoundVolume",t),-1}}};c(wn,"AudioPlugin");let ft=wn;gc([Jr.tryCatch(),Jr.validateParams("string")],ft.prototype,"play",1);const mc={token:"",isRequesting:!1},{Utils:{Object:wc}}=p,An=class An extends O.Plugins.BasePlugin{init(){const{storage:s}=this.game;s.addStorage("auth",mc)}async requestToken(){const{storage:s}=this.game;try{if(s.getStorageData("auth","isRequesting")||s.getStorageData("auth","token")!=="")return;s.setStorageData("auth","isRequesting",!0);const n=(await GameSDK.player.getSignedPlayerInfoAsync()).getSignature();s.setStorageData("auth","token",n)}catch(e){if(wc.hasOwn(e,"code")&&e.code==="PENDING_REQUEST")return;s.setStorageData("auth","token",""),console.error(e)}finally{s.setStorageData("auth","isRequesting",!1)}}getToken(){const{storage:s}=this.game;return s.getStorageData("auth","token")??""}};c(An,"AuthPlugin");let ys=An;var Zr=(y=>(y.SOLO="solo",y.TOURNAMENT="tournament",y.SHARE_INVITE="share_invite",y.MATCHING_GROUP="matching_group_match",y.CHALLENGE_FRIEND="challenge_friend_match",y))(Zr||{});const me=Zr,we=Vr,{Configs:Ac,Utils:{Array:Dc,Valid:Ic,Browser:vc}}=p,Dn=class Dn{constructor(s){h(this,"game");this.game=s}isValidContextType(s){return["THREAD","POST","SOLO","GROUP"].indexOf(s)>=0}isValidEntryPointData(s){return Ic.isObject(s)}isTournamentEntryPoint(s){return Dc.has(["facebook~game_list~tournaments","fb_feed_tournament_unit","messenger~bot_thread~tournaments"],s)}receiveContext(s,e,t){const{storage:a}=this.game;a.setStorageData("context","contextId",s),this.isValidEntryPointData(t)?a.setStorageData("context","entryPointData",t):console.warn(`Invalid context type: ${e}`),this.isValidContextType(e)?a.setStorageData("context","contextType",e):console.warn(`Invalid context type: ${e}`)}async detectContextSessionType(){const{storage:s}=this.game,e=s.getStorageData("context","entryPointData"),{type:t}=e??{},{SOLO:a,TOURNAMENT:n,MATCHING_GROUP:i,SHARE_INVITE:r,CHALLENGE_FRIEND:o}=me;let l=a;t===n&&(l=n),t===i&&(l=i),(t===o||t===r)&&(l=o),l===a&&(Ac.Core.FastCheckTournamentContext?l=this.fastCheckTournamentContext()||l:l=await this.outdatedCheckTournamentContext()||l),s.setStorageData("context","sessionContextType",l)}fastCheckTournamentContext(){const e=vc.getQueryParams().entry_point;return typeof e!="string"||!this.isTournamentEntryPoint(e)?!1:me.TOURNAMENT}async outdatedCheckTournamentContext(){const{storage:s}=this.game;if(!("getTournamentAsync"in GameSDK))return!1;try{const e=await GameSDK.getTournamentAsync();return s.setStorageData("context","contextId",e.getContextID()),e.getEndTime()>Date.now()/1e3?me.TOURNAMENT:!1}catch(e){return console.warn("outdatedCheckTournamentContext",e),!1}}detectContextGameMode(){const{player:s,storage:e}=this.game,t=e.getStorageData("context","entryPointData"),a=e.getStorageData("context","sessionContextType"),n=s.getPlayerId(),{matchId:i,playerId:r,opponentId:o=ae.playerId}=t??{},l=n===r,u=o===ae.playerId||[o,r].indexOf(n)>=0,{TOURNAMENT:f,MATCHING_GROUP:w,SHARE_INVITE:g,CHALLENGE_FRIEND:I}=me;let A=we.SINGLE;a===f&&(A=we.TOURNAMENT),a===g&&!l&&(A=we.CHALLENGE_FRIEND),a===I&&i&&u&&(A=we.CHALLENGE_FRIEND),a===w&&(A=we.MATCHING_GROUP),e.setStorageData("context","contextGameMode",A)}};c(Dn,"Context");let fs=Dn;const In=class In extends Error{constructor(s){super(s),this.name="PlayerHasFinishedMatch",this.message=s??"Player has finished match"}};c(In,"PlayerHasFinishedMatch");let gt=In;const vn=class vn extends Error{constructor(s){super(s),this.name="PlayerNotJoinInMatch",this.message=s||"Player is not join in match"}};c(vn,"PlayerNotJoinInMatch");let ze=vn;const{Events:mt,Plugins:{Analytics:eo},Utils:{Valid:Pc}}=p,Pn=class Pn{constructor(s){h(this,"game");this.game=s}async processContextData(){const{player:s,storage:e,monitorError:t}=this.game,a=e.getStorageData("context","contextId")??"",n=e.getStorageData("context","entryPointData")??{},i=e.getStorageData("context","sessionContextType")??"",{type:r,matchId:o,playerId:l,opponentId:d,playerScore:u,action:f}=n;f&&await this.processEntryPointAction(f);const w=s.isFirstSession();setTimeout(()=>{this.logUserAnalytics(w)},1e3);const{TOURNAMENT:g,SHARE_INVITE:I,MATCHING_GROUP:A,CHALLENGE_FRIEND:R}=me;if(i===g)try{await this.processTournamentModeAsync(a);return}catch{t==null||t.sendException(new Error("Process Tournament Fail"),{contextId:a,isFirstSession:w,entryPointData:n,playerData:s.getPlayerData()})}if(i===R){if(r===I&&typeof l=="string"){await this.processChallengeFromPostAsync(l);return}if(r===R&&typeof o=="string"&&typeof l=="string"&&typeof d=="string"){await this.processChallengeFromMessageAsync({contextId:a,matchId:o,playerId:l,opponentId:d});return}}if(i===A&&typeof l=="string"&&typeof u=="number"){await this.processMatchingGroupModeAsync(l,u);return}if(w){await this.processSingleModeAsync(!0),s.loggedIn();return}this.switchToDashboardScene()}logUserAnalytics(s){try{const{player:e,analytics:t}=this.game;if(s)t.event(eo.Events.NEW_USER);else{const{coins:a}=e.getPlayerData().gameData;t.event(eo.Events.RETURNING_USER,{coins:a})}}catch{}}async processEntryPointAction(s){try{const{player:e}=this.game;switch(s){case"reset_data":e.setPlayerDataByName("score",0),e.setPlayerDataByName("endlessScore",0),e.setGameData({coins:0,level:1}),await e.syncProfileToServer();break;case"enable_debug":e.setPlayerDataByName("debug",!0);break;case"set_locale_en":this.requestSetLocale("en");break;case"set_locale_ru":this.requestSetLocale("ru");break}}catch(e){console.warn("processEntryPointAction",e)}}requestSetLocale(s){const{event:e}=this.game;e.emit(mt.REQUEST_LANGUAGE,{locale:s})}async processTournamentModeAsync(s){const{match:e,player:t}=this.game,a=t.getPlayerId();if(Pc.isEmpty(s))throw new Error("Cannot get contextId");await e.tournament.continue.processAsync({playerId:a,contextId:s}),this.switchToGameScene()}async processChallengeFromPostAsync(s){const{match:e,player:t}=this.game,a=t.getPlayerId();if(a===s)await e.single.start.processAsync({playerId:a});else try{await e.challenge.friend.processAsync({playerId:a,opponentId:s})}catch(i){console.warn("processChallengeFromPostAsync",i),await e.single.start.processAsync({playerId:a})}this.switchToGameScene()}async processChallengeFromMessageAsync(s){try{await this.processContinueChallengeFromMessageAsync(s)}catch(e){if(console.warn("processContinueChallengeFromMessageAsync",e),e instanceof gt){await this.processAwaitChallengeFromMessageAsync(s);return}if(e instanceof ze){await this.processJoinChallengeFromMessageAsync(s);return}this.switchToDashboardScene()}}async processContinueChallengeFromMessageAsync(s){const{contextId:e,matchId:t,playerId:a,opponentId:n}=s,{match:i,player:r}=this.game,o=r.getPlayerId();if(a===o)await i.challenge.continue.processAsync({contextId:e,matchId:t,playerId:o,opponentId:n});else{const d=n===ae.playerId;await i.challenge.continue.processAsync({contextId:e,matchId:t,playerId:o,opponentId:d?n:a})}this.switchToGameScene()}async processJoinChallengeFromMessageAsync(s){const{contextId:e,matchId:t,playerId:a}=s,{match:n,player:i}=this.game,r=i.getPlayerId();await n.challenge.join.processAsync({contextId:e,matchId:t,playerId:r,opponentId:a}),this.switchToGameScene()}async processAwaitChallengeFromMessageAsync(s){const{contextId:e,matchId:t,playerId:a}=s,{match:n,player:i}=this.game,r=i.getPlayerId();try{await n.challenge.await.processAsync({contextId:e,matchId:t,playerId:r,opponentId:a}),this.switchToChallengeResultScene()}catch(o){console.warn("processAwaitChallengeFromMessageAsync",o),await this.processResultChallengeFromMessageAsync(s)}}async processResultChallengeFromMessageAsync(s){const{contextId:e,matchId:t,playerId:a}=s,{match:n,player:i}=this.game,r=i.getPlayerId();try{await n.challenge.result.processAsync({contextId:e,matchId:t,playerId:r,opponentId:a}),this.switchToChallengeResultScene()}catch{this.switchToDashboardScene()}}async processMatchingGroupModeAsync(s,e){const{match:t,player:a}=this.game;await t.group.join.processAsync({playerId:a.getPlayerId(),opponentId:s,opponentScore:e}),this.switchToGameScene()}async processSingleModeAsync(s){const{match:e,player:t}=this.game,a=t.getPlayerId();s&&await e.handler.setMatchCustomData({level:0}),await e.single.start.processAsync({playerId:a}),this.switchToGameScene()}switchToDashboardScene(){const{event:s}=this.game;s.emit(mt.SWITCH_SCENE,{sceneName:"DashboardScene",sceneData:{isFromLoader:!0}})}switchToGameScene(){const{event:s}=this.game;s.emit(mt.SWITCH_SCENE,{sceneName:"GameScene",sceneData:{isFromLoader:!0}})}switchToChallengeResultScene(){const{event:s}=this.game;s.emit(mt.SWITCH_SCENE,{sceneName:"ChallengeResultScene",sceneData:{isFromLoader:!0}})}};c(Pn,"Loader");let gs=Pn;const to={processed:!1,contextId:"",contextType:"SOLO",entryPointData:{},contextGameMode:"",sessionContextType:""},{Events:qe}=p,En=class En extends O.Plugins.BasePlugin{constructor(e){super(e);h(this,"context");h(this,"loader");this.loader=new gs(e),this.context=new fs(e)}init(){const{storage:e}=this.game;e.addStorage("context",to)}getSessionContextTypes(){return me}async processContextData(){const{event:e,monitorError:t}=this.game;try{e.getEventEmitCount(qe.CONTEXT_SESSION_TYPE_DETECTED)>0||await e.waitTo(qe.CONTEXT_SESSION_TYPE_DETECTED,3e3),await this.loader.processContextData(),e.emit(qe.CONTEXT_DATA_PROCESSED)}catch(a){if(console.debug("processContextData",a),this.switchToDashboardScene(),t){const n=a instanceof Error?a:new Error(JSON.stringify(a));t.sendException(n)}}}async detectContextSessionType(){const{event:e,monitorError:t}=this.game;try{await this.context.detectContextSessionType(),e.emit(qe.CONTEXT_SESSION_TYPE_DETECTED)}catch(a){if(console.debug("detectContextSessionType",a),t){const n=a instanceof Error?a:new Error(JSON.stringify(a));t.sendException(n)}}}detectContextGameMode(){this.context.detectContextGameMode()}receiveContext(e,t,a){this.context.receiveContext(e,t,a)}switchToDashboardScene(){const{event:e}=this.game;e.emit(qe.SWITCH_SCENE,{sceneName:"DashboardScene"})}};c(En,"ContextPlugin");let ms=En;const{Valid:ws}=p.Utils,{contextId:Ec,contextType:Sc,entryPointData:xc}=to,As="is invalid",Sn=class Sn extends U{constructor(){super(...arguments);h(this,"data")}setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateContextId(e){ws.isString(e)||this.exception("contextId",As)}validateContextType(e){(!ws.isString(e)||!e)&&this.exception("contextType",As)}validateEntryPointData(e){ws.isObject(e)||this.exception("entryPointData",As)}toObject(){return super.toObject()}};c(Sn,"ContextInfoDtos");let wt=Sn;wt.addDefaultData({contextId:Ec,contextType:Sc,entryPointData:xc}),p.Dtos.Context={Info:wt};const bc={0:{id:1,type:"coin",value:300},1:{id:2,type:"coin",value:500},2:{id:3,type:"coin",value:1e3},3:{id:4,type:"coin",value:2e3},4:{id:5,type:"coin",value:3e3},5:{id:6,type:"coin",value:5e3},6:{id:7,type:"coin",value:1e3}},{Object:Cc}=p.Utils,xn=class xn{async getDailyRewardsAsync(){return Cc.vals(bc)}};c(xn,"DailyRewardsAPI");let Ds=xn;const W={REWARDED:"rewarded",SKIPPED:"skipped",READY:"ready",WAITING:"waiting"},Tc={dailyRewards:{}},{Configs:{DailyRewards:{CheckInterrupt:so,MaxDays:ao,MockTime:no}},Utils:{Array:Is,Valid:At}}=p,Dt=no>0?no:864e5,bn=class bn extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"dailyRewardsApi",new Ds)}init(){const{storage:e}=this.game;e.addStorage("dailyRewards",Tc)}async requestDailyRewardsAsync(){const e=await this.dailyRewardsApi.getDailyRewardsAsync(),{logs:t,rewards:a}=this.parseDailyRewards(e);this.setRewardsLog(t),this.setDailyRewards(a)}getDailyRewards(){const{storage:e}=this.game,t=e.getStorageData("dailyRewards","dailyRewards");return t||null}logLoginReward(){so?this.logFromFirstReward():this.logFromLastReward()}logFromFirstReward(){const{player:e}=this.game,{logDays:t,firstReward:a}=e.getPlayerData().dailyRewarded,n=new Date,i=[...t];if(a===0){i[0]=!0,At.isDebugger()||n.setHours(0,0,0,0),this.setRewardsLog({logDays:i,firstReward:n.valueOf(),lastReward:n.valueOf()});return}const r=n.valueOf()-a,o=Math.floor(r/Dt);o>=ao||o>=t.length||(i[o]=!0,At.isDebugger()||n.setHours(0,0,0,0),this.setRewardsLog({logDays:i,lastReward:n.valueOf()}))}logFromLastReward(){const{player:e}=this.game,{logDays:t,lastReward:a}=e.getPlayerData().dailyRewarded,n=new Date,i=[...t];if(a===0){i[0]=!0,At.isDebugger()||n.setHours(0,0,0,0),this.setRewardsLog({logDays:i,firstReward:n.valueOf(),lastReward:n.valueOf()});return}const r=n.valueOf()-a;if(Math.floor(r/Dt)<1)return;const l=Is.searchIndex(i,d=>d===!1);l!==void 0&&(i[l]=!0,At.isDebugger()||n.setHours(0,0,0,0),this.setRewardsLog({logDays:i,lastReward:n.valueOf()}))}setRewardsLog(e){const{logDays:t,firstReward:a,lastReward:n}=e,{player:i}=this.game,r=i.getPlayerData().dailyRewarded;this.isSameLog(r,e)||i.setPlayerDataByName("dailyRewarded",{logDays:t!==void 0?[...t]:[...r.logDays],firstReward:a??r.firstReward,lastReward:n??r.lastReward})}isSameLog(e,t){if(t.firstReward!==void 0&&e.firstReward!==t.firstReward||t.lastReward!==void 0&&e.lastReward!==t.lastReward)return!1;if(t.logDays!==void 0){if(e.logDays.length!==t.logDays.length)return!1;for(let a=0;a<t.logDays.length;a++)if(e.logDays[a]!==t.logDays[a])return!1}return!0}parseDailyRewards(e){const{player:t}=this.game,{logDays:a,firstReward:n,lastReward:i}=t.getPlayerData().dailyRewarded;if(a===void 0||n===void 0||n===0||i===void 0||i===0||a.length!==e.length){const r=this.getDefaultDailyRewards(e);return{logs:{logDays:r.logDays,firstReward:0,lastReward:0},rewards:r.rewards}}return so?this.parseFromFirstReward(e,a,n,i):this.parseFromLastReward(e,a,n,i)}parseFromFirstReward(e,t,a,n){const r=Date.now()-a;if(r<0){const g=this.getDefaultDailyRewards(e);return{logs:{logDays:g.logDays,firstReward:0,lastReward:0},rewards:g.rewards}}const o=Math.floor(r/Dt),l=o>=ao||o>=t.length,d=Is.search(t.slice(0,o),g=>g===!1)!==void 0;if(l||d){const g=this.getDefaultDailyRewards(e);return{logs:{logDays:g.logDays,firstReward:0,lastReward:n},rewards:g.rewards}}const f=[],w={};for(let g=0;g<e.length;g++){const I=e[g],A=f.length>o,R=f.length===o,M=t[g];if(A){f.push(!1),w[I.id]={...I,status:W.WAITING};continue}if(f.push(M),R){w[I.id]={...I,status:M?W.REWARDED:W.READY};continue}w[I.id]={...I,status:M?W.REWARDED:W.SKIPPED}}return{logs:{logDays:f,firstReward:a,lastReward:n},rewards:w}}parseFromLastReward(e,t,a,n){const r=Date.now()-n;if(r<0){const g=this.getDefaultDailyRewards(e);return{logs:{logDays:g.logDays,firstReward:0,lastReward:0},rewards:g.rewards}}const l=Math.floor(r/Dt)>=1,d=Is.searchIndex(t,g=>g===!1);if(d===-1&&l){const g=this.getDefaultDailyRewards(e);return g.rewards[e[0].id].status=l?W.READY:W.WAITING,{logs:{logDays:g.logDays,firstReward:0,lastReward:n},rewards:g.rewards}}const f=[],w={};for(let g=0,I=e.length;g<I;g++){const A=e[g],R=d!==-1&&g>d,M=g===d;if(R){f.push(!1),w[A.id]={...A,status:W.WAITING};continue}if(M){f.push(!1),w[A.id]={...A,status:l?W.READY:W.WAITING};continue}f.push(!0),w[A.id]={...A,status:W.REWARDED}}return{logs:{logDays:f,firstReward:a,lastReward:n},rewards:w}}getDefaultDailyRewards(e){const t=[],a={};for(const n of e)t.push(!1),a[n.id]={...n,status:W.WAITING};return a[e[0].id].status=W.READY,{logDays:t,rewards:a}}setDailyRewards(e){const{storage:t}=this.game;t.setStorageData("dailyRewards","dailyRewards",e)}};c(bn,"DailyRewardsPlugin");let vs=bn;var Ps={exports:{}};Ps.exports,function(y){var s=Object.prototype.hasOwnProperty,e="~";function t(){}c(t,"Events"),Object.create&&(t.prototype=Object.create(null),new t().__proto__||(e=!1));function a(o,l,d){this.fn=o,this.context=l,this.once=d||!1}c(a,"EE");function n(o,l,d,u,f){if(typeof d!="function")throw new TypeError("The listener must be a function");var w=new a(d,u||o,f),g=e?e+l:l;return o._events[g]?o._events[g].fn?o._events[g]=[o._events[g],w]:o._events[g].push(w):(o._events[g]=w,o._eventsCount++),o}c(n,"addListener");function i(o,l){--o._eventsCount===0?o._events=new t:delete o._events[l]}c(i,"clearEvent");function r(){this._events=new t,this._eventsCount=0}c(r,"EventEmitter"),r.prototype.eventNames=c(function(){var l=[],d,u;if(this._eventsCount===0)return l;for(u in d=this._events)s.call(d,u)&&l.push(e?u.slice(1):u);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(d)):l},"eventNames"),r.prototype.listeners=c(function(l){var d=e?e+l:l,u=this._events[d];if(!u)return[];if(u.fn)return[u.fn];for(var f=0,w=u.length,g=new Array(w);f<w;f++)g[f]=u[f].fn;return g},"listeners"),r.prototype.listenerCount=c(function(l){var d=e?e+l:l,u=this._events[d];return u?u.fn?1:u.length:0},"listenerCount"),r.prototype.emit=c(function(l,d,u,f,w,g){var I=e?e+l:l;if(!this._events[I])return!1;var A=this._events[I],R=arguments.length,M,T;if(A.fn){switch(A.once&&this.removeListener(l,A.fn,void 0,!0),R){case 1:return A.fn.call(A.context),!0;case 2:return A.fn.call(A.context,d),!0;case 3:return A.fn.call(A.context,d,u),!0;case 4:return A.fn.call(A.context,d,u,f),!0;case 5:return A.fn.call(A.context,d,u,f,w),!0;case 6:return A.fn.call(A.context,d,u,f,w,g),!0}for(T=1,M=new Array(R-1);T<R;T++)M[T-1]=arguments[T];A.fn.apply(A.context,M)}else{var Jd=A.length,ht;for(T=0;T<Jd;T++)switch(A[T].once&&this.removeListener(l,A[T].fn,void 0,!0),R){case 1:A[T].fn.call(A[T].context);break;case 2:A[T].fn.call(A[T].context,d);break;case 3:A[T].fn.call(A[T].context,d,u);break;case 4:A[T].fn.call(A[T].context,d,u,f);break;default:if(!M)for(ht=1,M=new Array(R-1);ht<R;ht++)M[ht-1]=arguments[ht];A[T].fn.apply(A[T].context,M)}}return!0},"emit"),r.prototype.on=c(function(l,d,u){return n(this,l,d,u,!1)},"on"),r.prototype.once=c(function(l,d,u){return n(this,l,d,u,!0)},"once"),r.prototype.removeListener=c(function(l,d,u,f){var w=e?e+l:l;if(!this._events[w])return this;if(!d)return i(this,w),this;var g=this._events[w];if(g.fn)g.fn===d&&(!f||g.once)&&(!u||g.context===u)&&i(this,w);else{for(var I=0,A=[],R=g.length;I<R;I++)(g[I].fn!==d||f&&!g[I].once||u&&g[I].context!==u)&&A.push(g[I]);A.length?this._events[w]=A.length===1?A[0]:A:i(this,w)}return this},"removeListener"),r.prototype.removeAllListeners=c(function(l){var d;return l?(d=e?e+l:l,this._events[d]&&i(this,d)):(this._events=new t,this._eventsCount=0),this},"removeAllListeners"),r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=e,r.EventEmitter=r,y.exports=r}(Ps);var Nc=Ps.exports;const Oc=Br(Nc),he=new Oc,Lc={names:[],history:[]},Cn=class Cn extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"enableLog",!1);h(this,"muteEvents",[])}init(){const{storage:e}=this.game;e.addStorage("event",Lc)}enableLogEvent(){this.enableLog=!0}on(e,t){this.validateCallback(t),this.addEventName(e),this.addHistory(e,"on","listening"),he.on(e,t)}once(e,t){this.validateCallback(t),this.addEventName(e),this.addHistory(e,"once","listening"),he.once(e,t)}waitTo(e,t){return new Promise((a,n)=>{let i;const r=c(o=>{clearTimeout(i),a(o)},"callback");this.once(e,r),t&&t>0&&(i=setTimeout(()=>{this.off(e,r),n(new Error(`Event ${e} timeout`))},t))})}catchUp(e,t){if(this.validateCallback(t),this.once(e,t),!(this.getEventEmitCount(e)>0))return;const{payload:n}=this.getLastEventInfo(e)??{};this.emit(e,n)}off(e,t){this.validateCallback(t),he.off(e,t),this.addHistory(e,"action","removed")}mute(e){this.muteEvents.indexOf(e)>-1||this.muteEvents.push(e)}clear(e){he.removeAllListeners(e),this.addHistory(e,"action","removed")}emit(e,t){if(this.muteEvents.indexOf(e)>-1)return;let a=[];t&&(a=[t]),this.addHistory(e,"action","called",t),he.emit(e,...a)}validateCallback(e){if(typeof e!="function")throw new Error("Callback must be a function")}addEventName(e){const{storage:t}=this.game,a=t.getStorageData("event","names");a&&a.indexOf(e)<0&&a.push(e)}limitHistory(e){if(e.length<=1e4)return e;const{Utils:{Array:a}}=p;return a.limit(e,1e4)}getEventListeners(){const e=he.eventNames();return Object.keys(e)}getHistory(){const{storage:e}=this.game,t=e.getStorageData("event","history")??[];return this.limitHistory(t)}getEventEmitCount(e){return this.getHistory().filter(a=>a.name===e&&a.status==="called").length}getLastEventInfo(e){const t=this.getHistory();let a=null;for(let n=t.length-1;n>=0;n--)if(t[n].name===e){a=t[n];break}return a}getTypeFromHistory(e){const t=this.getLastEventInfo(e);return(t==null?void 0:t.type)??null}getCallsFromHistory(e){const t=this.getLastEventInfo(e);return(t==null?void 0:t.called)??0}addHistory(e,t,a,n){const r=this.getTypeFromHistory(e)??t,o=this.getCallsFromHistory(e),l=a==="called"?o+1:o;this.getHistory().push({type:r,status:a,name:e,called:l,payload:n??{}}),this.logEventInfo(e,r,a,l)}logEventInfo(e,t,a,n){if(this.enableLog){if(a==="listening"){console.debug(`Event (${t}) ${e}: ${a}`);const i=he.listenerCount(e);i>1&&console.warn(`Event ${e} has ${i} listener`)}else t!=="action"&&console.debug(`Event (${t}) ${e}: ${a} (${n} times)`);a==="called"&&he.listenerCount(e)<=0&&console.warn(`Event ${e} is called but not listening`)}}};c(Cn,"EventPlugin");let Es=Cn;const Rc='nunito,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif',{Configs:{FrameCapture:{Enabled:_c,WideframeConfigs:Ss}},Utils:{Object:xs}}=p,Mc=c(async y=>{if(!_c)return console.warn("FrameCapture is not enabled"),null;const s=Gc(y);if(!s)return null;$c(s,Ss.ResultChallenge);const{frameCapture:e}=window.game,{Width:t,Height:a}=Ss.ResultChallenge;return e.captureAsync({name:"ResultChallenge",width:t,height:a,renderOptions:s})},"renderResultChallenge"),$c=c((y,s)=>{const{Width:e,Height:t,Wideframe:a}=s;y.wideframe={name:"result-challenge",type:"image",depth:0,image:a,size:[e,t],position:[0,0]}},"addWideframe$3"),Gc=c(y=>{try{const{playerId:s="10",playerPhoto:e="",playerScore:t=0,opponentId:a="20",opponentPhoto:n="",opponentScore:i=0,isPlayerFinished:r,isOpponentFinished:o}=y,{RenderOptions:l}=Ss.ResultChallenge,d=xs.clone(l);if(!d)return null;const u=xs.clear(d),f=xs.camelCaseKeys(u),{playerPhoto:w,opponentPhoto:g}=f,I=t===i,A=t>i,R=r??o,M=r&&o;return w.type==="image"&&(w.name=`${s}`,w.image=e),g.type==="image"&&(g.name=`${a}`,g.image=n),R?Fc(f,{playerScore:t,opponentScore:i,isPlayerFinished:r,isOpponentFinished:o}):(delete f.leftScore,delete f.rightScore),!M||I?(delete f.leftCrown,delete f.rightCrown,f):(A?delete f.rightCrown:delete f.leftCrown,f)}catch(s){return console.warn("getRenderOptionsShareScore",s),null}},"getRenderOptions$3"),Fc=c((y,s)=>{const{leftScore:e,rightScore:t}=y,{playerScore:a=0,opponentScore:n=0,isPlayerFinished:i,isOpponentFinished:r}=s;(e==null?void 0:e.type)==="text"&&(e.text=i?`${a}`:"???"),(t==null?void 0:t.type)==="text"&&(t.text=r?`${n}`:"???")},"addRenderScores"),{Configs:{FrameCapture:{Enabled:kc,WideframeConfigs:bs}},Utils:{Object:Cs}}=p,Vc=c(async y=>{if(!kc)return console.warn("FrameCapture is not enabled"),null;const s=Uc(y);if(!s)return null;Bc(s,bs.ShareLeaderboard);const{frameCapture:e}=window.game,{Width:t,Height:a}=bs.ShareLeaderboard;return e.captureAsync({name:"ShareLeaderboard",width:t,height:a,renderOptions:s})},"renderShareLeaderboard"),Bc=c((y,s)=>{const{Width:e,Height:t,Wideframe:a}=s;y.wideframe={name:"share-leaderboard",type:"image",depth:0,image:a,size:[e,t],position:[0,0]}},"addWideframe$2"),Uc=c(y=>{try{const{playerId:s,playerPhoto:e,leaders:t}=y,{RenderOptions:a}=bs.ShareLeaderboard,n=Cs.clone(a);if(!n)return null;const i=Cs.clear(n),r=Cs.camelCaseKeys(i),{avatar:o}=r;return o.type==="image"&&(o.name=`${s}`,o.image=e),Wc(r,t),r}catch(s){return console.warn("getRenderOptionsShareScore",s),null}},"getRenderOptions$2"),Wc=c((y,s)=>{const e="600 48px";s.forEach((t,a)=>{const{id:n,name:i,photo:r,score:o}=t;let l=1294+180*a;y[`photo_${n}`]={depth:-1,name:n,type:"image",image:r,size:[96,96],position:[436,l]},l=1360+180*a,y[`name_${n}`]={font:e,depth:1,name:n,type:"text",text:i,position:[600,l]},y[`score_${n}`]={font:e,depth:1,name:n,type:"text",text:`${o}`,position:[100,l]}})},"addLeaders"),{Configs:{FrameCapture:{Enabled:jc,WideframeConfigs:Ts}},Utils:{Object:Ns}}=p,Kc=c(async y=>{if(!jc)return console.warn("FrameCapture is not enabled"),null;const s=zc(y);if(!s)return null;Hc(s,Ts.ShareScore);const{frameCapture:e}=window.game,{Width:t,Height:a}=Ts.ShareScore;return e.captureAsync({name:"ShareScore",width:t,height:a,renderOptions:s})},"renderShareScore"),Hc=c((y,s)=>{const{Width:e,Height:t,Wideframe:a}=s;y.wideframe={name:"share-score",type:"image",depth:0,image:a,size:[e,t],position:[0,0]}},"addWideframe$1"),zc=c(y=>{try{const{playerId:s,playerPhoto:e,playerScore:t}=y,{RenderOptions:a}=Ts.ShareScore,n=Ns.clone(a);if(!n)return null;const i=Ns.clear(n),r=Ns.camelCaseKeys(i);console.log("renderOptions",r);const{avatar:o,playerScore:l}=r;return o.type==="image"&&(o.name=`${s}`,o.image=e),l.type==="text"&&(l.text=`${t}`),r}catch(s){return console.warn("getRenderOptionsShareScore",s),null}},"getRenderOptions$1"),{Configs:{FrameCapture:{Enabled:qc,WideframeConfigs:Os}},Utils:{Object:Ls}}=p,Yc=c(async y=>{if(!qc)return console.warn("FrameCapture is not enabled"),null;const s=Xc(y);if(!s)return null;Qc(s,Os.UpdateChallenge);const{frameCapture:e}=window.game,{Width:t,Height:a}=Os.UpdateChallenge;return e.captureAsync({name:"UpdateChallenge",width:t,height:a,renderOptions:s})},"renderUpdateChallenge"),Qc=c((y,s)=>{const{Width:e,Height:t,Wideframe:a}=s;y.wideframe={name:"update-challenge",type:"image",depth:0,image:a,size:[e,t],position:[0,0]}},"addWideframe"),Xc=c(y=>{try{const{playerId:s,playerPhoto:e}=y,{RenderOptions:t}=Os.UpdateChallenge,a=Ls.clone(t);if(!a)return null;const n=Ls.clear(a),i=Ls.camelCaseKeys(n);console.log("renderOptions",i);const{avatar:r}=i;return r.type==="image"&&(r.name=`${s}`,r.image=e),i}catch(s){return console.warn("getRenderOptionsUpdateChallenge",s),null}},"getRenderOptions"),{Configs:{FrameCapture:{Options:Rs}},Utils:{Browser:Jc,Image:It,Object:Ye,Valid:vt}}=p,Tn=class Tn extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"width");h(this,"height");h(this,"canvas",null);h(this,"context",null);h(this,"testRenderOptions",null);h(this,"caches",{});h(this,"wideframe",{})}init(){this.addWideframeRender("renderShareScore",Kc),this.addWideframeRender("renderUpdateChallenge",Yc),this.addWideframeRender("renderResultChallenge",Mc),this.addWideframeRender("renderShareLeaderboard",Vc)}async preloadAsync(e){const{renderOptions:t}=e;await this.loadImages(t)}async captureAsync(e){const{width:t,height:a,renderOptions:n}=e;return await this.loadImages(n),this.width=t,this.height=a,this.createCanvas(),this.drawObjects(n),this.snapshotFrameAsync()}addWideframeRender(e,t){this.wideframe[e]=t}setTestRenderOptions(e){if(!e){this.testRenderOptions=null;return}const t=Ye.camelCaseKeys(e);this.testRenderOptions=Ye.merge(this.testRenderOptions,t)}createCanvas(){if(!this.canvas){const e=Jc.createCanvas({type:"canvas",contextAttributes:{alpha:!1,desynchronized:!0,willReadFrequently:!0},contextType:"2d"});this.canvas=e==null?void 0:e.canvas,this.context=e==null?void 0:e.context}if(!this.canvas)throw new Error("Failed to create canvas");this.context&&this.context.clearRect(0,0,this.width,this.height),this.canvas.width=this.width,this.canvas.height=this.height}async loadImages(e){const t=Ye.vals(e).filter(r=>r.type==="image"),a=this.prepareLoadImages(t),n=Ye.vals(a);if(n.length<1)return;const i=await Promise.all(n);this.cacheImages(a,i)}prepareLoadImages(e){const t={};for(const a of e){const{name:n,image:i,fallbackImage:r}=a,o=this.caches[n];!vt.isString(i)||o||(i===""&&vt.isString(r)&&(a.image=r),console.debug("prepareLoadImages",a),t[n]=new Promise(l=>{It.loadImage(i).then(u=>{l(u)}).catch(()=>{vt.isString(r)?(a.image=r,It.loadImage(a.image).then(u=>{l(u)}).catch(()=>{l(null)})):l(null)})}))}return t}cacheImages(e,t){for(const a in e){const n=t.shift();n&&(this.caches[a]=n)}}drawObjects(e){const t=Ye.vals(e).sort((a,n)=>a.depth-n.depth);for(const a of t)switch(a.type){case"text":this.drawText(a);break;case"image":this.drawImage(a);break}}drawText(e){if(!this.canvas||!this.context)return;const{position:t,font:a,text:n,color:i,lineWidth:r,textAlign:o}=e;this.context.font=`${a} ${Rc}`,this.context.fillStyle=i??"#ffffff",r&&(this.context.lineWidth=r),o&&(this.context.textAlign=o),console.debug("drawText",e);const[l,d]=t;this.context.fillText(n,l,d)}drawImage(e){if(!this.canvas||!this.context)return;const{name:t,size:a,position:n,fallbackImage:i}=e;let r=this.caches[t];if(!r&&i&&(r=this.caches[i]),!r)throw new Error(`Image ${t} not found`);console.debug("drawImage",e);const[o,l]=n,[d,u]=a;this.context.drawImage(r,o,l,d,u)}async snapshotFrameAsync(){if(!this.canvas)return null;let e=null;if(Rs.UseBlobIfPossible&&"toBlob"in this.canvas?e=await this.createAsBlob():e=this.createAsDataImage(),!e)throw new Error("Image data is null");return vt.isDebugger()&&It.logImage(e),e}createAsDataImage(){if(!this.canvas||!this.context)return null;const{Quality:e,RenderType:t}=Rs;return this.context.canvas.toDataURL(`image/${t}`,e)}createAsBlob(){return new Promise(e=>{if(!this.canvas){e(null);return}const{Quality:t,RenderType:a}=Rs;this.canvas.toBlob(n=>{if(!n){e(null);return}It.blobToDataImage(n).then(i=>{e(i)})},`image/${a}`,t)})}};c(Tn,"FrameCapturePlugin");let _s=Tn;const Nn=class Nn extends Error{constructor(e,t){const a=String(e);super(`Text with key "${a}" not found in locale "${t}"`);h(this,"key");h(this,"locale");this.name="MissingKeyInLocaleError",this.key=a,this.locale=t}};c(Nn,"MissingKeyInLocaleError");let Qe=Nn;const On=class On extends Error{constructor(e){super(`Locale "${e}" not found`);h(this,"locale");this.name="LocaleNotFoundError",this.locale=e}};c(On,"LocaleNotFoundError");let Pt=On;const{Utils:{Object:Ms,Function:io,Browser:Zc},Configs:{Languages:{DetectPlayerLocale:el}}}=p,Ln=class Ln extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"locale");h(this,"fallbackLocale");h(this,"data",{})}setFallbackLocale(e){this.fallbackLocale=e}hasTextKey(e,t){const a=t??this.getCurrentLocale(),{text:n}=this.getLocaleData(a);return Ms.hasOwn(n,e)}hasTextureKey(e,t){const a=t??this.getCurrentLocale(),{texture:n}=this.getLocaleData(a);return Ms.hasOwn(n,e)}add(e,t,a=!1){this.data[e]=t,a&&this.setFallbackLocale(e)}choose(e){this.locale=e;const{event:t}=this.game;t.emit(p.Events.LANGUAGE_CHANGED,{locale:e})}getText(e,t,a,n=!1){try{return this.uncaughtGetText(e,t,a,!n)}catch(i){return i instanceof Qe||i instanceof Pt?console.warn(i.message):console.error(i),String(e)}}getTexture(e,t,a=!1){return this.uncaughtGetTexture(e,t,!a)}uncaughtGetText(e,t=[],a,n=!0){if(!n||this.fallbackLocale===void 0){const o=this.getRawText(e,a??this.getCurrentLocale());return this.replaceVariables(o,t)}const i=this.fallbackLocale,r=io.retry(()=>this.getRawText(e,a??this.getCurrentLocale()),()=>this.getRawText(e,i));return this.replaceVariables(r,t)}getRawText(e,t){if(!this.hasTextKey(e,t))throw new Qe(e,t);const{text:a}=this.getLocaleData(t);return a[e]}uncaughtGetTexture(e,t,a=!0){if(!a||this.fallbackLocale===void 0)return this.getRawTexture(e,t??this.getCurrentLocale());const n=this.fallbackLocale;return io.retry(()=>this.getRawTexture(e,t??this.getCurrentLocale()),()=>this.getRawTexture(e,n))}getRawTexture(e,t){if(!this.hasTextureKey(e,t))throw new Qe(e,t);const{texture:a}=this.getLocaleData(t);return a[e]}getCurrentLocale(){return this.locale??"en"}getLocaleData(e){const t=e??this.getCurrentLocale();if(!Ms.hasOwn(this.data,t))throw new Pt(t);return this.data[t]}replaceVariables(e,t){const a=t.length;if(a===0)return e;let n=e;for(let i=0;i<a;i++){const r=t[i],o=`%{${i}}`;n=n.replace(o,r)}return n}getPlayerLanguage(){const{player:e}=globalThis.game,t=GameSDK.getLocale(),a=t==null?void 0:t.trim().split(/[-_]/)[0],n=this.getBrowserLanguage();return a!==n?a??n:e.getPlayerDataByKey("isFirstLogin")?n:e.getPlayerSetting("language")??n}getBrowserLanguage(){var a;if(el===!1)return"en";const e=Zc.getLocale();return(a=e==null?void 0:e.trim())==null?void 0:a.split(/[-_]/)[0]}};c(Ln,"LanguagePlugin");let $s=Ln;const tl=se("D",{_id:"",name:"",createdBy:"",description:"",expireTime:7*24*60*60*1e3,type:"app_leaderboard",timezone:"utc+0",createdAt:"2024-01-01T09:00:00.000Z",sortOrder:"desc",statistics:"max",resettable:"manually",resetScore:0,numberOfLeaders:15,amountPlayer:15}),{Configs:sl,Utils:al}=p,{Object:Xe,String:ro,Valid:oo}=al,{OtherHost:Je,Mockup:Ze,AppId:nl}=sl,Rn=class Rn{constructor(){h(this,"mockAPI")}async initMockAPI(){if(this.mockAPI)return;const s=(await ce(async()=>{const{default:e}=await v.import("./bundle/LeaderboardAPIMock.js");return{default:e}},void 0,v.meta.url)).default;if(typeof s!="function")throw new Error("Cannot load LeaderboardAPIMock");this.mockAPI=new s}async getLeadersAsync(s,e,t){const a=ro.params(t);let n;return Ze.Leaderboards.Enabled?(await this.initMockAPI(),"playerIds"in t?n=await this.mockAPI.getPlayers(s,t):n=await this.mockAPI.getLeaders(s,t)):n=await Oe(`${e}?${a}`,{},Je),!Xe.hasOwn(n,"data")||!Array.isArray(n.data)?[]:n.data}async getLeaderboardAsync(s){let e;const t=`leaderboards/${s}`;return Ze.Leaderboards.Enabled?(await this.initMockAPI(),e=await this.mockAPI.getLeaderboardAsync(s)):(e=await Oe(t,{},Je),Xe.hasOwn(e,"data")&&oo.isObject(e.data)&&(e=e.data)),e}async getLeaderboardsAsync(s){let e;const t=p.Utils.String.params(s);return Ze.Leaderboards.Enabled?(await this.initMockAPI(),e=await this.mockAPI.getLeaderboardsAsync(s)):(e=await Oe(`leaderboards?${t}`,{},Je),Xe.hasOwn(e,"data")&&Array.isArray(e.data)?e=e.data:e=[]),e}async setLeaderboardScoreAsync(s){const{leaderboardId:e,playerId:t,score:a}=s;Ze.Leaderboards.Enabled?(await this.initMockAPI(),await this.mockAPI.setScoreAsync(e,t,a)):await Z(`leaderboards/${e}/players/${t}`,{score:a},{},Je)}async createLeaderboardAsync(s){const e=s._id??ro.generateObjectId(),t=s.numberOfLeaders,a={...tl,...s,_id:e,appId:nl,numberOfLeaders:t},n="leaderboards";let i;if(Ze.Leaderboards.Enabled?(await this.initMockAPI(),i=await this.mockAPI.createLeaderboard(a)):(i=await Z(n,a,{},Je),Xe.hasOwn(i,"data")&&oo.isObject(i.data)&&(i=i.data)),!Xe.hasOwn(i,"_id")||i._id!==e)throw new Error("Create leaderboard failed");return e}};c(Rn,"LeaderboardAPI");let Gs=Rn;const co={limit:0,offset:0,leaders:{},isRequesting:!1,amountPlayer:0},il={leaderboards:{}},{Utils:{Array:rl,Valid:ol,Json:lo,Object:Et}}=p,_n=class _n extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"lbAPI",new Gs);h(this,"configs")}init(){const{storage:e}=this.game;e.addStorage("leaderboard",il),this.configs={}}addLeaderboard(e){const{name:t,type:a,leaderboardId:n,autoSortRank:i}=e;if(this.getLeaderboard(t)){console.warn(`Leaderboard with name ${t} already exists`);return}let o=`leaderboards/${n}/`;(a==="global"||a==="tournament")&&(o+="leaders"),a==="friends"&&(o+="players"),this.configs[t]={id:n,name:t,type:a,host:o,autoSortRank:i};const l=lo.clone(co);this.setLeaderboard(t,{...l})}async requestLeaderboardsAsync(e){try{return await this.lbAPI.getLeaderboardsAsync(e)}catch(t){return console.warn("requestGlobalLeaderboardsAsync",t),[]}}async requestLeaderboardAsync(e,t){try{this.validateLeaderboard(e),this.clearLeaderboard(e),this.setLeaderboard(e,{isRequesting:!0});const{id:a,type:n,host:i}=this.configs[e];let r=[];if(n==="friends"){const{player:o}=this.game,l=o.getPlayerId(),d=o.getConnectedPlayerIds(t,0),u=[l,...d];this.configs[e].playerIds=[...u],r=await this.lbAPI.getLeadersAsync(a,i,{playerIds:u})}else r=await this.lbAPI.getLeadersAsync(a,i,{limit:t,offset:0});if(r.length===0)return;await this.receiveLeaderboardAsync(e,r),this.setLeaderboard(e,{limit:t,offset:0})}finally{const a=await this.lbAPI.getLeaderboardAsync(this.configs[e].id),n=a?a.resettable:"",i=a?a.amountPlayer:0;this.setLeaderboard(e,{isRequesting:!1,resettable:n,amountPlayer:i})}}async loadMoreLeaderboardAsync(e,t){const a=this.getLeaderboard(e);if(a){if(this.configs[e].type==="friends"){console.warn("Cannot load more leaderboard with type friend");return}try{this.setLeaderboard(e,{isRequesting:!0});const{id:n,host:i}=this.configs[e],{offset:r,limit:o}=a,l=r+o,d=await this.lbAPI.getLeadersAsync(n,i,{limit:t,offset:l});if(d.length===0)return;this.receiveLeaderboardAsync(e,d),this.setLeaderboard(e,{limit:t,offset:l})}finally{this.setLeaderboard(e,{isRequesting:!1})}}}getLeaderboard(e){const{storage:t}=this.game,a=t.getStorageData("leaderboard","leaderboards");return!a||!a[e]?null:a[e]}async getLeadersByPlayerIdsAsync(e,t){try{this.validateLeaderboard(e);const{id:a}=this.configs[e],n=`leaderboards/${a}/players`,i=await this.lbAPI.getLeadersAsync(a,n,{playerIds:t});return i.length===0?[]:this.toLeaders(i)}catch(a){return console.warn(a),[]}}async getLeaderboardResponseAsync(e){return await this.lbAPI.getLeaderboardAsync(e)}clearLeaderboard(e){try{this.validateLeaderboard(e);const t=lo.clone(co);this.setLeaderboard(e,null),this.setLeaderboard(e,{...t})}catch(t){console.warn(t)}}isLeaderboardEmpty(e){const t=this.getLeaderboard(e);if(!t)return!0;const{leaders:a}=t;return Object.keys(a).length===0}isExistLeaderboardId(e){const{configs:t}=this;return Et.vals(t).some(a=>a.id===e)}getLeaderboardName(e){const{configs:t}=this,a=rl.search(Et.vals(t),n=>n.id===e);return a?a.name:null}async setLeaderboardScoreAsync(e,t,a){try{if(GameSDK.extra.isGuest)return;this.validateLeaderboard(e);const{id:n}=this.configs[e],i=await this.getLastScoreOnLeaderboard(e,t);if(i&&a<=i)return;await this.lbAPI.setLeaderboardScoreAsync({leaderboardId:n,playerId:t,score:a})}catch(n){console.warn(n)}}async getLastScoreOnLeaderboard(e,t){const a=await this.getLeadersByPlayerIdsAsync(e,[t]);return a.length===0?null:a[0].score}async createLeaderboardAsync(e){return this.lbAPI.createLeaderboardAsync(e)}validateLeaderboard(e){const t=this.getLeaderboard(e);if(!ol.isObject(t))throw new Error(`Leaderboard with name ${e} not found`)}setLeaderboard(e,t){if(!t)return;const{storage:a}=this.game;a.setStorageData("leaderboard","leaderboards",{[e]:t})}async receiveLeaderboardAsync(e,t){this.validateLeaderboard(e);const n=(await this.toLeaders(t)).filter(u=>u.name&&u.photo),{leaders:i={}}=this.getLeaderboard(e)??{},r=n.filter(u=>i[u.playerId]?(i[u.playerId]=u,!1):!0),o=Et.vals(i);r.length>0&&o.unshift(...r);let l=o.sort((u,f)=>f.score-u.score);this.configs[e].autoSortRank&&(l=l.map((u,f)=>({...u,rank:f+1})));const d=Et.keyBy(l,"playerId");this.setLeaderboard(e,{leaders:d})}async toLeaders(e){const{profile:t}=this.game,a=e.map(o=>o.playerId);await t.requestProfiles(a);const n=t.getProfiles();return e.map(o=>{const{playerId:l}=o,d=n[l];if(!d){const{language:u}=this.game,f=u.getText("core.nameless")??"Nameless";return{...o,name:f,photo:"default"}}return{...o,name:d.name,photo:d.photo}}).map(o=>({...o,score:parseInt(o.score,10)}))}};c(_n,"LeaderboardPlugin");let Fs=_n;const Mn=class Mn{constructor(){h(this,"APIHost")}setAPIHost(s){this.APIHost=s}getAPIHost(){return this.APIHost}};c(Mn,"BaseAPI");let ks=Mn;const{Utils:ho}=p,$n=class $n extends ks{async createSingleMatchAsync(s){const t=await Z("single-matches",s,{},this.getAPIHost());return this.returnValidMatchData(t)}async getSingleMatchDetailAsync(){const e=await Oe("single-matches/active",{},this.getAPIHost());return this.returnValidMatchData(e)}async updateSingleMatchMoveAsync(s,e){const t=`single-matches/${s}/move`,a=await Z(t,e,{},this.getAPIHost());return this.returnValidMatchData(a)}async finishSingleMatchAsync(s){const e=`single-matches/${s}/finish`,t=await Z(e,{},{},this.getAPIHost());return this.returnValidMatchData(t)}async createMatchAsync(s){const t=await Z("matches",s,{},this.getAPIHost());return this.returnValidMatchData(t)}async joinMatchAsync(s){const e=`matches/${s}/join`,t=await Z(e,{},{},this.getAPIHost());return this.returnValidMatchData(t)}async getMatchDetailByIdAsync(s){const e=`matches/${s}`,t=await Oe(e,{},this.getAPIHost());return this.returnValidMatchData(t)}async finishMatchAsync(s){const{matchId:e="",score:t=0,level:a=0,extraData:n={}}=s,i=`matches/${e}/finish`,r=await Z(i,{matchId:e,score:t,level:a,extraData:n},{},this.getAPIHost());return this.returnValidMatchData(r)}returnValidMatchData(s){return ho.Valid.isObject(s)?ho.Object.hasOwn(s,"data")?s.data??{}:{}:{}}};c($n,"MatchAPI");let Vs=$n;const Gn=class Gn{constructor(s){h(this,"matchAPI");this.createAPI(),this.setAPIConfig(s)}createAPI(){this.matchAPI=new Vs}setAPIConfig(s){s.matchAPIHost&&this.matchAPI.setAPIHost(s.matchAPIHost)}setMatchAPIInstance(s){this.matchAPI=s}getMatchAPI(){return this.matchAPI}};c(Gn,"APIHandler");let Bs=Gn;const Fn=class Fn{constructor(s,e){h(this,"game");h(this,"match");this.game=s,this.match=e}startLog(s){this.match.useCPUProfile&&console.profile(this.constructor.name),console.group(`🚀 ${this.constructor.name}`),s&&console.log("📦 ? Payload:",s)}endLog(){console.groupEnd(),this.match.useCPUProfile&&console.profileEnd()}async processAsync(s){throw new Error("Not implemented")}};c(Fn,"BaseConcrete");let E=Fn;const kn=class kn extends Y{constructor(s){super(s),this.name="LevelNotDefined",this.message=s??"Level is not defined"}};c(kn,"LevelNotDefined");let St=kn;const Vn=class Vn extends Y{constructor(s){super(s),this.name="MatchModeNotDefined",this.message=s??"Match id is not defined"}};c(Vn,"MatchModeNotDefined");let et=Vn;const{Object:Us,Valid:cl}=p.Utils,Bn=class Bn{constructor(s){h(this,"game");h(this,"match");h(this,"nextHandler");this.game=s.game,this.match=s.match,this.nextHandler=null}setNext(s){return this.nextHandler=s,s}async processAsync(s){console.groupCollapsed(`➡️ ${this.constructor.name}`),this.logData("Before",s)}async nextAsync(s){this.logData("After",s),console.groupEnd(),this.nextHandler&&await this.nextHandler.processAsync(s)}logData(s,e){if(!cl.isDebugger())return;console.groupCollapsed(`📦 MatchState: ${s}`);const{profiles:t,customData:a,...n}=e;console.info("💾 Base"),console.table(Us.clone(n)),console.info("💾 Profile"),console.table(Us.clone(t)),console.info("💾 Custom"),console.table(Us.clone(a)),console.groupEnd()}};c(Bn,"BaseHandler");let D=Bn;const{Plugins:ll,Utils:dl}=p,{Analytics:hl}=ll,{String:uo,Valid:po}=dl,Un=class Un extends D{async processAsync(s){super.processAsync(s);const{mode:e,customData:t}=s,{level:a}=t;this.validateMode(e),this.validateLevel(a);const{analytics:n}=this.game;n.event(hl.Events.MATCH_START,{level:a,game_mode:uo.toUpperCamelCase(e),level_name:this.getLevelName(a)}),await this.nextAsync(s)}validateMode(s){if(!po.isString(s))throw new et}validateLevel(s){if(!po.isNumber(s))throw new St}getLevelName(s){return`Level ${uo.padStart(s.toString(),5,"0")}`}};c(Un,"LogMatchStartHandler");let j=Un;const G={OPEN:"open",ACTIVE:"active",FINISHED:"finished"},Wn=class Wn extends D{async processAsync(s){super.processAsync(s);const{mode:e,status:t}=s;let a=e??we.SINGLE;t===G.FINISHED&&(a=we.SINGLE),this.contextGameModeDetected(a),await this.nextAsync(s)}contextGameModeDetected(s){const{storage:e}=this.game;e.setStorageData("context","contextGameMode",s)}};c(Wn,"ContextGameModeHandler");let N=Wn;const jn=class jn extends Error{constructor(s){super(s),this.name="GetMatchDetailFailed",this.message=s??"Get match detail failed"}};c(jn,"GetMatchDetailFailed");let tt=jn;const Kn=class Kn extends Error{constructor(s){super(s),this.name="MatchAreNotActive",this.message=s??"Match are not active"}};c(Kn,"MatchAreNotActive");let xt=Kn;const Hn=class Hn extends Y{constructor(s){super(s),this.name="MatchIdNotValid",this.message=s??"Match id is not valid"}};c(Hn,"MatchIdNotValid");let Q=Hn;const zn=class zn extends Error{constructor(s){super(s),this.name="OpponentHasFinishedMatch",this.message=s||"Opponent has finished match"}};c(zn,"OpponentHasFinishedMatch");let Ws=zn;const qn=class qn extends Y{constructor(s){super(s),this.name="OpponentIdNotValid",this.message=s??"Opponent id is not valid"}};c(qn,"OpponentIdNotValid");let F=qn;const Yn=class Yn extends Error{constructor(s){super(s),this.name="PlayerNotCurrentInMatch",this.message=s??"The player is not currently in this match"}};c(Yn,"PlayerNotCurrentInMatch");let st=Yn;const Qn=class Qn extends Error{constructor(s){super(s),this.name="PlayerNotFinishedMatch",this.message=s||"Player not finished match"}};c(Qn,"PlayerNotFinishedMatch");let bt=Qn;const{Dtos:ul,Utils:{Object:pl}}=p,Xn=class Xn extends D{async processAsync(s){super.processAsync(s),this.validateMatchData(s);const e=await this.getMatchAsync(s),t=new ul.Match.Data(e).toObject();this.validateAwaitMatchData(s,t),this.updateMatchData(s,t),this.validateMatchStatus(s),this.validatePlayerTurn(s),this.validateOpponentTurn(s),await this.nextAsync(s)}validateMatchData(s){const{id:e}=s;if(typeof e!="string")throw new Q}validateMatchStatus(s){const{status:e}=s;if(e!==G.ACTIVE)throw new xt}validateAwaitMatchData(s,e){const{id:t,customData:a}=s,{_id:n,whitePlayerId:i,blackPlayerId:r}=e;if(typeof n!="string"||n!==t)throw new tt;const{playerId:o}=a,l=i===o,d=r===o;if(!l&&r===ae.playerId)throw new ze;if(!l&&!d)throw new st}validatePlayerTurn(s){const{profiles:e,customData:t}=s,{playerId:a}=t;if(typeof a!="string")throw new P;const{finished:n}=e[a];if(!n)throw new bt}validateOpponentTurn(s){const{profiles:e,customData:t}=s,{opponentId:a}=t;if(typeof a!="string")throw new F;const{finished:n}=e[a];if(n)throw new Ws}async getMatchAsync(s){const{id:e}=s;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):{}}updateMatchData(s,e){this.updateMatchGeneral(s,e),this.updatePlayerIds(s,e),this.initializeProfiles(s),this.updateScoresAndStatus(s,e)}updateMatchGeneral(s,e){const{status:t,extraData:a}=e;s.status=t,s.customData=pl.merge(s.customData,a)}updatePlayerIds(s,e){const{whitePlayerId:t,blackPlayerId:a}=e,n=t===s.customData.playerId;s.customData.playerId=n?t:a,s.customData.opponentId=n?a:t}initializeProfiles(s){const{playerId:e,opponentId:t}=s.customData;if(!e||!t)return;const a={name:"",photo:"",finished:!1};s.profiles[e]||(s.profiles[e]={id:e,...a}),s.profiles[t]||(s.profiles[t]={id:t,...a})}updateScoresAndStatus(s,e){const{playerId:t,opponentId:a}=s.customData;if(!t||!a)return;const{whitePlayerId:n,whitePlayerScore:i,whitePlayerFinish:r,blackPlayerScore:o,blackPlayerFinish:l}=e,d=n===t;s.profiles[t].score=d?i:o,s.profiles[a].score=d?o:i,s.profiles[t].finished=d?r:l,s.profiles[a].finished=d?l:r}};c(Xn,"AwaitMatchHandler");let js=Xn;const Ks={level:1,rescued:0,contextId:null,playerId:null,opponentId:null,tournamentId:null,leaderboardId:null},Jn=class Jn extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),this.initializeMatch(e),await this.nextAsync(e)}initializeMatch(e){const{id:t,mode:a,customData:n}=this.payload;e.id=t??null,e.mode=a||null,e.status=G.OPEN,e.startAt=0,e.finishAt=0,e.profiles={},e.customData={...Ks,...e.customData,...n}}};c(Jn,"PrepareMatchHandler");let k=Jn;const Ae=me,Zn=class Zn extends Error{constructor(s){super(s),this.name="UnavailableFeature",this.message=`Unavailable feature: ${s}`}};c(Zn,"UnavailableFeature");let S=Zn;const ei=class ei extends Y{constructor(s){super(s),this.name="ContextIdNotValid",this.message=s??"Context id is not valid"}};c(ei,"ContextIdNotValid");let H=ei;const ti=class ti extends Y{constructor(s){super(s),this.name="ProfileNotFound",this.message=s??"Profile not found"}};c(ti,"ProfileNotFound");let x=ti;const si=class si extends D{async processAsync(s){super.processAsync(s),this.validateData(s);const e=await this.createWideframesAwaitingAsync(s);e&&this.sendMessageAsync(s,e),await this.nextAsync(s)}validateData(s){const{id:e,customData:t}=s,{contextId:a,opponentId:n}=t;if(!e||typeof e!="string")throw new Q;if(!a||typeof a!="string")throw new H;if(!n||typeof n!="string")throw new F}async createWideframesAwaitingAsync(s){try{const{frameCapture:e}=this.game,{profiles:t,customData:a}=s,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=t[n],o=t[i];if(!r||!o)return null;const{photo:l,score:d=0,finished:u}=r;if(!u)return null;const{photo:f,score:w=0,finished:g}=o;return g?null:await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:f,opponentScore:w,isPlayerFinished:!0,isOpponentFinished:!1})}catch(e){return console.warn("createWideframesAwaitingAsync",e),null}}async sendMessageAsync(s,e){const{id:t,profiles:a,customData:n}=s,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const o=a[i];if(!o)throw new x;const{name:l}=o,d={data:{type:Ae.CHALLENGE_FRIEND,matchId:t,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${l} is waiting for you to finish this game. Play now!`,localizations:{vi_VN:`${l} đang chờ bạn kết thúc trận đấu. Chơi ngay!`}},image:e,strategy:"LAST",notification:"PUSH"};await GameSDK.extra.updateAsync(d)}};c(si,"SendAwaitingMessageHandler");let Hs=si;const ai=class ai extends D{async processAsync(s){await this.nextAsync(s)}async nextAsync(s){this.nextHandler&&await this.nextHandler.processAsync(s)}};c(ai,"NothingHandler");let b=ai;const{Dtos:yl}=p,ni=class ni extends D{async processAsync(s){super.processAsync(s),this.validateData(s);const{customData:e}=s,{playerId:t,opponentId:a}=e;let n=t;const i=await this.getProfile(n);if(!i)throw new x;if(this.updateMatchProfile(s,n,i),n=a,n!==ae.playerId){const r=await this.getProfile(n);if(!r)throw new x;this.updateMatchProfile(s,n,r)}else this.updateMatchProfile(s,n);await this.nextAsync(s)}validateData(s){const{customData:e}=s,{playerId:t,opponentId:a}=e;if(!t||typeof t!="string")throw new P;if(!a||typeof a!="string")throw new F}async getProfile(s){const{profile:e}=this.game;return await e.requestProfiles([s]),e.getProfiles()[s]}updateMatchProfile(s,e,t){const{name:a,photo:n}=t??ae,i=new yl.Match.Profile({id:e,name:a,photo:n}).toObject();s.profiles[e]?(s.profiles[e].name=i.name,s.profiles[e].photo=i.photo):s.profiles[e]=i}};c(ni,"GetMatchProfilesHandler");let te=ni;const ii=class ii extends E{async processAsync(s){try{this.startLog(s);const{matchId:e,playerId:t,opponentId:a}=s,n=new b(this),i=new k(this,{id:e,mode:K.CHALLENGE_FRIEND,customData:{playerId:t,opponentId:a}});n.setNext(i);const r=new js(this);i.setNext(r);const o=new te(this);r.setNext(o);const l=new Hs(this);o.setNext(l);const d=new j(this);l.setNext(d);const u=new N(this);d.setNext(u);const f=this.match.getMatchState();await n.processAsync(f)}finally{this.endLog()}}};c(ii,"AwaitChallengeMatchConcrete");let zs=ii;const ri=class ri extends Y{constructor(s){super(s),this.name="CreateContextFailed",this.message=s??"Create context failed"}};c(ri,"CreateContextFailed");let at=ri;const{Valid:yo,Object:fo}=p.Utils,oi=class oi extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e);const{opponentId:t}=this.payload,a=await this.createAsync(t);e.customData.contextId=a,await this.nextAsync(e)}async createAsync(e){try{await GameSDK.context.createAsync(e)}catch(a){this.validateError(a)}const t=GameSDK.context.getID();if(!yo.isString(t))throw new at;return t}validateError(e){if(!fo.hasOwn(e,"code"))throw e;if(e.code!=="SAME_CONTEXT"){if(e.code==="INVALID_PARAM"){if(!this.isNotConnectedPlayerError(e))throw e;return}throw e}}validateErrorMessage(e){if(!fo.hasOwn(e,"message")||!yo.isString(e.message))throw e}isNotConnectedPlayerError(e){return this.validateErrorMessage(e),e.message.indexOf("is not a connected player of the current player")>-1}};c(oi,"CreateContextHandler");let qs=oi;const ci=class ci extends Y{constructor(s){super(s),this.name="MatchAreNotOpen",this.message=s??"Match are not open"}};c(ci,"MatchAreNotOpen");let Re=ci;const{Dtos:fl,Utils:{Object:gl}}=p,li=class li extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),this.validateData(e);const t=await this.createMatchAsync(e),a=new fl.Match.Data(t).toObject();this.updateMatchState(e,a),await this.nextAsync(e)}validateData(e){const{status:t,customData:a}=e,{opponentId:n}=a;if(typeof n!="string")throw new F;if(t!==G.OPEN)throw new Re}async createMatchAsync(e){const{opponentId:t}=e.customData,{extraData:a}=this.payload;if(!t)return{};const n={opponentPlayerId:t,extraData:a};return this.match.api.getMatchAPI().createMatchAsync(n)}updateMatchState(e,t){this.updateMatchGeneral(e,t),this.updatePlayerIds(e,t),this.initializeProfiles(e),this.updateFinishStatus(e,t)}updateMatchGeneral(e,t){const{_id:a,extraData:n}=t;e.id=a||null,e.customData=gl.merge(e.customData,n)}updatePlayerIds(e,t){const{whitePlayerId:a,blackPlayerId:n}=t,{customData:i}=e,r=a===i.opponentId,o=r?n:a,l=r?a:n;e.customData.playerId=o,e.customData.opponentId=l}initializeProfiles(e){const{playerId:t,opponentId:a}=e.customData;if(!t||!a)return;const n={name:"",photo:"",finished:!1};e.profiles[t]||(e.profiles[t]={id:t,...n}),e.profiles[a]||(e.profiles[a]={id:a,...n})}updateFinishStatus(e,t){const{playerId:a,opponentId:n}=e.customData;if(!a||!n)return;const{whitePlayerId:i,whitePlayerFinish:r,blackPlayerFinish:o}=t,l=i===e.customData.opponentId,d=l?o:r,u=l?r:o;e.profiles[a].finished=d,e.profiles[n].finished=u}};c(li,"CreateMatchHandler");let Ct=li;const di=class di extends D{async processAsync(s){if(super.processAsync(s),s.status!==G.OPEN)throw new Re;this.startMatch(s),await this.nextAsync(s)}startMatch(s){s.status=G.ACTIVE,s.startAt=Date.now()}};c(di,"StartMatchHandler");let z=di;const hi=class hi extends D{async processAsync(s){super.processAsync(s),this.validateData(s);const e=await this.createWideframesChallengeAsync(s);e&&this.sendMessageAsync(s,e),await this.nextAsync(s)}validateData(s){const{id:e,customData:t}=s,{contextId:a,opponentId:n}=t;if(!e||typeof e!="string")throw new Q;if(!a||typeof a!="string")throw new H;if(!n||typeof n!="string")throw new F}async createWideframesChallengeAsync(s){try{const{frameCapture:e}=this.game,{profiles:t,customData:a}=s,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=t[n],o=t[i];if(!r||!o)return null;const{photo:l,score:d=0}=r,{photo:u,score:f=0}=o;return await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:u,opponentScore:f,isPlayerFinished:!1,isOpponentFinished:!1})}catch(e){return console.warn("createWideframesChallengeAsync",e),null}}async sendMessageAsync(s,e){const{id:t,profiles:a,customData:n}=s,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const{name:o}=a[i],l={data:{type:Ae.CHALLENGE_FRIEND,matchId:t,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${o} challenges you`,localizations:{vi_VN:`${o} thử thách bạn trong trận đấu này. Chơi ngay!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};await GameSDK.extra.updateAsync(l)}};c(hi,"SendChallengeMessageHandler");let Tt=hi;const ui=class ui extends E{async processAsync(s){try{this.startLog(s);const{playerId:e,opponentId:t,extraData:a}=s,n=new b(this),i=new qs(this,{opponentId:t});n.setNext(i);const r=new k(this,{mode:K.CHALLENGE_FRIEND,customData:{playerId:e,opponentId:t}});i.setNext(r);const o=new Ct(this,{extraData:a});r.setNext(o);const l=new te(this);o.setNext(l);const d=new z(this);l.setNext(d);const u=new j(this);d.setNext(u);const f=new Tt(this);u.setNext(f);const w=new N(this);f.setNext(w);const g=this.match.getMatchState();await n.processAsync(g)}finally{this.endLog()}}};c(ui,"ChallengeFriendConcrete");let Ys=ui;const pi=class pi extends Error{constructor(s){super(s),this.name="SameContext",this.message=s??"Same context"}};c(pi,"SameContext");let nt=pi;const{Utils:go}=p,yi=class yi extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e);const{contextId:t}=this.payload;await this.switchAsync(t),e.customData.contextId=t,await this.nextAsync(e)}checkSameContext(e){const t=e==="SOLO",a=GameSDK.context.getID();if(a===e)throw new nt;if(t&&a===null)throw new nt}async switchAsync(e){const t=e==="SOLO";try{this.checkSameContext(e),await GameSDK.context.switchAsync(e,t)}catch(a){if(a instanceof nt)return;if(!go.Object.hasOwn(a,"code"))throw a;if(go.Device.isAndroid()&&t&&a.code==="INVALID_PARAM")return;if(a.code!=="SAME_CONTEXT")throw a}}};c(yi,"SwitchContextHandler");let _e=yi;const{Dtos:ml,Utils:{Object:wl}}=p,fi=class fi extends D{async processAsync(s){super.processAsync(s),this.validateMatchData(s);const e=await this.getMatchAsync(s),t=new ml.Match.Data(e).toObject();this.validateContinueMatchData(s,t),this.updateMatchData(s,t),this.validatePlayerTurn(s),await this.nextAsync(s)}validateMatchData(s){const{id:e,status:t}=s;if(typeof e!="string")throw new Q;if(t!==G.OPEN)throw new Re}validateContinueMatchData(s,e){const{id:t,customData:a}=s,{_id:n,whitePlayerId:i,blackPlayerId:r}=e;if(typeof n!="string"||n!==t)throw console.warn("🤖 ? respMatchDataValidated",e),new tt;const{playerId:o}=a,l=i===o,d=r===o;if(!l&&r===ae.playerId)throw new ze;if(!l&&!d)throw new st}validatePlayerTurn(s){const{profiles:e,customData:t}=s,{playerId:a}=t;if(typeof a!="string")throw new P;const{finished:n}=e[a];if(n)throw new gt}async getMatchAsync(s){const{id:e}=s;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):{}}updateMatchData(s,e){this.updateMatchGeneral(s,e),this.updatePlayerIds(s,e),this.initializeProfiles(s),this.updateScoresAndStatus(s,e)}updateMatchGeneral(s,e){const{extraData:t}=e;s.customData=wl.merge(s.customData,t)}updatePlayerIds(s,e){const{whitePlayerId:t,blackPlayerId:a}=e,n=t===s.customData.playerId;s.customData.playerId=n?t:a,s.customData.opponentId=n?a:t}initializeProfiles(s){const{playerId:e,opponentId:t}=s.customData;if(!e||!t)return;const a={name:"",photo:"",finished:!1};s.profiles[e]||(s.profiles[e]={id:e,...a}),s.profiles[t]||(s.profiles[t]={id:t,...a})}updateScoresAndStatus(s,e){const{playerId:t,opponentId:a}=s.customData;if(!t||!a)return;const{whitePlayerId:n,whitePlayerScore:i,whitePlayerFinish:r,blackPlayerScore:o,blackPlayerFinish:l}=e,d=n===t;s.profiles[t].score=d?i:o,s.profiles[a].score=d?o:i,s.profiles[t].finished=d?r:l,s.profiles[a].finished=d?l:r}};c(fi,"ContinueMatchHandler");let Qs=fi;const gi=class gi extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){if(super.processAsync(e),this.payload.ignore){await this.nextAsync(e);return}this.validateData(e);const t=await this.createWideframesCurrentScoreAsync();t&&this.sendMessageAsync(e,t),await this.nextAsync(e)}validateData(e){const{id:t,customData:a}=e,{contextId:n,opponentId:i}=a;if(!t||typeof t!="string")throw new Q;if(!n||typeof n!="string")throw new H;if(!i||typeof i!="string")throw new F}async createWideframesCurrentScoreAsync(){try{const{player:e,frameCapture:t}=this.game,{playerId:a,photo:n}=e.getPlayer();return await t.wideframe.renderUpdateChallenge({playerId:a,playerPhoto:n})}catch(e){return console.warn("createWideframesCurrentScoreAsync",e),null}}async sendMessageAsync(e,t){const{id:a,profiles:n,customData:i}=e,{playerId:r,opponentId:o}=i;if(!r||typeof r!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const l=n[r];if(!l)throw new x;const{name:d}=l,u={data:{type:Ae.CHALLENGE_FRIEND,matchId:a,playerId:r,opponentId:o},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${d} made an update.`,localizations:{vi_VN:`${d} đã cập nhật trận đấu. Chơi ngay!`}},image:t,strategy:"LAST",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(u)}};c(gi,"SendUpdateMessageHandler");let Xs=gi;const mi=class mi extends E{async processAsync(s){try{this.startLog(s);const{contextId:e,matchId:t,playerId:a,opponentId:n,sendUpdateMessage:i=!0}=s,r=new b(this),o=new _e(this,{contextId:e});r.setNext(o);const l=new k(this,{id:t,mode:K.CHALLENGE_FRIEND,customData:{playerId:a,opponentId:n}});o.setNext(l);const d=new Qs(this);l.setNext(d);const u=new te(this);d.setNext(u);const f=new z(this);u.setNext(f);const w=new Xs(this,{ignore:!i});f.setNext(w);const g=new j(this);w.setNext(g);const I=new N(this);g.setNext(I);const A=this.match.getMatchState();await r.processAsync(A)}finally{this.endLog()}}};c(mi,"ContinueChallengeMatchConcrete");let Js=mi;const{Plugins:Al,Utils:Dl}=p,{Analytics:Il}=Al,{String:mo,Valid:wo}=Dl,wi=class wi extends D{async processAsync(s){super.processAsync(s);const{customData:e,mode:t,startAt:a,finishAt:n}=s,{level:i}=e;this.validateMode(t),this.validateLevel(i);const{analytics:r}=this.game,o=Math.floor((n-a)/1e3);r.event(Il.Events.MATCH_END,{level:i,game_mode:mo.toUpperCamelCase(t),level_name:this.getLevelName(i),time_played:o}),await this.nextAsync(s)}validateMode(s){if(!wo.isString(s))throw new et}validateLevel(s){if(!wo.isNumber(s))throw new St}getLevelName(s){return`Level ${mo.padStart(s.toString(),5,"0")}`}};c(wi,"LogMatchFinishedHandler");let De=wi;const Ai=class Ai extends Error{constructor(s){super(s),this.name="LeaderboardNotExist",this.message=s??"Leaderboard not exist in game"}};c(Ai,"LeaderboardNotExist");let Nt=Ai;const Di=class Di extends Error{constructor(s){super(s),this.name="ScoreNotValid",this.message=s??"Score is not valid"}};c(Di,"ScoreNotValid");let it=Di;const{Utils:{Valid:vl},Configs:{Leaderboards:{LeaderboardList:Pl}}}=p,Ii=class Ii extends D{constructor(e,t){super(e);h(this,"payload");h(this,"skipPostScore");this.payload={score:0,playerId:""},this.skipPostScore=!!(t!=null&&t.ignore)}async processAsync(e){if(super.processAsync(e),this.skipPostScore){await this.nextAsync(e);return}this.setupSetScorePayload(e),"submitGameResultsAsync"in GameSDK.extra&&await GameSDK.extra.submitGameResultsAsync(this.payload.score);for(const t of Pl){const{Id:a,Mode:n}=t;!e.mode||!this.isValidMode(n,e.mode)||this.setLeaderboardScoreAsync({leaderboardId:a,...this.payload})}await this.nextAsync(e)}isValidMode(e,t){return e===t}async setupSetScorePayload(e){const{profiles:t,customData:a}=e,{playerId:n}=a;if(!n||!t[n])throw new x;const{score:i}=t[n];if(!vl.isNumber(i))throw new it;this.payload={score:i,playerId:n}}async setLeaderboardScoreAsync(e){try{const{playerId:t,score:a,leaderboardId:n}=e,i=this.game.leaderboard.getLeaderboardName(n);if(!i)throw new Nt;await this.game.leaderboard.setLeaderboardScoreAsync(i,t,a)}catch(t){console.warn("setLeaderboardScoreAsync",t)}}};c(Ii,"PostGlobalLeaderboardsScoreHandler");let Me=Ii;const{Dtos:El,Utils:Sl}=p,{Valid:Ot,Object:xl}=Sl,vi=class vi extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),this.validateMatchData(e);const{useAPI:t}=this.payload;if(t){const a=await this.finishMatchAsync(e),n=new El.Match.Data(a).toObject();this.updateMatchFromAPI(e,n)}else this.updateMatchData(e);this.updateMatchState(e),await this.nextAsync(e)}validateMatchData(e){const{status:t,profiles:a,customData:n}=e;if(t!==G.ACTIVE)throw new xt;const{playerId:i}=n;if(!i||!xl.hasOwn(a,i))throw new st}updateMatchData(e){const{playerId:t}=e.customData;if(!Ot.isString(t))throw new P;e.profiles[t].finished=!0}updateMatchState(e){e.status=G.FINISHED,e.finishAt=Date.now()}async finishMatchAsync(e){const{id:t,profiles:a,customData:n}=e,{level:i,playerId:r}=n;if(!Ot.isString(r))throw new P;const{score:o}=a[r],{extraData:l}=this.payload,d={matchId:t??"",score:o,level:i,extraData:l};return this.match.api.getMatchAPI().finishMatchAsync(d)}updateMatchFromAPI(e,t){const{playerId:a,opponentId:n}=e.customData;if(!Ot.isString(a))throw new P;if(!Ot.isString(n))throw new F;const{whitePlayerId:i,whitePlayerScore:r,blackPlayerScore:o,whitePlayerFinish:l,blackPlayerFinish:d}=t,u=a===i,f=u?r:o,w=u?o:r,g=u?l:d,I=u?d:l;e.profiles[a].score=f,e.profiles[n].score=w,e.profiles[a].finished=g,e.profiles[n].finished=I}};c(vi,"FinishMatchHandler");let Ie=vi;const Pi=class Pi extends D{async processAsync(s){super.processAsync(s),this.validateData(s);const e=await this.createWideframesResultAsync(s);e&&this.progressSendFinishedMessage(s,e),await this.nextAsync(s)}validateData(s){const{id:e,customData:t}=s,{contextId:a,opponentId:n}=t;if(!e||typeof e!="string")throw new Q;if(!a||typeof a!="string")throw new H;if(!n||typeof n!="string")throw new F}async createWideframesResultAsync(s){try{const{frameCapture:e}=this.game,{profiles:t,customData:a}=s,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=t[n],o=t[i];if(!r||!o)return null;const{photo:l,score:d=0,finished:u}=r,{photo:f,score:w=0,finished:g}=o;return await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:f,opponentScore:w,isPlayerFinished:!!u,isOpponentFinished:!!g})}catch(e){return console.warn("createWideframesResultAsync",e),null}}progressSendFinishedMessage(s,e){const{profiles:t,customData:a}=s,{playerId:n,opponentId:i}=a;if(!n||typeof n!="string")throw new P;if(!i||typeof i!="string")throw new F;if(!t[n]||!t[i])throw new x;const{score:r=0,finished:o}=t[n],{score:l=0,finished:d}=t[i];o?this.sendFinishMessageAsync(s,e):d&&r>l?this.sendBestScoreMessageAsync(s,e):this.sendPlayTurnMessageAsync(s,e)}async sendFinishMessageAsync(s,e){const{id:t,profiles:a,customData:n}=s,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const o=a[i];if(!o)throw new x;const{name:l}=o,d={data:{type:Ae.CHALLENGE_FRIEND,matchId:t,playerId:i,opponentId:r,status:G.FINISHED},action:"CUSTOM",template:"finished",cta:{default:"See result",localizations:{vi_VN:"Xem kết quả"}},text:{default:`${l} just finished. Check them now.`,localizations:{vi_VN:`${l} vừa hoàn thành màn chơi. Nhấn để xem kết quả trận đấu.`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(d)}async sendPlayTurnMessageAsync(s,e){const{id:t,profiles:a,customData:n}=s,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;const o=a[i];if(!o)throw new x;const{name:l,score:d}=o,u={data:{type:Ae.CHALLENGE_FRIEND,matchId:t,playerId:i,opponentId:r,status:G.ACTIVE},action:"CUSTOM",template:"finished",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${l} got ${d} scores. So easy! Can you?`,localizations:{vi_VN:`${l} đã đạt ${d} điểm! Nhấn Chơi để so tài!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(u)}async sendBestScoreMessageAsync(s,e){const{id:t,profiles:a,customData:n}=s,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;const o=a[i];if(!o)throw new x;const{name:l,score:d}=o,u={data:{type:Ae.CHALLENGE_FRIEND,matchId:t,playerId:i,opponentId:r,status:G.FINISHED},action:"CUSTOM",template:"pass_score",cta:{default:"See result",localizations:{vi_VN:"Xem kết quả"}},text:{default:`${l} beat your high score. Their score: ${d}`,localizations:{vi_VN:`${l} đã vượt qua điểm số của bạn, với ${d} điểm!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(u)}};c(Pi,"SendFinishedMessageHandler");let Zs=Pi;const Ei=class Ei extends D{constructor(e,t){super(e);h(this,"ignore");this.ignore=!!(t!=null&&t.ignore)}async processAsync(e){super.processAsync(e),this.setPlayerBestScore(e),await this.nextAsync(e)}setPlayerBestScore(e){if(this.ignore)return;const{profiles:t,customData:a}=e,{playerId:n}=a;if(!n||!t[n])throw new x;const{player:i}=this.game,r=i.getBestScore()||0,{score:o=0}=t[n];o<=r||(i.setBestScore(o),t[n].bestScore=o)}};c(Ei,"SetPlayerBestScoreHandler");let ve=Ei;const Si=class Si extends E{async processAsync(s){try{this.startLog(s);const{extraData:e}=s??{},t=new b(this),a=new Ie(this,{useAPI:!0,extraData:e});t.setNext(a);const n=new Zs(this);a.setNext(n);const i=new De(this);n.setNext(i);const r=new ve(this);i.setNext(r);const o=new Me(this);r.setNext(o);const l=new N(this);o.setNext(l);const d=this.match.getMatchState();await t.processAsync(d)}finally{this.endLog()}}};c(Si,"FinishChallengeMatchConcrete");let ea=Si;const xi=class xi extends Error{constructor(s){super(s),this.name="ContextAreSolo",this.message=s??"Context are solo"}};c(xi,"ContextAreSolo");let ta=xi;const bi=class bi extends Error{constructor(s){super(s),this.name="ContextNotChallenge",this.message=s??"Context is not a challenge"}};c(bi,"ContextNotChallenge");let sa=bi;const Ci=class Ci extends Error{constructor(s){super(s),this.name="NetworkFailure",this.message=s??"Network failure"}};c(Ci,"NetworkFailure");let aa=Ci;const{Utils:bl,Dtos:Cl}=p,{Array:Tl,Object:Nl}=bl,Ti=class Ti extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),this.checkCurrentContext();const t=await this.getOpponentIdFromContextAsync();e.customData.opponentId=t,await this.nextAsync(e)}checkCurrentContext(){const e=GameSDK.context.getID();if(typeof e!="string")throw new H;if(e==="SOLO")throw new ta}async getOpponentIdFromContextAsync(){const{ignoreId:e}=this.payload,t=await this.getContextPlayers([e]);if(t.length>1)throw new sa;let a=ae;return t.length===1&&(a=t[0]),a.playerId}async getContextPlayers(e){try{const t=await GameSDK.context.getPlayersAsync(),a=[];for(const n of t){const i=n.getID();if(e.indexOf(i)>-1)continue;const r=n.getName();if(!r)continue;const o=n.getPhoto();a.push(new Cl.Player.Info({playerId:i,name:r,photo:o}).toObject())}return Tl.unique(a)}catch(t){if(Nl.hasOwn(t,"code")&&t.code==="NETWORK_FAILURE")throw new aa;return[]}}};c(Ti,"GetOpponentChallengeContextHandler");let Lt=Ti;const Ni=class Ni extends Error{constructor(s){super(s),this.name="ContextIsTournament",this.message=s??"Context is a tournament"}};c(Ni,"ContextIsTournament");let rt=Ni;const{Object:Ol}=p.Utils,Oi=class Oi extends D{async processAsync(s){super.processAsync(s);const e=await this.chooseAsync();await this.checkContextTournament(),s.customData.contextId=e,await this.nextAsync(s)}async chooseAsync(){try{await GameSDK.context.chooseAsync({filters:["INCLUDE_EXISTING_CHALLENGES"],minSize:2,maxSize:2})}catch(e){if(!Ol.hasOwn(e,"code")||e.code!=="SAME_CONTEXT")throw e}const s=GameSDK.context.getID();if(typeof s!="string")throw new at;return s}async checkContextTournament(){try{if(!GameSDK.context.getID())return;throw"getTournamentAsync"in GameSDK?(await GameSDK.getTournamentAsync(),new rt):new S("getTournamentAsync")}catch(s){if(s instanceof rt)throw s}}};c(Oi,"ChooseContextHandler");let na=Oi;const Li=class Li extends E{async processAsync(s){try{this.startLog(s);const{playerId:e,extraData:t}=s,a=new b(this),n=new na(this);a.setNext(n);const i=new k(this,{mode:K.CHALLENGE_FRIEND,customData:{playerId:e}});n.setNext(i);const r=new Lt(this,{ignoreId:e});i.setNext(r);const o=new Ct(this,{extraData:t});r.setNext(o);const l=new te(this);o.setNext(l);const d=new z(this);l.setNext(d);const u=new j(this);d.setNext(u);const f=new Tt(this);u.setNext(f);const w=new N(this);f.setNext(w);const g=this.match.getMatchState();await a.processAsync(g)}finally{this.endLog()}}};c(Li,"InviteFriendsConcrete");let ia=Li;const Ri=class Ri extends Error{constructor(s){super(s),this.name="JoinMatchFailed",this.message=s??"Join match failed"}};c(Ri,"JoinMatchFailed");let ra=Ri;const _i=class _i extends Error{constructor(s){super(s),this.name="MatchAreFinished",this.message=s??"Match are finished"}};c(_i,"MatchAreFinished");let oa=_i;const Mi=class Mi extends Error{constructor(s){super(s),this.name="OtherPlayerHasJoinedMatch",this.message=s??"Other player has joined match"}};c(Mi,"OtherPlayerHasJoinedMatch");let ca=Mi;const{Dtos:Ll,Utils:{Object:Rl}}=p,$i=class $i extends D{async processAsync(s){super.processAsync(s),this.validateMatchData(s);const e=await this.joinMatchAsync(s),t=new Ll.Match.Data(e).toObject();this.validateJoinMatchData(s,t),this.updateMatchData(s,t),await this.nextAsync(s)}validateMatchData(s){const{status:e}=s;if(e!==G.OPEN)throw new Re}validateJoinMatchData(s,e){const{id:t,customData:a}=s,{_id:n,blackPlayerId:i,whitePlayerId:r,whitePlayerFinish:o,blackPlayerFinish:l}=e,d=i===a.playerId,u=r===a.opponentId;if(typeof n!="string"||n!==t||!u)throw console.warn("🤖 ? matchData",e),new ra;if(o&&l)throw new oa;if(!d)throw new ca}async joinMatchAsync(s){const{id:e}=s;return e?this.match.api.getMatchAPI().joinMatchAsync(e):{}}updateMatchData(s,e){this.updateMatchGeneral(s,e),this.updatePlayerIds(s,e),this.initializeProfiles(s),this.updateScoresAndStatus(s,e)}updateMatchGeneral(s,e){const{extraData:t}=e;s.customData=Rl.merge(s.customData,t)}updatePlayerIds(s,e){const{whitePlayerId:t,blackPlayerId:a}=e,{customData:n}=s,i=t===n.playerId,r=i?t:a,o=i?a:t;s.customData.playerId=r,s.customData.opponentId=o}initializeProfiles(s){const{playerId:e,opponentId:t}=s.customData;if(!e||!t)return;const a={name:"",photo:"",finished:!1};s.profiles[e]||(s.profiles[e]={id:e,...a}),s.profiles[t]||(s.profiles[t]={id:t,...a})}updateScoresAndStatus(s,e){const{playerId:t,opponentId:a}=s.customData;if(!t||!a)return;const{whitePlayerId:n,whitePlayerScore:i,whitePlayerFinish:r,blackPlayerScore:o,blackPlayerFinish:l}=e,d=n===s.customData.playerId;s.profiles[t].score=d?i:o,s.profiles[a].score=d?o:i,s.profiles[t].finished=d?r:l,s.profiles[a].finished=d?l:r}};c($i,"JoinMatchHandler");let la=$i;const Gi=class Gi extends D{async processAsync(s){super.processAsync(s),this.validateData(s);const e=await this.createWideframesAcceptedAsync(s);e&&this.sendMessageAsync(s,e),await this.nextAsync(s)}validateData(s){const{id:e,customData:t}=s,{contextId:a,opponentId:n}=t;if(!e||typeof e!="string")throw new Q;if(!a||typeof a!="string")throw new H;if(!n||typeof n!="string")throw new F}async createWideframesAcceptedAsync(s){try{const{frameCapture:e}=this.game,{profiles:t,customData:a}=s,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=t[n],o=t[i];if(!r||!o)return null;const{photo:l,score:d=0,finished:u}=r;if(u)return null;const{photo:f,score:w=0,finished:g}=o;return g?await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:f,opponentScore:w,isPlayerFinished:!1,isOpponentFinished:!0}):null}catch(e){return console.warn("createWideframesAcceptedAsync",e),null}}async sendMessageAsync(s,e){const{id:t,profiles:a,customData:n}=s,{playerId:i,opponentId:r}=n;if(!i||typeof i!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const o=a[i];if(!o)throw new x;const{name:l}=o,d={data:{type:Ae.CHALLENGE_FRIEND,matchId:t,playerId:i,opponentId:r},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${l} accepted the challenge.`,localizations:{vi_VN:`${l} đã chấp nhận tham gia trận đấu.`}},image:e,strategy:"LAST",notification:"PUSH"};await GameSDK.extra.updateAsync(d)}};c(Gi,"SendAcceptedMessageHandler");let da=Gi;const Fi=class Fi extends E{async processAsync(s){try{this.startLog(s);const{matchId:e,playerId:t,opponentId:a}=s,n=new b(this),i=new k(this,{id:e,mode:K.CHALLENGE_FRIEND,customData:{playerId:t,opponentId:a}});n.setNext(i);const r=new la(this);i.setNext(r);const o=new te(this);r.setNext(o);const l=new z(this);o.setNext(l);const d=new da(this);l.setNext(d);const u=new j(this);d.setNext(u);const f=new N(this);u.setNext(f);const w=this.match.getMatchState();await n.processAsync(w)}finally{this.endLog()}}};c(Fi,"JoinChallengeMatchConcrete");let ha=Fi;const Ao={_id:"",status:"",appId:"",createdAt:"",startedAt:null,finishedAt:null,winnerId:"",whitePlayerId:"",blackPlayerId:"",whitePlayerScore:0,blackPlayerScore:0,whitePlayerFinish:!1,blackPlayerFinish:!1,extraData:{}},{Configs:{AppId:_l},Utils:{Valid:V}}=p,B="is invalid",ki=class ki extends U{setupData(s){this.lazySetupData(s)}validateStructure(s){this.lazyValidateStructure(s)}validateData(s){this.lazyValidateData(s)}validateId(s){(!V.isString(s)||!s)&&this.exception("_id",B)}validateStatus(s){(!V.isString(s)||!s)&&this.exception("status",B)}validateAppId(s){(!V.isString(s)||s!==_l)&&this.exception("appId",B)}validateCreatedAt(s){V.isString(s)||this.exception("createdAt",B)}validateStartedAt(s){s!==null&&(V.isString(s)||this.exception("startedAt",B))}validateFinishedAt(s){s!==null&&(V.isString(s)||this.exception("finishedAt",B))}validateExtraData(s){s!==null&&(V.isObject(s)||this.exception("extraData",B))}validateWinnerId(s){s!==null&&(!V.isString(s)||!s)&&this.exception("winnerId",B)}validateWhitePlayerId(s){(!V.isString(s)||!s)&&this.exception("whitePlayerId",B)}validateBlackPlayerId(s){(!V.isString(s)||!s)&&this.exception("blackPlayerId",B)}validateWhitePlayerScore(s){V.isNumber(s)||this.exception("whitePlayerScore",B)}validateBlackPlayerScore(s){V.isNumber(s)||this.exception("blackPlayerScore",B)}validateWhitePlayerFinish(s){V.isBoolean(s)||this.exception("whitePlayerFinish",B)}validateBlackPlayerFinish(s){V.isBoolean(s)||this.exception("blackPlayerFinish",B)}toObject(){return super.toObject()}static getDefaultData(){return Ao}};c(ki,"RespMatchDataDtos");let ot=ki;ot.addDefaultData(Ao);const Vi=class Vi extends Error{constructor(s){super(s),this.name="MatchAreNotFinished",this.message=s||"Match are not finished"}};c(Vi,"MatchAreNotFinished");let ua=Vi;const Bi=class Bi extends Error{constructor(s){super(s),this.name="OpponentNotFinishedMatch",this.message=s||"Opponent not finished match"}};c(Bi,"OpponentNotFinishedMatch");let pa=Bi;const{Utils:{Object:Ml}}=p,Ui=class Ui extends D{async processAsync(s){super.processAsync(s),this.validateMatchData(s);const e=await this.getMatchAsync(s),t=new ot(e).toObject();this.validateResultMatchData(s,t),this.updateMatchData(s,t),this.validatePlayerTurn(s),this.validateOpponentTurn(s),await this.nextAsync(s)}validateMatchData(s){const{id:e}=s;if(typeof e!="string")throw new Q}validateResultMatchData(s,e){const{id:t}=s,{_id:a,whitePlayerFinish:n,blackPlayerFinish:i}=e;if(typeof a!="string"||a!==t)throw new tt;if(!n&&!i)throw new ua}validatePlayerTurn(s){const{profiles:e,customData:t}=s,{playerId:a}=t;if(typeof a!="string")throw new P;const{finished:n}=e[a];if(!n)throw new bt}validateOpponentTurn(s){const{profiles:e,customData:t}=s,{opponentId:a}=t;if(typeof a!="string")throw new F;const{finished:n}=e[a];if(!n)throw new pa}async getMatchAsync(s){const{id:e}=s;return e?this.match.api.getMatchAPI().getMatchDetailByIdAsync(e):null}updateMatchData(s,e){this.updateMatchGeneral(s,e),this.updatePlayerIds(s,e),this.initializeProfiles(s),this.updateScoresAndStatus(s,e)}updateMatchGeneral(s,e){const{extraData:t}=e;s.status=G.FINISHED,s.customData=Ml.merge(s.customData,t)}updatePlayerIds(s,e){const{whitePlayerId:t,blackPlayerId:a}=e,{customData:n}=s,i=t===n.playerId,r=i?t:a,o=i?a:t;s.customData.playerId=r,s.customData.opponentId=o}initializeProfiles(s){const{playerId:e,opponentId:t}=s.customData;if(!e||!t)return;const a={name:"",photo:"",finished:!0};s.profiles[e]||(s.profiles[e]={id:e,...a}),s.profiles[t]||(s.profiles[t]={id:t,...a})}updateScoresAndStatus(s,e){const{playerId:t,opponentId:a}=s.customData;if(!t||!a)return;const{whitePlayerId:n,whitePlayerScore:i,whitePlayerFinish:r,blackPlayerScore:o,blackPlayerFinish:l}=e,d=n===s.customData.playerId;s.profiles[t].score=d?i:o,s.profiles[a].score=d?o:i,s.profiles[t].finished=d?r:l,s.profiles[a].finished=d?l:r}};c(Ui,"ResultMatchHandler");let ya=Ui;const Wi=class Wi extends E{async processAsync(s){try{this.startLog(s);const{matchId:e,playerId:t,opponentId:a}=s,n=new b(this),i=new k(this,{id:e,mode:K.CHALLENGE_FRIEND,customData:{playerId:t,opponentId:a}});n.setNext(i);const r=new ya(this);i.setNext(r);const o=new te(this);r.setNext(o);const l=new N(this);o.setNext(l);const d=this.match.getMatchState();await n.processAsync(d)}finally{this.endLog()}}};c(Wi,"ResultChallengeMatchConcrete");let fa=Wi;const ji=class ji extends E{constructor(){super(...arguments);h(this,"fallbackSingleMode");h(this,"startFLowChallengeFriend",c(async e=>{try{return await this.match.challenge.invite.processAsync(e),!0}catch(t){return t}},"startFLowChallengeFriend"));h(this,"startFlowTournament",c(async e=>{try{const t=GameSDK.context.getID();if(typeof t!="string")throw new H;await this.match.tournament.continue.processAsync({playerId:e,contextId:t})}catch{await this.startFlowSingle(e)}},"startFlowTournament"));h(this,"startFlowSingle",c(async e=>this.match.single.start.processAsync({playerId:e}),"startFlowSingle"))}async processAsync(e){try{this.startLog(e);const{playerId:t,extraData:a,fallbackSingleMode:n}=e;this.fallbackSingleMode=n;const i=await this.startFLowChallengeFriend({playerId:t,extraData:a});if(i===!0)return;if(i instanceof rt)await this.startFlowTournament(t);else if(this.fallbackSingleMode)await this.startFlowSingle(t);else throw i}finally{this.endLog()}}};c(ji,"ChooseContextConcrete");let ga=ji;const Ki=class Ki extends Error{constructor(s){super(s),this.name="LeaderboardIdNotValid",this.message=s??"Leaderboard id is not valid"}};c(Ki,"LeaderboardIdNotValid");let Pe=Ki;const{Valid:Do}=p.Utils,Hi=class Hi extends D{constructor(e,t){super(e);h(this,"payload");h(this,"leaderboardPayload");this.payload=t}async processAsync(e){super.processAsync(e),this.setupSetScorePayload(e),"submitGameResultsAsync"in GameSDK.extra&&await GameSDK.extra.submitGameResultsAsync(this.payload.score),this.setLeaderboardScoreAsync(),await this.nextAsync(e)}async setupSetScorePayload(e){const{profiles:t,customData:a}=e,{playerId:n}=a;if(!n||!t[n])throw new x;const{score:i,leaderboardId:r}=this.payload;if(!Do.isNumber(i))throw new it;if(!Do.isString(r))throw new Pe;this.leaderboardPayload={score:i,playerId:n,leaderboardId:r}}async setLeaderboardScoreAsync(){try{const{playerId:e,score:t,leaderboardId:a}=this.leaderboardPayload,n=this.game.leaderboard.getLeaderboardName(a);if(!n)throw new Nt;await this.game.leaderboard.setLeaderboardScoreAsync(n,e,t)}catch(e){console.warn("setLeaderboardScoreAsync",e)}}};c(Hi,"SetLeaderboardScoreHandler");let Rt=Hi;const{Utils:{Valid:$l}}=p,zi=class zi extends Rt{constructor(s){super(s,{score:0,leaderboardId:""})}async setupSetScorePayload(s){const{profiles:e,customData:t}=s,{playerId:a,leaderboardId:n}=t;if(!n)throw new Pe;if(!a||!e[a])throw new x;const{score:i}=e[a];if(!$l.isNumber(i))throw new it;this.payload.score=i,this.payload.leaderboardId=n,super.setupSetScorePayload(s)}};c(zi,"PostLeaderboardScoreHandler");let ct=zi;const qi=class qi extends D{async processAsync(s){super.processAsync(s),this.validateData(s),this.progressSendGroupMessage(s),await this.nextAsync(s)}validateData(s){const{id:e,customData:t}=s,{contextId:a,opponentId:n}=t;if(!e||typeof e!="string")throw new Q;if(!a||typeof a!="string")throw new H;if(!n||typeof n!="string")throw new F}async createWideframesResultGroupAsync(s){try{const{frameCapture:e}=this.game,{profiles:t,customData:a}=s,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const r=t[n],o=t[i];if(!r||!o)return null;const{photo:l,score:d=0}=r,{photo:u,score:f=0}=o;return await e.wideframe.renderResultChallenge({playerId:n,playerPhoto:l,playerScore:d,opponentId:i,opponentPhoto:u,opponentScore:f,isPlayerFinished:!0,isOpponentFinished:!0})}catch(e){return console.warn("createWideframesResultGroupAsync",e),null}}async createWideframesBestScoreAsync(s){try{const{player:e,frameCapture:t}=this.game,{playerId:a}=s.customData,{playerId:n,photo:i,data:r}=e.getPlayer();if(a!==n)return null;const{score:o}=r||{};return await t.wideframe.renderShareScore({playerId:n,playerPhoto:i,playerScore:o})}catch(e){return console.warn("createWideframesBestScoreAsync",e),null}}async progressSendGroupMessage(s){const{profiles:e,customData:t}=s,{playerId:a,opponentId:n}=t;if(n&&typeof n=="string"){if(!a||typeof a!="string")throw new P;const r=e[a],o=e[n];if(!r||!o)return;const{score:l=0}=r,{score:d=0}=o;if(l>d){const u=await this.createWideframesResultGroupAsync(s);if(!u)return;this.sendBestScoreMessageAsync(s,u);return}}const i=await this.createWideframesBestScoreAsync(s);i&&this.sendChallengeMessageAsync(s,i)}async sendBestScoreMessageAsync(s,e){const{profiles:t,customData:a}=s,{playerId:n}=a;if(!n||typeof n!="string")throw new P;if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");const i=t[n];if(!i)throw new x;const{name:r,score:o}=i,d={data:{type:this.game.context.getSessionContextTypes().MATCHING_GROUP,playerId:n,playerName:r,playerScore:o},action:"CUSTOM",template:"play_turn",cta:{default:"Play",localizations:{vi_VN:"Chơi"}},text:{default:`${r} beats your high score. Their score: ${o}.`,localizations:{vi_VN:`${r} vừa vượt điểm số cao nhất của bạn! Chơi lần nữa chứ?`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(d)}async sendChallengeMessageAsync(s,e){const{profiles:t,customData:a}=s,{playerId:n}=a;if(!n||typeof n!="string")throw new P;const i=t[n];if(!i)throw new x;const{name:r,score:o}=i,d={data:{type:this.game.context.getSessionContextTypes().MATCHING_GROUP,playerId:n,playerName:r,playerScore:o},action:"CUSTOM",template:"play_turn",cta:{default:"Play",localizations:{vi_VN:"Chơi ngay"}},text:{default:`${r} got ${o} scores. So easy! Can you?`,localizations:{vi_VN:`${r} đã đạt ${o} điểm! Quá dễ luôn. Chơi lại nào!`}},image:e,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new S("updateAsync");await GameSDK.extra.updateAsync(d)}};c(qi,"SendGroupMessageHandler");let ma=qi;const Yi=class Yi extends E{async processAsync(){try{this.startLog();const s=new b(this),e=new Ie(this,{useAPI:!1});s.setNext(e);const t=new ma(this);e.setNext(t);const a=new De(this);t.setNext(a);const n=new ve(this);a.setNext(n);const i=new ct(this);n.setNext(i);const r=new N(this);i.setNext(r);const o=this.match.getMatchState();await s.processAsync(o)}finally{this.endLog()}}};c(Yi,"FinishGroupConcrete");let wa=Yi;const{Dtos:Gl}=p,Qi=class Qi extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),this.updateProfileMatchData(e),await this.nextAsync(e)}updateProfileMatchData(e){const{id:t}=this.payload,{profiles:a}=e;if(!a[t])throw new x;const n={...a[t],...this.payload},i=new Gl.Match.Profile(n).toObject();a[i.id]=i}};c(Qi,"SetProfileDataHandler");let $e=Qi;const Xi=class Xi extends E{async processAsync(s){try{this.startLog(s);const{playerId:e,opponentId:t,opponentScore:a}=s,n=new b(this),i=new k(this,{id:"7749",mode:K.MATCHING_GROUP,customData:{playerId:e,opponentId:t}});n.setNext(i);const r=new te(this);i.setNext(r);const o=new $e(this,{id:e,score:a});r.setNext(o);const l=new z(this);o.setNext(l);const d=new j(this);l.setNext(d);const u=new N(this);d.setNext(u);const f=this.match.getMatchState();await n.processAsync(f)}finally{this.endLog()}}};c(Xi,"JoinGroupConcrete");let Aa=Xi;const Ji=class Ji extends Error{constructor(s){super(s),this.name="MatchGroupNotSupported",this.message=s??"Match group is not supported"}};c(Ji,"MatchGroupNotSupported");let _t=Ji;const Zi=class Zi extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),await this.checkMatchGroupSupported();const t=await this.matchingGroup();e.customData.contextId=t,await this.nextAsync(e)}async checkMatchGroupSupported(){if(!("getSupportedAPIs"in GameSDK))throw new S("getSupportedAPIs");if(!("checkCanPlayerMatchAsync"in GameSDK.extra))throw new S("checkCanPlayerMatchAsync");if(!(GameSDK.getSupportedAPIs().indexOf("checkCanPlayerMatchAsync")>-1))throw new _t;if(!await GameSDK.extra.checkCanPlayerMatchAsync())throw new _t}async matchingGroup(){if(!("matchPlayerAsync"in GameSDK.extra))throw new S("matchPlayerAsync");const{matchTag:e,autoSwitch:t=!1,onlyExisting:a=!1}=this.payload;await GameSDK.extra.matchPlayerAsync(e,t,a);const n=GameSDK.context.getID();if(typeof n!="string")throw new at;return n}};c(Zi,"GroupContextHandler");let Da=Zi;const er=class er extends E{async processAsync(s){try{this.startLog(s);const{matchTag:e,playerId:t,options:a}=s,n=new b(this),i=new Da(this,{matchTag:e,...a});n.setNext(i);const r=new k(this,{id:"7749",mode:K.MATCHING_GROUP,customData:{playerId:t}});i.setNext(r);const o=new Lt(this,{ignoreId:t});r.setNext(o);const l=new z(this);o.setNext(l);const d=new te(this);l.setNext(d);const u=new j(this);d.setNext(u);const f=new N(this);u.setNext(f);const w=this.match.getMatchState();await n.processAsync(w)}finally{this.endLog()}}};c(er,"StartGroupConcrete");let Ia=er;const tr=class tr extends E{async processAsync(){try{this.startLog();const s=new b(this),e=new Ie(this,{useAPI:!1});s.setNext(e);const t=new De(this);e.setNext(t);const a=new ve(this);t.setNext(a);const n=new Me(this);a.setNext(n);const i=new N(this);n.setNext(i);const r=this.match.getMatchState();await s.processAsync(r)}finally{this.endLog()}}};c(tr,"FinishSingleConcrete");let va=tr;const sr=class sr extends Error{constructor(s){super(s),this.name="ProfileIdNotDefined",this.message=s??"Profile id is not defined"}};c(sr,"ProfileIdNotDefined");let Pa=sr;const{Dtos:Fl}=p,ar=class ar extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e);const{profileId:t}=this.payload;if(!t)throw new Pa;const{player:a}=this.game,n=a.getPlayerId();let i;if(t===n)i=this.getPlayerProfile();else if(i=await this.getProfileAsync(t),!i)throw new x;this.updateMatchData(i,e),await this.nextAsync(e)}getPlayerProfile(){const{player:e}=this.game,{playerId:t,name:a,photo:n,locale:i}=e.getPlayer();return{playerId:t,name:a,photo:n,locale:i}}async getProfileAsync(e){const{profile:t}=this.game;return await t.requestProfiles([e]),t.getProfiles()[e]}updateMatchData(e,t){const{playerId:a,name:n,photo:i}=e,r=new Fl.Match.Profile({id:a,name:n,photo:i}).toObject();t.profiles[a]=r}};c(ar,"GetProfileHandler");let Ee=ar;const nr=class nr extends E{async processAsync(s){try{this.startLog(s);const{playerId:e}=s,t=new b(this),a=new _e(this,{contextId:"SOLO"});t.setNext(a);const n=new k(this,{id:"123456",mode:K.SINGLE,customData:{playerId:e}});a.setNext(n);const i=new z(this);n.setNext(i);const r=new Ee(this,{profileId:e});i.setNext(r);const o=new j(this);r.setNext(o);const l=new N(this);o.setNext(l);const d=this.match.getMatchState();await t.processAsync(d)}finally{this.endLog()}}};c(nr,"StartSingleConcrete");let Ea=nr;const ir=class ir extends E{async processAsync(s){try{this.startLog(s);const{setPlayerBestScore:e=!1,postGlobalLeaderboard:t=!1}=s??{},a=new b(this),n=new Ie(this,{useAPI:!1});a.setNext(n);const i=new De(this);n.setNext(i);const r=new ve(this,{ignore:!e});i.setNext(r);const o=new Me(this,{ignore:!t});r.setNext(o);const l=new N(this);o.setNext(l);const d=this.match.getMatchState();await a.processAsync(d)}finally{this.endLog()}}};c(ir,"FinishStrategyConcrete");let Sa=ir;const rr=class rr extends E{async processAsync(s){try{this.startLog(s);const{matchId:e,playerId:t,gameMode:a,extraData:n={}}=s,i=new b(this),r=new _e(this,{contextId:"SOLO"});i.setNext(r);const o=new k(this,{id:e,mode:a,customData:{playerId:t,...n}});r.setNext(o);const l=new z(this);o.setNext(l);const d=new Ee(this,{profileId:t});l.setNext(d);const u=new j(this);d.setNext(u);const f=new N(this);u.setNext(f);const w=this.match.getMatchState();await i.processAsync(w)}finally{this.endLog()}}};c(rr,"StartStrategyConcrete");let xa=rr;const{Plugins:kl,Utils:Vl}=p,{Analytics:Bl}=kl,{String:Ul,Valid:Wl}=Vl,or=class or extends D{async processAsync(s){super.processAsync(s);const{mode:e,customData:t}=s;this.validateMode(e);const{analytics:a}=this.game,{tournamentId:n,leaderboardId:i}=t;a.event(Bl.Events.TOURNAMENT_START,{success:!0,game_mode:Ul.toUpperCamelCase(e),tournament_id:n,leaderboard_id:i}),await this.nextAsync(s)}validateMode(s){if(!Wl.isString(s))throw new et}};c(or,"LogTournamentStartHandler");let Mt=or;const cr=class cr extends Error{constructor(s){super(s),this.name="TournamentIdNotValid",this.message=s??"Tournament id is not valid"}};c(cr,"TournamentIdNotValid");let $t=cr;const{Valid:ba}=p.Utils,lr=class lr extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e);const{contextId:t}=this.payload;this.validateContextId(t);const a=await GameSDK.getTournamentAsync(),n=a.getID().toString();this.validateTournamentId(n);const i=JSON.parse(a.getPayload()||"{}"),{leaderboardId:r}=i;this.validateLeaderboardId(r),e.customData.contextId=t,e.customData.tournamentId=n,e.customData.leaderboardId=r,await this.nextAsync(e)}validateContextId(e){if(!ba.isString(e))throw new H}validateTournamentId(e){if(!ba.isString(e))throw new $t}validateLeaderboardId(e){if(!ba.isString(e)||e==="")throw new Pe}};c(lr,"ContinueTournamentHandler");let Ca=lr;const dr=class dr extends E{async processAsync(s){try{this.startLog(s);const{playerId:e,contextId:t}=s,a=new b(this),n=new Ca(this,{contextId:t});a.setNext(n);const i=new k(this,{id:"1997",mode:K.TOURNAMENT,customData:{playerId:e}});n.setNext(i);const r=new z(this);i.setNext(r);const o=new Ee(this,{profileId:e});r.setNext(o);const l=new j(this);o.setNext(l);const d=new Mt(this);l.setNext(d);const u=new N(this);l.setNext(u);const f=this.match.getMatchState();await a.processAsync(f)}finally{this.endLog()}}};c(dr,"ContinueTournamentConcrete");let Ta=dr;const{Plugins:jl}=p,{Analytics:Kl}=jl,hr=class hr extends D{async processAsync(s){super.processAsync(s);const{customData:e}=s,{analytics:t}=this.game,{tournamentId:a,leaderboardId:n}=e;t.event(Kl.Events.TOURNAMENT_CREATE,{success:!0,tournament_id:a,leaderboard_id:n}),await this.nextAsync(s)}};c(hr,"LogTournamentCreateHandler");let Na=hr;const ur=class ur extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),await this.createTournamentAsync(),await this.updateMatchStateAsync(e),await this.nextAsync(e)}async createTournamentAsync(){const{name:e,score:t,customData:a}=this.payload;await GameSDK.tournament.createAsync({initialScore:t,config:{title:e,tournamentTitle:e},data:a})}async updateMatchStateAsync(e){try{if(!("getTournamentAsync"in GameSDK))throw new S("getTournamentAsync");const t=await GameSDK.getTournamentAsync(),a=t.getContextID(),n=t.getID().toString(),{playerId:i}=this.payload;e.customData.playerId=i,e.customData.contextId=a,e.customData.tournamentId=n}catch(t){if(t instanceof S)return}}};c(ur,"CreateTournamentHandler");let Oa=ur;const{Valid:Io}=p.Utils,pr=class pr extends D{constructor(e,t){super(e);h(this,"payload");h(this,"leaderboardPayload");this.payload=t}async processAsync(e){super.processAsync(e),this.validatePayload(),await this.setupCreatePayload(e),await this.createLeaderboardAsync(e),await this.nextAsync(e)}validatePayload(){const{leaderboardId:e}=this.payload;if(!Io.isString(e))throw new Pe}validatePlayerId(e){if(!Io.isString(e))throw new P}async setupCreatePayload(e){const{playerId:t}=e.customData;this.validatePlayerId(t);const{name:a,leaderboardId:n,customData:i}=this.payload;this.leaderboardPayload={_id:n,name:a??"",createdBy:t,description:JSON.stringify(i)}}async createLeaderboardAsync(e){const t=await this.game.leaderboard.createLeaderboardAsync(this.leaderboardPayload);e.customData.leaderboardId=t}};c(pr,"CreateLeaderboardHandler");let La=pr;const yr=class yr extends E{async processAsync(s){try{this.startLog(s);const{playerId:e,name:t,score:a,leaderboardId:n,payload:i}=s,r=new b(this),o=new _e(this,{contextId:"SOLO"});r.setNext(o);const l=new Oa(this,{name:t,score:a,playerId:e,customData:i});o.setNext(l);const d=new Ee(this,{profileId:e});l.setNext(d);const u=new $e(this,{id:e,score:a});d.setNext(u);const f=new La(this,{name:t,customData:i,leaderboardId:n});u.setNext(f);const w=new ct(this);f.setNext(w);const g=new Na(this);w.setNext(g);const I=this.match.getMatchState();await r.processAsync(I)}finally{this.endLog()}}};c(yr,"CreateTournamentConcrete");let Ra=yr;const{Analytics:vo}=p.Plugins,{Valid:Hl}=p.Utils,fr=class fr extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),this.validateData(e),await this.postScoreTournamentAsync(e),await this.nextAsync(e)}validateData(e){const{profiles:t,customData:a}=e,{playerId:n}=a;if(this.validatePlayerId(n),!t[n])throw new x}validatePlayerId(e){if(!Hl.isString(e))throw new P}getPlayerProfile(e){const{profiles:t,customData:a}=e,{playerId:n}=a;return this.validatePlayerId(n),t[n]}isNewBestScore(e){const t=this.getPlayerProfile(e),{score:a=0,bestScore:n=0}=t;return a>n}async postScoreTournamentAsync(e){const{analytics:t}=window.game,a=this.getPlayerProfile(e),{score:n=0}=a;let i=null,r=!1;const{checkBestScore:o}=this.payload,l=this.isNewBestScore(e);try{if(!("getTournamentAsync"in GameSDK))throw new S("getTournamentAsync");await GameSDK.getTournamentAsync(),!o||l?(i=vo.Events.TOURNAMENT_SHARE,await GameSDK.tournament.shareAsync({score:n})):(i=vo.Events.TOURNAMENT_POST_SCORE,await GameSDK.tournament.postScoreAsync(n)),r=!0}catch(d){console.warn("Post Score Tournament",d)}finally{i&&t.event(i,{success:r})}}};c(fr,"PostScoreTournamentHandler");let _a=fr;const gr=class gr extends E{async processAsync(s){try{this.startLog(s);const{playerId:e,bestScore:t,checkBestScore:a=!1}=s,n=new b(this),i=new Ie(this,{useAPI:!1});n.setNext(i);const r=new $e(this,{id:e,bestScore:t});i.setNext(r);const o=new _a(this,{checkBestScore:a});r.setNext(o);const l=new De(this);o.setNext(l);const d=new ve(this);l.setNext(d);const u=new ct(this);d.setNext(u);const f=new Me(this);u.setNext(f);const w=new N(this);f.setNext(w);const g=this.match.getMatchState();await n.processAsync(g)}finally{this.endLog()}}};c(gr,"FinishTournamentConcrete");let Ma=gr;const{Valid:$a,Object:zl}=p.Utils,mr=class mr extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e);const{tournamentId:t}=this.payload;this.validateTournamentId(t),await this.joinTournamentAsync(t);const a=await GameSDK.getTournamentAsync(),n=a.getContextID();this.validateContextId(n);const i=JSON.parse(a.getPayload()||"{}"),{leaderboardId:r}=i;this.validateLeaderboardId(r),e.customData.contextId=n,e.customData.tournamentId=t,e.customData.leaderboardId=r,await this.nextAsync(e)}validateTournamentId(e){if(!$a.isString(e))throw new $t}validateContextId(e){if(!$a.isString(e))throw new H}validateLeaderboardId(e){if(!$a.isString(e)||e==="")throw new Pe}async joinTournamentAsync(e){if(!("tournament"in GameSDK))throw new S("tournament");try{await GameSDK.tournament.joinAsync(e)}catch(t){if(!zl.hasOwn(t,"code")||t.code!=="SAME_CONTEXT")throw t}}};c(mr,"JoinTournamentHandler");let Ga=mr;const wr=class wr extends E{async processAsync(s){try{this.startLog(s);const{playerId:e,tournamentId:t}=s,a=new b(this),n=new Ga(this,{tournamentId:t});a.setNext(n);const i=new k(this,{id:"1997",mode:K.TOURNAMENT,customData:{playerId:e}});n.setNext(i);const r=new z(this);i.setNext(r);const o=new Ee(this,{profileId:e});r.setNext(o);const l=new j(this);o.setNext(l);const d=new Mt(this);l.setNext(d);const u=new N(this);d.setNext(u);const f=this.match.getMatchState();await a.processAsync(f)}finally{this.endLog()}}};c(wr,"JoinTournamentConcrete");let Fa=wr;const{Dtos:ql,Utils:Yl}=p,{Object:Ql}=Yl,Ar=class Ar extends D{async processAsync(s){super.processAsync(s);const e=await this.getMatchCustomData(s);this.updateMatchCustomData(s,e),await this.nextAsync(s)}async getMatchCustomData(s){const{id:e}=s;if(!e)return{};const a=await this.match.api.getMatchAPI().getMatchDetailByIdAsync(e);return(a==null?void 0:a.extraData)??{}}updateMatchCustomData(s,e){const t=Ql.merge(s.customData,e),a=new ql.Match.CustomData(t).toObject();s.customData=a}};c(Ar,"GetMatchCustomDataHandler");let ka=Ar;const{Dtos:Xl,Utils:Jl}=p,{Object:Zl}=Jl,Dr=class Dr extends D{constructor(e,t){super(e);h(this,"payload");this.payload=t}async processAsync(e){super.processAsync(e),this.updateMatchCustomData(e),await this.nextAsync(e)}updateMatchCustomData(e){const t=Zl.merge(e.customData,this.payload),a=new Xl.Match.CustomData(t).toObject();e.customData=a}};c(Dr,"SetMatchCustomDataHandler");let Va=Dr;const ed={id:null,mode:null,status:null,startAt:0,finishAt:0,profiles:{},customData:{...Ks}},{Configs:Po}=p,Ir=class Ir extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"base");h(this,"group");h(this,"single");h(this,"context");h(this,"strategy");h(this,"challenge");h(this,"tournament");h(this,"api");h(this,"handler");h(this,"useCPUProfile")}init(){this.createMatchData(),this.createAPIHandler(),this.createBaseConcrete(),this.createConcreteFlows(),this.createConcreteHandlers()}setUseCPUProfile(e){this.useCPUProfile=e}createMatchData(){const{storage:e}=this.game;e.addStorage("match",ed)}getMatchState(){const{storage:e}=this.game;return e.getStorage("match")}createBaseConcrete(){this.base=new E(this.game,this)}createConcreteFlows(){this.createGroupFlows(),this.createSingleFlows(),this.createContextFlows(),this.createStrategyFlows(),this.createChallengeFlows(),this.createTournamentFlows()}createConcreteHandlers(){this.handler={setProfileData:c(async e=>{const t=new $e(this.base,e);await this.processHandlerAsync(t)},"setProfileData"),setMatchCustomData:c(async e=>{const t=new Va(this.base,e);await this.processHandlerAsync(t)},"setMatchCustomData"),getMatchCustomData:c(async()=>{const e=new ka(this.base);await this.processHandlerAsync(e)},"getMatchCustomData"),setLeaderboardScore:c(async e=>{const t=new Rt(this.base,e);await this.processHandlerAsync(t)},"setLeaderboardScore")}}createAPIHandler(){const e={appId:Po.AppId,matchAPIHost:Po.ApiHost};this.api=new Bs(e)}createGroupFlows(){this.group={join:new Aa(this.game,this),start:new Ia(this.game,this),finish:new wa(this.game,this)}}createSingleFlows(){this.single={start:new Ea(this.game,this),finish:new va(this.game,this)}}createStrategyFlows(){this.strategy={start:new xa(this.game,this),finish:new Sa(this.game,this)}}createContextFlows(){this.context={choose:new ga(this.game,this)}}createChallengeFlows(){this.challenge={invite:new ia(this.game,this),friend:new Ys(this.game,this),join:new ha(this.game,this),await:new zs(this.game,this),result:new fa(this.game,this),finish:new ea(this.game,this),continue:new Js(this.game,this)}}createTournamentFlows(){this.tournament={join:new Fa(this.game,this),create:new Ra(this.game,this),finish:new Ma(this.game,this),continue:new Ta(this.game,this)}}processHandlerAsync(e){const t=this.getMatchState();return e.processAsync(t)}};c(Ir,"MatchPlugin");let Ba=Ir;const{Valid:Se}=p.Utils,xe="is invalid",vr=class vr extends U{setupData(s){this.lazySetupData(s)}validateStructure(s){this.lazyValidateStructure(s)}validateData(s){this.lazyValidateData(s)}validateLevel(s){(!Se.isNumber(s)||s<0)&&this.exception("level",xe)}validateRescued(s){(!Se.isNumber(s)||s<0)&&this.exception("rescued",xe)}validateContextId(s){Se.isString(s)||this.exception("contextId",xe)}validatePlayerId(s){Se.isString(s)||this.exception("playerId",xe)}validateOpponentId(s){!Se.isString(s)&&s!==null&&this.exception("opponentId",xe)}validateTournamentId(s){!Se.isString(s)&&s!==null&&this.exception("tournamentId",xe)}validateLeaderboardId(s){!Se.isString(s)&&s!==null&&this.exception("leaderboardId",xe)}toObject(){return super.toObject()}static getDefaultData(){return U.getDefaultData()}};c(vr,"MatchCustomDataDtos");let Gt=vr;Gt.addDefaultData(Ks);const{Valid:Ge}=p.Utils,Fe="is invalid",Pr=class Pr extends U{setupData(s){this.lazySetupData(s)}validateStructure(s){this.lazyValidateStructure(s)}validateData(s){this.lazyValidateData(s)}validateId(s){(!Ge.isString(s)||!s)&&this.exception("id",Fe)}validateName(s){(!Ge.isString(s)||!s)&&this.exception("name",Fe)}validatePhoto(s){Ge.isString(s)||this.exception("photo",Fe)}validateScore(s){(!Ge.isNumber(s)||s<0)&&this.exception("score",Fe)}validateBestScore(s){(!Ge.isNumber(s)||s<0)&&this.exception("bestScore",Fe)}validateFinished(s){Ge.isBoolean(s)||this.exception("finished",Fe)}toObject(){return super.toObject()}static getDefaultData(){return U.getDefaultData()}};c(Pr,"MatchProfileDtos");let Ft=Pr;Ft.addDefaultData({id:"",name:"Your Friend",photo:"./assets/images/others/avatar.png",score:0,bestScore:0,finished:!1}),p.Dtos.Match={Data:ot,Profile:Ft,CustomData:Gt};const{Utils:{Object:td},Configs:{ApiHost:Eo}}=p,sd=c(()=>{const y=GameSDK.getSDKName();let s="players";switch(y){case"MsGames":s+="?platform=ms-games";break;case"Yandex":s+="?platform=yandex";break}return s},"getUrl"),ad=c(async y=>{if(!Eo)return{};const s=sd(),e=await Z(s,y,{},Eo,10);return td.hasOwn(e,"data")?e.data||{}:{}},"updatePlayerProfileAsync"),{Utils:{Array:nd,Object:kt,Valid:id},Configs:{AppId:rd}}=p,Er=class Er extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"isLoggedIn",!1)}init(){const{storage:e}=this.game;e.addStorage("player",de)}async saveToCloud(){try{const e=this.getPlayerData();await GameSDK.player.setDataAsync(e)}catch(e){console.warn(e)}}receiveData(e,t){const{storage:a}=this.game,{playerId:n,name:i,photo:r,locale:o}=e;a.setStorageData("player","playerId",n),a.setStorageData("player","name",i),a.setStorageData("player","photo",r),a.setStorageData("player","locale",o),t&&(this.setPlayerData(t),this.isLoggedIn=!t.isFirstLogin)}async syncProfileToServer(){if(GameSDK.extra.isGuest)throw new Error("Guest player cannot sync profile to server");const{storage:e}=this.game,t=this.getPlayer(),{playerId:a,name:n,photo:i,locale:r}=t;let o=this.getPlayerASID();!id.isString(o)&&"getASIDAsync"in GameSDK.player&&(o=await GameSDK.player.getASIDAsync()??o,e.setStorageData("player","ASID",`${o}`)),await ad({appId:rd,ASID:o,playerId:a,name:n,photo:i,locale:r})}setPlayerDataByName(e,t){this.setPlayerData({[e]:t})}setPlayerData(e){const{storage:t}=this.game;t.setStorageData("player","data",e),this.saveToCloud()}setBestScore(e){this.setPlayerDataByName("score",e)}setBestEndlessScore(e){this.setPlayerDataByName("endlessScore",e)}setSetting(e,t){this.setPlayerDataByName("settings",{[e]:t})}setGameData(e){const t=this.getGameData()??{},a=kt.merge(t,e);this.setPlayerDataByName("gameData",a)}async requestConnectedPlayers(){const{storage:e}=this.game,a=(await GameSDK.player.getConnectedPlayersAsync()).map(r=>{const o=r.getID(),l=r.getName(),d=r.getPhoto();return!o||!l||!d?null:new Ne({playerId:o,name:l,photo:d}).toObject()}),n=nd.unique(a);if(n.length<1)return;const i=kt.keyBy(n,"playerId");e.setStorageData("player","connectedPlayers",i)}getPlayer(){const{storage:e}=this.game;return e.getStorage("player")}getPlayerId(){const{storage:e}=this.game;return e.getStorageData("player","playerId")??""}getPlayerASID(){const{storage:e}=this.game;return e.getStorageData("player","ASID")??null}getPlayerLocale(){const{storage:e}=this.game;return e.getStorageData("player","locale")??""}getPlayerData(){const{storage:e}=this.game;return e.getStorageData("player","data")??de.data}getPlayerDataByKey(e){const t=this.getPlayerData();return kt.hasOwn(t,e)?t[e]:null}getGameData(){return this.getPlayerDataByKey("gameData")}getPlayerSetting(e){const t=this.getPlayerSettings();return kt.hasOwn(t,e)?t[e]:null}getPlayerSettings(){const{settings:e}=this.getPlayerData();return e}isFirstLogin(){return this.getPlayerDataByKey("isFirstLogin")??de.data.isFirstLogin}isFirstSession(){const e=this.isLoggedIn;return this.isFirstLogin()&&!e}loggedIn(){this.setPlayerDataByName("isFirstLogin",!1),this.isLoggedIn=!0}getBestScore(){const{score:e}=this.getPlayerData();return e}getBestEndlessScore(){const{endlessScore:e}=this.getPlayerData();return e}getConnectedPlayers(){const{storage:e}=this.game;return e.getStorageData("player","connectedPlayers")??{}}getConnectedPlayerIds(e,t){const a=this.getConnectedPlayers();return Object.keys(a).slice(t,t+e)}getNotificationData(){return this.getPlayerDataByKey("notificationData")??de.data.notificationData}};c(Er,"PlayerPlugin");let Ua=Er;const{Dtos:So,Utils:od}=p,{Valid:$}=od,{score:xo,endlessScore:cd,settings:ld,gameData:dd,isFirstLogin:hd,dailyRewarded:ud,notificationData:pd,lastCallSwitchGame:yd}=de.data,_="is invalid",Sr=class Sr extends U{processData(s){this.validateStructure(s),s.settings=new So.Player.Settings(s.settings).toObject(),s.gameData=new So.Player.GameData(s.gameData).toObject(),this.validateData(s),this.setupData(s)}setupData(s){this.lazySetupData(s)}validateStructure(s){this.lazyValidateStructure(s)}validateData(s){this.lazyValidateData(s)}validateScore(s){(!$.isNumber(s)||s<0)&&this.exception("score",_)}validateEndlessScore(s){(!$.isNumber(s)||xo<0)&&this.exception("endlessScore",_)}validateSettings(s){$.isObject(s)||this.exception("settings",_)}validateNotificationData(s){$.isObject(s)||this.exception("notificationData",_),(!("D1"in s)||!$.isObject(s.D1))&&this.exception("notificationData.D1",_),(!("D2"in s)||!$.isObject(s.D2))&&this.exception("notificationData.D2",_),(!("D3"in s)||!$.isObject(s.D3))&&this.exception("notificationData.D3",_),(!("D4"in s)||!$.isObject(s.D4))&&this.exception("notificationData.D4",_),(!("D5"in s)||!$.isObject(s.D5))&&this.exception("notificationData.D5",_),(!("D6"in s)||!$.isObject(s.D6))&&this.exception("notificationData.D6",_),(!("D7"in s)||!$.isObject(s.D7))&&this.exception("notificationData.D7",_)}validateGameData(s){$.isObject(s)||this.exception("gameData",_)}validateIsFirstLogin(s){$.isBoolean(s)||this.exception("isFirstLogin",_)}validateDailyRewarded(s){$.isObject(s)||this.exception("dailyRewarded",_)}validateLastCallSwitchGame(s){$.isNumber(s)||this.exception("lastCallSwitchGame",_),s<0&&this.exception("lastCallSwitchGame",_)}toObject(){return super.toObject()}};c(Sr,"PlayerDataDtos");let Vt=Sr;Vt.addDefaultData({score:xo,endlessScore:cd,settings:ld,gameData:dd,isFirstLogin:hd,dailyRewarded:ud,notificationData:pd,lastCallSwitchGame:yd});const{Valid:bo}=p.Utils,{level:fd,coins:gd}=de.data.gameData,xr=class xr extends U{setupData(s){this.lazySetupData(s)}validateStructure(s){this.lazyValidateStructure(s)}validateData(s){this.lazyValidateData(s)}validateLevel(s){(!bo.isNumber(s)||s<0)&&this.exception("level","is invalid")}validateCoins(s){(!bo.isNumber(s)||s<0)&&this.exception("coins","is invalid")}toObject(){return super.toObject()}};c(xr,"PlayerGameDataDtos");let Bt=xr;Bt.addDefaultData({level:fd,coins:gd});const{Valid:Ut}=p.Utils,{sound:md,music:wd,vibrate:Ad,language:Dd}=de.data.settings,Wt="is invalid",br=class br extends U{setupData(s){this.lazySetupData(s)}validateStructure(s){this.lazyValidateStructure(s)}validateData(s){this.lazyValidateData(s)}validateSound(s){Ut.isBoolean(s)||this.exception("sound",Wt)}validateMusic(s){Ut.isBoolean(s)||this.exception("music",Wt)}validateVibrate(s){Ut.isBoolean(s)||this.exception("vibrate",Wt)}validateLanguage(s){(!Ut.isString(s)||!s)&&this.exception("language",Wt)}toObject(){return super.toObject()}};c(br,"PlayerSettingsDtos");let jt=br;jt.addDefaultData({sound:md,music:wd,vibrate:Ad,language:Dd}),p.Dtos.Player={Info:Ne,Data:Vt,Settings:jt,GameData:Bt};const{Configs:Id,Utils:vd}=p,{Object:Pd,String:Ed}=vd,{ApiHost:Co,Mockup:Sd}=Id,Cr=class Cr{constructor(){h(this,"mockAPI")}async initMockAPI(){if(this.mockAPI)return;const s=(await ce(async()=>{const{default:e}=await v.import("./bundle/ProfileAPIMock.js");return{default:e}},void 0,v.meta.url)).default;if(typeof s!="function")throw new Error("Cannot load ProfileAPIMock");this.mockAPI=new s}async getPlayersAsync(s){const e=Ed.params(s);let t;if(Sd.Profile.Enabled)await this.initMockAPI(),t=await this.mockAPI.getPlayersAsync(s);else{if(!Co)return[];t=await Oe(`players?${e}`,{},Co)}return!Pd.hasOwn(t,"data")||!Array.isArray(t.data)?[]:t.data}};c(Cr,"ProfileAPI");let Wa=Cr;const To={profiles:{},profileIds:[]},{Utils:xd,Dtos:bd}=p,{Array:No,Valid:Cd,Object:Td,Function:Nd}=xd,Tr=class Tr extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"profileAPI",new Wa)}init(){const{storage:e}=this.game;e.addStorage("profile",To)}async requestProfiles(e){const t=this.getProfileIds(),a=No.difference(e,t);if(a.length<1)return;const i=No.chunk(a,400).map(d=>this.profileAPI.getPlayersAsync({playerIds:d})),o=(await Nd.allSettled(i)).reduce((d,u)=>u.status==="fulfilled"?d.concat(u.value):d,[]);if(!this.validateProfilesResponse(o))return;const l=this.convertToProfiles(o);this.setProfiles(l)}getProfile(e){return this.getProfiles()[e]??null}getProfiles(){const{storage:e}=this.game;return e.getStorageData("profile","profiles")??To.profiles}setProfiles(e){const{storage:t}=this.game;t.setStorageData("profile","profiles",e),t.setStorageData("profile","profileIds",Object.keys(e))}getProfileIds(){const{storage:e}=this.game;return e.getStorageData("profile","profileIds")??[]}validateProfilesResponse(e){return!(!Array.isArray(e)||e.length<1)}convertToProfiles(e){const t={};for(const a of e)Td.hasOwn(a,"playerId")&&Cd.isString(a.playerId)&&(t[a.playerId]=new bd.Player.Info(a).toObject());return t}};c(Tr,"ProfilePlugin");let ja=Tr;const Oo="Save The Pets",{Utils:{Object:Lo,Valid:Ro,Browser:_o}}=p,Nr=class Nr extends O.Plugins.BasePlugin{constructor(e){super(e);h(this,"storages");h(this,"storageLocalKeys",{});this.storages={}}async addStorage(e,t,a=!1){console.info("addStorage",e,t),this.storages[e]=t,a&&await this.initFromWebStorage(e,t)}async initFromWebStorage(e,t){this.storageLocalKeys[e]=!0;const a=await _o.getIndexedDB(`${Oo}_S_${e}`);if(!Ro.isObject(a))return;const n=Object.keys(t);for(const i of n)Lo.hasOwn(a,i)&&typeof t[i]==typeof a[i]&&this.setStorageData(e,i,a[i])}initStorageData(e,t,a){this.storages[e][t]=a}setStorageData(e,t,a){let n;if(Ro.isObject(a)){const i=this.getStorageData(e,t);n=Lo.merge(i,a)}else n=a;this.storages[e][t]=n}getStorageData(e,t){return this.getStorage(e)[t]}getStorage(e){return this.storages[e]}async updateToWebStorage(e){if(this.storageLocalKeys[e])return this.saveToWebStorage(e)}async saveToWebStorage(e){const t=this.getStorage(e);return _o.setIndexedDB(`${Oo}_S_${e}`,t)}};c(Nr,"StoragePlugin");let Ka=Nr;const Or=class Or extends O.Plugins.BasePlugin{constructor(){super(...arguments);h(this,"isVisible",!0);h(this,"browserPrefixes",["moz","ms","o","","webkit"]);h(this,"handleVisibilityChange",c(e=>{if(["focus","blur"].indexOf(e)>-1)return e==="focus"?this.onVisibleEvent():this.onHiddenEvent();const a=this.getBrowserPrefix();return this.getHiddenPropertyName(a)in document?this.onHiddenEvent():this.onVisibleEvent()},"handleVisibilityChange"))}init(){const e=this.getBrowserPrefix(),a=[this.getVisibilityEvent(e),"focus","blur"];for(const n of a)window.addEventListener(n,()=>{this.handleVisibilityChange(n)},!1),document.addEventListener(n,()=>{this.handleVisibilityChange(n)},!1);GameSDK.extra&&("onPause"in GameSDK.extra&&GameSDK.extra.onPause(()=>{this.handleVisibilityChange("blur")}),"onResume"in GameSDK.extra&&GameSDK.extra.onResume(()=>{this.handleVisibilityChange("focus")}))}isGameVisible(){return this.isVisible}getHiddenPropertyName(e){return e?`${e}Hidden`:"hidden"}getVisibilityEvent(e){return`${e||""}visibilitychange`}getBrowserPrefix(){for(const e of this.browserPrefixes)if(this.getHiddenPropertyName(e)in document)return e;return""}onVisibleEvent(){this.isVisible||(this.isVisible=!0,this.game.event.emit(p.Events.VISIBILITY_VISIBLE))}onHiddenEvent(){this.isVisible&&(this.isVisible=!1,this.game.event.emit(p.Events.VISIBILITY_HIDDEN))}};c(Or,"VisibilityPlugin");let Ha=Or;const{Utils:{Object:Mo},Plugins:{Ads:{Status:q,Types:ne,AdError:Kt,AdInstance:Od}}}=p,Lr=class Lr extends Od{constructor(e,t){super(e,t);h(this,"service");h(this,"instance");h(this,"instanceQueue",[]);this.service=GameSDK.getSDKName(),this.instance=null}async loadAsync(){if(console.debug("AdInstance","loadAsync called",{type:this.type,status:this.status,service:this.service,placementId:this.placementId}),!(this.instance&&this.status===q.FILLED)){if(this.status!==q.IDLE)throw new Kt("AD_NOT_READY","Ad is not ready.");try{if(this.instance=await this.createInstanceByType(this.type),this.instance===null)throw new Kt("AD_INSTANCE_NOT_INITIATED","Ad instance didn't initiated.");this.setStatus(q.LOADING),await this.instance.loadAsync(),this.setStatus(q.FILLED),console.debug("AdInstance","loadAsync success",{type:this.type,status:this.status,service:this.service}),this.logAdLoad()}catch(e){throw console.warn("AdInstance","loadAsync failed",{type:this.type,status:this.status,service:this.service}),console.warn(e),this.setStatus(q.IDLE),e instanceof Object&&"code"in e&&e.code==="INVALID_PARAM"&&(this.instance=null),this.instance&&this.pushInstanceToQueue(this.instance),self.game.analytics.loadAdFail({type:this.type,service:this.service}),e}}}async showAsync(){if(console.debug("AdInstance","showAsync called",{type:this.type,status:this.status,service:this.service}),this.status!==q.FILLED)throw new Kt("AD_NOT_FILLED","Ad is not filled.");if(this.instance===null)throw new Kt("AD_INSTANCE_NOT_INITIATED","Ad instance didn't initiated.");let e=!1;try{this.setStatus(q.SHOWING),self.game.analytics.showingAd({type:this.type,service:this.service}),await this.instance.showAsync(),e=!0,this.setStatus(q.IDLE),this.instance=null,console.debug("AdInstance","showAsync success",{type:this.type,status:this.status,service:this.service})}catch(t){throw console.warn("AdInstance","showAsync failed",{type:this.type,status:this.status,service:this.service,error:t}),Mo.hasOwn(t,"code")&&(t.code==="AD_NOT_LOADED"&&this.setStatus(q.IDLE),["INVALID_PARAM","INVALID_OPERATION","USER_INPUT"].indexOf(`${t.code}`)>-1&&(this.setStatus(q.IDLE),this.instance=null),t.code==="USER_INPUT"&&(e=!0)),this.status===q.SHOWING&&(this.setStatus(q.IDLE),this.instance=null),t}finally{e?this.logAdShown():self.game.analytics.showAdFail({type:this.type,service:this.service})}}async createInstanceByType(e){try{return await this.getAdInstanceByType(e)}catch(t){return Mo.hasOwn(t,"code")&&t.code==="ADS_TOO_MANY_INSTANCES"?this.getAdInstanceFailed():null}}async getAdInstanceByType(e){switch(e){case ne.REWARDED_VIDEO:return await GameSDK.getRewardedVideoAsync(this.placementId);case ne.INTERSTITIAL:return await GameSDK.getInterstitialAdAsync(this.placementId);case ne.REWARDED_INTERSTITIAL:return await GameSDK.getRewardedInterstitialAsync(this.placementId);default:return null}}getAdInstanceFailed(){if("canBeLoadedAd"in GameSDK.extra){for(const e of this.instanceQueue)if(GameSDK.extra.canBeLoadedAd(e))return this.instanceQueue.splice(this.instanceQueue.indexOf(e),1),e}else return this.instanceQueue.shift()||null;return null}logAdLoad(){switch(this.type){case ne.INTERSTITIAL:self.game.analytics.loadInterstitialAd({service:this.service});break;case ne.REWARDED_VIDEO:self.game.analytics.loadRewardedVideoAd({service:this.service});break;case ne.REWARDED_INTERSTITIAL:self.game.analytics.loadRewardedInterstitialAd({service:this.service});break}}logAdShown(){switch(this.type){case ne.INTERSTITIAL:self.game.analytics.showInterstitialAd({service:this.service});break;case ne.REWARDED_VIDEO:self.game.analytics.showRewardedVideoAd({service:this.service});break;case ne.REWARDED_INTERSTITIAL:self.game.analytics.showRewardedInterstitialAd({service:this.service});break}}pushInstanceToQueue(e){this.instanceQueue.push(e)}};c(Lr,"NormalAdInstance");let Ht=Lr;const{Plugins:{Ads:{Types:zt}}}=p,Rr=class Rr extends Ht{constructor(s,e){super(s,e),this.service="adsense"}async createInstanceByType(s){try{const e=window.GoogleAds;if(!e)return null;switch(s){case zt.BANNER:return e.getBannerAdAsync(this.placementId);case zt.REWARDED_VIDEO:return e.getRewardedVideoAsync(this.placementId);case zt.INTERSTITIAL:return e.getInterstitialAdAsync(this.placementId);case zt.REWARDED_INTERSTITIAL:return e.getRewardedInterstitialAsync(this.placementId);default:return null}}catch(e){return console.warn(e),null}}getAdInstanceFailed(){return null}};c(Rr,"AdSenseInstance");let za=Rr;const _r=class _r extends Yr{async loadAsync(){this.exception("Unsupported method")}async showAsync(){this.exception("This method is not implemented")}async hideAsync(){this.exception("This method is not implemented")}};c(_r,"BannerInstance");let qa=_r;const{Status:$o}=p.Plugins.Ads,Mr=class Mr extends qa{async showAsync(){await GameSDK.loadBannerAdAsync(this.placementId),this.setStatus($o.SHOWING)}async hideAsync(){await GameSDK.hideBannerAdAsync(this.placementId),this.setStatus($o.IDLE)}};c(Mr,"BannerAdInstance");let Ya=Mr;const{Utils:{Array:ue}}=p,ie={IDLE:"idle",LOADING:"loading",LOADED:"loaded",FAILED:"failed"},pe={NOT_STARTED:"not-started",IN_PROGRESS:"in-progress",COMPLETED:"completed",FAILED:"failed"},Go=["reward"],Fo=["next","preroll","browse","pause","start"],qt=["auto","banner","rectangle","vertical"],$r=class $r{constructor(s){h(this,"initStatus",ie.IDLE);h(this,"preloadStatus",pe.NOT_STARTED);h(this,"game");h(this,"adBreak");h(this,"adConfig");h(this,"config");h(this,"serviceName","adsense");h(this,"rewardedType","reward");h(this,"interstitialType","next");h(this,"bannerFormatType","auto");this.game=s}setInitStatus(s){var e,t;this.initStatus!==s&&((t=(e=this.game)==null?void 0:e.analytics)==null||t.initAdEvent({adService:this.serviceName,state:s}),this.initStatus=s)}getInitStatus(){return this.initStatus}async getRewardedVideoAsync(s){return await this.ensureInitialized(),this.createAdInstance(this.rewardedType,s)}async getInterstitialAdAsync(s){return await this.ensureInitialized(),this.createAdInstance(this.interstitialType,s)}async getRewardedInterstitialAsync(s){return await this.ensureInitialized(),this.createAdInstance(this.rewardedType,s)}async getBannerAdAsync(s){return await this.ensureInitialized(),this.createAdInstance(this.bannerFormatType,s)}setRewardType(s){ue.has(Go,s)?this.rewardedType=s:console.warn(`Rewarded Ad type: ${s} is not supported.`)}setInterstitialType(s){ue.has(Fo,s)?this.interstitialType=s:console.warn(`Interstitial Ad type: ${s} is not supported.`)}setBannerFormatType(s){ue.has(qt,s)?this.bannerFormatType=s:console.warn(`Banner Ad format type: ${s} is not supported.`)}async initAsync(s){try{switch(this.initStatus){case ie.LOADED:console.warn(`${this.serviceName} already initiated.`);return;case ie.LOADING:console.warn(`${this.serviceName} is being initiated.`);return}if(!this.validateConfig(s))throw new Error("Invalid Google Ads configuration");this.setInitStatus(ie.LOADING),this.config=s,await this.loadScriptElementAsync(),console.info(`${this.serviceName} initialized successfully`)}catch(e){throw this.setInitStatus(ie.FAILED),console.warn(`Failed to initialize ${this.serviceName}:`,e),e}}validateConfig(s){if(!s)return console.error(`${this.serviceName} Ads config is required`),!1;const{dataAdClient:e,dataAdHost:t}=s;if(!e&&!t)return console.error(`Either ${this.serviceName} dataAdClient or dataAdHost is required`),!1;if(s.dataAdFrequencyHint){const a=Number(s.dataAdFrequencyHint);if(isNaN(a)||a<=0)return console.error(`${this.serviceName} dataAdFrequencyHint must be a positive number`),!1}return!0}async loadScriptElementAsync(){try{await this.injectMainScript(),await this.configureGoogleAds(),this.config.usePreload&&await this.preloadAdConfig()}catch(s){throw console.warn(`Failed to load ${this.serviceName} Ads script:`,s),s}}async injectMainScript(){return new Promise((s,e)=>{try{const t=document.createElement("script");this.configureScriptAttributes(t),t.onload=()=>{this.setInitStatus(ie.LOADED),s()},t.onerror=a=>{this.setInitStatus(ie.FAILED),e(new Error(`Failed to load ${this.serviceName} Ads script: ${a}`))},document.head.appendChild(t)}catch(t){console.warn(`Failed to inject ${this.serviceName} Ads main script:`,t),e(t)}})}async configureGoogleAds(){try{window.adsbygoogle=window.adsbygoogle||[],window.adBreak=s=>adsbygoogle.push(s),window.adConfig=s=>adsbygoogle.push(s),this.adBreak=window.adBreak,this.adConfig=window.adConfig}catch(s){throw console.warn(`Failed to configure ${this.serviceName} Ads:`,s),s}}configureScriptAttributes(s){const{dataAdClient:e,dataAdHost:t,dataAdChannel:a,dataAdBreakTest:n,dataAdFrequencyHint:i}=this.config;s.async=!0,s.crossOrigin="anonymous";let r="";i&&s.setAttribute("data-ad-frequency-hint",`${i}s`),e&&(s.setAttribute("data-ad-client",e),r+=`?client=${e}`),a&&s.setAttribute("data-ad-channel",a),t&&(s.setAttribute("data-ad-host",t),r+=`&host=${t}`),n&&s.setAttribute("data-adbreak-test","on"),s.src=`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js${r}`}async ensureInitialized(){if(this.initStatus!==ie.LOADED)throw console.warn(this.initStatus),new Error("Google Ads not initialized. Call initAsync first.");await this.ensurePreloaded()}async ensurePreloaded(){this.preloadStatus!==pe.COMPLETED&&await this.preloadAdPlacement()}createAdInstance(s,e){const t=ue.has(qt,s);return{getPlacementID:c(()=>e,"getPlacementID"),loadAsync:c(async()=>{if(!t)return this.preloadAdPlacement();const a=s,{dataAdClient:n,dataAdChannel:i,dataAdBreakTest:r}=this.config;return this.setupBannerAdElement({type:a,placementId:e,dataAdClient:n,dataAdChannel:i,dataAdBreakTest:r})},"loadAsync"),showAsync:c(()=>this.showAd(s,e),"showAsync"),hideAsync:c(()=>this.hideAd(s,e),"hideAsync")}}async showAd(s,e){return new Promise((t,a)=>{try{if(ue.has(qt,s))return;const n=this.createAdBreakConfig({type:s,placementId:e,resolve:t,reject:a});this.adBreak(n)}catch(n){console.warn("Failed to show ad:",n),a(n)}})}async hideAd(s,e){if(!ue.has(qt,s)||document.getElementsByClassName("adsbygoogle").length===0)return;const a=this.getBannerAdElement(e);a&&a.remove()}getBannerAdElement(s){const e=document.getElementsByClassName("adsbygoogle");return Array.from(e).find(t=>t.getAttribute("data-placement-id")===s)||null}async setupBannerAdElement(s){const{type:e,placementId:t,dataAdClient:a,dataAdChannel:n,dataAdBreakTest:i}=s;if(this.getBannerAdElement(t))return;const o=document.createElement("ins");o.className="adsbygoogle",o.style.display="inline-block",o.style.width="100%",o.style.height="51px",o.setAttribute("data-placement-id",t),o.setAttribute("data-ad-client",a),o.setAttribute("data-ad-slot",n??""),o.setAttribute("data-ad-format",e),o.setAttribute("data-ad-test",i?"on":"off"),o.setAttribute("data-full-width-responsive","true");const l=document.createElement("script");l.innerHTML="(adsbygoogle = window.adsbygoogle || []).push({});",o.appendChild(l),document.body.insertAdjacentElement("beforeend",o)}createAdBreakConfig(s){const e=this.createBaseAdBreakConfig({placementId:s.placementId}),{type:t}=s;if(ue.has(Fo,t))return this.createInterstitialAdBreakConfig(e,s);if(ue.has(Go,t))return this.createRewardAdBreakConfig(e,s);throw new Error(`Ad type: ${t} is not supported.`)}createBaseAdBreakConfig(s){return{name:s.placementId,beforeAd:c(()=>{},"beforeAd"),adBreakDone:c(e=>{},"adBreakDone")}}createInterstitialAdBreakConfig(s,{resolve:e,reject:t}){return{...s,type:this.interstitialType,adBreakDone:c(a=>{var n;(n=s.adBreakDone)==null||n.call(s,a),this.handleAdBreakDone({info:a,resolve:e,reject:t})},"adBreakDone")}}createRewardAdBreakConfig(s,{resolve:e,reject:t}){return{...s,type:this.rewardedType,beforeReward:c(a=>{a()},"beforeReward"),adDismissed:c(()=>{t(new Error("USER_INPUT"))},"adDismissed"),adViewed:c(()=>{e()},"adViewed")}}handleAdBreakDone(s){const{info:e,resolve:t,reject:a}=s;switch(e.breakStatus){case"viewed":t();break;case"frequencyCapped":a(new Error("AD_FREQUENCY_CAPPED"));break;default:a(new Error(e.breakStatus))}}async preloadAdPlacement(){if(this.initStatus!==ie.LOADED)throw new Error(`${this.serviceName} Ads not initiated.`);return this.preloadAdConfig()}getPreloadStatus(){return this.preloadStatus}async preloadAdConfig(){if(this.preloadStatus!==pe.COMPLETED&&this.preloadStatus!==pe.IN_PROGRESS)return this.preloadStatus=pe.IN_PROGRESS,new Promise((s,e)=>{const t=setTimeout(()=>{this.preloadStatus===pe.IN_PROGRESS&&(this.preloadStatus=pe.FAILED,e(new Error("Failed to preload ad config in time.")))},5e3);this.adConfig({preloadAdBreaks:"on",onReady:c(()=>{clearTimeout(t),this.preloadStatus=pe.COMPLETED,s()},"onReady")})})}};c($r,"GoogleAds");let Qa=$r;const re={};var Ld=Object.defineProperty,Rd=Object.getOwnPropertyDescriptor,Xa=c((y,s,e,t)=>{for(var a=t>1?void 0:t?Rd(s,e):s,n=y.length-1,i;n>=0;n--)(i=y[n])&&(a=(t?i(s,e,a):i(a))||a);return t&&a&&Ld(s,e,a),a},"__decorateClass");const{BaseAnalytics:_d,Events:oe}=p.Plugins.Analytics,{Events:{VISIBILITY_HIDDEN:Md,VISIBILITY_VISIBLE:$d},Utils:{Array:ko,Object:Yt,Image:Gd,Decorator:Ja},Configs:{Analytics:{ClarityAnalytics:Vo}}}=p,Bo=Yt.invert(oe),Fd=[oe.SCREEN_OPEN],Gr=class Gr extends _d{constructor(e,t){super(e,"ClarityAnalytics",{...t,color:"#9692FF"});h(this,"image");h(this,"screenshotCount",4);h(this,"isCapturing",!1);h(this,"isScreenshotByEvent",!1);h(this,"handleVisibilityHidden",c(()=>{var e;(e=this.clarity)==null||e.call(this,"set","Visibility","hidden")},"handleVisibilityHidden"));h(this,"handleVisibilityVisible",c(()=>{var e;(e=this.clarity)==null||e.call(this,"set","Visibility","visible")},"handleVisibilityVisible"));h(this,"makeScreenshotByEvent",c(async(e,t=0)=>{if(!this.game.canvasRecorder||!this.isScreenshotByEvent||!Yt.hasOwn(Bo,e))return;const n=Bo[e];ko.has(Vo.ScreenshotCanvas.ByEvent,n)&&(await this.setScreenshotToHtml(),t<this.screenshotCount&&setTimeout(()=>this.makeScreenshotByEvent(e,t+1),300))},"makeScreenshotByEvent"));h(this,"setScreenshotToHtml",c(async()=>{try{if(this.isCapturing||(this.isCapturing=!0,!this.image))return;const e=await this.captureScreenshot();if(!e)return;this.image.src=e}finally{this.isCapturing=!1}},"setScreenshotToHtml"));this.setupScreenshots(),this.listenVisibilityEvents()}get clarity(){return Yt.hasOwn(window,"clarity")?window.clarity:null}setUser(e,t=!1){var n;const a=t?"guest":void 0;(n=this.clarity)==null||n.call(this,"identify",e,a)}listenVisibilityEvents(){this.game.event.on(Md,this.handleVisibilityHidden),this.game.event.on($d,this.handleVisibilityVisible)}processEvent(e,t){var a;this.setTagByEvent(e,t),this.makeScreenshotByEvent(e),!ko.has(Fd,e)&&((a=this.clarity)==null||a.call(this,"event",e,t))}setTagByEvent(e,t){if(t)switch(e){case oe.PAGE_VIEW:case oe.SCREEN_OPEN:this.setPageTag(t);break;case oe.AD_SHOWING:this.setAdTag(t);break;case oe.BUTTON_CLICK:this.setButtonTag(t);break;case oe.TUTORIAL_STEP:this.setTutorialTag(t);break;case oe.LEVEL_START:this.setLevelTag(t);break;case oe.USE_ITEM:this.setItemTag(t);break}}setPageTag(e){var a;if(!e.page_title&&!e.path_path)return;const t=e.page_title||e.path_path;t&&((a=this.clarity)==null||a.call(this,"set","Page",t))}setAdTag(e){var a;if(!e.ad_type||!e.ad_service)return;const t=`${e.ad_type}:${e.ad_service}`;(a=this.clarity)==null||a.call(this,"set","Ad",t)}setButtonTag(e){var a;if(!e.button_name||!e.screen_name)return;const t=`${e.button_name}:${e.screen_name}`;(a=this.clarity)==null||a.call(this,"set","Button",t)}setTutorialTag(e){var a;if(!e.step)return;const t=e.step.toString();(a=this.clarity)==null||a.call(this,"set","Tutorial",t)}setLevelTag(e){var a;if(!e.level_name||!e.game_mode)return;const t=`${e.game_mode}:${e.level_name}`;(a=this.clarity)==null||a.call(this,"set","Level",t)}setItemTag(e){var t;e.item_name&&((t=this.clarity)==null||t.call(this,"set","Item",e.item_name))}setupScreenshots(){if(typeof FileReader>"u"){console.warn("FileReader is not supported");return}this.initImage();const{ByEvent:e,Interval:t}=Vo.ScreenshotCanvas;if(e.length>0){this.isScreenshotByEvent=!0;return}setInterval(this.setScreenshotToHtml,t)}initImage(){if(this.image)return;const e=document.getElementById("Cocos3dGameContainer");e&&(this.image=document.createElement("img"),this.image.id="clarity-screenshot",this.image.setAttribute("data-clarity-unmask","true"),Yt.assign(this.image.style,{position:"absolute",display:"flex",width:"100%",top:0,left:0,pointerEvents:"none"}),e.insertBefore(this.image,e.firstChild))}async captureScreenshot(){if(!this.game.canvasRecorder)return null;const e=await this.game.canvasRecorder.snapshotFrameAsync({force:!0,type:"jpeg",quality:.1,resolution:.5});return this.game.canvasRecorder.waitNextFrame(),e?await Gd.blobToDataImage(e):null}};c(Gr,"ClarityAnalytics");let ye=Gr;Xa([Ja.tryCatch()],ye.prototype,"setupScreenshots",1),Xa([Ja.tryCatch()],ye.prototype,"initImage",1),Xa([Ja.tryCatch()],ye.prototype,"captureScreenshot",1);const{BaseAnalytics:kd,Events:be}=p.Plugins.Analytics,Vd=[be.SCREEN_OPEN,be.ENGINE_READY],{Utils:{Array:Bd}}=p,Fr=class Fr extends kd{constructor(s,e){super(s,"GoogleAnalytics",{...e,color:"#E35335"})}processEvent(s,e){Bd.has(Vd,s)||(this.customEvent(s,e),gtag("event",s,e))}customEvent(s,e){switch(s){case be.AD_SHOW:case be.AD_SHOW_FAILED:case be.AD_SHOWING:case be.USE_ITEM:case be.EARN_ITEM:this.addLevelName(e);break}}addLevelName(s){if(!s||!(game!=null&&game.match))return;const t=game.match.getMatchState().customData.level;!t||t<0||(s.level_name=this.getLevelName(t))}};c(Fr,"GoogleAnalytics");let lt=Fr;const Ud="development",Za="32",{Dtos:Wd,Events:Ce,Configs:{AppId:jd,Ads:X,Analytics:Qt,AdaptivePerformance:Uo,Debugger:Te,Firebase:Wo,Notification:Kd,RemoteConfig:jo,PerformanceMonitor:Hd},Plugins:{Ads:{Types:Xt}},Utils:{Device:zd,Object:Ko,Json:dt,String:Ho,Valid:qd,Mark:C}}=p,kr=class kr extends O.Game{constructor(){super(...arguments);h(this,"markName","Core Initialize");h(this,"modulePlugins",[]);h(this,"processContextSession",c(async()=>{C.putAttr(this.markName,"Step","Process Context Payload"),await this.context.detectContextSessionType(),this.context.detectContextGameMode();const e=this.storage.getStorageData("context","sessionContextType")||"unknown";C.putAttr(this.markName,"Context Mode",e),console.warn("GameCore start completed",e),C.stop(this.markName)},"processContextSession"));h(this,"addDevPlugins",c(()=>{var e;(e=GameSDK==null?void 0:GameSDK.player)==null||e.getID(),this.addConsolePlugin(),this.addProfilerPlugin()},"addDevPlugins"));h(this,"handleProtectGameInstance",c(()=>{const e=this.event.getEventEmitCount(le.MODULE_PLUGIN_READY),t=this.modulePlugins.length;e<t||(window.game=Object.freeze(window.game),console.warn("window.game",window.game))},"handleProtectGameInstance"));h(this,"initCanvasRecorderPlugin",c(()=>{if(!this.canvasRecorder)return;const{CanvasRecorder:e}=Te,{Type:t,Quality:a,RecordFps:n,SyncFps:i}=e.Options;this.canvasRecorder.configure({type:t,quality:a,syncFps:i,recordFps:n}),this.canvasRecorder.setPanelExpanded(e.PanelExpanded);const r=document.querySelector("canvas");if(!r){console.error("Canvas not found");return}this.canvasRecorder.setCanvas(r)},"initCanvasRecorderPlugin"));h(this,"initMonitorErrorPlugin",c(()=>{var u;if(!this.monitorError)return;const{MonitorError:e,ListPlayerDevIds:t}=Te,{ApiKey:a,Service:n,Feedback:i,TrackUser:r,FilterErrors:o}=e,l=GameSDK.player.getID(),d=GameSDK.player.getName();l&&t.indexOf(l)>=0||((u=window.disableSimpleTrackErrors)==null||u.call(window),this.monitorError.configure({apiKey:a,service:n,feedback:i,trackUser:r,releaseStage:Ud,buildVersion:`${Za}`}),this.monitorError.setUser({id:l,name:d}),this.monitorError.addFilterErrors(o),this.monitorError.initFeedbackTrackErrors(),this.updateMonitorErrorUserAndMetadata(),this.processErrorsQueue())},"initMonitorErrorPlugin"));h(this,"updateMonitorErrorUserAndMetadata",c(()=>{this.event.catchUp(Ce.PLAYER_INFO_LOADED,this.processWhenPlayerInfoLoaded)},"updateMonitorErrorUserAndMetadata"));h(this,"processErrorsQueue",c(()=>{if(this.monitorError&&window.__errorQueue){for(const e of window.__errorQueue)if(e instanceof Error)this.monitorError.sendException(e);else{const{message:t,code:a,stack:n}=e||{message:"",code:"Unknown",stack:"Unknown stack"},i=new Error(t||a);i.stack=n,this.monitorError.sendException(i)}window.__errorQueue=null}},"processErrorsQueue"));h(this,"processWhenPlayerInfoLoaded",c(()=>{if(!this.monitorError)return;const{playerId:e,name:t}=this.player.getPlayer();this.monitorError.setUser({id:e,name:t}),this.monitorError.addMetadata({isFirstSession:this.player.isFirstSession()})},"processWhenPlayerInfoLoaded"));h(this,"handleSaveRemoteConfig",c(e=>{try{const t={[e.type]:e};this.player.setPlayerDataByName("remoteConfig",t)}catch(t){console.warn("handleSaveGameCoreConfig",t)}},"handleSaveRemoteConfig"));h(this,"handleUpdateGameCoreConfig",c(e=>{try{const{id:t,type:a}=e;if(a!=="GameCore")return;p.Configs=Ko.merge(p.Configs,e.config);const{Ads:n}=p.Configs;this.ads.configure(n),this.event.emit(le.REMOTE_CONFIG_UPDATED,{id:t,type:a})}catch(t){console.warn("handleUpdateGameCoreConfig",t)}},"handleUpdateGameCoreConfig"));h(this,"handleStorageCurrentRemoteConfig",c(()=>{const e=this.player.getPlayerDataByKey("remoteConfig");if(console.debug("playerRemoteConfig",dt.clone(e)),!!e){for(const t in e)if(Ko.hasOwn(e,t)){const a=e[t],n=dt.clone(a);console.log("newRemoteConfig",n);const i=new Wd.RemoteConfig.Data(n).toObject();console.debug("remoteConfigValid",i),this.remoteConfig.setRemoteConfig(i),this.remoteConfig.processUpdateConfig(i.id,i.type)}}},"handleStorageCurrentRemoteConfig"));h(this,"initAdaptivePerformancePlugin",c(()=>{if(!this.adaptivePerformance)return;const e=dt.clone(Uo);this.adaptivePerformance.configure(e)},"initAdaptivePerformancePlugin"));h(this,"processAfterSyncProfile",c(()=>{Kd.Enabled&&this.updatePlayerProfileToNotificationService()},"processAfterSyncProfile"))}getBuildVersion(){return parseInt(`${Za}`)||0}async boot(){console.groupEnd(),console.groupCollapsed("🧬 GameCore Boot"),super.boot(),this.addPlugins(),this.initEventPlugin(),this.event.emit(Ce.CORE_BOOTING),this.initFirebasePlugin(),this.initMarkCoreInitialize(),C.putAttr(this.markName,"Step","Init Analytics"),this.initGoogleAnalytics(),this.initClarityAnalytics(),this.initFirebaseAnalytics(),this.initYandexAnalytics(),this.initXiaomiAnalytics(),this.initFacebookAnalytics(),this.initTranssionH5Analytics(),C.putAttr(this.markName,"Step","Init Plugins"),this.initAds(),this.initMatchPlugin(),this.initRemoteConfig(),C.putAttr(this.markName,"Step","Load Lazy Plugins"),qd.isDebugger()||this.event.on(Ce.MODULE_PLUGIN_READY,this.handleProtectGameInstance),this.addMonitorPlugin().then(this.initMonitorErrorPlugin),this.addCanvasRecorderPlugin().then(this.initCanvasRecorderPlugin),this.addAdaptivePerformancePlugin().then(this.initAdaptivePerformancePlugin),C.putAttr(this.markName,"Step","Load Dev Plugins"),this.event.catchUp(Ce.GAME_SDK_READY,this.addDevPlugins)}async start(){console.groupEnd(),console.groupCollapsed("🧬 GameCore Start"),super.start(),C.putAttr(this.markName,"Step","Core Start"),this.event.emit(Ce.CORE_STARTING),C.putAttr(this.markName,"Step","Request Token"),await this.auth.requestToken(),C.putAttr(this.markName,"Step","Init States"),await this.initState(),C.putAttr(this.markName,"Step","Process Player Profile"),this.processPlayerProfile(),GameSDK.getSDKName()==="FacebookInstant"&&zd.isIOS()?this.event.catchUp(Ce.GAME_SDK_STARTED,this.processContextSession):await this.processContextSession(),C.putAttr(this.markName,"Step","Core Ready"),C.putAttr(this.markName,"Success","true"),this.event.emit(Ce.CORE_READY)}addPlugins(){this.installPlugin("Storage",Ka),this.installPlugin("Event",Es),this.installPlugin("Ads",cs),this.installPlugin("Auth",ys),this.installPlugin("Audio",ft),this.installPlugin("Match",Ba),this.installPlugin("Player",Ua),this.installPlugin("Profile",ja),this.installPlugin("Context",ms),this.installPlugin("Language",$s),this.installPlugin("Analytics",us),this.installPlugin("Visibility",Ha),this.installPlugin("Leaderboard",Fs),this.installPlugin("DailyRewards",vs),this.installPlugin("FrameCapture",_s),this.installPlugin("RemoteConfig",Zt),"Proxy"in window&&this.installPlugin("Firebase",Zt)}installPlugin(e,t,a=!1){const n=Ho.toCamelCase(Ho.capitalize(e));this.plugins.install(e,t,!0,n),e!=="Storage"&&(a?this.emitModulePluginReady(e):this.emitCorePluginReady(e))}async addMonitorPlugin(){try{const{MonitorError:e}=Te;if(!e.Enabled)return;this.modulePlugins.push("MonitorError");const t=(await ce(async()=>{const{default:a}=await v.import("./bundle/monitor-error.js");return{default:a}},void 0,v.meta.url)).default;if(typeof t!="function")return;this.installPlugin("MonitorError",t,!0)}catch(e){console.error("Error importing Monitor Error plugin:",e)}}async addCanvasRecorderPlugin(){try{const{CanvasRecorder:e}=Te;if(!e.Enabled)return;this.modulePlugins.push("CanvasRecorder");const t=(await ce(async()=>{const{default:a}=await v.import("./bundle/canvas-recorder.js").then(n=>n.i);return{default:a}},void 0,v.meta.url)).default;if(typeof t!="function")throw new Error("CanvasRecorderPlugin is not a function");this.installPlugin("CanvasRecorder",t,!0)}catch(e){console.error("Error importing Canvas Recorder plugin:",e)}}async addAdaptivePerformancePlugin(){try{if(!Uo.Enabled)return;this.modulePlugins.push("AdaptivePerformance");const e=(await ce(async()=>{const{default:t}=await v.import("./bundle/index.js");return{default:t}},void 0,v.meta.url)).default;if(typeof e!="function")return;this.installPlugin("AdaptivePerformance",e,!0)}catch(e){console.error("Error importing Adaptive Performance plugin:",e)}}async addConsolePlugin(){try{const{Console:e}=Te;if(!e.Enabled)return;this.modulePlugins.push("Console");const t=(await ce(async()=>{const{default:a}=await v.import("./bundle/canvas-recorder.js").then(n=>n.e);return{default:a}},void 0,v.meta.url)).default;if(typeof t!="function")throw new Error("ConsolePlugin is not a function");this.installPlugin("Console",t,!0),this.initConsolePlugin()}catch(e){console.error("Error importing Console plugin:",e)}}async addProfilerPlugin(){try{const{Profiler:e}=Te;if(!e.Enabled)return;this.modulePlugins.push("Profiler");const t=(await ce(async()=>{const{default:a}=await v.import("./bundle/canvas-recorder.js").then(n=>n.e);return{default:a}},void 0,v.meta.url)).default;if(typeof t!="function")throw new Error("ProfilerPlugin is not a function");this.installPlugin("Profiler",t,!0),this.initProfilerPlugin()}catch(e){console.error("Error importing Profiler plugin:",e)}}emitCorePluginReady(e){this.event.emit(le.CORE_PLUGIN_READY,{name:e})}emitModulePluginReady(e){this.event.emit(le.MODULE_PLUGIN_READY,{name:e})}initEventPlugin(){const{EventLogging:e}=Te;e.Enabled&&this.event.enableLogEvent()}initMatchPlugin(){this.match.setUseCPUProfile(!1)}initAds(){this.ads.configure(X),this.initGoogleAds(),this.initTranssionH5Ads(),this.initAdInstance(),X.Enabled&&this.analytics.initAdEvent({adService:"platform",state:"loaded"})}async initGoogleAds(){try{if(!X.Enabled)return;const{AdSense:e}=X.AdServiceConfigs;if(!e.Enabled)return;const t=new Qa(this);await t.initAsync({usePreload:e.UsePreload,dataAdHost:e.DataAdHost,dataAdClient:e.DataAdClient,dataAdChannel:e.DataAdChannel,dataAdBreakTest:e.DataAdBreakTest,dataAdFrequencyHint:e.DataAdFrequencyHint}),window.GoogleAds=t}catch(e){console.warn("initGoogleAds",e)}}async initTranssionH5Ads(){try{if(!X.Enabled)return;const{Savana:e}=X.AdServiceConfigs;if(!e.Enabled)return;const t=new re(this);await t.initAsync({usePreload:e.UsePreload,dataAdHost:e.DataAdHost,dataAdClient:e.DataAdClient,dataAdChannel:e.DataAdChannel,dataAdBreakTest:e.DataAdBreakTest,dataAdFrequencyHint:e.DataAdFrequencyHint}),window.TranssionH5Ads=t}catch(e){console.warn("initTranssionH5Ads",e)}}getAdInstanceByService(e,t=!1){const{AdSense:a,AppLovin:n,Savana:i}=X.AdServiceConfigs;switch(e){case"adsense":if(a.Enabled)return za;break;case"applovin":n.Enabled;break;case"savana":if(i.Enabled)return re;break;default:return t?Ya:Ht}return null}initAdInstance(){for(const t of X.InterstitialAdOptions){const a=this.getAdInstanceByService(t.AdService);a&&this.ads.setAdInstance(Xt.INTERSTITIAL,t.PlacementId,a)}for(const t of X.RewardedVideoAdOptions){const a=this.getAdInstanceByService(t.AdService);a&&this.ads.setAdInstance(Xt.REWARDED_VIDEO,t.PlacementId,a)}for(const t of X.RewardedInterstitialAdOptions){const a=this.getAdInstanceByService(t.AdService);a&&this.ads.setAdInstance(Xt.REWARDED_INTERSTITIAL,t.PlacementId,a)}const e=!0;for(const t of X.BannerDisplayAdOptions){const a=this.getAdInstanceByService(t.AdService,e);a&&this.ads.setAdInstance(Xt.BANNER,t.PlacementId,a)}}async initState(){try{const e=new ns(this);e.initContext(),await e.initPlayer()}catch(e){console.error("StateInitiator",e)}}initConsolePlugin(){this.console&&this.console.configure()}initProfilerPlugin(){this.profiler&&this.profiler.configure()}initRemoteConfig(){if(!jo.Enabled)return;const e=dt.clone(jo);this.remoteConfig.configure(e),this.event.on(le.REQUEST_SAVE_CONFIG,this.handleSaveRemoteConfig),this.event.on(le.REQUEST_UPDATE_CONFIG,this.handleUpdateGameCoreConfig),this.event.catchUp(le.PLAYER_INFO_LOADED,this.handleStorageCurrentRemoteConfig)}initFirebasePlugin(){if(!Wo.Enabled||!this.firebase)return;const e=dt.clone(Wo);this.firebase.configure(e),C.setService(this.firebase.services.performance)}initMarkCoreInitialize(){Hd.CoreFlows&&(C.measure(this.markName),C.putAttr(this.markName,"Build",`${Za}`),C.putAttr(this.markName,"GameSDK",GameSDK.getSDKName()),C.putAttr(this.markName,"Platform",GameSDK.getPlatform()),C.putAttr(this.markName,"Success","false"),C.start(this.markName))}async processPlayerProfile(){try{await this.player.syncProfileToServer(),this.processAfterSyncProfile()}catch(e){console.warn("processPlayerProfile fail",e)}}async updatePlayerProfileToNotificationService(){try{const e=this.player.getPlayer(),{ASID:t,playerId:a,name:n,photo:i,locale:r}=e;await cc({appId:jd,ASID:t,playerId:a,name:n,photo:i,locale:r})}catch(e){console.warn("updatePlayerProfileToNotificationService",e)}}initGoogleAnalytics(){const{Enabled:e,ConsoleLog:t}=Qt.GoogleAnalytics??{};if(e){if(typeof lt!="function"||!(lt.prototype instanceof Object)){console.warn("GoogleAnalytics is not a constructor");return}this.analytics.add(new lt(this.game,{log:!!t}))}}initClarityAnalytics(){const{Enabled:e,ConsoleLog:t}=Qt.ClarityAnalytics??{};if(!e)return;if(typeof ye!="function"||!(ye.prototype instanceof Object)){console.warn("ClarityAnalytics is not a constructor");return}const a=new ye(this.game,{log:!!t}),n=this.player.getPlayer(),{playerId:i}=n;a.setUser(i,GameSDK.extra.isGuest),this.analytics.add(a)}initFirebaseAnalytics(){const{Enabled:e,ConsoleLog:t}=Qt.FirebaseAnalytics??{};if(!e)return;if(typeof re!="function"||!(re.prototype instanceof Object)){console.warn("FirebaseAnalytics is not a constructor");return}const a=new re(this.game,{log:!!t});this.analytics.add(a);let n="no_entry";GameSDK.getEntryPointAsync().then(i=>{n=i}).catch(i=>{console.warn(i)}).finally(()=>{const i=this.player.getPlayer(),{playerId:r,locale:o}=i,{fbig_ad_id:l,fbig_adset_id:d,fbig_campaign_id:u}=GameSDK.getEntryPointData()||{};a.setUser(r,{locale:o,ad_id:l,adset_id:d,campaign_id:u,traffic_source:n})})}initYandexAnalytics(){GameSDK.getSDKName()==="Yandex"&&this.analytics.add(new re(this.game))}initXiaomiAnalytics(){GameSDK.getSDKName()==="Xiaomi"&&this.analytics.add(new re(this.game))}initFacebookAnalytics(){const e=GameSDK.getSDKName(),{Enabled:t,Prefix:a,ConsoleLog:n}=Qt.FacebookAnalytics??{};if(!(!t||e!=="FacebookInstant")){if(typeof a!="string"){console.warn("Facebook Analytics is not configured");return}this.analytics.add(new re(this.game,{prefix:a,log:!!n}))}}initTranssionH5Analytics(){GameSDK.getSDKName()==="TranssionH5"&&this.analytics.add(new re(this.game))}};c(kr,"MagicGame");let en=kr;const{Configs:{GameEngine:{ForceDesktopDPR:Jt}},Utils:{Device:Yd},Events:tn}=p,Qd=c(async()=>{const y=new en;window.game=y;const s=20;window.__sdkLoadingCount<s&&(window.__sdkLoadingCount=s),window.__gameCoreStart=!0,await y.boot(),y.event.catchUp(tn.REQUEST_CORE_START,zo),Xd(y)},"initGame"),zo=c(()=>{if(!window.__sdkInitiated){game.event.catchUp(tn.GAME_SDK_READY,zo);return}window.game.start(),console.warn("Game started");const y=25;window.__sdkLoadingCount<y&&(window.__sdkLoadingCount=y)},"startGame"),Xd=c(y=>{const e=setInterval(()=>{if(!window.__sdkInitiated)return;clearInterval(e);const t=10;window.__sdkLoadingCount<t&&(window.__sdkLoadingCount=t),y.event.emit(tn.GAME_SDK_READY)},5)},"waitGameSDK");Jt!==!1&&Yd.isDesktop()&&typeof Jt=="number"&&Jt>0&&(window.devicePixelRatio=Jt),window.originalRequestAnimationFrame=window.requestAnimationFrame,window.isCustomRequestAnimationFrame=!0,window.requestAnimationFrame=y=>window.isCustomRequestAnimationFrame?(setTimeout(y,1e3/60),0):window.originalRequestAnimationFrame(y),Qd()},"execute")}});
